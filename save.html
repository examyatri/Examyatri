<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Quiz Zone - EXAMYATRI</title>
    <!-- MathJax Configuration -->
    <script>
        MathJax = { tex: { inlineMath: [['\\(', '\\)']], displayMath: [['$$', '$$']] } };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script" async></script>
    <style>
        :root {
            --primary-bg: #121212; --secondary-bg: #1e1e1e; --component-bg: #2a2a2e; --text-color: #e0e0e0; --border-color: #44474b; --shadow-color: rgba(255, 255, 255, 0.08); --accent-color: #4dabf7; --accent-hover: #1c7ed6; --correct-color: #28a745; --incorrect-color: #dc3545; --yellow-color: #ffc107; --blue-color: #007bff;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--primary-bg); color: var(--text-color); margin: 0; padding: 20px; box-sizing: border-box; }
        .hidden { display: none !important; }

        /* --- Global & Shared Styles --- */
        .btn { color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em; font-weight: 600; text-align: center; text-decoration: none; transition: all 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:hover:not(:disabled) { box-shadow: 0 4px 8px var(--shadow-color); transform: translateY(-2px); }
        .btn:disabled { background-color: #555; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-accent { background-color: var(--accent-color); }
        .btn-accent:hover:not(:disabled) { background-color: var(--accent-hover); }
        .btn-red { background-color: var(--incorrect-color); }
        .btn-red:hover:not(:disabled) { background-color: #c82333; }
        .btn-blue { background-color: var(--blue-color); }
        .btn-blue:hover:not(:disabled) { background-color: #0056b3; }
        .btn-yellow { background-color: var(--yellow-color); color: #121212;}
        .btn-yellow:hover:not(:disabled) { background-color: #e0a800; }
        .btn-green { background-color: var(--correct-color); }
        .btn-green:hover:not(:disabled) { background-color: #218838; }

        .main-container { width: 100%; max-width: 900px; margin: 80px auto 20px; padding: 2rem; background-color: var(--secondary-bg); border-radius: 10px; box-shadow: 0 4px 15px var(--shadow-color); box-sizing: border-box; }
        #global-nav-bar { position: fixed; top: 0; left: 0; width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background-color: var(--secondary-bg); box-shadow: 0 2px 10px var(--shadow-color); z-index: 10000; box-sizing: border-box; }
        #global-home-btn, #how-to-use-btn { font-size: 1em; padding: 10px 18px; }
        
        /* FIX: Text wrapping for all content */
        #question-text, #explanation-box, .option-btn, #question-preamble p, .review-question p, .review-explanation {
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
        }

        /* --- Search View Styles --- */
        #search-view .header { text-align: center; margin-bottom: 2rem; }
        #search-view .header h1 { color: var(--accent-color); }
        #filter-container { display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: flex-end; margin-bottom: 2rem; padding: 1.5rem; background-color: var(--component-bg); border-radius: 8px; border: 1px solid var(--border-color); }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { margin-bottom: 8px; font-weight: bold; }
        .filter-group input { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 5px; box-sizing: border-box; background-color: var(--primary-bg); color: var(--text-color); font-size: 1em; }
        #quiz-feed-container { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        .quiz-card { background-color: var(--component-bg); border: 1px solid var(--border-color); border-left: 5px solid var(--accent-color); border-radius: 8px; padding: 1.5rem; display: flex; flex-direction: column; transition: transform 0.2s, box-shadow 0.2s; }
        .quiz-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px var(--shadow-color); }
        .quiz-card h3 { margin: 0 0 0.5rem; color: var(--accent-color); font-size: 1.3em; }
        .quiz-card p { margin: 0.4rem 0; font-size: 1em; opacity: 0.9; }
        .quiz-card .start-quiz-btn { width: 100%; margin-top: 1.5rem; }
        #loader, #no-quiz-found, #search-prompt { text-align: center; padding: 2rem; font-size: 1.2em; font-style: italic; }
        #no-quiz-found .btn { margin-top: 1.5rem; }
        .spinner { border: 6px solid rgba(128, 128, 128, 0.3); border-top: 6px solid var(--accent-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Player View Styles --- */
        #player-view { margin-top: 20px; } /* Adjust margin for when nav bar is hidden */
        .quiz-header { padding: 1.5rem; background-color: var(--component-bg); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .quiz-header h2 { margin: 0; color: var(--accent-color); }
        #progress, #timer { font-weight: bold; font-size: 1.2em; background-color: var(--primary-bg); padding: 5px 10px; border-radius: 5px; }
        .question-body { padding: 1.5rem; }
        #question-preamble { background-color: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid var(--yellow-color); }
        #question-preamble p { margin: 0.5rem 0; }
        #question-text { font-size: 1.3em; margin-bottom: 2rem; line-height: 1.6; }
        .options-container { display: flex; flex-direction: column; gap: 1rem; }
        .option-btn { width: 100%; padding: 15px; text-align: left; background-color: var(--component-bg); border: 2px solid var(--border-color); color: var(--text-color); border-radius: 8px; cursor: pointer; font-size: 1.1em; transition: all 0.3s; }
        .option-btn:hover:not(.disabled) { border-color: var(--accent-color); background-color: #3a3a3e; }
        .option-btn.correct { background-color: var(--correct-color) !important; color: white !important; border-color: var(--correct-color) !important; }
        .option-btn.incorrect { background-color: var(--incorrect-color) !important; color: white !important; border-color: var(--incorrect-color) !important; }
        .option-btn.disabled { cursor: not-allowed; }
        #fitb-container { gap: 1rem; }
        #fitb-input { width: 100%; padding: 15px; border: 2px solid var(--border-color); border-radius: 8px; background-color: var(--primary-bg); color: var(--text-color); font-size: 1.1em; }
        #explanation-box { background-color: #2f3e46; padding: 1rem; border-radius: 8px; margin-top: 1.5rem; font-style: italic; border-left: 4px solid var(--accent-color); }
        .navigation-footer { padding: 1.5rem; border-top: 1px solid var(--border-color); display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        #prev-btn { grid-column: 1; } #next-btn { grid-column: 2; }
        #submit-btn { grid-column: 1; } #skip-btn { grid-column: 2; }

        /* --- Result Screen Styles --- */
        #result-screen h2 { color: var(--accent-color); font-size: 2.2em; text-align: center; }
        #result-screen .score-text { font-size: 1.5em; text-align: center; margin-bottom: 2rem; }
        .score-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem; margin: 2rem 0; text-align: center; }
        .summary-item { background-color: var(--component-bg); padding: 1.5rem; border-radius: 8px; }
        .summary-item h3 { margin: 0 0 0.5rem; font-size: 1.1em; opacity: 0.8; }
        .summary-item p { margin: 0; font-size: 2em; font-weight: bold; }
        #score-correct { color: var(--correct-color); } #score-incorrect { color: var(--incorrect-color); } #score-percentage { color: var(--accent-color); }
        #review-section { margin-top: 2.5rem; }
        #review-section h3 { border-bottom: 2px solid var(--accent-color); padding-bottom: 0.5rem; margin-bottom: 1.5rem; text-align: left;}
        .review-question { background-color: var(--component-bg); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: left; border-left: 4px solid var(--border-color); }
        .review-question p { margin: 0.5rem 0; font-size: 1.1em; }
        .review-question .user-answer.correct { color: var(--correct-color); font-weight: bold; }
        .review-question .user-answer.incorrect { color: var(--incorrect-color); text-decoration: line-through; }
        .review-explanation { margin-top: 10px; opacity: 0.9; font-size: 0.95em; }
        .result-actions { text-align: center; margin-top: 2rem; display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; }

        /* --- Emoji Reaction Styles --- */
        #emoji-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 9999; pointer-events: none; }
        .emoji { position: absolute; left: 50%; top: 50%; font-size: 2rem; animation: spread 1.5s ease-out forwards; will-change: transform, opacity; }
        @keyframes spread { 0% { transform: translate(-50%, -50%) scale(0); opacity: 1; } 100% { transform: translate(var(--x), var(--y)) scale(1.5); opacity: 0; } }
    </style>
</head>
<body>
<div id="emoji-container"></div>
<div id="global-nav-bar">
    <button id="global-home-btn" class="btn btn-accent">üè† Home</button>
    <button id="how-to-use-btn" class="btn btn-red">How to Use</button>
</div>

<!-- =========== SEARCH VIEW =========== -->
<div id="search-view" class="main-container">
    <div class="header">
        <h1>Practice Zone</h1>
        <p>Search for a quiz topic to begin your practice.</p>
    </div>
    <div id="filter-container">
        <div class="filter-group">
            <label for="topic-input">Topic</label>
            <input type="text" id="topic-input" placeholder="Enter your topic name">
        </div>
        <button id="search-btn" class="btn btn-accent">Search</button>
    </div>
    <div id="loader" class="hidden">
        <div class="spinner"></div>
        <p>Searching for quizzes in the library...</p>
    </div>
    <div id="search-prompt">
        <p>Please enter a topic and click Search to find quizzes.</p>
    </div>
    <div id="quiz-feed-container"></div>
    <div id="no-quiz-found" class="hidden">
        <p>üòî No quizzes found for the topic you searched.</p>
        <a href="https://examyatri.live/#manualGenerator" class="btn btn-green">Create your own question and start practice</a>
    </div>
</div>

<!-- =========== PLAYER VIEW =========== -->
<div id="player-view" class="main-container hidden">
    <div id="quiz-screen">
        <div class="quiz-header">
            <h2 id="quiz-topic">Quiz Topic</h2>
            <div><span id="progress">Q 1/10</span> | <span id="timer">00:00</span></div>
        </div>
        <div class="question-body">
            <div id="question-preamble" class="hidden"></div>
            <p id="question-text">Loading question...</p>
            <div id="fitb-container" class="options-container hidden">
                <input type="text" id="fitb-input" placeholder="Type your answer here">
                <button id="fitb-check-btn" class="btn btn-accent">Check Answer</button>
            </div>
            <div id="options-container" class="options-container"></div>
            <div id="explanation-box" class="hidden"></div>
        </div>
        <div class="navigation-footer">
            <button id="prev-btn" class="btn btn-blue">Previous Question</button>
            <button id="next-btn" class="btn btn-blue">Next Question</button>
            <button id="submit-btn" class="btn btn-red">Submit Quiz</button>
            <button id="skip-btn" class="btn btn-yellow">Skip</button>
        </div>
    </div>
    <!-- Results Screen -->
    <div id="result-screen" class="hidden">
        <!-- Dynamic result content -->
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIGURATION ---
    const BOT_TOKEN = "8048748246:AAHTQNq9tHJE7sSFgESMhSAMn-MGd9SPWsQ";
    const CHANNEL_ID = "-1002941383294"; 
    const API_URL = `https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?limit=100&offset=-100&chat_id=${CHANNEL_ID}`;

    // --- DOM ELEMENTS ---
    const elements = {
        searchView: document.getElementById('search-view'),
        playerView: document.getElementById('player-view'),
        globalNavBar: document.getElementById('global-nav-bar'),
        loader: document.getElementById('loader'),
        searchPrompt: document.getElementById('search-prompt'),
        quizFeedContainer: document.getElementById('quiz-feed-container'),
        noQuizFound: document.getElementById('no-quiz-found'),
        topicInput: document.getElementById('topic-input'),
        searchBtn: document.getElementById('search-btn'),
        homeBtn: document.getElementById('global-home-btn'),
        howToUseBtn: document.getElementById('how-to-use-btn'),
        quizScreen: document.getElementById('quiz-screen'),
        resultScreen: document.getElementById('result-screen'),
        quizTopic: document.getElementById('quiz-topic'),
        progress: document.getElementById('progress'),
        timer: document.getElementById('timer'),
        questionPreamble: document.getElementById('question-preamble'),
        questionText: document.getElementById('question-text'),
        fitbContainer: document.getElementById('fitb-container'),
        fitbInput: document.getElementById('fitb-input'),
        fitbCheckBtn: document.getElementById('fitb-check-btn'),
        optionsContainer: document.getElementById('options-container'),
        explanationBox: document.getElementById('explanation-box'),
        prevBtn: document.getElementById('prev-btn'),
        skipBtn: document.getElementById('skip-btn'),
        nextBtn: document.getElementById('next-btn'),
        submitBtn: document.getElementById('submit-btn'),
        emojiContainer: document.getElementById('emoji-container'),
    };

    // --- STATE ---
    let currentQuizData = null;
    let userAnswers = [];
    let questionTimers = [];
    let currentQuestionIndex = 0;
    let questionTimerInterval = null;
    let secondsElapsed = 0;

    // =========== VIEW MANAGEMENT & ROUTING ===========
    function showSearchView() {
        elements.playerView.classList.add('hidden');
        elements.searchView.classList.remove('hidden');
        elements.globalNavBar.classList.remove('hidden');
        document.body.scrollTop = 0; document.documentElement.scrollTop = 0;
    }

    function showPlayerView() {
        elements.searchView.classList.add('hidden');
        elements.globalNavBar.classList.add('hidden');
        elements.playerView.classList.remove('hidden');
        document.body.scrollTop = 0; document.documentElement.scrollTop = 0;
    }

    function router() {
        const hash = window.location.hash;
        // The player view should only show if a quiz is actively loaded
        if (hash === '#player' && currentQuizData) {
            showPlayerView();
        } else {
            // Default to search view for any other case
            window.location.hash = '';
            currentQuizData = null; // Clear quiz data if navigating away
            showSearchView();
        }
    }

    // =========== SEARCH AND DATA FETCHING LOGIC ===========
    async function handleSearch() {
        const searchTerm = elements.topicInput.value.trim().toLowerCase();
        if (!searchTerm) { alert('Please enter a topic to search.'); return; }

        elements.loader.classList.remove('hidden');
        elements.quizFeedContainer.innerHTML = '';
        elements.noQuizFound.classList.add('hidden');
        elements.searchPrompt.classList.add('hidden');

        try {
            const response = await fetch(API_URL);
            if (!response.ok) throw new Error(`API error: ${response.statusText}`);
            const data = await response.json();
            
            if (data.ok && data.result) {
                const fullQuizData = data.result
                    .map(update => update.channel_post)
                    .filter(post => post && post.text && post.text.trim().startsWith('{'))
                    .map(post => {
                        try {
                            return { ...JSON.parse(post.text), date: new Date(post.date * 1000) };
                        } catch (e) { return null; }
                    })
                    .filter(q => q && q.topic && q.topic.toLowerCase().includes(searchTerm));
                
                groupAndRenderQuizzes(fullQuizData);
            } else { throw new Error(`Telegram response not OK: ${data.description}`); }
        } catch (error) {
            console.error("Failed to fetch quizzes:", error);
            elements.noQuizFound.querySelector('p').textContent = '‚ö†Ô∏è Could not load quizzes. Please check your connection or try again later.';
            elements.noQuizFound.classList.remove('hidden');
        } finally {
            elements.loader.classList.add('hidden');
        }
    }
    
    function groupAndRenderQuizzes(fullQuizData) {
        elements.quizFeedContainer.innerHTML = '';
        if (fullQuizData.length === 0) {
            elements.noQuizFound.classList.remove('hidden');
            return;
        }

        const sortedQuizzes = fullQuizData.sort((a, b) => a.date - b.date);
        const quizBlocks = [];
        if (sortedQuizzes.length > 0) {
            let currentBlock = [sortedQuizzes[0]];
            for (let i = 1; i < sortedQuizzes.length; i++) {
                const timeDifference = (sortedQuizzes[i].date.getTime() - sortedQuizzes[i-1].date.getTime()) / (1000 * 60);
                if (sortedQuizzes[i].topic.toLowerCase() === sortedQuizzes[i-1].topic.toLowerCase() && timeDifference < 15) {
                    currentBlock.push(sortedQuizzes[i]);
                } else {
                    quizBlocks.push(currentBlock);
                    currentBlock = [sortedQuizzes[i]];
                }
            }
            quizBlocks.push(currentBlock);
        }

        quizBlocks.reverse().forEach((block, index) => {
            const card = createQuizCard({
                id: `quiz-block-${index}`,
                topic: block[0].topic,
                date: block[0].date.toLocaleString(),
                questionCount: block.length,
                questions: block
            });
            elements.quizFeedContainer.appendChild(card);
        });
    }

    function createQuizCard(quizBlock) {
        const card = document.createElement('div');
        card.className = 'quiz-card';
        card.innerHTML = `
            <h3>${quizBlock.topic}</h3>
            <p><strong>Date Created:</strong> ${quizBlock.date}</p>
            <p><strong>Questions Available:</strong> ${quizBlock.questionCount}</p>
            <button class="btn btn-accent start-quiz-btn">Start Quiz</button>
        `;
        card.querySelector('.start-quiz-btn').addEventListener('click', () => launchQuiz(quizBlock));
        return card;
    }

    // =========== QUIZ PLAYER LOGIC ===========
    function launchQuiz(quizBlock) {
        currentQuizData = {
            questions: quizBlock.questions.map(q => ({
                question: q.question, options: q.options, correctAnswer: q.answer, explanation: q.explanation || 'No explanation provided.', type: q.type || 'mcq', assertion: q.assertion, reason: q.reason, statements: q.statements
            })),
            meta: { topic: quizBlock.topic, totalQuestions: quizBlock.questionCount }
        };
        userAnswers = new Array(currentQuizData.meta.totalQuestions).fill(null);
        questionTimers = new Array(currentQuizData.meta.totalQuestions).fill(0);
        currentQuestionIndex = 0;

        elements.quizScreen.classList.remove('hidden');
        elements.resultScreen.classList.add('hidden');
        
        // Change hash to trigger router and show player
        window.location.hash = 'player';
        renderQuestion(0);
    }

    function renderQuestion(index) {
        if (index < 0 || index >= currentQuizData.meta.totalQuestions) return;
        currentQuestionIndex = index;
        const q = currentQuizData.questions[index];
        const userAnswer = userAnswers[index];
        
        elements.quizTopic.textContent = currentQuizData.meta.topic;
        elements.explanationBox.classList.add('hidden');
        elements.questionPreamble.classList.add('hidden');
        elements.optionsContainer.classList.add('hidden');
        elements.fitbContainer.classList.add('hidden');

        switch (q.type) {
            case 'ar':
                elements.questionPreamble.classList.remove('hidden');
                elements.questionPreamble.innerHTML = `<p><strong>Assertion (A):</strong> ${q.assertion}</p><p><strong>Reason (R):</strong> ${q.reason}</p>`;
                elements.questionText.textContent = q.question || "Regarding the assertion and reason, which is correct?";
                renderOptions(q);
                break;
            case 'statement':
                elements.questionPreamble.classList.remove('hidden');
                elements.questionPreamble.innerHTML = q.statements.map((s, i) => `<p><strong>Statement ${i+1}:</strong> ${s}</p>`).join('');
                elements.questionText.textContent = q.question;
                renderOptions(q);
                break;
            case 'fitb':
                elements.fitbContainer.classList.remove('hidden');
                elements.questionText.textContent = q.question;
                elements.fitbInput.value = '';
                elements.fitbInput.disabled = false;
                elements.fitbCheckBtn.disabled = false;
                elements.fitbCheckBtn.onclick = () => handleFitbAnswer(q);
                break;
            default: // mcq, tf
                elements.questionText.textContent = q.question;
                renderOptions(q);
                break;
        }

        if (window.MathJax) { MathJax.typesetPromise([elements.questionPreamble, elements.questionText, elements.optionsContainer]); }
        
        if (userAnswer) { restoreAnswerState(userAnswer, q); } 
        else { startQuestionTimer(); }
        
        updateNavigation();
    }

    function renderOptions(question) {
        elements.optionsContainer.classList.remove('hidden');
        elements.optionsContainer.innerHTML = '';
        (question.options || []).forEach((optionText) => {
            const button = document.createElement('button');
            button.className = 'option-btn';
            button.textContent = optionText;
            button.onclick = () => handleAnswerSelection(button, optionText, question);
            elements.optionsContainer.appendChild(button);
        });
    }

    function restoreAnswerState(userAnswer, question) {
        stopQuestionTimer();
        elements.timer.textContent = formatTime(questionTimers[currentQuestionIndex]);
        if (question.type === 'fitb') {
            elements.fitbInput.value = userAnswer.answer;
            elements.fitbInput.disabled = true;
            elements.fitbCheckBtn.disabled = true;
        } else {
            Array.from(elements.optionsContainer.children).forEach(btn => {
                btn.classList.add('disabled'); btn.onclick = null;
                if (btn.textContent === userAnswer.answer) { btn.classList.add(userAnswer.isCorrect ? 'correct' : 'incorrect'); }
                if (btn.textContent === question.correctAnswer) { btn.classList.add('correct'); }
            });
        }
        elements.explanationBox.innerHTML = `<strong>Explanation:</strong> ${question.explanation}`;
        elements.explanationBox.classList.remove('hidden');
        if (window.MathJax) { MathJax.typesetPromise([elements.explanationBox]); }
    }

    function handleAnswerSelection(selectedButton, selectedOption, question) {
        if(userAnswers[currentQuestionIndex] !== null) return;
        stopQuestionTimer();
        questionTimers[currentQuestionIndex] = secondsElapsed;
        const isCorrect = selectedOption === question.correctAnswer;
        createReaction(isCorrect);
        userAnswers[currentQuestionIndex] = { answer: selectedOption, isCorrect: isCorrect };
        
        Array.from(elements.optionsContainer.children).forEach(btn => {
            btn.classList.add('disabled'); btn.onclick = null;
            if (btn.textContent === question.correctAnswer) { btn.classList.add('correct'); }
        });
        selectedButton.classList.add(isCorrect ? 'correct' : 'incorrect');
        elements.explanationBox.innerHTML = `<strong>Explanation:</strong> ${question.explanation}`;
        elements.explanationBox.classList.remove('hidden');
        if (window.MathJax) { MathJax.typesetPromise([elements.explanationBox]); }
    }
    
    function handleFitbAnswer(question) {
        if(userAnswers[currentQuestionIndex] !== null) return;
        const userAnswer = elements.fitbInput.value.trim();
        if (!userAnswer) { alert("Please enter an answer."); return; }

        stopQuestionTimer();
        questionTimers[currentQuestionIndex] = secondsElapsed;
        const isCorrect = userAnswer.toLowerCase() === question.correctAnswer.toLowerCase();
        createReaction(isCorrect);
        userAnswers[currentQuestionIndex] = { answer: userAnswer, isCorrect: isCorrect };
        
        elements.fitbInput.disabled = true;
        elements.fitbCheckBtn.disabled = true;

        elements.explanationBox.innerHTML = `Your Answer: <strong>${userAnswer}</strong><br>Correct Answer: <strong>${question.correctAnswer}</strong><br><br><strong>Explanation:</strong> ${question.explanation}`;
        elements.explanationBox.classList.remove('hidden');
        if (window.MathJax) { MathJax.typesetPromise([elements.explanationBox]); }
    }

    function updateNavigation() {
        elements.progress.textContent = `Q ${currentQuestionIndex + 1}/${currentQuizData.meta.totalQuestions}`;
        elements.prevBtn.disabled = currentQuestionIndex === 0;
        elements.nextBtn.disabled = currentQuestionIndex === currentQuizData.meta.totalQuestions - 1;
    }

    function startQuestionTimer() {
        secondsElapsed = questionTimers[currentQuestionIndex] || 0;
        elements.timer.textContent = formatTime(secondsElapsed);
        if (questionTimerInterval) clearInterval(questionTimerInterval);
        questionTimerInterval = setInterval(() => {
            secondsElapsed++;
            elements.timer.textContent = formatTime(secondsElapsed);
        }, 1000);
    }

    function stopQuestionTimer() { clearInterval(questionTimerInterval); }
    function formatTime(s) { return `${Math.floor(s/60)<10?'0':''}${Math.floor(s/60)}:${s%60<10?'0':''}${s%60}`; }
    function goToNextQuestion() { renderQuestion(currentQuestionIndex + 1); }
    function goToPrevQuestion() { renderQuestion(currentQuestionIndex - 1); }

    function skipQuestion() {
        if (userAnswers[currentQuestionIndex] === null) {
            userAnswers[currentQuestionIndex] = { answer: 'Skipped', isCorrect: false };
            questionTimers[currentQuestionIndex] = secondsElapsed;
            stopQuestionTimer();
        }
        if (currentQuestionIndex < currentQuizData.meta.totalQuestions - 1) { goToNextQuestion(); }
        else { submitQuiz(); }
    }
    
    function submitQuiz() {
        stopQuestionTimer();
        elements.quizScreen.classList.add('hidden');
        calculateAndRenderResults();
        elements.resultScreen.classList.remove('hidden');
    }

    function calculateAndRenderResults() {
        let correct = 0, incorrect = 0;
        userAnswers.forEach(ans => { if(ans && ans.isCorrect) correct++; else incorrect++; });
        const totalTime = questionTimers.reduce((a, b) => a + b, 0);
        const percentage = currentQuizData.meta.totalQuestions > 0 ? ((correct / currentQuizData.meta.totalQuestions) * 100).toFixed(2) : 0;
        
        const reviewHTML = currentQuizData.questions.map((q, i) => {
            const userAnswer = userAnswers[i];
            const userAnswerText = userAnswer ? userAnswer.answer : 'Not Answered';
            const isCorrect = userAnswer ? userAnswer.isCorrect : false;
            return `<div class="review-question">
                        <p><strong>Q${i+1}: ${q.question}</strong></p>
                        <p>Time Taken: ${formatTime(questionTimers[i])}</p>
                        <p>Your Answer: <span class="user-answer ${userAnswer ? (isCorrect ? 'correct' : 'incorrect') : ''}">${userAnswerText}</span></p>
                        ${!isCorrect && userAnswerText !== 'Skipped' && userAnswerText !== 'Not Answered' ? `<p>Correct Answer: <span class="correct">${q.correctAnswer}</span></p>` : ''}
                        <div class="review-explanation"><strong>Explanation:</strong> ${q.explanation}</div>
                    </div>`;
        }).join('');

        elements.resultScreen.innerHTML = `
            <h2>Quiz Complete!</h2>
            <p class="score-text">Here is your performance summary.</p>
            <div class="score-summary">
                <div class="summary-item"><h3>Total Questions</h3><p>${currentQuizData.meta.totalQuestions}</p></div>
                <div class="summary-item"><h3>Correct</h3><p id="score-correct">${correct}</p></div>
                <div class="summary-item"><h3>Incorrect / Skipped</h3><p id="score-incorrect">${incorrect}</p></div>
                <div class="summary-item"><h3>Total Time</h3><p>${formatTime(totalTime)}</p></div>
                <div class="summary-item"><h3>Performance</h3><p id="score-percentage">${percentage}%</p></div>
            </div>
            <div class="result-actions">
                <button class="btn btn-blue" id="another-quiz-btn">Search for Another Quiz</button>
                <button class="btn btn-green" id="new-practice-btn">Start New Practice (External)</button>
            </div>
            <div id="review-section"><h3>Review Your Answers</h3>${reviewHTML}</div>
        `;
        // Attach event listeners for the new buttons on the result screen
        document.getElementById('another-quiz-btn').addEventListener('click', () => { window.location.hash = ''; });
        document.getElementById('new-practice-btn').addEventListener('click', handleResetAndRedirect);
        if (window.MathJax) { MathJax.typesetPromise([elements.resultScreen]); }
    }
    
    function handleResetAndRedirect() { localStorage.clear(); window.location.href = 'https://examyatri.live'; }

    function createReaction(isCorrect) {
        const emojis = isCorrect ? ['üòä', 'üëç', 'üéâ', '‚ú®', 'üíØ'] : ['üòü', 'ü§î', 'üò¢', 'Try Again'];
        for (let i = 0; i < 20; i++) {
            const emoji = document.createElement('div');
            emoji.className = 'emoji';
            emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            emoji.style.setProperty('--x', `${(Math.random() - 0.5) * 2 * window.innerWidth}px`);
            emoji.style.setProperty('--y', `${(Math.random() - 0.5) * 2 * window.innerHeight}px`);
            elements.emojiContainer.appendChild(emoji);
            setTimeout(() => emoji.remove(), 1500);
        }
    }

    function setupEventListeners() {
        elements.searchBtn.addEventListener('click', handleSearch);
        elements.topicInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleSearch(); });
        elements.homeBtn.addEventListener('click', handleResetAndRedirect);
        elements.howToUseBtn.addEventListener('click', () => { window.open('https://m.youtube.com/@ExamYatri_mock_test/videos', '_blank'); });
        elements.nextBtn.addEventListener('click', goToNextQuestion);
        elements.prevBtn.addEventListener('click', goToPrevQuestion);
        elements.skipBtn.addEventListener('click', skipQuestion);
        elements.submitBtn.addEventListener('click', () => { if (confirm('Are you sure you want to submit?')) submitQuiz(); });
        
        // Listen to hash changes to route between views
        window.addEventListener('hashchange', router);
    }

    // --- START THE APP ---
    setupEventListeners();
    router(); // Initial route check on page load
});
</script>
</body>
</html>