<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExamYatri Typing - Real Exam Simulator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #FFFFFF;
            --primary-color: #4CAF50; /* Green for accents */
            --error-color: #F44336;
            --caret-color: #2196F3;
            --disabled-color: #555555;
            --border-color: #333333;
            --font-family: 'Roboto Mono', monospace;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            text-align: center;
        }

        .container {
            width: 90%;
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem 0;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        header {
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: 500;
        }

        .language-switch {
            display: flex;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .lang-btn {
            background: transparent;
            color: var(--text-color);
            border: none;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-family: var(--font-family);
            transition: background-color 0.2s;
        }

        .lang-btn.active {
            background-color: var(--primary-color);
        }

        /* Views */
        .view {
            display: none;
            flex-direction: column;
            flex-grow: 1;
        }
        .view.active {
            display: flex;
        }

        /* Setup View */
        #setup-view {
            justify-content: center;
            gap: 1.5rem;
        }

        .setup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .setup-card {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .setup-card label {
            text-align: left;
            font-size: 0.9rem;
            color: #ccc;
        }
        
        .custom-select {
            width: 100%;
            padding: 0.75rem;
            background-color: #111;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: var(--font-family);
            font-size: 1rem;
            cursor: pointer;
        }

        .minus-marking-controls {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-start;
        }
        .minus-marking-controls > div {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .minus-marking-controls input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .minus-marking-controls input[type="number"] {
            width: 60px;
            padding: 0.5rem;
            background-color: #111;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: var(--font-family);
        }

        #start-practice-btn {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            padding: 1rem;
            background-color: var(--primary-color);
            color: #000;
            font-weight: 700;
            border: none;
            border-radius: 6px;
            font-size: 1.2rem;
            font-family: var(--font-family);
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        #start-practice-btn:disabled {
            background-color: var(--disabled-color);
            cursor: not-allowed;
        }

        #loading-status {
            min-height: 1.2em;
            margin-bottom: 1rem;
        }
        
        /* Practice View */
        #practice-view {
            gap: 1rem;
        }

        .stats-dashboard {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
        }

        .stat-item {
            display: flex;
            gap: 0.5rem;
            align-items: baseline;
        }
        .stat-item .label {
            font-size: 0.8rem;
            color: #aaa;
        }
        .stat-item .value {
            font-size: 1.2rem;
            font-weight: 700;
        }

        #text-display-wrapper {
            border: 1px solid var(--border-color);
            padding: 1rem;
            border-radius: 6px;
            font-size: 1.5rem;
            line-height: 1.8;
            text-align: left;
            overflow-y: auto;
            scroll-behavior: smooth;
            height: 250px;
            position: relative;
            flex-shrink: 0;
            user-select: none;
            cursor: text;
        }
        
        #text-display {
            color: #888;
            position: relative;
            overflow-wrap: break-word; /* Prevents text from overflowing horizontally */
        }
        #text-display.hindi {
            font-family: 'Noto Sans Devanagari', serif;
        }

        .char {
            display: inline;
        }
        .char.correct { color: var(--primary-color); }
        .char.incorrect { color: var(--error-color); text-decoration: underline; }
        
        .caret {
            position: absolute;
            width: 2px;
            background-color: var(--caret-color);
            animation: blink 1s infinite;
            transition: left 0.1s linear, top 0.1s linear;
            border-radius: 1px;
            height: calc(1.5rem * 1.2);
            margin-top: calc(1.5rem * 0.2);
        }
        @keyframes blink { 50% { opacity: 0; } }

        #hidden-input {
            position: fixed;
            left: 0;
            top: 0;
            width: 1px;
            height: 1px;
            opacity: 0;
            margin: -1px;
            padding: 0;
            border: 0;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
        }

        #free-hand-area {
            width: 100%;
            height: 100%;
            background: #111;
            color: var(--text-color);
            border: none;
            font-size: 1.2rem;
            font-family: inherit;
            resize: none;
            padding: 1rem;
        }

        #submit-test-btn {
            padding: 0.75rem 2rem;
            background-color: var(--error-color);
            color: var(--text-color);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 0 auto;
        }
        
        /* Results Modal */
        #results-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: none; /* Toggled by JS */
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #results-modal.active {
            display: flex;
        }

        .results-content {
            background-color: #1a1a1a;
            padding: 2rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        
        .result-item h3 {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 0.25rem;
            font-weight: 400;
            text-transform: uppercase;
        }
        .result-item p {
            font-size: 1.8rem;
            font-weight: 700;
        }
        .result-item.final-wpm p {
            color: var(--primary-color);
            font-size: 2.2rem;
        }
        .result-item.final-wpm {
            grid-column: 1 / -1;
            text-align: center;
            background: #222;
            padding: 1rem;
            border-radius: 6px;
        }

        #result-summary {
            font-size: 1rem;
            color: #ddd;
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
            margin-top: 0.5rem;
        }

        .results-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .results-actions button {
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: #222;
            color: var(--text-color);
            font-family: var(--font-family);
            cursor: pointer;
        }
        
        @media (max-width: 600px) {
            header h1 { font-size: 1.2rem; }
            .setup-grid { grid-template-columns: 1fr; }
            #text-display-wrapper { font-size: 1.2rem; height: 200px; }
            .stat-item .value { font-size: 1rem; }
            .result-item p { font-size: 1.5rem; }
            .result-item.final-wpm p { font-size: 1.8rem; }
            
            #results-modal {
                align-items: flex-start;
                padding-top: 5vh;
            }
            .results-content {
                padding: 1.5rem;
                height: 95vh;
                overflow-y: auto;
                padding-bottom: 200px; /* Space for stacked buttons */
            }
            .results-actions {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: #222;
                padding: 1rem;
                border-top: 1px solid var(--border-color);
                flex-direction: column;
                gap: 0.75rem;
                z-index: 1001;
            }
            .results-actions button {
                width: 100%;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/index.css">
</head>
<body>
    <header>
        <div class="container header-content">
            <h1>ExamYatri Typing</h1>
            <div class="language-switch">
                <button id="lang-english-btn" class="lang-btn active" data-lang="en">English</button>
                <button id="lang-hindi-btn" class="lang-btn" data-lang="hi">हिंदी</button>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Setup View -->
        <section id="setup-view" class="view active">
            <div class="setup-grid">
                <div class="setup-card">
                    <label for="level-select">1. Difficulty Level</label>
                    <select id="level-select" class="custom-select"></select>
                </div>
                <div class="setup-card">
                    <label for="method-select">2. Practice Method</label>
                    <select id="method-select" class="custom-select"></select>
                </div>
                <div class="setup-card">
                    <label for="duration-select">3. Duration</label>
                    <select id="duration-select" class="custom-select">
                        <option value="1">1 Minute</option>
                        <option value="2">2 Minutes</option>
                        <option value="5">5 Minutes</option>
                        <option value="10">10 Minutes</option>
                        <option value="15">15 Minutes</option>
                        <option value="30">30 Minutes</option>
                    </select>
                </div>
                <div class="setup-card minus-marking-controls">
                    <label>4. Minus Marking</label>
                    <div>
                        <input type="checkbox" id="minus-marking-enabled">
                        <label for="minus-marking-enabled">Enable</label>
                    </div>
                    <div>
                        <input type="number" id="minus-marking-value" min="0" max="5" value="1" disabled>
                        <label for="minus-marking-value">WPM per error</label>
                    </div>
                </div>
            </div>
            <p id="loading-status"></p>
            <button id="start-practice-btn">Start Practice</button>
        </section>

        <!-- Practice View -->
        <section id="practice-view" class="view">
            <div class="stats-dashboard">
                <div class="stat-item"><span class="label">Time:</span><span id="stat-time" class="value">00:00</span></div>
                <div class="stat-item"><span class="label">Gross WPM:</span><span id="stat-gross-wpm" class="value">0</span></div>
                <div class="stat-item"><span class="label">Net WPM:</span><span id="stat-net-wpm" class="value">0</span></div>
                <div class="stat-item"><span class="label">Errors:</span><span id="stat-errors" class="value">0</span></div>
                <div class="stat-item"><span class="label">Accuracy:</span><span id="stat-accuracy" class="value">100%</span></div>
            </div>
            <div id="text-display-wrapper">
                <div id="text-display"></div>
                <div id="caret" class="caret" style="display: none;"></div>
                <textarea id="free-hand-area" style="display: none;" placeholder="Start typing..."></textarea>
            </div>
            <button id="submit-test-btn">Submit Now</button>
        </section>
    </main>

    <!-- Results Modal -->
    <div id="results-modal">
        <div class="results-content">
            <h2>Result Summary</h2>
            <div class="results-grid">
                <div class="result-item"><h3>Gross Speed</h3><p><span id="result-gross-wpm">0</span> WPM</p></div>
                <div class="result-item"><h3>Net Speed</h3><p><span id="result-net-wpm">0</span> WPM</p></div>
                <div class="result-item"><h3>Accuracy</h3><p><span id="result-accuracy">0</span>%</p></div>
                <div class="result-item"><h3>Errors</h3><p><span id="result-errors">0</span></p></div>
                <div class="result-item"><h3>Total Words</h3><p><span id="result-total-words">0</span></p></div>
                <div class="result-item"><h3>Correct Words</h3><p><span id="result-correct-words">0</span></p></div>
                <div class="result-item"><h3>Time Taken</h3><p id="result-time-taken">00:00</p></div>
                <div class="result-item"><h3>Keystrokes</h3><p><span id="result-keystrokes">0</span></p></div>
                <div class="result-item final-wpm"><h3>Final WPM</h3><p><span id="result-final-wpm">0</span> WPM</p></div>
            </div>
            <p id="minus-marking-summary" style="font-size: 0.9rem; text-align: left;"></p>
            <p id="result-summary" style="text-align: left;"></p>
            <div class="results-actions">
                <button id="retry-test-btn">Retry Same Test</button>
                <button id="new-test-btn">Next Practice Text</button>
                <button id="back-to-home-btn">Back to Home</button>
            </div>
        </div>
    </div>

    <textarea id="hidden-input" autofocus autocapitalize="none" autocorrect="off"></textarea>
    
    <footer style="margin-top: auto; padding: 1rem 0; font-size: 0.9rem; color: #888; border-top: 1px solid var(--border-color);">
        Visitor Count: <span id="visitCount">0</span>
    </footer>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dom = {
                setupView: document.getElementById('setup-view'),
                practiceView: document.getElementById('practice-view'),
                levelSelect: document.getElementById('level-select'),
                methodSelect: document.getElementById('method-select'),
                durationSelect: document.getElementById('duration-select'),
                minusMarkingEnabled: document.getElementById('minus-marking-enabled'),
                minusMarkingValue: document.getElementById('minus-marking-value'),
                loadingStatus: document.getElementById('loading-status'),
                startBtn: document.getElementById('start-practice-btn'),
                
                stats: {
                    time: document.getElementById('stat-time'),
                    grossWpm: document.getElementById('stat-gross-wpm'),
                    netWpm: document.getElementById('stat-net-wpm'),
                    errors: document.getElementById('stat-errors'),
                    accuracy: document.getElementById('stat-accuracy'),
                },
                textDisplayWrapper: document.getElementById('text-display-wrapper'),
                textDisplay: document.getElementById('text-display'),
                caret: document.getElementById('caret'),
                hiddenInput: document.getElementById('hidden-input'),
                freeHandArea: document.getElementById('free-hand-area'),
                submitBtn: document.getElementById('submit-test-btn'),

                resultsModal: document.getElementById('results-modal'),
                results: {
                    grossWpm: document.getElementById('result-gross-wpm'),
                    netWpm: document.getElementById('result-net-wpm'),
                    accuracy: document.getElementById('result-accuracy'),
                    errors: document.getElementById('result-errors'),
                    totalWords: document.getElementById('result-total-words'),
                    correctWords: document.getElementById('result-correct-words'),
                    timeTaken: document.getElementById('result-time-taken'),
                    keystrokes: document.getElementById('result-keystrokes'),
                    finalWpm: document.getElementById('result-final-wpm'),
                    minusMarkingSummary: document.getElementById('minus-marking-summary'),
                    summary: document.getElementById('result-summary'),
                },
                resultActions: {
                    retry: document.getElementById('retry-test-btn'),
                    newTest: document.getElementById('new-test-btn'),
                    backToHome: document.getElementById('back-to-home-btn'),
                },
                langEnglishBtn: document.getElementById('lang-english-btn'),
                langHindiBtn: document.getElementById('lang-hindi-btn'),
            };

            const GRAPHEME_SPLITTER = new Intl.Segmenter();
            const splitTextToChars = (text) => [...GRAPHEME_SPLITTER.segment(text)].map(s => s.segment);
            
            const KEYS = {
                en: {
                    home: "asdfjkl;",
                    top: "qwertyuiop",
                    bottom: "zxcvbnm,.",
                    numbers: "1234567890",
                    symbols: "!@#$%^&*()_+-=[]{}|;':\",./<>?"
                },
                hi: {
                    home: "ोेि्कसहमतरल",
                    top: "ौैाीपृछठटझफ",
                    bottom: "़ऋदजगबअड़ध",
                    numbers: "१२३४५६७८९०",
                    symbols: "।(),'\"-:",
                }
            };
             const OFFLINE_FALLBACK = {
                en: [
                    "The quick brown fox jumps over the lazy dog.",
                    "Technology has changed the way we live and work.",
                    "The internet connects people from all over the world.",
                    "Reading books is a great way to expand your knowledge.",
                    "Success is not final, failure is not fatal: it is the courage to continue that counts.",
                    "The only way to do great work is to love what you do.",
                    "Believe you can and you're halfway there.",
                    "The future belongs to those who believe in the beauty of their dreams.",
                    "Strive not to be a success, but rather to be of value.",
                    "In the middle of every difficulty lies opportunity.",
                ],
                hi: [
                    "सूरज की पहली किरण आशा लेकर आती है।",
                    "सच्चा मित्र वही है जो कठिन समय में साथ दे।",
                    "परिश्रम ही सफलता की कुंजी है।",
                    "ज्ञान सबसे बड़ी शक्ति है।",
                    "एक हजार मील की यात्रा एक कदम से शुरू होती है।",
                    "समय किसी का इंतजार नहीं करता।",
                    "स्वस्थ शरीर में ही स्वस्थ मन का वास होता है।",
                    "किताबें हमारी सबसे अच्छी दोस्त होती हैं।",
                    "जीवन एक अनमोल उपहार है, इसे व्यर्थ न करें।",
                    "धैर्य और लगन से हर मुश्किल आसान हो जाती है।",
                ]
            };
             const STATIC_TEXTS = {
                en: {
                    application: "To,\nThe Hiring Manager,\n[Company Name],\n[Company Address]\n\nSubject: Application for the post of [Job Title]\n\nDear Sir/Madam,\nI am writing to express my keen interest in the [Job Title] position advertised on [Platform]. With my skills and experience, I am confident that I would be a valuable asset to your team. My resume is attached for your review. I look forward to hearing from you soon.\n\nSincerely,\n[Your Name]",
                    legal: "Notwithstanding any other provision of this agreement, the parties agree that neither party shall be liable to the other for any indirect, special, or consequential damages. The validity, interpretation, and performance of this agreement shall be governed by and construed in accordance with the laws of the specified jurisdiction, without regard to its conflict of law principles.",
                    letter: "Dear [Recipient Name],\nI hope this letter finds you well. I am writing to you today to discuss the upcoming project deadline. We need to ensure all deliverables are submitted by the end of the week. Please coordinate with your respective teams to finalize the reports. Your prompt attention to this matter is highly appreciated.\n\nBest regards,\n[Your Name]",
                    punctuation: "Wait, what? He asked, \"Are you sure?\" I'm not sure... let's check the guide (page 5). The options are: red, green, or blue; however, I prefer the first one. It's a 'win-win' situation, isn't it?",
                    capitalization: "The United Nations (UN) headquarters is in New York City. Dr. Smith and his colleague, Professor Jones, attended a conference in Paris, France, last Monday. They discussed the impact of climate change on the Arctic Circle.",
                    symbols: "The formula E=mc^2 is famous. Contact me at user@example.com or call +1 (555) 123-4567. The stock price rose by 15% to $1,234.56. We need to check the file at C:\\Users\\Default\\.",
                },
                hi: {
                    application: "सेवा में,\nश्रीमान प्रबंधक,\n[कंपनी का नाम],\n[कंपनी का पता]\n\nविषय: [पद का नाम] पद हेतु आवेदन पत्र\n\nमहोदय,\nसविनय निवेदन है कि मुझे [प्लेटफॉर्म] पर विज्ञापित [पद का नाम] पद के लिए आपकी कंपनी में रुचि है। मेरे कौशल और अनुभव के साथ, मुझे विश्वास है कि मैं आपकी टीम के लिए एक मूल्यवान संपत्ति होऊंगा। मेरा बायोडाटा आपके अवलोकन के लिए संलग्न है। मुझे आपसे शीघ्र उत्तर की आशा है।\n\nभवदीय,\n[आपका नाम]",
                    legal: "इस समझौते के किसी अन्य प्रावधान के होते हुए भी, पक्ष इस बात से सहमत हैं कि कोई भी पक्ष दूसरे पक्ष के प्रति किसी भी अप्रत्यक्ष, विशेष, या परिणामी क्षति के लिए उत्तरदायी नहीं होगा। इस समझौते की वैधता, व्याख्या, और प्रदर्शन निर्दिष्ट अधिकार क्षेत्र के कानूनों के अनुसार शासित और समझे जाएंगे, इसके कानून सिद्धांतों के टकराव की परवाह किए बिना।",
                    letter: "प्रिय [प्राप्तकर्ता का नाम],\nआशा है कि आप स्वस्थ होंगे। मैं आज आपसे आगामी परियोजना की समय सीमा पर चर्चा करने के लिए लिख रहा हूं। हमें यह सुनिश्चित करने की आवश्यकता है कि सभी डिलिवरेबल्स सप्ताह के अंत तक जमा कर दिए जाएं। कृपया रिपोर्ट को अंतिम रूप देने के लिए अपनी संबंधित टीमों के साथ समन्वय करें। इस मामले पर आपके त्वरित ध्यान की अत्यधिक सराहना की जाती है।\n\nसाभार,\n[आपका नाम]",
                    punctuation: "रुको, क्या? उसने पूछा, \"क्या तुम निश्चित हो?\" मुझे यकीन नहीं है... चलो गाइड (पेज 5) देखते हैं। विकल्प हैं: लाल, हरा, या नीला; हालाँकि, मुझे पहला वाला पसंद है। यह एक 'जीत-जीत' की स्थिति है, है ना?",
                    capitalization: "संयुक्त राष्ट्र (UN) का मुख्यालय न्यूयॉर्क शहर में है। डॉ. शर्मा और उनके सहयोगी, प्रोफेसर वर्मा, पिछले सोमवार को पेरिस, फ्रांस में एक सम्मेलन में शामिल हुए। उन्होंने आर्कटिक सर्कल पर जलवायु परिवर्तन के प्रभाव पर चर्चा की।",
                }
            };

            const getRandomFallback = (lang) => OFFLINE_FALLBACK[lang][Math.floor(Math.random() * OFFLINE_FALLBACK[lang].length)];
            
            const generateRandomText = (chars, wordLength, numWords) => {
                let text = '';
                for (let i = 0; i < numWords; i++) {
                    let word = '';
                    const currentWordLength = Math.floor(Math.random() * (wordLength - 2)) + 2;
                    for (let j = 0; j < currentWordLength; j++) {
                        word += chars[Math.floor(Math.random() * chars.length)];
                    }
                    text += word + ' ';
                }
                return text.trim();
            };

            const getTypingText = async (language = 'en') => {
                 const sources = [
                    async () => { 
                        const url = language === 'hi'
                            ? 'https://api.rss2json.com/v1/api.json?rss_url=https://www.jagran.com/education/rssfeed.xml'
                            : 'https://api.rss2json.com/v1/api.json?rss_url=https://www.thehindu.com/education/feeder/default.rss';
                        const res = await fetch(url, { cache: "no-cache" });
                        if (!res.ok) throw new Error("RSS Network error");
                        const data = await res.json();
                        if (data.status !== 'ok' || !data.items || data.items.length === 0) throw new Error("News source failed");
                        return data.items[Math.floor(Math.random() * data.items.length)].description.replace(/<[^>]+>/g, '').trim();
                    },
                    async () => {
                        const url = language === 'hi'
                            ? 'https://hi.wikipedia.org/api/rest_v1/page/random/summary'
                            : 'https://en.wikipedia.org/api/rest_v1/page/random/summary';
                        const res = await fetch(url);
                        if (!res.ok) throw new Error("Wikipedia Network error");
                        const data = await res.json();
                        if (!data.extract) throw new Error("Wikipedia extract failed");
                        return data.extract;
                    }
                ];

                for (const source of sources) {
                    try {
                        const text = await Promise.race([
                            source(),
                            new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 4000))
                        ]);
                        if (text && text.length > 50) return text;
                    } catch (err) {
                        console.warn("A text source failed or timed out, trying next...");
                    }
                }
                
                console.warn("All online sources failed. Using offline fallback.");
                return getRandomFallback(language);
            };

            const appendMoreText = async () => {
                if (appState.session.isFetchingMoreText || !appState.isPracticeActive) return;
                
                appState.session.isFetchingMoreText = true;
                dom.loadingStatus.textContent = 'Generating more text...';
                try {
                    const newText = await appState.config.textGenerator();
                    if (newText && appState.isPracticeActive) {
                        const separator = ' ';
                        
                        appState.config.sourceText += separator + newText;
                        const newChars = splitTextToChars(separator + newText);
                        appState.config.sourceChars.push(...newChars);
                        appState.config.sourceWords = appState.config.sourceText.split(/\s+/).filter(Boolean);

                        const newHtml = newChars.map(char => `<span class="char">${char}</span>`).join('');
                        dom.textDisplay.insertAdjacentHTML('beforeend', newHtml);
                    }
                } catch (error) {
                    console.error("Failed to generate/fetch more text:", error);
                } finally {
                    dom.loadingStatus.textContent = '';
                    appState.session.isFetchingMoreText = false;
                }
            };
            
            const HINDI_BEGINNER_PRACTICE = {
                "1. Home Row": "कर हम तरस; महक कसक; कमल महल; सिर किस; केसर कोमल; हमेशा समर;",
                "2. Top Row": "पठ छठ; पीठ मीठी; पाठ पीठ; कैसा बैठा; फौजी चौकी; मीठा पाठ;",
                "3. Bottom Row": "जग मग गज; अब जब; धन बढ़; गड़बड़ अजय; अगर डगर; भजन गगन;",
                "4. Home + Top": "टिकट मिठाई; कठोर कठिन; ठीक ठाक; पहला पहर; महफिल शामिल;",
                "5. Home + Bottom": "जगह महल; गरम खबर; सहज समझ; बाहर भजन; मदद मकसद;",
                "6. Top + Bottom": "अटक भटक; पढ़ना चढ़ना; गठन बचपन; अजय अचल;",
                "7. Word Formation": "किसान किताब; बारिश शामिल; टोकरी कटोरी; पहचान मेहमान;",
                "9. Random Row Mix": "भारत महान; बचपन की याद; समय का महत्व; सड़क पर गजराज; कलम दवात;"
            };

            const practiceLevels = {
                "Beginner": {
                    "1. Home Row": () => appState.lang === 'hi' ? Promise.resolve(HINDI_BEGINNER_PRACTICE["1. Home Row"]) : generateRandomText(KEYS.en.home, 5, 20),
                    "2. Top Row": () => appState.lang === 'hi' ? Promise.resolve(HINDI_BEGINNER_PRACTICE["2. Top Row"]) : generateRandomText(KEYS.en.top, 5, 20),
                    "3. Bottom Row": () => appState.lang === 'hi' ? Promise.resolve(HINDI_BEGINNER_PRACTICE["3. Bottom Row"]) : generateRandomText(KEYS.en.bottom, 5, 20),
                    "4. Home + Top": () => appState.lang === 'hi' ? Promise.resolve(HINDI_BEGINNER_PRACTICE["4. Home + Top"]) : generateRandomText(KEYS.en.home + KEYS.en.top, 6, 25),
                    "5. Home + Bottom": () => appState.lang === 'hi' ? Promise.resolve(HINDI_BEGINNER_PRACTICE["5. Home + Bottom"]) : generateRandomText(KEYS.en.home + KEYS.en.bottom, 6, 25),
                    "6. Top + Bottom": () => appState.lang === 'hi' ? Promise.resolve(HINDI_BEGINNER_PRACTICE["6. Top + Bottom"]) : generateRandomText(KEYS.en.top + KEYS.en.bottom, 6, 25),
                    "7. Word Formation": () => appState.lang === 'hi' ? Promise.resolve(HINDI_BEGINNER_PRACTICE["7. Word Formation"]) : generateRandomText(KEYS.en.home + KEYS.en.top, 4, 30),
                    "8. Small Sentences": () => Promise.resolve(getRandomFallback(appState.lang)),
                    "9. Random Row Mix": () => appState.lang === 'hi' ? Promise.resolve(HINDI_BEGINNER_PRACTICE["9. Random Row Mix"]) : generateRandomText(KEYS.en.home + KEYS.en.top + KEYS.en.bottom, 6, 25),
                    "10. Numeric Practice": () => generateRandomText(KEYS.en.numbers + ' ', 5, 20),
                },
                "Skill Building": {
                    "1. Random Words": () => getTypingText(appState.lang),
                    "2. Sentence Practice": () => getTypingText(appState.lang),
                    "3. Paragraph Practice": () => getTypingText(appState.lang),
                    "4. Punctuation Practice": () => Promise.resolve(STATIC_TEXTS[appState.lang].punctuation),
                    "5. Capitalization": () => Promise.resolve(STATIC_TEXTS[appState.lang].capitalization),
                    "6. Numeric Row Practice": () => generateRandomText(KEYS.en.numbers + ' 123 456 7890 ', 7, 20),
                    "7. Symbol Typing": () => Promise.resolve(STATIC_TEXTS.en.symbols),
                    "8. Dictation Mode": () => getTypingText(appState.lang),
                    "9. Mixed Practice": () => getTypingText(appState.lang),
                    "10. Repetition Drill": async () => { const s = await getTypingText(appState.lang); return (s + " ").repeat(2).trim(); },
                },
                "Advanced": {
                    "1. Editorial Articles": () => getTypingText(appState.lang),
                    "2. Technical Text": () => getTypingText(appState.lang),
                    "3. Application Format": () => Promise.resolve(STATIC_TEXTS[appState.lang].application),
                    "4. Government Notice": () => getTypingText(appState.lang),
                    "5. Table Data Typing": () => Promise.resolve("Name|Age|City|Country\nJohn|30|New York|USA\nAnna|25|Paris|France\nMike|42|Tokyo|Japan"),
                    "6. Speech Text": () => getTypingText(appState.lang),
                    "7. Legal Paragraphs": () => Promise.resolve(STATIC_TEXTS[appState.lang].legal),
                    "8. Complex Sentences": () => getTypingText(appState.lang),
                    "9. News Report Practice": () => getTypingText(appState.lang),
                    "10. Error Correction": () => getTypingText(appState.lang),
                },
                "Expert": {
                    "1. Long Paragraph": () => getTypingText(appState.lang),
                    "2. Letter Writing": () => Promise.resolve(STATIC_TEXTS[appState.lang].letter),
                    "3. Report Typing": () => getTypingText(appState.lang),
                    "4. Press Release": () => getTypingText(appState.lang),
                    "5. Data Table Typing": () => Promise.resolve("ID,Product,Price,Stock\n101,Laptop,1200,50\n102,Mouse,25,200\n103,Keyboard,75,150\n104,Monitor,300,80"),
                    "6. Essay Typing": () => getTypingText(appState.lang),
                    "7. Mixed Format": () => Promise.resolve(`${STATIC_TEXTS[appState.lang].letter} \n\n ${STATIC_TEXTS[appState.lang].legal}`),
                    "8. Official Document": () => getTypingText(appState.lang),
                    "9. English-Hindi Mix": () => Promise.resolve("This is an English sentence. यह एक हिंदी वाक्य है। We need to type both. हमें दोनों टाइप करने होंगे।"),
                    "10. Multiple Passages": () => getTypingText(appState.lang),
                },
                "Exam Type": {
                    "1. SSC Exam Mode": () => getTypingText(appState.lang),
                    "2. CPCT Mode": () => getTypingText(appState.lang),
                    "3. RSMSSB Mode": () => getTypingText(appState.lang),
                    "4. UP Police Clerk": () => getTypingText(appState.lang),
                    "5. Bank Clerk Mode": () => getTypingText(appState.lang),
                    "6. Railway Typing": () => getTypingText(appState.lang),
                    "7. High Court Clerk": () => getTypingText(appState.lang),
                    "8. Insurance Typing": () => getTypingText(appState.lang),
                    "9. MP DEO Typing": () => getTypingText(appState.lang),
                    "10. Custom Exam Sim": () => getTypingText(appState.lang),
                },
                "Free Hand": { "Free Practice": () => Promise.resolve(""), }
            };
            
            let appState = {};

            const resetState = () => {
                appState = {
                    lang: 'en', timerId: null, isPracticeActive: false,
                    config: { level: '', method: '', duration: 0, minusMarking: { enabled: false, value: 1 }, sourceText: '', sourceWords: [], sourceChars: [], isDynamicText: false, textGenerator: null },
                    session: { startTime: 0, timeLeft: 0, typedText: '', charIndex: 0, correctChars: 0, errorCount: 0, keystrokes: 0, isFetchingMoreText: false },
                };
            };
            
            const populateLevels = () => { dom.levelSelect.innerHTML = Object.keys(practiceLevels).map(level => `<option value="${level}">${level}</option>`).join(''); };
            const populateMethods = () => {
                const selectedLevel = dom.levelSelect.value;
                const methods = Object.keys(practiceLevels[selectedLevel]);
                dom.methodSelect.innerHTML = methods.map(method => `<option value="${method}">${method}</option>`).join('');
                handleMethodChange();
            };
            const handleMethodChange = () => {
                 const isFreeHand = dom.levelSelect.value === 'Free Hand';
                 dom.durationSelect.disabled = isFreeHand;
                 dom.minusMarkingEnabled.disabled = isFreeHand;
                 if (isFreeHand && dom.minusMarkingEnabled.checked) { dom.minusMarkingEnabled.click(); }
            };

            const switchView = (view) => {
                dom.setupView.classList.toggle('active', view === 'setup');
                dom.practiceView.classList.toggle('active', view === 'practice');
            };

            const startPractice = async () => {
                dom.startBtn.disabled = true;
                dom.loadingStatus.textContent = 'Fetching text...';
                try {
                    const level = dom.levelSelect.value;
                    const method = dom.methodSelect.value;
                    const textGenerator = practiceLevels[level][method];

                    appState.config = {
                        level: level,
                        method: method,
                        duration: parseInt(dom.durationSelect.value, 10) * 60,
                        minusMarking: { enabled: dom.minusMarkingEnabled.checked, value: parseInt(dom.minusMarkingValue.value, 10) },
                        isDynamicText: level !== 'Free Hand',
                        textGenerator: textGenerator,
                        sourceText: await textGenerator(),
                    };
                    if (!appState.config.sourceText && appState.config.level !== 'Free Hand') {
                        appState.config.sourceText = getRandomFallback(appState.lang);
                    }
                    if (appState.config.level === 'Free Hand') {
                        dom.textDisplay.style.display = 'none';
                        dom.caret.style.display = 'none';
                        dom.freeHandArea.style.display = 'block';
                        dom.freeHandArea.value = '';
                    } else {
                        dom.textDisplay.style.display = 'block';
                        dom.freeHandArea.style.display = 'none';
                        appState.config.sourceWords = appState.config.sourceText.split(/\s+/).filter(Boolean);
                        appState.config.sourceChars = splitTextToChars(appState.config.sourceText);
                        dom.textDisplay.innerHTML = appState.config.sourceChars.map(char => `<span class="char">${char}</span>`).join('');
                        dom.textDisplay.className = appState.lang === 'hi' ? 'hindi' : '';
                    }
                    resetSession();
                    switchView('practice');
                    appState.config.level === 'Free Hand' ? dom.freeHandArea.focus() : dom.hiddenInput.focus();
                } catch (error) {
                    console.error("Failed to start practice:", error);
                    dom.loadingStatus.textContent = 'Error fetching text. Please try again.';
                } finally {
                    dom.loadingStatus.textContent = '';
                    dom.startBtn.disabled = false;
                }
            };
            
            const resetSession = () => {
                if (appState.timerId) clearInterval(appState.timerId);
                appState.isPracticeActive = false;
                appState.timerId = null;
                appState.session = { startTime: 0, timeLeft: appState.config.duration, typedText: '', charIndex: 0, correctChars: 0, errorCount: 0, keystrokes: 0, isFetchingMoreText: false };
                dom.hiddenInput.value = '';
                dom.textDisplayWrapper.scrollTop = 0;
                updateStatsDisplay();
                updateTextDisplay();
            };

            const handleTyping = () => {
                if (appState.session.timeLeft <= 0 && appState.config.level !== 'Free Hand' && appState.config.duration > 0) return;
                if (!appState.isPracticeActive && appState.config.duration > 0) {
                    appState.isPracticeActive = true;
                    appState.session.startTime = Date.now();
                    startTimer();
                }
                appState.session.typedText = appState.config.level === 'Free Hand' ? dom.freeHandArea.value : dom.hiddenInput.value;
                updateTextDisplay();

                const remainingChars = appState.config.sourceChars.length - appState.session.charIndex;
                if (appState.config.isDynamicText && remainingChars < 100) {
                    appendMoreText();
                }
                
                if (appState.config.level !== 'Free Hand' && appState.session.charIndex === appState.config.sourceChars.length && !appState.config.isDynamicText) {
                    endPractice();
                }
            };
            
            const startTimer = () => {
                if (appState.timerId || appState.config.duration <= 0) return;
                appState.timerId = setInterval(() => {
                    if (appState.isPracticeActive) {
                        const elapsed = Math.floor((Date.now() - appState.session.startTime) / 1000);
                        appState.session.timeLeft = appState.config.duration - elapsed;
                        updateStatsDisplay();
                    }
                    if (appState.session.timeLeft <= 0) { endPractice(); }
                }, 250);
            };

            const updateTextDisplay = () => {
                if (appState.config.level === 'Free Hand') return;
                const typedChars = splitTextToChars(appState.session.typedText);
                const charElements = dom.textDisplay.querySelectorAll('.char');
                appState.session.charIndex = typedChars.length;
                let correctCount = 0;
                let errorCount = 0;
                charElements.forEach((charEl, index) => {
                    if (index < appState.session.charIndex) {
                        if (typedChars[index] === appState.config.sourceChars[index]) {
                            charEl.className = 'char correct';
                            correctCount++;
                        } else {
                            charEl.className = 'char incorrect';
                            errorCount++;
                        }
                    } else {
                        charEl.className = 'char';
                    }
                });
                appState.session.correctChars = correctCount;
                appState.session.errorCount = errorCount;
                updateCaretPosition();
            };
            
            const updateCaretPosition = () => {
                const charElements = dom.textDisplay.querySelectorAll('.char');
                const isAtEnd = appState.session.charIndex >= charElements.length;
                const currentEl = isAtEnd ? charElements[charElements.length - 1] : charElements[appState.session.charIndex];

                if (!currentEl) {
                    dom.caret.style.display = 'none';
                    return;
                }

                dom.caret.style.display = 'block';
                const currentElRect = currentEl.getBoundingClientRect();
                dom.caret.style.left = `${currentEl.offsetLeft + (isAtEnd ? currentEl.offsetWidth : 0)}px`;
                dom.caret.style.top = `${currentEl.offsetTop}px`;
                
                const wrapper = dom.textDisplayWrapper;
                const caretTop = currentEl.offsetTop;
                const caretHeight = currentEl.offsetHeight;

                if (caretTop < wrapper.scrollTop) {
                    wrapper.scrollTop = caretTop - caretHeight;
                } else if (caretTop + caretHeight > wrapper.scrollTop + wrapper.clientHeight) {
                    wrapper.scrollTop = caretTop + caretHeight - wrapper.clientHeight;
                }
            };

            const updateStatsDisplay = () => {
                const duration = appState.config.duration > 0 
                    ? Math.max(0, appState.session.timeLeft)
                    : (appState.isPracticeActive ? Math.floor((Date.now() - appState.session.startTime) / 1000) : 0);
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                dom.stats.time.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                if (!appState.isPracticeActive && appState.session.startTime === 0) return;
                
                const elapsedMinutes = (Date.now() - appState.session.startTime) / 60000;
                if(elapsedMinutes <= 0) return;

                const totalTypedChars = appState.session.typedText.length;
                const grossWpm = (totalTypedChars / 5) / elapsedMinutes;

                const errorCount = appState.session.errorCount;
                const correctChars = totalTypedChars - errorCount;
                
                const netWpm = elapsedMinutes > 0 ? (correctChars / 5) / elapsedMinutes : 0;
                const accuracy = totalTypedChars > 0 ? (correctChars / totalTypedChars) * 100 : 100;

                dom.stats.grossWpm.textContent = Math.round(grossWpm);
                dom.stats.netWpm.textContent = Math.round(Math.max(0, netWpm));
                dom.stats.errors.textContent = errorCount;
                dom.stats.accuracy.textContent = `${Math.round(accuracy)}%`;
            };

            const endPractice = () => {
                if (!appState.isPracticeActive && appState.session.startTime > 0) return;
                if (appState.timerId) clearInterval(appState.timerId);
                appState.isPracticeActive = false;
                appState.session.timeLeft = 0;
                updateStatsDisplay();
                dom.hiddenInput.blur();
                dom.freeHandArea.blur();
                showResults();
            };
            
            const showResults = () => {
                const isFreeHand = appState.config.level === 'Free Hand';
                const timeTakenSec = isFreeHand 
                    ? (appState.session.startTime > 0 ? Math.floor((Date.now() - appState.session.startTime) / 1000) : 0)
                    : (appState.config.duration - Math.max(0, appState.session.timeLeft));
                
                const timeTakenMin = timeTakenSec > 0 ? timeTakenSec / 60 : (appState.config.duration / 60 || 1);
                
                const totalCharsTyped = appState.session.typedText.length;
                const characterErrors = appState.session.errorCount;
                const correctChars = appState.session.correctChars;
                
                const grossWpm = timeTakenMin > 0 ? (totalCharsTyped / 5) / timeTakenMin : 0;
                const netWpm = timeTakenMin > 0 ? (correctChars / 5) / timeTakenMin : 0;
                
                const accuracy = totalCharsTyped > 0 ? (correctChars / totalCharsTyped) * 100 : 100;
                
                const typedWordsArray = appState.session.typedText.trim().split(/\s+/).filter(Boolean);
                const totalWordsTyped = typedWordsArray.length;
                let wordErrors = 0;
                if (!isFreeHand) {
                    typedWordsArray.forEach((word, index) => { if (index < appState.config.sourceWords.length && word !== appState.config.sourceWords[index]) { wordErrors++; } });
                }
                const correctWords = totalWordsTyped - wordErrors;

                let finalWpm = netWpm;
                dom.results.minusMarkingSummary.textContent = "Minus marking was disabled.";
                if (appState.config.minusMarking.enabled && !isFreeHand) {
                    const deduction = characterErrors * appState.config.minusMarking.value;
                    finalWpm = Math.max(0, netWpm - deduction);
                    dom.results.minusMarkingSummary.innerHTML = `<strong>Minus Marking:</strong> ${characterErrors} character errors × ${appState.config.minusMarking.value} WPM penalty = <strong>${deduction.toFixed(0)} WPM deducted</strong>.`;
                }

                dom.results.grossWpm.textContent = Math.round(grossWpm);
                dom.results.netWpm.textContent = Math.round(netWpm);
                dom.results.accuracy.textContent = accuracy.toFixed(1);
                dom.results.errors.textContent = characterErrors; // Display character errors
                dom.results.totalWords.textContent = totalWordsTyped;
                dom.results.correctWords.textContent = correctWords;
                dom.results.keystrokes.textContent = appState.session.keystrokes;
                const minutes = Math.floor(timeTakenSec / 60);
                const seconds = timeTakenSec % 60;
                dom.results.timeTaken.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                dom.results.finalWpm.textContent = Math.round(finalWpm);
                
                let summaryText = `You achieved a final speed of ${Math.round(finalWpm)} WPM with ${accuracy.toFixed(1)}% accuracy. `;
                if (Math.round(finalWpm) >= 50 && accuracy >= 95) {
                    summaryText += "Excellent job! Your speed and accuracy are impressive.";
                } else if (Math.round(finalWpm) >= 35 && accuracy >= 90) {
                    summaryText += "Good work! Keep practicing to increase your speed.";
                } else {
                    summaryText += "You're on the right track! Consistent practice will lead to great improvements.";
                }
                dom.results.summary.textContent = summaryText;

                dom.resultsModal.classList.add('active');
            };
            
            const hideResults = () => dom.resultsModal.classList.remove('active');

            const init = () => {
                resetState();
                populateLevels();
                populateMethods();

                const visitCountEl = document.getElementById("visitCount");
                if (visitCountEl) {
                    let count = parseInt(localStorage.getItem("visitorCount") || "0");
                    count++;
                    localStorage.setItem("visitorCount", String(count));
                    visitCountEl.textContent = count.toLocaleString();
                }

                dom.levelSelect.addEventListener('change', populateMethods);
                dom.methodSelect.addEventListener('change', handleMethodChange);
                dom.minusMarkingEnabled.addEventListener('change', (e) => { dom.minusMarkingValue.disabled = !e.target.checked; });
                [dom.langEnglishBtn, dom.langHindiBtn].forEach(btn => {
                    btn.addEventListener('click', () => {
                        dom.langEnglishBtn.classList.remove('active');
                        dom.langHindiBtn.classList.remove('active');
                        btn.classList.add('active');
                        appState.lang = btn.dataset.lang;
                    });
                });
                dom.startBtn.addEventListener('click', startPractice);
                dom.submitBtn.addEventListener('click', endPractice);
                dom.hiddenInput.addEventListener('input', handleTyping);
                dom.hiddenInput.addEventListener('keydown', (e) => { 
                    appState.session.keystrokes++;
                    if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End'].includes(e.key)) e.preventDefault(); 
                });
                dom.freeHandArea.addEventListener('input', handleTyping);
                dom.freeHandArea.addEventListener('keydown', () => { appState.session.keystrokes++; });
                dom.textDisplayWrapper.addEventListener('click', () => { appState.config.level === 'Free Hand' ? dom.freeHandArea.focus() : dom.hiddenInput.focus(); });
                dom.resultActions.retry.addEventListener('click', () => {
                    hideResults();
                    const oldConfig = { ...appState.config }; resetSession(); appState.config = oldConfig;
                    if(appState.config.level !== 'Free Hand') {
                        dom.textDisplay.innerHTML = appState.config.sourceChars.map(char => `<span class="char">${char}</span>`).join('');
                        dom.textDisplay.className = appState.lang === 'hi' ? 'hindi' : '';
                    }
                    switchView('practice');
                    appState.config.level === 'Free Hand' ? dom.freeHandArea.focus() : dom.hiddenInput.focus();
                });
                dom.resultActions.newTest.addEventListener('click', () => { hideResults(); startPractice(); });
                dom.resultActions.backToHome.addEventListener('click', () => { hideResults(); switchView('setup'); });
            };

            init();
        });
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>