<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EXAMYATRI - Multiplayer Quiz</title>
  <!-- Cropper.js CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1HGZL93811"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-1HGZL93811');
</script>
  <!-- ADDED: MathJax for Math/Physics Formula Rendering -->
<script>
  MathJax = {
    tex: {
      inlineMath: [['\\(', '\\)'], ['$', '$']] // CORRECTED: Single backslash for escaping
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

  <!-- ADDED: Google Font for better Math Rendering -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Math&display=swap" rel="stylesheet">


  <style>
    /* --- Base & Theme Variables --- */
    :root {
      --primary-bg: #f0f4f8;
      --secondary-bg: #ffffff;
      --component-bg: #f8f9fa;
      --text-color: #333;
      --border-color: #dee2e6;
      --shadow-color: rgba(0, 0, 0, 0.08);
      --accent-color: #007bff;
      --accent-hover: #0056b3;
      --correct-color: #28a745;
      --incorrect-color: #dc3545;
      --skipped-color: #ffc107;
      --bookmark-color: #a5a5a5;
      --bookmarked-active-color: #ffb300;
      /* NEW: Multiplayer colors */
      --multiplayer-accent: #8e44ad;
      --multiplayer-accent-hover: #7b2a9a;
      --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      /* UPDATED: Added a dedicated math font variable */
      --font-family-math: 'Noto Sans Math', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body.dark-mode {
      --primary-bg: #121212;
      --secondary-bg: #1e1e1e;
      --component-bg: #2a2a2e;
      --text-color: #e0e0e0;
      --border-color: #44474b;
      --shadow-color: rgba(255, 255, 255, 0.08);
      --accent-color: #4dabf7;
      --accent-hover: #1c7ed6;
       /* NEW: Multiplayer colors */
      --multiplayer-accent: #a569bd;
      --multiplayer-accent-hover: #c39bd3;
    }

    /* --- General Styles --- */
    body {
      font-family: var(--font-family);
      background-color: var(--primary-bg);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
      transition: background-color 0.3s, color 0.3s;
    }

    .container {
      width: 100%;
      max-width: 800px;
      background-color: var(--secondary-bg);
      border-radius: 10px;
      box-shadow: 0 4px 15px var(--shadow-color);
      overflow: hidden;
      transition: background-color 0.3s, opacity 0.4s ease, transform 0.4s ease;
      margin-bottom: 20px;
      padding: 2rem 2.5rem;
    }

    .container.fade-out {
        opacity: 0;
        transform: scale(0.95);
    }

    .header {
      background-color: var(--accent-color);
      color: white;
      padding: 15px 20px;
      text-align: center;
      font-size: 1.5em;
      position: relative;
      margin: -2rem -2.5rem 2rem -2.5rem; /* Adjust to fit padding */
      border-radius: 10px 10px 0 0;
    }
    body.dark-mode .header { background-color: #1f1f1f; border-bottom: 1px solid var(--border-color); }

    .header-branding {
        font-size: 1em;
        display: inline-flex;
        align-items: center;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.2em 0.6em;
    }
    .header-branding strong {
        font-size: 1.1em;
        letter-spacing: 0.5px;
    }
    .header-branding .tagline {
        font-size: 0.7em;
        opacity: 0.9;
        font-weight: 400;
        margin-top: 0.2em;
    }


    .hidden { display: none !important; }

    /* --- Animations & Effects --- */
    .fade-in-slide-up {
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.5s ease-out, transform 0.5s ease-out;
    }
    .fade-in-slide-up:not(.hidden) {
        opacity: 1;
        transform: translateY(0);
    }

    @keyframes glow {
        0% { box-shadow: 0 0 4px var(--accent-color); }
        50% { box-shadow: 0 0 16px var(--accent-color), 0 0 24px var(--accent-hover); }
        100% { box-shadow: 0 0 4px var(--accent-color); }
    }
    .btn.glowing { animation: glow 1.8s infinite; }

    @keyframes shake-horizontal { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    .is-shaking { animation: shake-horizontal 0.8s cubic-bezier(.36,.07,.19,.97) both; }


    /* --- Loading Overlay --- */
    #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 11000;
        color: white;
        font-size: 1.2em;
        text-align: center;
    }
    .spinner {
        border: 6px solid rgba(255, 255, 255, 0.3);
        border-top: 6px solid var(--accent-color);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    #loading-text { font-weight: bold; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }


    /* --- CREATION METHOD SELECTOR --- */
    #creation-method-selector { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-top: 2rem; }
    .creation-option-card { background-color: var(--component-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s ease-in-out; }
    .creation-option-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px var(--shadow-color); border-color: var(--accent-color); }
    .creation-option-card .card-icon { font-size: 2.5rem; display: block; margin-bottom: 0.5rem; }
    .creation-option-card h4 { margin: 0.5rem 0; color: var(--accent-color); font-size: 1.1em; }
    .creation-option-card p { font-size: 0.9em; color: var(--text-color); opacity: 0.8; margin: 0; }

    .creation-option-card#select-multiplayer {
        border-color: var(--multiplayer-accent);
        grid-column: 1 / -1; /* Make it full width */
        background: linear-gradient(45deg, var(--multiplayer-accent), #a569bd);
        color: white;
    }
    .creation-option-card#select-multiplayer h4 { color: white; }
    .creation-option-card#select-multiplayer p { color: white; opacity: 0.9;}
    .creation-option-card#select-multiplayer:hover {
         border-color: var(--multiplayer-accent-hover);
         box-shadow: 0 8px 25px rgba(142, 68, 173, 0.4);
         transform: translateY(-5px) scale(1.02);
    }

    @media (max-width: 600px) { #creation-method-selector { grid-template-columns: 1fr; gap: 1rem; } .creation-option-card { padding: 1rem; } }

    /* --- MULTIPLAYER LOBBY STYLES --- */
    #multiplayer-lobby { text-align: center; }
    #multiplayer-lobby .header { background-color: var(--multiplayer-accent); }
    #multiplayer-lobby .btn-primary { background-color: var(--multiplayer-accent); }
    #multiplayer-lobby .btn-primary:hover { background-color: var(--multiplayer-accent-hover); }
    #multiplayer-lobby .input-field { border-color: var(--multiplayer-accent); }
    #multiplayer-lobby h3 { color: var(--multiplayer-accent); font-size: 1.5em; margin-bottom: 1rem;}
    #multiplayer-lobby .lobby-actions { display: flex; flex-direction: column; gap: 1rem; margin-top: 1.5rem; max-width: 400px; margin-left: auto; margin-right: auto; }
    #multiplayer-lobby .or-divider { margin: 1rem 0; font-weight: bold; color: var(--border-color); }
    #multiplayer-lobby .input-group { margin-bottom: 1.5rem; text-align: left; }
    #multiplayer-lobby .join-game-group { display: flex; gap: 10px; }
    .room-code-container { display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    #room-code-display { font-size: 2em; font-weight: bold; background-color: var(--component-bg); padding: 0.5rem 1.5rem; border-radius: 8px; letter-spacing: 3px; border: 2px dashed var(--multiplayer-accent); }
    #participant-list { list-style: none; padding: 0; margin: 1.5rem auto; max-width: 400px; }
    #participant-list li { background-color: var(--component-bg); padding: 0.75rem 1rem; border-radius: 5px; margin-bottom: 0.5rem; text-align: left; border-left: 4px solid var(--multiplayer-accent); }
    #name-prompt { margin-top: 2rem; }
    #room-full-notification, #room-not-found-notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: var(--incorrect-color); color: white; padding: 1rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 12000; animation: fade-in-out 3s forwards; }
    @keyframes fade-in-out { 0% { opacity: 0; top: 0; } 10% { opacity: 1; top: 20px; } 90% { opacity: 1; top: 20px; } 100% { opacity: 0; top: 0; } }
    .multiplayer-disclaimer { background-color: var(--component-bg); border: 1px solid var(--multiplayer-accent); color: var(--multiplayer-accent); padding: 1rem; border-radius: 8px; margin-top: 1.5rem; font-size: 0.9em; line-height: 1.4; }

    /* NEW: Multiplayer Setup Screen */
    #multiplayer-setup-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2.5rem;
        margin-top: 1.5rem;
    }
    .multiplayer-setup-panel {
        background-color: var(--component-bg);
        border: 1px solid var(--border-color);
        padding: 1.5rem;
        border-radius: 8px;
    }
    .multiplayer-setup-panel h4 {
        margin-top: 0;
        margin-bottom: 1rem;
        font-size: 1.3em;
        color: var(--multiplayer-accent);
        border-bottom: 2px solid var(--multiplayer-accent);
        padding-bottom: 0.5rem;
    }
    @media (min-width: 768px) {
        #multiplayer-setup-container {
            grid-template-columns: 1fr 1fr;
        }
    }


    /* --- GENERATOR STYLES --- */
    .step-header-container { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; }
    .step-header { padding-bottom: 10px; margin: 2rem 0 0 0; border-bottom: none; }
    .input-label { display: block; margin-bottom: 8px; font-weight: bold; }
    .input-label-group { display: flex; justify-content: space-between; align-items: center; }
    textarea, .input-field, select.input-field { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 5px; box-sizing: border-box; background-color: var(--component-bg); color: var(--text-color); font-family: var(--font-family); font-size: 1em; resize: vertical; }
    select.input-field { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right .75rem center; background-size: 16px 12px; }
    body.dark-mode select.input-field { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23e0e0e0' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); }
    #quiz-data-input, #source-text-input, #source-text-image, #source-text-pdf { min-height: 250px; }

    #paste-notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: var(--correct-color); color: white; padding: 10px 20px; border-radius: 25px; font-size: 1em; font-weight: bold; opacity: 0; transition: opacity 0.5s ease, top 0.5s ease; pointer-events: none; z-index: 2100; }
    #paste-notification.show { top: 40px; opacity: 1; }
    .prompt-actions-row { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }

    /* --- PDF/IMAGE WORKFLOW STYLES --- */
    #image-input-area, #pdf-input-area { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 1.5rem; }
    #image-preview-container { display: flex; flex-wrap: wrap; gap: 15px; width: 100%; margin-top: 1rem; min-height: 100px; border: 2px dashed var(--border-color); padding: 10px; border-radius: 5px;}
    .img-preview-wrapper { position: relative; width: 120px; height: 120px; border: 1px solid var(--border-color); border-radius: 5px; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between; background-color: var(--component-bg); }
    .img-preview-wrapper .img-container { width: 100%; height: 100%; flex-grow: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .img-preview-wrapper img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .img-preview-actions { display: flex; justify-content: space-around; background-color: rgba(0,0,0,0.4); padding: 4px 0; }
    .img-preview-btn { background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem; }
    .img-preview-btn:hover { color: var(--accent-color); }

    #ocr-status, #pdf-status { margin-top: 1rem; font-style: italic; color: var(--accent-color); font-weight: bold;}
    .page-range-container { display: flex; align-items: center; gap: 10px; }
    .page-range-container input[type="number"] { width: 80px; }

    /* --- Image Format Guide --- */
    #image-format-guide { display: flex; gap: 1.5rem; margin-top: 1rem; margin-bottom: 1.5rem; opacity: 0; transform: translateY(20px); transition: opacity 0.5s ease-out, transform 0.5s ease-out; }
    #image-format-guide:not(.hidden) { opacity: 1; transform: translateY(0); }
    .guide-card { flex: 1; background-color: var(--component-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; text-align: center; }
    .guide-card.good { border-left: 4px solid var(--correct-color); }
    .guide-card.bad { border-left: 4px solid var(--incorrect-color); }
    .guide-card h5 { margin: 0 0 0.5rem 0; font-size: 1em; }
    .guide-card p { font-size: 0.85em; margin: 0; line-height: 1.4; opacity: 0.9; }
    .guide-card svg { width: 100%; height: 80px; margin-bottom: 0.5rem; }
    @media (max-width: 600px) { #image-format-guide { flex-direction: column; gap: 1rem; } }


    /* --- QUIZ PLAYER & RESULTS --- */
    /* UPDATED: Applying math font and improving line-height */
    #question-text, .option-text, #explanation-text, .result-question, .result-option, .result-explanation {
        font-family: var(--font-family-math);
        line-height: 1.6; /* Increased for better readability of complex formulas */
    }

    #quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px dashed var(--border-color); gap: 1rem; flex-wrap: wrap; }
    #question-topic { font-weight: bold; color: var(--accent-color); font-size: 1.1rem; flex-shrink: 0; }
    #progress { background-color: var(--accent-color); color: white; padding: 5px 12px; border-radius: 15px; font-size: 0.9rem; font-weight: bold; white-space: nowrap; }
    #timer { font-weight: bold; background: var(--component-bg); padding: 8px 15px; border-radius: 25px; border: 2px solid var(--border-color); display: flex; align-items: center; gap: 10px; position: relative; width: auto; justify-content: center; }
    #timer-text { font-size: 1.4em; font-weight: bold; color: var(--accent-color); width: 60px; text-align: center; }
    body.dark-mode #timer-text { color: var(--accent-color); }
    .timer-face { font-size: 1.6rem; display: none; }
    .timer-face.visible { display: inline-block; animation: face-pop 0.4s ease-out; }
    @keyframes face-pop { 0% { transform: scale(0.5); opacity: 0; } 80% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
    #question-image-container { margin-bottom: 1rem; }
    #question-image-container img { max-width: 100%; max-height: 400px; border-radius: 8px; display: block; margin: auto; border: 1px solid var(--border-color); }
    #question-and-bookmark { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; margin-bottom: 1rem; }
    #question-text-container { flex-grow: 1; }
    #question-text { font-size: 1.4em; font-weight: 500; margin: 0; }
    #bookmark-btn { background: none; border: 1px solid var(--border-color); color: var(--bookmark-color); font-size: 1.5rem; cursor: pointer; border-radius: 50%; width: 44px; height: 44px; flex-shrink: 0; display: flex; justify-content: center; align-items: center; transition: all 0.2s ease; }
    #bookmark-btn:hover { background-color: var(--component-bg); transform: scale(1.1); }
    #bookmark-btn.bookmarked { color: white; background-color: var(--bookmarked-active-color); border-color: var(--bookmarked-active-color); }
    #statements-list p { margin: 0.5em 0; background: var(--component-bg); padding: 10px; border-radius: 5px; border-left: 3px solid var(--accent-color); }
    .option { position: relative; border: 2px solid var(--border-color); padding: 12px 15px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: space-between; }
    .option:hover:not(.disabled) { border-color: var(--accent-hover); background-color: var(--component-bg); }
    .option.selected { border-color: var(--accent-color); background-color: #eaf5ff; }
    body.dark-mode .option.selected { background-color: #36363c; }
    .option.correct { border-color: var(--correct-color); background-color: #e9f7ef; color: #145a32; font-weight: bold; }
    body.dark-mode .option.correct { background-color: #1c3c24; color: #a3d9b1; }
    .option.incorrect { border-color: var(--incorrect-color); background-color: #fbeee6; color: #943126; font-weight: bold; }
    body.dark-mode .option.incorrect { background-color: #4a1c20; color: #f1b0b7; }
    .option.disabled { pointer-events: none; opacity: 0.8; }
    .option-feedback { display: flex; align-items: center; gap: 10px; }
    .feedback-icon { font-size: 1.5rem; transform: scale(0); animation: pop-in 0.5s ease-out forwards; }
    .user-choice-emoji { font-size: 1.5rem; display: none; animation: pop-in 0.5s ease-out forwards; }
    .user-choice-emoji.visible { display: inline-block; }
    @keyframes pop-in { 0% { transform: scale(0); opacity: 0; } 70% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
    #explanation-container { margin-top: 1.5rem; padding: 1rem; background-color: var(--component-bg); border-left: 5px solid var(--accent-color); border-radius: 5px; }
    #explanation-container h4 { margin-top: 0; }

    #quiz-actions { margin-top: 2rem; display: flex; flex-direction: column; gap: 1rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem; }
    .quiz-actions-primary { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px; }
    .quiz-actions-primary .btn { flex: 1 1 120px; /* grow, shrink, basis */ }
    .quiz-actions-final { display: flex; justify-content: center; }

    .btn { background-color: var(--accent-color); color: white; padding: 10px 18px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: 600; text-align: center; transition: all 0.3s; margin: 0; display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
    .btn-full-width { width: 100%; }
    .btn:hover:not(:disabled) { background-color: var(--accent-hover); box-shadow: 0 4px 8px var(--shadow-color); transform: translateY(-2px); }
    .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; opacity: 0.7; }
    body.dark-mode .btn:disabled { background-color: #555; }
    .btn-secondary { background-color: #6c757d; }
    .btn-secondary:hover:not(:disabled) { background-color: #5a6268; }
    .btn-danger { background-color: var(--incorrect-color); }
    .btn-danger:hover:not(:disabled) { background-color: #c82333; }
    #check-answer-btn { background-color: var(--correct-color); }
    #check-answer-btn:hover:not(:disabled) { background-color: #218838; }
    #skip-question-btn { background-color: var(--skipped-color); color: #212529;}
    #skip-question-btn:hover:not(:disabled) { background-color: #e0a800; }

    .exam-buttons-container, .ai-platform-selector { display: flex; flex-wrap: wrap; gap: 8px; }
    .ai-platform-selector { justify-content: center; margin-top: 10px; }
    .exam-btn, .ai-platform-btn { background-color: var(--component-bg); color: var(--text-color); border: 1px solid var(--border-color); padding: 6px 14px; font-size: 0.85em; min-width: auto; margin: 0; flex-grow: 1; }
    .exam-btn:hover:not(:disabled), .ai-platform-btn:hover:not(:disabled) { background-color: var(--primary-bg); border-color: var(--accent-color); transform: translateY(-1px); box-shadow: none; }
    .exam-btn.active, .ai-platform-btn.active { background-color: var(--accent-color); color: white; border-color: var(--accent-color); transform: none; box-shadow: none; }
    .ai-platform-option { display: flex; flex-direction: column; flex: 1; text-align: center; }
    .ai-tip { font-size: 0.8em; color: #6c757d; margin-top: 5px; }
    body.dark-mode .ai-tip { color: #aaa; }
    #results-screen h2 { color: var(--correct-color); border-bottom-color: var(--correct-color); }
    #score-summary { font-size: 1.5rem; font-weight: bold; text-align: center; margin-bottom: 1.5rem; transform: scale(0.8); opacity: 0; transition: transform 0.5s ease-out, opacity 0.5s ease-out; }
    #score-summary.visible { transform: scale(1); opacity: 1; }

    #results-summary-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
        background-color: var(--component-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    #score-performance-chart-container {
        flex: 1 1 200px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }
    .performance-pie-chart {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background-image: conic-gradient(var(--skipped-color) 0 100%);
        border: 4px solid var(--secondary-bg);
        box-shadow: 0 2px 8px var(--shadow-color);
    }
    .chart-legend {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        font-size: 0.9em;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .legend-color-box {
        width: 15px;
        height: 15px;
        border-radius: 3px;
    }
    #quiz-summary-details {
        flex: 1 1 300px;
        background-color: transparent;
        border: none;
        padding: 0;
        margin: 0;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    @media (min-width: 601px) {
        #score-performance-chart-container {
            flex-direction: row;
        }
    }

    .summary-item { display: flex; flex-direction: column; }
    .summary-label { font-size: 0.9em; color: #6c757d; font-weight: 500;}
    .summary-value { font-size: 1.2em; font-weight: bold; }
    .summary-value.remark { color: var(--accent-color); }
    .summary-value.count-up { transition: all 0.5s ease-out; }
    body.dark-mode .summary-label { color: #aaa; }
    .result-item { border: 1px solid var(--border-color); padding: 1rem; margin-bottom: 1rem; border-radius: 8px; background-color: var(--component-bg); }
    .result-item .result-question { font-weight: bold; position: relative; }
    .bookmark-indicator { color: var(--bookmarked-active-color); font-size: 1.2rem; position: absolute; top: 0; right: 0; opacity: 0; transition: opacity 0.3s; }
    .bookmark-indicator.visible { opacity: 1; }
    .result-options-list { margin-top: 1rem; padding-left: 0; list-style-type: none; }
    .result-option { padding: 8px; border-radius: 4px; margin-bottom: 5px; border: 1px solid transparent; }
    .result-option.user-selected { border-color: var(--accent-color); }
    .result-option.correct-answer { background-color: #d4edda; }
    body.dark-mode .result-option.correct-answer { background-color: #1c3c24; }
    .result-explanation { margin-top: 1rem; padding: 1rem; background-color: var(--primary-bg); border-left: 4px solid var(--accent-color); border-radius: 5px; font-size: 0.95em; }
    .result-explanation h5 { margin-top: 0; }
    .share-buttons { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; justify-content: center; align-items: center;}
    .share-buttons-row { display: flex; gap: 10px; justify-content: center; width: 100%; flex-wrap: wrap; }
    #results-page-telegram-opener { width: 100%; max-width: 400px; }
    .telegram-input-group { display: flex; gap: 10px; align-items: center; }
    .telegram-input-group .input-field { flex-grow: 1; margin: 0; padding: 12px; border-radius: 5px; border: 1px solid var(--border-color); background-color: var(--component-bg); color: var(--text-color);}
    .telegram-input-group .btn { flex-grow: 0; padding: 12px 15px; margin: 0; }
    #theme-toggle-btn { position: absolute; top: 50%; transform: translateY(-50%); right: 20px; background: none; border: 1px solid rgba(255, 255, 255, 0.7); color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; transition: all 0.3s ease; display: flex; justify-content: center; align-items: center; }
    #theme-toggle-btn:hover { background-color: rgba(255, 255, 255, 0.2); transform: translateY(-50%) rotate(15deg) scale(1.1); }

    /* --- GUIDE BUTTON & MODAL STYLES --- */
    .guide-container { display: flex; flex-direction: column; align-items: center; }
    .guide-help-text { font-size: 0.7em; font-weight: 500; opacity: 0.7; margin-top: -2px; user-select: none; }
    .guide-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 5px; line-height: 1; opacity: 0.7; transition: opacity 0.2s, transform 0.2s; animation: pulse 2.5s infinite ease-in-out; }
    .guide-btn:hover { opacity: 1; transform: scale(1.2); animation-play-state: paused; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

    #telegram-backup-guide-container { display: flex; flex-direction: column; align-items: center; gap: 5px; margin-top: 15px; }
    #telegram-backup-guide-btn { background: none; border: none; font-size: 2rem; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; }
    #telegram-backup-guide-btn:hover { opacity: 1; }
    #telegram-backup-guide-container p { font-size: 0.8em; color: var(--text-color); opacity: 0.8; margin: 0; text-align: center; }

    #flowchart-modal-content {
        width: 100%;
        max-height: 65vh; /* Limit height */
        overflow-y: auto; /* Add scroll for long content */
        padding-right: 15px; /* Space for scrollbar */
    }
    .guide-step {
        background-color: var(--component-bg);
        border-left: 4px solid var(--accent-color);
        padding: 1rem;
        margin-bottom: 1.5rem;
        border-radius: 5px;
    }
    .guide-step strong {
        font-size: 1.1em;
        display: block;
        margin-bottom: 0.5em;
        color: var(--accent-color);
    }
    .guide-step p {
        margin: 0.5em 0;
        line-height: 1.5;
        font-size: 0.95em;
    }
    .guide-step .hindi-text {
        font-style: italic;
        opacity: 0.9;
        font-size: 0.9em;
        color: var(--text-color);
    }
    .modal-close-btn-top {
        position: absolute;
        top: 10px;
        right: 15px;
        background: none;
        border: none;
        font-size: 2rem;
        line-height: 1;
        cursor: pointer;
        color: var(--text-color);
        opacity: 0.6;
        transition: opacity 0.2s, transform 0.2s;
    }
    .modal-close-btn-top:hover {
        opacity: 1;
        transform: scale(1.1);
    }


    /* --- Fallback & Redundancy Styles --- */
    #ai-link-fallback {
        background-color: var(--primary-bg);
        border: 2px dashed var(--accent-color);
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        margin-top: 1rem;
    }
    #ai-link-fallback p { margin: 0 0 0.5rem 0; }
    #ai-link-fallback a { font-weight: bold; }


    /* --- MODAL STYLES (MODIFIED Z-INDEX) --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 10001; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
    .modal-overlay:not(.hidden) { opacity: 1; pointer-events: auto; }
    .modal-content { position: relative; background-color: var(--secondary-bg); color: var(--text-color); padding: 1.5rem; border-radius: 10px; width: 90%; max-width: 800px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); transform: scale(0.95); transition: transform 0.3s ease; display: flex; flex-direction: column; max-height: 90vh; }
    .modal-overlay:not(.hidden) .modal-content { transform: scale(1); }
    .modal-content h3 { margin-top: 0; color: var(--accent-color); padding-right: 30px; /* Add padding for close button */ }
    #manual-copy-modal-content h3 { color: var(--incorrect-color); }
    #crop-image-container { width: 100%; flex-grow: 1; overflow: hidden; }
    #crop-image-container img { max-width: 100%; max-height: 100%; }
    .modal-actions { margin-top: 1rem; display: flex; justify-content: flex-end; gap: 10px; flex-shrink: 0; border-top: 1px solid var(--border-color); padding-top: 1rem;}
    .modal-content textarea { width: 100%; min-height: 200px; max-height: 50vh; margin-top: 1rem; margin-bottom: 1.5rem; font-family: monospace; font-size: 0.9em; background-color: var(--primary-bg); border: 1px solid var(--border-color); color: var(--text-color); padding: 10px; box-sizing: border-box; border-radius: 5px; }

    /* UPDATED: Host quiz creation view as full page */
    #host-quiz-generation-view {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--primary-bg);
        z-index: 10000;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        box-sizing: border-box;
        overflow-y: auto;
    }
     #host-quiz-generation-view h3 {
        color: var(--multiplayer-accent);
        font-size: 1.5em;
        margin-bottom: 1rem;
        width: 100%;
        max-width: 800px;
        text-align: center;
    }

    /* UPDATED: Vertical alignment for host creation options */
    #host-creation-method-selector {
        display: flex;
        flex-direction: column; /* Arrange vertically */
        gap: 1rem;
        width: 100%;
        max-width: 500px; /* Constrain width */
        margin-top: 1.5rem;
    }
    #host-creation-method-selector .creation-option-card {
        width: 100%;
        box-sizing: border-box;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }
     #host-creation-method-selector .creation-option-card .card-icon {
        font-size: 2rem;
        margin-bottom: 0;
    }

    #host-generator-workflow-container-wrapper {
        width: 100%;
        max-width: 800px;
        margin-top: 1.5rem;
        overflow-y: auto;
        padding: 1.5rem;
        background-color: var(--secondary-bg);
        border-radius: 8px;
        box-shadow: 0 4px 15px var(--shadow-color);
    }


    /* --- NEW/MODIFIED: Feedback Effects --- */
    #congrats-animation-container {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        pointer-events: none;
        overflow: hidden;
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .congrats-emoji {
        position: absolute;
        top: 50%; left: 50%;
        font-size: 2.5rem;
        opacity: 0;
        animation: spread-out 2.5s ease-out forwards;
    }
    @keyframes spread-out {
        0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
        20% { opacity: 1; }
        100% { transform: var(--transform-end) scale(1); opacity: 0; }
    }

    #sad-reaction-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9998;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease-in-out;
    }
    #sad-reaction-overlay:not(.hidden) {
        opacity: 1;
    }
    #sad-reaction-emoji {
      font-size: 15vw; /* Responsive size */
      animation: sadBounce 1.5s ease-in-out forwards;
      text-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    @keyframes sadBounce {
      0% { transform: scale(0.5); opacity: 0; }
      30% { transform: scale(1.1) rotate(-5deg); opacity: 1; }
      50% { transform: scale(0.95) rotate(5deg); }
      70% { transform: scale(1.05) rotate(-2deg); }
      90% { transform: scale(1); opacity: 1; }
      100% { transform: scale(0.8); opacity: 0; }
    }

    /* --- NEW: Mental Pressure Mode --- */
    #pressure-mode-container {
        position: relative;
        margin-left: auto;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 50px; /* Ensure space for animation */
    }
    #pressure-mode-toggle-btn {
        background: none;
        border: none;
        font-size: 1.8rem;
        cursor: pointer;
        padding: 5px;
        transition: transform 0.2s;
    }
    #pressure-mode-toggle-btn:hover {
        transform: scale(1.2);
    }
    #pressure-text-animation {
        font-size: 1.1em;
        font-weight: bold;
        color: var(--incorrect-color);
        padding: 8px 15px;
        border-radius: 25px;
        background-color: var(--component-bg);
        border: 2px solid var(--incorrect-color);
        animation: pulse-red 1.5s infinite;
        white-space: nowrap;
    }
    @keyframes pulse-red {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
        70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
    }
    #pressure-mode-controls {
        position: absolute;
        top: 100%;
        right: 0;
        background-color: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 4px 15px var(--shadow-color);
        z-index: 100;
        width: 220px;
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
    }
    #pressure-mode-controls label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: var(--accent-color);
    }
    input:checked + .slider:before {
      transform: translateX(20px);
    }

    @keyframes vibrate {
      0% { transform: translate(0); }
      20% { transform: translate(-2px, 2px); }
      40% { transform: translate(-2px, -2px); }
      60% { transform: translate(2px, 2px); }
      80% { transform: translate(2px, -2px); }
      100% { transform: translate(0); }
    }
    #check-answer-btn.vibrating {
        animation: vibrate 0.3s linear infinite;
    }

    /* --- NEW: Gemini Instructions Modal & Fire Button --- */
    #gemini-instructions-modal-overlay .modal-content {
        padding: 1rem 1.5rem;
        height: auto;
        max-height: calc(100vh - 40px);
    }
    #gemini-instructions-modal-overlay .guide-step {
        margin-bottom: 0.8rem;
        padding: 0.8rem;
    }
     #gemini-instructions-modal-overlay h3 {
        text-align: center;
        margin-bottom: 1rem;
     }
    #gemini-instructions-content-wrapper {
        overflow-y: auto;
        flex-grow: 1;
        padding-right: 10px; /* space for scrollbar */
        margin-bottom: 1rem; /* space above button */
    }
    @keyframes fire {
        0% { box-shadow: 0 0 10px #ffc107, 0 0 20px #ffc107, 0 0 30px #ff8c00, 0 0 40px #ff4500, inset 0 0 5px #ffc107; }
        50% { box-shadow: 0 0 15px #ffc107, 0 0 25px #ffc107, 0 0 35px #ff8c00, 0 0 45px #ff4500, inset 0 0 10px #ff8c00; }
        100% { box-shadow: 0 0 10px #ffc107, 0 0 20px #ffc107, 0 0 30px #ff8c00, 0 0 40px #ff4500, inset 0 0 5px #ffc107; }
    }
    .fire-animation {
        animation: fire 1.5s infinite ease-in-out;
        background-color: #dc3545;
        border-color: #ffc107;
    }

    /* NEW: Lobby waiting info */
    .lobby-info {
        background-color: var(--component-bg);
        border: 1px solid var(--border-color);
        border-left: 4px solid var(--multiplayer-accent);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        text-align: left;
    }
    .lobby-info p {
        margin: 0.5rem 0;
    }
     .lobby-info strong {
        color: var(--multiplayer-accent);
     }

    /* NEW: Host Decision Modal */
    #host-decision-modal-overlay .modal-content {
        text-align: center;
    }
    #host-decision-timer {
        font-size: 2em;
        font-weight: bold;
        color: var(--multiplayer-accent);
        margin: 1rem 0;
        display: block;
    }
    #host-decision-actions {
        display: flex;
        justify-content: center;
        gap: 1rem;
    }


  </style>
</head>
<body>

<div id="loading-overlay" class="hidden">
    <div class="spinner"></div>
    <p id="loading-text"></p>
</div>

<div id="paste-notification"></div>
<div id="congrats-animation-container"></div>
<div id="sad-reaction-overlay" class="hidden"><span id="sad-reaction-emoji"></span></div>
<div id="room-full-notification" class="hidden"><p>Room is full (max 5 participants).</p></div>
<div id="room-not-found-notification" class="hidden"><p>Room not found. Check the code.</p></div>


<!-- ======================================= -->
<!-- ===== GENERATOR CONTAINER (MAIN) ==== -->
<!-- ======================================= -->
<div class="container" id="manual-generator-container">
    <div class="header">
        <span class="header-branding">✍️ <strong>EXAMYATRI</strong> - <span class="tagline"> One Platform, All Exam </span></span>
        <button id="theme-toggle-btn" title="Toggle Dark/Light Mode">🌙</button>
    </div>
    <div id="manual-generator-screen">
        <p>❤️Create FREE Topicwise,  Subjectwise Mock Test,   Unlimited Quiz Practice❤️</p>

        <div id="creation-method-selector">
            <div class="creation-option-card" id="select-from-topic">
                <span class="card-icon">📝</span><h4>Generate from Topic</h4><p>Provide a topic and generate quiz.</p>
            </div>
            <div class="creation-option-card" id="select-from-text">
                <span class="card-icon">📋</span><h4>Generate from Text</h4><p>Paste text/formula(physics,math) to create questions.</p>
            </div>
            <div class="creation-option-card" id="select-from-image">
                <span class="card-icon">🖼️</span><h4>Generate from Image</h4><p>Use images of notes/any book/any Question for a quiz.</p>
            </div>
            <div class="creation-option-card" id="select-from-pdf">
                <span class="card-icon">📄</span><h4>Generate from PDF</h4><p>Upload a PDF to create a quiz.</p>
            </div>
            <!-- NEW: Practice with Friends Card -->
            <div class="creation-option-card" id="select-multiplayer">
                <span class="card-icon">👥</span><h4>Practice with Friends</h4><p>Create a private room and challenge your friends in a real-time quiz battle!</p>
            </div>
        </div>

        <!-- WORKFLOW 1: From Topic -->
        <div id="topic-generator-workflow" class="hidden">
            <button class="btn btn-secondary back-to-selection-btn" style="margin-bottom: 1.5rem;">&larr; Back to Options</button>
            <div class="step-header-container">
              <h3 class="step-header">Step 1: Define Your Quiz</h3>
              <div class="guide-container">
                  <button class="btn guide-btn" data-guide-id="topic-step1" title="Show Guide">💁</button>
                  <span class="guide-help-text">How to use</span>
              </div>
            </div>
            <div class="input-group"><label for="prompt-topic-topic" class="input-label">Quiz Topic (Required)</label><input type="text" id="prompt-topic-topic" class="input-field" placeholder="e.g., The Solar System, World War II" required></div>
            <div class="input-group"><label for="prompt-subject-topic" class="input-label">Subject Area (Required)</label><input type="text" id="prompt-subject-topic" class="input-field" placeholder="e.g., Science, History" required></div>
            <div class="input-group"><label for="prompt-num-questions-topic" class="input-label">Number of Questions</label><input type="number" id="prompt-num-questions-topic" class="input-field" placeholder="e.g., 10" min="1" max="50"></div>
            <div class="input-group"><label for="prompt-language-topic" class="input-label">Quiz Language</label><select id="prompt-language-topic" class="input-field"><option value="English" selected>English</option><option value="Hindi">Hindi</option><option value="Spanish">Spanish</option><option value="French">French</option><option value="German">German</option></select></div>
            <div class="input-group"><label for="prompt-difficulty-topic" class="input-label">Difficulty Level</label><select id="prompt-difficulty-topic" class="input-field"><option value="Easy">Easy</option><option value="Medium" selected>Medium</option><option value="Hard">Hard</option><option value="Expert">Expert</option></select></div>
            <div class="input-group"><label class="input-label">Target Exam (Optional)</label><div class="exam-buttons-container"></div><input type="text" class="prompt-exam-other input-field hidden" id="prompt-exam-other-topic" placeholder="Enter custom exam name" style="margin-top: 10px;"></div>
            <div class="input-group"><label for="question-format-select-topic" class="input-label">Question Format</label><select id="question-format-select-topic" class="input-field"></select></div>
            <button id="generate-prompt-btn-topic" class="btn btn-full-width glowing">Start 🚀</button>
            <button class="btn btn-secondary btn-full-width back-to-selection-btn" style="margin-top: 1rem;">↩️ Back to Main Menu</button>
        </div>

        <!-- WORKFLOW 2: From Text -->
        <div id="text-generator-workflow" class="hidden">
            <button class="btn btn-secondary back-to-selection-btn" style="margin-bottom: 1.5rem;">&larr; Back to Options</button>
            <div class="step-header-container">
              <h3 class="step-header">Step 1: Provide Your Text</h3>
              <div class="guide-container">
                  <button class="btn guide-btn" data-guide-id="text-step1" title="Show Guide">💁</button>
                  <span class="guide-help-text">How to use</span>
              </div>
            </div>
            <div class="input-group"><label for="source-text-text" class="input-label">Paste your source text below</label><textarea id="source-text-text" placeholder="Paste the content you want to create a quiz from..."></textarea></div>
            <div class="step-header-container">
              <h3 class="step-header">Step 2: Define Your Quiz</h3>
              <div class="guide-container">
                  <button class="btn guide-btn" data-guide-id="text-step2" title="Show Guide">💁</button>
                  <span class="guide-help-text">How to use</span>
              </div>
            </div>
            <div class="input-group"><label for="prompt-subject-text" class="input-label">Subject Area (Required)</label><input type="text" id="prompt-subject-text" class="input-field" placeholder="e.g., Physics, Literature" required></div>
            <div class="input-group"><label for="prompt-num-questions-text" class="input-label">Number of Questions</label><input type="number" id="prompt-num-questions-text" class="input-field" placeholder="e.g., 5" min="1" max="50"></div>
            <div class="input-group"><label for="prompt-instructions-text" class="input-label">Specific Instructions (Optional)</label><input type="text" id="prompt-instructions-text" class="input-field" placeholder="e.g., Generate similar questions on the above formula."></div>
            <div class="input-group"><label for="prompt-language-text" class="input-label">Quiz Language</label><select id="prompt-language-text" class="input-field"><option value="English" selected>English</option><option value="Hindi">Hindi</option><option value="Spanish">Spanish</option><option value="French">French</option><option value="German">German</option></select></div>
            <div class="input-group"><label for="prompt-difficulty-text" class="input-label">Difficulty Level</label><select id="prompt-difficulty-text" class="input-field"><option value="Easy">Easy</option><option value="Medium" selected>Medium</option><option value="Hard">Hard</option><option value="Expert">Expert</option></select></div>
            <div class="input-group"><label for="question-format-select-text" class="input-label">Question Format</label><select id="question-format-select-text" class="input-field"></select></div>
            <div class="input-group"><label class="input-label">Target Exam (Optional)</label><div class="exam-buttons-container"></div><input type="text" class="prompt-exam-other input-field hidden" id="prompt-exam-other-text" placeholder="Enter custom exam name" style="margin-top: 10px;"></div>
            <button id="generate-prompt-btn-text" class="btn btn-full-width glowing">Start 🚀</button>
            <button class="btn btn-secondary btn-full-width back-to-selection-btn" style="margin-top: 1rem;">↩️ Back to Main Menu</button>
        </div>

        <!-- WORKFLOW 3: From Image -->
        <div id="image-generator-workflow" class="hidden">
            <button class="btn btn-secondary back-to-selection-btn" style="margin-bottom: 1.5rem;">&larr; Back to Options</button>

            <div id="image-format-guide" class="hidden">
                <div class="guide-card good">
                    <h5>✅ Good Example</h5>
                    <svg viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg">
                        <rect x="5" y="5" width="90" height="110" rx="5" fill="var(--component-bg)" stroke="var(--correct-color)" stroke-width="3"/>
                        <path d="M20 25 h60 M20 40 h60 M20 55 h60 M20 70 h40 M20 85 h60" stroke="var(--text-color)" stroke-width="2" />
                    </svg>
                    <p>Image is <strong>upright</strong> (portrait) and the text is <strong>clear</strong>.</p>
                </div>
                <div class="guide-card bad">
                    <h5>❌ Bad Example</h5>
                    <svg viewBox="0 0 120 100" xmlns="http://www.w3.org/2000/svg">
                        <rect x="5" y="5" width="110" height="90" rx="5" fill="var(--component-bg)" stroke="var(--incorrect-color)" stroke-width="3"/>
                        <path d="M25 20 v60 M40 20 v60 M55 20 v60 M70 20 v40 M85 20 v60" stroke="var(--text-color)" stroke-width="2" stroke-dasharray="3 3"/>
                    </svg>
                    <p>Image is <strong>sideways</strong> (landscape) or the text is <strong>blurry</strong>.</p>
                </div>
            </div>

            <div class="step-header-container">
              <h3 class="step-header">Step 1: Add Your Images of Notes/ Question</h3>
              <div class="guide-container">
                  <button class="btn guide-btn" data-guide-id="image-step1" title="Show Guide">💁</button>
                  <span class="guide-help-text">How to use</span>
              </div>
            </div>
            <p>Select your images. Orientation will be corrected and text will be extracted automatically.</p>
            <div id="image-input-area"><button id="select-images-btn" class="btn btn-secondary">📂 Select Images</button><input type="file" id="image-file-input" multiple accept="image/*" class="hidden"></div>
            <div id="image-preview-container"></div>

            <button id="extract-text-btn" class="btn btn-full-width hidden" style="margin-top: 1.5rem;">🔍 Extract Text from Images</button>
            <div id="ocr-status"></div>

            <div id="image-quiz-definition-area" class="hidden fade-in-slide-up">
                <div class="step-header-container">
                  <h3 class="step-header">Step 2: Define Your Quiz</h3>
                  <div class="guide-container">
                      <button class="btn guide-btn" data-guide-id="image-step3" title="Show Guide">💁</button>
                      <span class="guide-help-text">How to use</span>
                  </div>
                </div>
                <div class="input-group hidden"><label for="source-text-image" class="input-label">Extracted Text</label><textarea id="source-text-image"></textarea></div>
                <div class="input-group"><label for="prompt-subject-image" class="input-label">Subject Area (Optional)</label><input type="text" id="prompt-subject-image" class="input-field" placeholder="e.g., Biology from textbook page"></div>
                <div class="input-group"><label for="prompt-num-questions-image" class="input-label">Number of Questions</label><input type="number" id="prompt-num-questions-image" class="input-field" placeholder="e.g., 5" min="1" max="50"></div>
                <div class="input-group"><label for="prompt-instructions-image" class="input-label">Specific Instructions (Optional)</label><input type="text" id="prompt-instructions-image" class="input-field" placeholder="e.g., Generate new questions on Photosynthesis"></div>
                <div class="input-group"><label for="prompt-language-image" class="input-label">Quiz Language</label><select id="prompt-language-image" class="input-field"><option value="English" selected>English</option><option value="Hindi">Hindi</option><option value="Spanish">Spanish</option><option value="French">French</option><option value="German">German</option></select></div>
                <div class="input-group"><label for="prompt-difficulty-image" class="input-label">Difficulty Level</label><select id="prompt-difficulty-image" class="input-field"><option value="Easy">Easy</option><option value="Medium" selected>Medium</option><option value="Hard">Hard</option><option value="Expert">Expert</option></select></div>
                <div class="input-group"><label for="question-format-select-image" class="input-label">Question Format</label><select id="question-format-select-image" class="input-field"></select></div>
                <div class="input-group"><label class="input-label">Target Exam (Optional)</label><div class="exam-buttons-container"></div><input type="text" class="prompt-exam-other input-field hidden" id="prompt-exam-other-image" placeholder="Enter custom exam name" style="margin-top: 10px;"></div>
                <button id="generate-prompt-btn-image" class="btn btn-full-width glowing">Start 🚀</button>
                <button class="btn btn-secondary btn-full-width back-to-selection-btn" style="margin-top: 1rem;">↩️ Back to Main Menu</button>
            </div>
        </div>

        <!-- WORKFLOW 4: From PDF -->
        <div id="pdf-generator-workflow" class="hidden">
            <button class="btn btn-secondary back-to-selection-btn" style="margin-bottom: 1.5rem;">&larr; Back to Options</button>
            <div class="step-header-container">
              <h3 class="step-header">Step 1: Upload & Extract</h3>
              <div class="guide-container">
                  <button class="btn guide-btn" data-guide-id="pdf-step1" title="Show Guide">💁</button>
                  <span class="guide-help-text">How to use</span>
              </div>
            </div>
            <div id="pdf-input-area">
                <button id="select-pdf-btn" class="btn btn-secondary">📂 Select PDF</button>
                <input type="file" id="pdf-file-input" accept=".pdf" class="hidden">
                <span id="pdf-file-name" style="align-self: center; margin-left: 15px; font-style: italic;"></span>
            </div>
            <div id="pdf-options-container" class="hidden fade-in-slide-up">
                <div class="input-group">
                    <label class="input-label">Extraction Options</label>
                    <label><input type="radio" name="pdf-page-option" id="pdf-page-option-all" value="all" checked> Extract All Pages</label><br>
                    <label><input type="radio" name="pdf-page-option" id="pdf-page-option-range" value="range"> Extract Page Range</label>
                    <div id="pdf-page-range-selector" class="hidden" style="margin-top: 10px;">
                        <div class="page-range-container">
                            <label for="pdf-page-from">From:</label>
                            <input type="number" id="pdf-page-from" class="input-field" min="1">
                            <label for="pdf-page-to">To:</label>
                            <input type="number" id="pdf-page-to" class="input-field" min="1">
                        </div>
                    </div>
                </div>
                <div class="input-group">
                    <label><input type="checkbox" id="pdf-force-ocr" checked> Force OCR (for scanned or image-based PDFs)</label>
                </div>
                <button id="extract-text-pdf-btn" class="btn btn-full-width">🔍 Extract Text from PDF</button>
                <div id="pdf-status"></div>
            </div>
             <div id="pdf-quiz-definition-area" class="hidden fade-in-slide-up">
                <div class="step-header-container">
                  <h3 class="step-header">Step 2: Define Your Quiz</h3>
                  <div class="guide-container">
                      <button class="btn guide-btn" data-guide-id="pdf-step2" title="Show Guide">💁</button>
                      <span class="guide-help-text">How to use</span>
                  </div>
                </div>
                <div class="input-group hidden"><label for="source-text-pdf" class="input-label">Extracted Text</label><textarea id="source-text-pdf"></textarea></div>
                <div class="input-group"><label for="prompt-topic-pdf" class="input-label">Quiz Topic (Optional, will be inferred from PDF)</label><input type="text" id="prompt-topic-pdf" class="input-field" placeholder="e.g., History of Ancient Rome"></div>
                <div class="input-group"><label for="prompt-subject-pdf" class="input-label">Subject Area (Optional)</label><input type="text" id="prompt-subject-pdf" class="input-field" placeholder="e.g., History, Science"></div>
                <div class="input-group"><label for="prompt-num-questions-pdf" class="input-label">Number of Questions</label><input type="number" id="prompt-num-questions-pdf" class="input-field" placeholder="e.g., 10" min="1" max="50"></div>
                <div class="input-group"><label for="prompt-language-pdf" class="input-label">Quiz Language</label><select id="prompt-language-pdf" class="input-field"><option value="English" selected>English</option><option value="Hindi">Hindi</option><option value="Spanish">Spanish</option><option value="French">French</option><option value="German">German</option></select></div>
                <div class="input-group"><label for="prompt-difficulty-pdf" class="input-label">Difficulty Level</label><select id="prompt-difficulty-pdf" class="input-field"><option value="Easy">Easy</option><option value="Medium" selected>Medium</option><option value="Hard">Hard</option><option value="Expert">Expert</option></select></div>
                <div class="input-group"><label for="question-format-select-pdf" class="input-label">Question Format</label><select id="question-format-select-pdf" class="input-field"></select></div>
                <div class="input-group"><label class="input-label">Target Exam (Optional)</label><div class="exam-buttons-container"></div><input type="text" class="prompt-exam-other input-field hidden" id="prompt-exam-other-pdf" placeholder="Enter custom exam name" style="margin-top: 10px;"></div>
                <button id="generate-prompt-btn-pdf" class="btn btn-full-width glowing">Start 🚀</button>
                <button class="btn btn-secondary btn-full-width back-to-selection-btn" style="margin-top: 1rem;">↩️ Back to Main Menu</button>
            </div>
        </div>
    </div>
</div>

<!-- ======================================= -->
<!-- ===== NEW: MULTIPLAYER LOBBY ====== -->
<!-- ======================================= -->
<div class="container hidden" id="multiplayer-lobby">
    <div class="header">
        <span class="header-branding">👥 <strong>Practice with Friends</strong></span>
    </div>

    <!-- Step 1: Main setup (Host/Join) -->
    <div id="room-selection">
        <div id="multiplayer-setup-container">
            <!-- Host Panel -->
            <div id="host-setup" class="multiplayer-setup-panel">
                <h4>Host a Study Room</h4>
                <div class="input-group">
                    <label for="host-name" class="input-label">Your Name (Host)</label>
                    <input type="text" id="host-name" class="input-field" placeholder="Enter your name">
                </div>
                <div class="input-group">
                    <label for="host-time-limit" class="input-label">Time Limit</label>
                    <select id="host-time-limit" class="input-field">
                        <option value="300">5 Minutes</option>
                        <option value="600" selected>10 Minutes</option>
                        <option value="900">15 Minutes</option>
                        <option value="1200">20 Minutes</option>
                        <option value="1800">30 Minutes</option>
                    </select>
                </div>
                <button id="create-room-btn" class="btn btn-primary btn-full-width">Create a Study Room</button>
            </div>
            <!-- User/Join Panel -->
            <div id="user-join-setup" class="multiplayer-setup-panel">
                <h4>Join a Study Room</h4>
                <div class="input-group">
                    <label for="player-name" class="input-label">Your Name</label>
                    <input type="text" id="player-name" class="input-field" placeholder="Enter your name to join">
                </div>
                <div class="input-group">
                    <label for="join-game-code" class="input-label">Enter Study Code</label>
                    <input type="text" id="join-game-code" class="input-field" placeholder="Paste the 6-digit code">
                </div>
                <button id="join-game-btn" class="btn btn-secondary btn-full-width">Join Study Room</button>
            </div>
        </div>
        <button class="btn btn-secondary back-to-main-menu-btn fire-animation" style="margin-top: 2rem; max-width: 400px; margin-left: auto; margin-right: auto;">&larr; Back to Main Menu</button>
    </div>

    <!-- Step 2: Room Lobby/Waiting Screen -->
    <div id="room-lobby" class="hidden">
        <div class="lobby-info">
             <p><strong>Topic:</strong> <span id="room-topic-display">Waiting for host to create quiz...</span></p>
             <p><strong>Time Limit:</strong> <span id="room-time-limit-display">Waiting...</span></p>
        </div>

        <div class="room-code-container">
            <span>Room Code:</span>
            <strong id="room-code-display"></strong>
            <button id="share-code-btn" class="btn btn-secondary">🔗 Share Code</button>
        </div>
        <h4>Participants (<span id="participant-count">1</span>/5)</h4>
        <ul id="participant-list"></ul>

        <p id="waiting-message" style="font-style: italic; margin-top: 1rem;">Waiting for the host to start the game...</p>

        <!-- Host Controls -->
        <div id="host-controls" class="hidden">
            <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 2rem 0;">
            <h4>Host Actions</h4>
            <p>As the host, you can now generate the quiz for everyone in the room.</p>
            <button id="host-generate-quiz-btn" class="btn btn-primary btn-full-width">✨ Create Quiz for the Room</button>
        </div>

        <button class="btn btn-danger back-to-main-menu-btn fire-animation" style="margin-top: 2rem;">Leave Room</button>
    </div>
</div>

<!-- ======================================= -->
<!-- ===== HOST QUIZ GENERATION VIEW ====== -->
<!-- ======================================= -->
<div id="host-quiz-generation-view" class="hidden">
     <button class="modal-close-btn-top" id="close-host-view-btn" title="Close" style="position: absolute; top: 20px; right: 20px;">&times;</button>
    <h3>Create the Quiz</h3>
    <p>Select a method to generate the quiz. This quiz will be shared with all participants.</p>

    <div id="host-creation-method-selector">
         <div class="creation-option-card" id="host-select-from-topic">
            <span class="card-icon">📝</span><h4>From Topic</h4>
        </div>
        <div class="creation-option-card" id="host-select-from-text">
            <span class="card-icon">📋</span><h4>From Text</h4>
        </div>
        <div class="creation-option-card" id="host-select-from-image">
            <span class="card-icon">🖼️</span><h4>From Image</h4>
        </div>
        <div class="creation-option-card" id="host-select-from-pdf">
            <span class="card-icon">📄</span><h4>From PDF</h4>
        </div>
    </div>

    <div id="host-generator-workflow-container-wrapper" class="hidden">
        <div id="host-generator-workflow-container"></div>
    </div>
</div>


<!-- ======================================= -->
<!-- ===== PASTE CONTAINER (STEP 2) ====== -->
<!-- ======================================= -->
<div class="container hidden" id="paste-quiz-container">
    <div class="header">
        <span class="header-branding">✍️ <strong>EXAMYATRI</strong> - <span id="paste-container-tagline">Quiz Se Kro Success Yatra</span></span>
    </div>
    <p id="paste-container-message" style="text-align: center; font-size: 1.1em;"><b>Welcome back!</b> I'm now waiting for the quiz text from the AI.</p>

    <div id="ai-link-fallback" class="hidden">
        <p>⚠️ It looks like the AI tab was blocked by your browser.</p>
        <a href="https://gemini.google.com" target="_blank" class="btn">Click Here to Open Gemini Manually</a>
    </div>

    <div class="input-group">
        <div class="input-label-group">
            <label for="quiz-data-input" class="input-label">Paste AI response here</label>
        </div>
        <textarea id="quiz-data-input" placeholder="I'll try to paste and start automatically when you return to this tab. If that doesn't work, just click into this box."></textarea>
    </div>
    <button id="start-manual-quiz-btn" class="btn btn-full-width">Parse & Start Quiz! 🧠</button>
</div>


<!-- QUIZ PLAYER & RESULTS -->
<div class="container hidden" id="quiz-player-container">
    <div id="quiz-header">
        <span id="question-topic"></span>
        <span id="timer">
            <span class="timer-face" id="face-happy">😊</span>
            <span class="timer-face" id="face-worried">😟</span>
            <span class="timer-face" id="face-sad">😥</span>
            <span class="timer-face" id="face-crying">😭</span>
            <span id="timer-text">00:00</span>
        </span>
        <span id="progress"></span>
        <!-- NEW: Pressure Mode UI -->
        <div id="pressure-mode-container">
            <button id="pressure-mode-toggle-btn" title="Mental Pressure Settings">⏰</button>
            <span id="pressure-text-animation" class="hidden"></span>
            <div id="pressure-mode-controls" class="hidden">
                <label>
                    <span class="switch"><input type="checkbox" id="shake-reminder-toggle"><span class="slider"></span></span>
                    Shake Button Reminder
                </label>
            </div>
        </div>
    </div>
    <div id="question-image-container" class="hidden"></div>
    <div id="question-and-bookmark">
        <div id="question-text-container">
            <p id="question-text"></p>
            <div id="statements-list"></div>
        </div>
        <button id="bookmark-btn" title="Bookmark Question">⭐</button>
    </div>
    <div id="options-container"></div>
    <div id="explanation-container" class="hidden">
        <h4>Explanation</h4>
        <p id="explanation-text"></p>
    </div>
    <div id="quiz-actions"></div>
</div>
<div class="container hidden" id="results-screen">
    <div class="header"><h2>🏆 Quiz Results</h2></div>
    <div id="score-summary"></div>
    <!-- NEW: Wrapper for Chart and Details -->
    <div id="results-summary-wrapper">
        <div id="score-performance-chart-container"></div>
        <div id="quiz-summary-details"></div>
    </div>
    <div class="share-buttons">
        <div class="share-buttons-row">
            <button id="share-pdf-btn" class="btn">📄 Download PDF</button>
            <button id="copy-bookmarks-btn" class="btn" style="background-color: var(--bookmarked-active-color);">⭐ Copy Bookmarked</button>
            <button id="copy-all-btn" class="btn">📋 Copy All</button>
            <button id="share-whatsapp-btn" class="btn" style="background-color: #25D366;">💬 Share on WhatsApp</button>
            <button id="share-site-btn" class="btn" style="background-color: #5865f2;">📢 Share Website</button>
            <button id="restart-quiz-btn" class="btn">🔄 Take Another Quiz</button>
        </div>
        <div id="results-page-telegram-opener">
            <div class="telegram-input-group">
                <input type="text" id="results-page-telegram-input" class="input-field" placeholder="Enter Telegram channel username...">
                <button id="results-page-open-telegram-btn" class="btn btn-secondary">Open</button>
            </div>
        </div>
        <div id="telegram-backup-guide-container">
            <button id="telegram-backup-guide-btn" title="How to backup on Telegram">🤔</button>
            <p>how to backup this bookmark question on telegram for future revision</p>
        </div>
    </div>

    <!-- HOST CONTROLS FOR RESULTS SCREEN (NOW A MODAL) -->
    <div id="host-results-controls-placeholder"></div>

    <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 2rem 0;">
    <h3 >Review Your Answers:</h3>
    <div id="results-review"></div>
</div>

<!-- MODALS -->
<div id="manual-copy-modal-overlay" class="modal-overlay hidden"><div id="manual-copy-modal-content" class="modal-content"><h3>Automatic Copy Failed</h3><p>Please manually copy the text below (it's already selected for you):</p><textarea id="manual-copy-textarea" readonly></textarea><button id="manual-copy-close-btn" class="btn">Close</button></div></div>
<div id="crop-modal-overlay" class="modal-overlay hidden">
    <div id="crop-modal-content" class="modal-content">
        <h3>Crop Image</h3>
        <div id="crop-image-container"><img id="image-to-crop" src="" alt="Image for cropping"></div>
        <div class="modal-actions"><button id="cancel-crop-btn" class="btn btn-secondary">Cancel</button><button id="save-crop-btn" class="btn">Crop & Save</button></div>
    </div>
</div>
<div id="flowchart-modal-overlay" class="modal-overlay hidden">
    <div class="modal-content">
        <button class="modal-close-btn-top" title="Close guide">&times;</button>
        <h3 id="flowchart-modal-title">Step Guide</h3>
        <div id="flowchart-modal-content">
            <!-- Text-based guide will be injected here -->
        </div>
        <div class="modal-actions">
            <button id="flowchart-modal-close-btn" class="btn">Got It!</button>
        </div>
    </div>
</div>
<div id="telegram-backup-modal-overlay" class="modal-overlay hidden">
    <div class="modal-content">
        <button class="modal-close-btn-top" title="Close guide">&times;</button>
        <h3>How to Backup on Telegram</h3>
        <div id="telegram-backup-modal-content" class="guide-step">
            <p><strong>Step 1: Create a Telegram Channel</strong><br>Open Telegram, create a "New Channel". Make sure you set it to "Public" and give it a unique, easy-to-remember username (e.g., "my_upsc_notes_123").</p>
            <p><strong>Step 2: Copy Questions from EXAMYATRI</strong><br>On this results page, click the "⭐ Copy Bookmarked" or "📋 Copy All" button. This copies the text to your clipboard.</p>
            <p><strong>Step 3: Enter Username & Open</strong><br>Type the channel username you created (e.g., "my_upsc_notes_123") into the box above the 🤔 button and click "Open".</p>
            <p><strong>Step 4: Paste and Save</strong><br>This will open your channel in Telegram. Just paste the copied questions into the message box and send. Your notes are now saved!</p>
        </div>
        <div class="modal-actions">
            <button id="telegram-backup-close-btn" class="btn">Okay, I Understand</button>
        </div>
    </div>
</div>

<!-- PERMISSION MODAL -->
<div id="clipboard-permission-modal-overlay" class="modal-overlay hidden">
    <div id="clipboard-permission-modal-content" class="modal-content">
        <h3>✨ Automation Helper</h3>
        <p>To make things super fast, this website can automatically paste the quiz text for you when you return from the AI.</p>
        <p>For this to work, I need your permission to read text from your clipboard. I will only do this when you're on this page and only to find quiz text.</p>
        <div class="modal-actions">
            <button id="deny-clipboard-btn" class="btn btn-secondary">No, I'll paste manually</button>
            <button id="grant-clipboard-btn" class="btn">Yes, allow auto-pasting</button>
        </div>
    </div>
</div>

<!-- NEW: Gemini Instructions Modal -->
<div id="gemini-instructions-modal-overlay" class="modal-overlay hidden">
    <div class="modal-content">
        <h3>Ready for AI Magic? ✨</h3>
        <div id="gemini-instructions-content-wrapper">
            <div class="guide-step">
                <strong>1️⃣ When Gemini opens:</strong>
                <p>Just paste the instructions into the message box and hit send.</p>
            </div>
            <div class="guide-step">
                <strong>2️⃣ Copy the Generated Questions:</strong>
                <p>Once the AI finishes, copy the entire response.</p>
                <ul style="padding-left: 20px; margin-top: 0.5em; font-size: 0.9em;">
                    <li><strong>Method 1:</strong> Tap on 3 Vertical Dots (⋮) at the start of the generated question.</li>
                    <li><strong>Method 2:</strong> Tap the Copy Icon (📋) at the end of the generated question.</li>
                </ul>
            </div>
             <div class="guide-step">
                <strong>3️⃣ Return to Examyatri:</strong>
                <p>Come back to this tab to start the quiz.</p>
                 <ul style="padding-left: 20px; margin-top: 0.5em; font-size: 0.9em;">
                    <li><strong>Method 1:</strong> Press your device's 'Back' button twice.</li>
                    <li><strong>Method 2:</strong> Manually switch tabs from Gemini back to Examyatri.</li>
                </ul>
            </div>
        </div>
        <div class="modal-actions" style="justify-content: center;">
            <button id="open-gemini-btn" class="btn btn-full-width fire-animation">Got it and Open Gemini Now ➜</button>
        </div>
    </div>
</div>

<!-- NEW: Host Decision Modal -->
<div id="host-decision-modal-overlay" class="modal-overlay hidden">
    <div class="modal-content">
        <h3>What's Next, Host?</h3>
        <p>The room will close automatically in:</p>
        <span id="host-decision-timer">20</span>
        <div id="host-decision-actions" class="modal-actions">
            <button id="restart-multiplayer-quiz-btn" class="btn" style="background-color: var(--multiplayer-accent);">🔄 Start New Quiz</button>
            <button id="end-room-btn" class="btn btn-danger fire-animation">🚪 End Room for All</button>
        </div>
    </div>
</div>


<!-- SCRIPTS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;</script>
<script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<script type="module">
    // Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, get, serverTimestamp, onDisconnect, remove, update } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    // --- UPDATED FIREBASE CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyBlCQwYIgrL5HBh5EyKLqBpB0S8X1MLzpU",
      authDomain: "examyatri-a6e8f.firebaseapp.com",
      databaseURL: "https://examyatri-a6e8f-default-rtdb.firebaseio.com",
      projectId: "examyatri-a6e8f",
      storageBucket: "examyatri-a6e8f.appspot.com",
      messagingSenderId: "779046225357",
      appId: "1:779046225357:web:2752c7bbec7968537ab084",
      measurementId: "G-6TRQV2MHYB"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

document.addEventListener('DOMContentLoaded', () => {

    // --- CONSTANTS ---
    const QUESTION_FORMATS = {
        'mcq': { name: 'Multiple Choice (MCQ)' },
        'statement': { name: 'Statement-Based' },
        'assertion-reason': { name: 'Assertion-Reason' },
        'true-false': { name: 'True/False' },
        'math-physics': { name: 'Maths, Physics, or Other Questions'},
        'fill-blank': { name: 'Fill-in-the-Blank' },
        'mix': { name: 'Mixed Format' }
    };
    const MAX_PARTICIPANTS = 5;
    const HOST_DATA_KEY = 'examyatriHostData';

    const commonGuideAfterInput = `
        <div class="guide-step">
            <strong>Step 2: Fill Quiz Details</strong>
            <p>Fill in the details like Number of Questions, Subject, Language, Difficulty, Exam, and Question Format.</p>
            <p class="hindi-text">(चरण 2: क्विज़ का विवरण भरें - प्रश्नों की संख्या, विषय, भाषा, कठिनाई, परीक्षा और प्रश्न प्रारूप जैसे विवरण भरें।)</p>
        </div>
        <div class="guide-step">
            <strong>Step 3: Generate Prompt & Open AI</strong>
            <p>Click the big "Start 🚀" button. This automatically copies the instructions for the AI and opens the Gemini website in a new tab.</p>
            <p class="hindi-text">(चरण 3: 'Start 🚀' बटन पर क्लिक करें - यह AI के लिए निर्देश अपने आप कॉपी कर लेगा और एक नए टैब में Gemini वेबसाइट खोल देगा।)</p>
        </div>
        <div class="guide-step">
            <strong>Step 4: Use the AI (Gemini)</strong>
            <p>In the Gemini website, just paste the prompt into the message box and send it. Wait for the AI to generate all the questions.</p>
            <p class="hindi-text">(चरण 4: AI (Gemini) का उपयोग करें - Gemini वेबसाइट में, बस प्रॉम्प्ट को मैसेज बॉक्स में पेस्ट करें और भेजें। AI द्वारा सभी प्रश्न बनाने तक प्रतीक्षा करें।)</p>
        </div>
        <div class="guide-step">
            <strong>Step 5: Copy AI's Response</strong>
            <p>After the questions are generated, copy the entire response. There are two ways to copy from Gemini: 1) Click the copy icon (like a clipboard 📋) below the answer. 2) Click the three dots (...) at the top-right of the response and select 'Copy'.</p>
            <p class="hindi-text">(चरण 5: AI की प्रतिक्रिया कॉपी करें - प्रश्न बन जाने के बाद, पूरी प्रतिक्रिया कॉपी करें। Gemini से कॉपी करने के 2 तरीके हैं: 1) उत्तर के नीचे कॉपी आइकन (📋) पर क्लिक करें। 2) प्रतिक्रिया के ऊपर-दाईं ओर तीन डॉट्स (...) पर क्लिक करें और 'कॉपी करें' चुनें।)</p>
        </div>
        <div class="guide-step">
            <strong>Step 6: Return to Examyatri</strong>
            <p>You have two choices: 1) Simply switch tabs from Gemini back to examyatri. 2) On mobile, you can press your phone's 'Back' navigation button twice. The quiz will be created automatically!</p>
            <p class="hindi-text">(चरण 6: Examyatri पर वापस आएं - आपके पास 2 विकल्प हैं: 1) बस Gemini से Gemini टैब पर वापस स्विच करें। 2) मोबाइल पर, आप अपने फोन का 'बैक' नेविगेशन बटन दो बार दबा सकते हैं। क्विज़ अपने आप बन जाएगा!)</p>
        </div>
    `;

    const GUIDE_DATA = {
        'topic-step1': {
            title: 'Guide: Create Quiz from Topic',
            content: `
                <div class="guide-step">
                    <strong>Step 1: Enter Your Topic</strong>
                    <p>First, fill in the "Quiz Topic" field. For example: "World War II" or "Solar System".</p>
                    <p class="hindi-text">(चरण 1: अपना विषय दर्ज करें - सबसे पहले, "Quiz Topic" फ़ील्ड भरें। उदाहरण के लिए: "द्वितीय विश्व युद्ध" या "सौर मंडल"।)</p>
                </div>
                ${commonGuideAfterInput}
            `
        },
        'text-step1': {
            title: 'Guide: Create Quiz from Text',
            content: `
                <div class="guide-step">
                    <strong>Step 1: Paste Your Text</strong>
                    <p>Find any article, notes, or paragraph you want to make a quiz from. Copy that text and paste it into the big text box here.</p>
                    <p class="hindi-text">(चरण 1: अपना टेक्स्ट पेस्ट करें - कोई भी लेख, नोट्स या पैराग्राफ खोजें जिससे आप क्विज़ बनाना चाहते हैं। उस टेक्स्ट को कॉपी करें और यहां बड़े टेक्स्ट बॉक्स में पेस्ट करें।)</p>
                </div>
                ${commonGuideAfterInput}
            `
        },
        'text-step2': {
            title: 'Guide: Create Quiz from Text',
            content: `
                <div class="guide-step">
                    <strong>Step 1: Paste Your Text</strong>
                    <p>Find any article, notes, or paragraph you want to make a quiz from. Copy that text and paste it into the big text box here.</p>
                    <p class="hindi-text">(चरण 1: अपना टेक्स्ट पेस्ट करें - कोई भी लेख, नोट्स या पैराग्राफ खोजें जिससे आप क्विज़ बनाना चाहते हैं। उस टेक्स्ट को कॉपी करें और यहां बड़े टेक्स्ट बॉक्स में पेस्ट करें।)</p>
                </div>
                ${commonGuideAfterInput}
            `
        },
        'image-step1': {
            title: 'Guide: Create Quiz from Image',
            content: `
                <div class="guide-step">
                    <strong>Step 1: Upload Your Images</strong>
                    <p>Click "Select Images" and choose pictures of your book pages or notes. The app will automatically detect the correct text orientation and extract the text for you.</p>
                    <p class="hindi-text">(चरण 1: अपनी इमेज अपलोड करें - "Select Images" पर क्लिक करें और अपनी किताब के पन्नों या नोट्स की तस्वीरें चुनें। ऐप अपने आप टेक्स्ट की सही दिशा का पता लगा लेगा और आपके लिए टेक्स्ट निकाल देगा।)</p>
                </div>
                ${commonGuideAfterInput}
            `
        },
        'image-step3': {
            title: 'Guide: Create Quiz from Image',
            content: `
                 <div class="guide-step">
                    <strong>Step 1: Upload Your Images</strong>
                    <p>Click "Select Images" and choose pictures of your book pages or notes. The app will automatically detect the correct text orientation and extract the text for you.</p>
                    <p class="hindi-text">(चरण 1: अपनी इमेज अपलोड करें - "Select Images" पर क्लिक करें और अपनी किताब के पन्नों या नोट्स की तस्वीरें चुनें। ऐप अपने आप टेक्स्ट की सही दिशा का पता लगा लेगा और आपके लिए टेक्स्ट निकाल देगा।)</p>
                </div>
                ${commonGuideAfterInput}
            `
        },
        'pdf-step1': {
            title: 'Guide: Create Quiz from PDF',
            content: `
                <div class="guide-step">
                    <strong>Step 1: Select Your PDF</strong>
                    <p>Click "Select PDF" and choose the PDF file from your phone or computer.</p>
                    <p class="hindi-text">(चरण 1: अपनी PDF चुनें - "Select PDF" पर क्लिक करें और अपने फोन या कंप्यूटर से PDF फाइल चुनें।)</p>
                </div>
                <div class="guide-step">
                    <strong>Step 2: Choose Options & Extract Text</strong>
                    <p>You can extract all pages or a specific range. <strong>Important:</strong> If your PDF is a scanned copy or has images of text, check the "Force OCR" box for best results. Then click "Extract Text from PDF".</p>
                    <p class="hindi-text">(चरण 2: विकल्प चुनें और टेक्स्ट निकालें - आप सभी पृष्ठ या एक विशिष्ट रेंज निकाल सकते हैं। <strong>महत्वपूर्ण:</strong> यदि आपकी PDF एक स्कैन की हुई कॉपी है या उसमें टेक्स्ट की तस्वीरें हैं, तो सर्वोत्तम परिणामों के लिए "Force OCR" बॉक्स को चेक करें। फिर "Extract Text from PDF" पर क्लिक करें।)</p>
                </div>
                ${commonGuideAfterInput}
            `
        },
        'pdf-step2': {
            title: 'Guide: Create Quiz from a PDF',
            content: `
               <div class="guide-step">
                    <strong>Step 1: Select Your PDF</strong>
                    <p>Click "Select PDF" and choose the PDF file from your phone or computer.</p>
                    <p class="hindi-text">(चरण 1: अपनी PDF चुनें - "Select PDF" पर क्लिक करें और अपने फोन या कंप्यूटर से PDF फाइल चुनें।)</p>
                </div>
                <div class="guide-step">
                    <strong>Step 2: Choose Options & Extract Text</strong>
                    <p>You can extract all pages or a specific range. <strong>Important:</strong> If your PDF is a scanned copy or has images of text, check the "Force OCR" box for best results. Then click "Extract Text from PDF".</p>
                    <p class="hindi-text">(चरण 2: विकल्प चुनें और टेक्स्ट निकालें - आप सभी पृष्ठ या एक विशिष्ट रेंज निकाल सकते हैं। <strong>महत्वपूर्ण:</strong> यदि आपकी PDF एक स्कैन की हुई कॉपी है या उसमें टेक्स्ट की तस्वीरें हैं, तो सर्वोत्तम परिणामों के लिए "Force OCR" बॉक्स को चेक करें। फिर "Extract Text from PDF" पर क्लिक करें।)</p>
                </div>
                ${commonGuideAfterInput}
            `
        }
    };

    // --- ADDED FOR STATE PERSISTENCE ---
    const FORM_STATE_KEY = 'examyatriFormState';
    const SCROLL_POS_KEY = 'examyatriScrollPos';
    // --- END ---

    // --- DOM ELEMENT DICTIONARY ---
    const elements = {
        // Main Containers
        loadingOverlay: document.getElementById('loading-overlay'),
        loadingText: document.getElementById('loading-text'),
        manualGeneratorContainer: document.getElementById('manual-generator-container'),
        pasteQuizContainer: document.getElementById('paste-quiz-container'),
        quizPlayerContainer: document.getElementById('quiz-player-container'),
        resultsScreen: document.getElementById('results-screen'),

        // Multiplayer Lobby
        multiplayerLobby: document.getElementById('multiplayer-lobby'),
        selectMultiplayerBtn: document.getElementById('select-multiplayer'),
        hostNameInput: document.getElementById('host-name'),
        hostTimeLimitInput: document.getElementById('host-time-limit'),
        playerNameInput: document.getElementById('player-name'),
        roomSelection: document.getElementById('room-selection'),
        createRoomBtn: document.getElementById('create-room-btn'),
        joinGameCodeInput: document.getElementById('join-game-code'),
        joinGameBtn: document.getElementById('join-game-btn'),
        roomLobby: document.getElementById('room-lobby'),
        roomTopicDisplay: document.getElementById('room-topic-display'),
        roomTimeLimitDisplay: document.getElementById('room-time-limit-display'),
        roomCodeDisplay: document.getElementById('room-code-display'),
        shareCodeBtn: document.getElementById('share-code-btn'),
        participantList: document.getElementById('participant-list'),
        participantCount: document.getElementById('participant-count'),
        waitingMessage: document.getElementById('waiting-message'),
        hostControls: document.getElementById('host-controls'),
        hostGenerateQuizBtn: document.getElementById('host-generate-quiz-btn'),
        roomFullNotification: document.getElementById('room-full-notification'),
        roomNotFoundNotification: document.getElementById('room-not-found-notification'),
        backToMainMenuBtns: document.querySelectorAll('.back-to-main-menu-btn'),


        // Host View
        hostQuizGenerationView: document.getElementById('host-quiz-generation-view'),
        hostCreationMethodSelector: document.getElementById('host-creation-method-selector'),
        hostGeneratorWorkflowContainerWrapper: document.getElementById('host-generator-workflow-container-wrapper'),
        hostGeneratorWorkflowContainer: document.getElementById('host-generator-workflow-container'),
        closeHostViewBtn: document.getElementById('close-host-view-btn'),


        // Generator Screen
        creationMethodSelector: document.getElementById('creation-method-selector'),
        selectFromTopicBtn: document.getElementById('select-from-topic'),
        selectFromTextBtn: document.getElementById('select-from-text'),
        selectFromImageBtn: document.getElementById('select-from-image'),
        selectFromPdfBtn: document.getElementById('select-from-pdf'),
        backToSelectionBtns: document.querySelectorAll('.back-to-selection-btn'),

        // Workflows
        topicGeneratorWorkflow: document.getElementById('topic-generator-workflow'),
        textGeneratorWorkflow: document.getElementById('text-generator-workflow'),
        imageGeneratorWorkflow: document.getElementById('image-generator-workflow'),
        pdfGeneratorWorkflow: document.getElementById('pdf-generator-workflow'),

        // Prompt Generation Buttons
        generatePromptBtnTopic: document.getElementById('generate-prompt-btn-topic'),
        generatePromptBtnText: document.getElementById('generate-prompt-btn-text'),
        generatePromptBtnImage: document.getElementById('generate-prompt-btn-image'),
        generatePromptBtnPdf: document.getElementById('generate-prompt-btn-pdf'),

        // Image Workflow
        imageFormatGuide: document.getElementById('image-format-guide'),
        selectImagesBtn: document.getElementById('select-images-btn'),
        imageFileInput: document.getElementById('image-file-input'),
        imagePreviewContainer: document.getElementById('image-preview-container'),
        extractTextBtn: document.getElementById('extract-text-btn'),
        ocrStatus: document.getElementById('ocr-status'),
        imageQuizDefinitionArea: document.getElementById('image-quiz-definition-area'),
        sourceTextImage: document.getElementById('source-text-image'),

        // PDF Workflow
        selectPdfBtn: document.getElementById('select-pdf-btn'),
        pdfFileInput: document.getElementById('pdf-file-input'),
        pdfFileName: document.getElementById('pdf-file-name'),
        pdfOptionsContainer: document.getElementById('pdf-options-container'),
        pdfPageRangeSelector: document.getElementById('pdf-page-range-selector'),
        pdfForceOcrCheckbox: document.getElementById('pdf-force-ocr'),
        extractTextPdfBtn: document.getElementById('extract-text-pdf-btn'),
        pdfStatus: document.getElementById('pdf-status'),
        pdfQuizDefinitionArea: document.getElementById('pdf-quiz-definition-area'),
        sourceTextPdf: document.getElementById('source-text-pdf'),

        // Paste & Parse Screen
        aiLinkFallback: document.getElementById('ai-link-fallback'),
        quizDataInput: document.getElementById('quiz-data-input'),
        startManualQuizBtn: document.getElementById('start-manual-quiz-btn'),
        pasteContainerTagline: document.getElementById('paste-container-tagline'),
        pasteContainerMessage: document.getElementById('paste-container-message'),


        // Quiz Player
        questionTopic: document.getElementById('question-topic'),
        progress: document.getElementById('progress'),
        timer: document.getElementById('timer'),
        timerText: document.getElementById('timer-text'),
        faces: { happy: document.getElementById('face-happy'), worried: document.getElementById('face-worried'), sad: document.getElementById('face-sad'), crying: document.getElementById('face-crying')},
        bookmarkBtn: document.getElementById('bookmark-btn'),
        questionText: document.getElementById('question-text'),
        statementsList: document.getElementById('statements-list'),
        optionsContainer: document.getElementById('options-container'),
        explanationContainer: document.getElementById('explanation-container'),
        explanationText: document.getElementById('explanation-text'),
        quizActions: document.getElementById('quiz-actions'),

        // Feedback & Pressure Mode Elements
        congratsAnimationContainer: document.getElementById('congrats-animation-container'),
        sadReactionOverlay: document.getElementById('sad-reaction-overlay'),
        sadReactionEmoji: document.getElementById('sad-reaction-emoji'),
        pressureModeToggleBtn: document.getElementById('pressure-mode-toggle-btn'),
        pressureModeControls: document.getElementById('pressure-mode-controls'),
        shakeReminderToggle: document.getElementById('shake-reminder-toggle'),

        // Results Screen
        scoreSummary: document.getElementById('score-summary'),
        scorePerformanceChartContainer: document.getElementById('score-performance-chart-container'),
        quizSummaryDetails: document.getElementById('quiz-summary-details'),
        resultsReview: document.getElementById('results-review'),
        sharePdfBtn: document.getElementById('share-pdf-btn'),
        copyBookmarksBtn: document.getElementById('copy-bookmarks-btn'),
        copyAllBtn: document.getElementById('copy-all-btn'),
        shareWhatsappBtn: document.getElementById('share-whatsapp-btn'),
        shareSiteBtn: document.getElementById('share-site-btn'),
        restartBtn: document.getElementById('restart-quiz-btn'),
        resultsPageTelegramInput: document.getElementById('results-page-telegram-input'),
        resultsPageOpenTelegramBtn: document.getElementById('results-page-open-telegram-btn'),
        telegramBackupGuideBtn: document.getElementById('telegram-backup-guide-btn'),

        // Modals
        pasteNotification: document.getElementById('paste-notification'),
        manualCopyModalOverlay: document.getElementById('manual-copy-modal-overlay'),
        manualCopyTextarea: document.getElementById('manual-copy-textarea'),
        manualCopyCloseBtn: document.getElementById('manual-copy-close-btn'),
        cropModalOverlay: document.getElementById('crop-modal-overlay'),
        imageToCrop: document.getElementById('image-to-crop'),
        cancelCropBtn: document.getElementById('cancel-crop-btn'),
        saveCropBtn: document.getElementById('save-crop-btn'),
        flowchartModalOverlay: document.getElementById('flowchart-modal-overlay'),
        flowchartModalTitle: document.getElementById('flowchart-modal-title'),
        flowchartModalContent: document.getElementById('flowchart-modal-content'),
        flowchartModalCloseBtn: document.getElementById('flowchart-modal-close-btn'),
        telegramBackupModalOverlay: document.getElementById('telegram-backup-modal-overlay'),
        telegramBackupCloseBtn: document.getElementById('telegram-backup-close-btn'),
        clipboardPermissionModalOverlay: document.getElementById('clipboard-permission-modal-overlay'),
        grantClipboardBtn: document.getElementById('grant-clipboard-btn'),
        denyClipboardBtn: document.getElementById('deny-clipboard-btn'),
        geminiInstructionsModalOverlay: document.getElementById('gemini-instructions-modal-overlay'),
        openGeminiBtn: document.getElementById('open-gemini-btn'),
        hostDecisionModalOverlay: document.getElementById('host-decision-modal-overlay'),
        hostDecisionTimer: document.getElementById('host-decision-timer'),
        endRoomBtn: document.getElementById('end-room-btn'),
        restartMultiplayerQuizBtn: document.getElementById('restart-multiplayer-quiz-btn'),

        // Misc
        themeToggleBtn: document.getElementById('theme-toggle-btn'),
    };

    // --- SESSION PRESERVATION (Quiz-in-progress ONLY) ---
    const dbHelper = {
        db: null,
        dbName: 'examyatriDB',
        storeName: 'sessionState',

        async init() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(this.dbName, 1);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(this.storeName)) {
                        db.createObjectStore(this.storeName);
                    }
                };
                request.onsuccess = (event) => {
                    this.db = event.target.result;
                    resolve(this.db);
                };
                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.error);
                    reject(event.target.error);
                };
            });
        },

        async set(key, value) {
            if (!this.db) await this.init();
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction([this.storeName], 'readwrite');
                const store = transaction.objectStore(this.storeName);
                const request = store.put(value, key);
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        },

        async get(key) {
            if (!this.db) await this.init();
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction([this.storeName], 'readonly');
                const store = transaction.objectStore(this.storeName);
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        },

        async clear() {
            if (!this.db) await this.init();
             return new Promise((resolve, reject) => {
                const transaction = this.db.transaction([this.storeName], 'readwrite');
                const store = transaction.objectStore(this.storeName);
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        }
    };

    // --- FORM & SCROLL PERSISTENCE ---
    function getPersistableInputs() {
        return document.querySelectorAll('#manual-generator-container input, #manual-generator-container textarea, #manual-generator-container select');
    }

    function saveFormState() {
        const state = {};
        const inputs = getPersistableInputs();
        inputs.forEach(input => {
            if (!input.id && !input.name) return;
            const key = input.id || input.name;
            switch (input.type) {
                case 'checkbox':
                    state[key] = input.checked;
                    break;
                case 'radio':
                    if (input.checked) {
                        state[input.name] = input.id;
                    }
                    break;
                default:
                    state[key] = input.value;
            }
        });

        const activeExamBtn = document.querySelector('.exam-btn.active');
        state['activeExamButton'] = activeExamBtn ? activeExamBtn.dataset.examName : '';

        localStorage.setItem(FORM_STATE_KEY, JSON.stringify(state));
    }

    function loadFormState() {
        const savedState = localStorage.getItem(FORM_STATE_KEY);
        if (!savedState) return;

        const state = JSON.parse(savedState);
        const inputs = getPersistableInputs();

        inputs.forEach(input => {
            if (!input.id && !input.name) return;
            const key = input.id || input.name;

            if (input.type === 'radio' && state[input.name]) {
                input.checked = (input.id === state[input.name]);
            } else if (state.hasOwnProperty(key)) {
                switch (input.type) {
                    case 'checkbox':
                        input.checked = state[key];
                        break;
                    default:
                        input.value = state[key];
                }
            }
        });

        document.querySelectorAll('.exam-btn').forEach(btn => btn.classList.remove('active'));
        if (state.activeExamButton) {
            const btnToActivate = document.querySelector(`.exam-btn[data-exam-name="${state.activeExamButton}"]`);
            if (btnToActivate) {
                btnToActivate.classList.add('active');
                const otherInput = btnToActivate.closest('.input-group').querySelector('.prompt-exam-other');
                if (otherInput) {
                    otherInput.classList.toggle('hidden', state.activeExamButton !== 'Other');
                }
            }
        }

        document.querySelectorAll('input[name="pdf-page-option"]').forEach(radio => {
            if (radio.checked) {
                elements.pdfPageRangeSelector.classList.toggle('hidden', radio.value !== 'range');
            }
        });
    }

    function clearFormState() {
        localStorage.removeItem(FORM_STATE_KEY);
        localStorage.removeItem(SCROLL_POS_KEY);
    }

    function saveScrollPosition() {
        if (elements.manualGeneratorContainer.offsetParent !== null) {
            localStorage.setItem(SCROLL_POS_KEY, window.scrollY);
        }
    }

    function loadScrollPosition() {
        const scrollY = localStorage.getItem(SCROLL_POS_KEY);
        if (scrollY && elements.manualGeneratorContainer.offsetParent !== null) {
            setTimeout(() => window.scrollTo(0, parseInt(scrollY, 10)), 100);
        }
    }

    // --- STATE MANAGEMENT & SESSION ---
    const QUIZ_STATE_KEY = 'examyatriQuizState';
    let quizData = [], originalQuizData = [], userAnswers = [];
    let quizMetaData = {};
    let currentQuestionIndex = 0, selectedOptionIndex = null;
    let bookmarkedQuestions = new Set();
    let timerId = null, quizStartTime = null, questionStartTime = null;
    let imageFiles = [];
    let pdfFile = null;
    let cropper = null;
    let currentEditingImageId = null;
    let ocrWorker = null;
    let promptForGemini = null;

    // --- Multiplayer State ---
    let currentRoomCode = null;
    let currentUserId = null;
    let isHost = false;
    let roomUnsubscribe = null; // To store the Firebase listener unsubscribe function
    let roomStatusUnsubscribe = null; // Listener for final results
    let submissionsListener = null; 
    let hostDecisionTimeout = null;
    let hostDecisionInterval = null;


    // --- Pressure Mode State ---
    let isShakeReminderEnabled = true; // Enabled by default
    let pressureTextCounter = 1;

    // --- Sound Effects ---
    const optionClickSound = new Audio('data:audio/mpeg;base64,UklGRkYAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhMgAAAP//AwD//wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAE=');
    const clapSound = new Audio('data:audio/mpeg;base64,UklGRigBAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABgAAABkYXRhJAEAAAD///////8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//_');

    // --- INITIALIZATION ---
    async function init() {
        applyInitialTheme();
        populateSharedElements();
        setupAudio();

        currentUserId = getSessionUserId();

        await dbHelper.init();

        try {
            const hostRejoined = await checkForHostRejoin();
            if (hostRejoined) {
                // Host rejoin logic is complete, so we exit init.
                return;
            }
        } catch (error) {
            console.error("Error during host rejoin check:", error);
            // If rejoin fails, clear potentially corrupted state and proceed.
            localStorage.removeItem(HOST_DATA_KEY);
        }


        loadFormState();
        loadScrollPosition();
        loadPressureModeSettings();
        setupEventListeners();

        const quizRestored = await loadQuizState();
        if (quizRestored) {
            // Active solo quiz session takes precedence.
        } else if (sessionStorage.getItem('promptGeneratedForSolo') === 'true') {
            showScreen('paste');
            handleClipboardPermission();
        } else {
            showScreen('manualGenerator');
        }
    }

    function setupAudio() {
        optionClickSound.volume = 0.7;
        clapSound.volume = 0.5;
    }

    init();


    // --- UI & EFFECTS ---
    function showLoading(text) {
        elements.loadingText.textContent = text;
        elements.loadingOverlay.classList.remove('hidden');
    }

    function hideLoading() {
        elements.loadingOverlay.classList.add('hidden');
    }

    function shakeElement(element) {
        element.classList.add('is-shaking');
        element.addEventListener('animationend', () => {
            element.classList.remove('is-shaking');
        }, { once: true });
    }

    function showScreen(screenName) {
        const screens = {
            manualGenerator: elements.manualGeneratorContainer,
            paste: elements.pasteQuizContainer,
            player: elements.quizPlayerContainer,
            results: elements.resultsScreen,
            multiplayer: elements.multiplayerLobby,
            hostQuizGeneration: elements.hostQuizGenerationView,
        };
        const activeScreen = Object.values(screens).find(s => s && !s.classList.contains('hidden'));

        const switchScreens = () => {
            Object.values(screens).forEach(s => s && s.classList.add('hidden'));
            if(screens[screenName]) {
                screens[screenName].classList.remove('hidden', 'fade-out');
                if(screenName === 'manualGenerator') showCreationSelector();
            }
        };

        if (activeScreen && activeScreen !== screens[screenName]) {
            activeScreen.classList.add('fade-out');
            setTimeout(switchScreens, 300);
        } else {
            switchScreens();
        }
    }

    function showCreationSelector() { ['topic', 'text', 'image', 'pdf'].forEach(w => elements[w+'GeneratorWorkflow'].classList.add('hidden')); elements.creationMethodSelector.classList.remove('hidden'); elements.imageFormatGuide.classList.add('hidden'); }

    function showWorkflow(workflowName) {
        ['topic', 'text', 'image', 'pdf'].forEach(w => {
            elements[w + 'GeneratorWorkflow'].classList.add('hidden');
        });
        elements.creationMethodSelector.classList.add('hidden');

        const workflowElement = elements[workflowName + 'GeneratorWorkflow'];
        if (workflowElement) {
            workflowElement.classList.remove('hidden');
        }

        elements.imageFormatGuide.classList.toggle('hidden', workflowName !== 'image');
        if (workflowName === 'image') {
            setTimeout(() => { elements.imageFormatGuide.classList.remove('hidden'); }, 50);
        }
    }


    function populateSharedElements() {
        const formatSelects = document.querySelectorAll('select[id^="question-format-select"]');
        formatSelects.forEach(select => {
            if (!select) return;
            select.innerHTML = ''; // Clear existing options
            Object.keys(QUESTION_FORMATS).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = QUESTION_FORMATS[key].name;
                select.appendChild(option);
            });
            select.value = 'mcq'; // Set MCQ as the default for all
        });

        const examHtml = `<button class="btn exam-btn" data-exam-name="NEET">NEET</button><button class="btn exam-btn" data-exam-name="IIT-JEE">IIT-JEE</button><button class="btn exam-btn" data-exam-name="NEET PG">NEET PG</button><button class="btn exam-btn" data-exam-name="CUET">CUET</button><button class="btn exam-btn" data-exam-name="AIAPGET">AIAPGET</button><button class="btn exam-btn" data-exam-name="UPSC Civil Services">UPSC</button><button class="btn exam-btn" data-exam-name="SSC CGL">SSC</button><button class="btn exam-btn" data-exam-name="UP-SI">UP-SI</button><button class="btn exam-btn" data-exam-name="State PSC">State PSC</button><button class="btn exam-btn" data-exam-name="Banking Exams">Bank</button><button class="btn exam-btn" data-exam-name="Railway Exams">Railway</button><button class="btn exam-btn" data-exam-name="Other">Other</button>`;
        document.querySelectorAll('.exam-buttons-container').forEach(c => c.innerHTML = examHtml);
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        // Main Navigation
        elements.selectFromTopicBtn.addEventListener('click', () => showWorkflow('topic'));
        elements.selectFromTextBtn.addEventListener('click', () => showWorkflow('text'));
        elements.selectFromImageBtn.addEventListener('click', () => showWorkflow('image'));
        elements.selectFromPdfBtn.addEventListener('click', () => showWorkflow('pdf'));
        elements.backToSelectionBtns.forEach(btn => btn.addEventListener('click', showCreationSelector));

        // Multiplayer Navigation
        elements.selectMultiplayerBtn.addEventListener('click', () => showScreen('multiplayer'));
        elements.createRoomBtn.addEventListener('click', handleCreateRoom);
        elements.shareCodeBtn.addEventListener('click', handleShareCode);
        elements.joinGameBtn.addEventListener('click', handleJoinRoomAttempt);
        elements.hostGenerateQuizBtn.addEventListener('click', openHostQuizGenerationView);

        // Host View Listeners
        elements.closeHostViewBtn.addEventListener('click', () => {
            showScreen('multiplayer');
            elements.roomLobby.classList.remove('hidden');
        });
        document.getElementById('host-select-from-topic').addEventListener('click', () => showHostWorkflow('topic'));
        document.getElementById('host-select-from-text').addEventListener('click', () => showHostWorkflow('text'));
        document.getElementById('host-select-from-image').addEventListener('click', () => showHostWorkflow('image'));
        document.getElementById('host-select-from-pdf').addEventListener('click', () => showHostWorkflow('pdf'));


        // Prompt Generation
        elements.generatePromptBtnTopic.addEventListener('click', () => handleGeneratePrompt('topic'));
        elements.generatePromptBtnText.addEventListener('click', () => handleGeneratePrompt('text'));
        elements.generatePromptBtnImage.addEventListener('click', () => handleGeneratePrompt('image'));
        elements.generatePromptBtnPdf.addEventListener('click', () => handleGeneratePrompt('pdf'));


        // Image Workflow (Crop modal buttons are not delegated as they are unique)
        elements.saveCropBtn.addEventListener('click', saveCrop);
        elements.cancelCropBtn.addEventListener('click', closeCropModal);

        // PDF Workflow
        document.querySelectorAll('input[name="pdf-page-option"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                elements.pdfPageRangeSelector.classList.toggle('hidden', e.target.value !== 'range');
            });
        });
        elements.extractTextPdfBtn.addEventListener('click', runPdfExtraction);

        // --- DELEGATED CLICK LISTENER FOR DYNAMIC/SHARED BUTTONS ---
        document.body.addEventListener('click', (event) => {
            const guideBtn = event.target.closest('.guide-btn');
            if (guideBtn) {
                event.preventDefault();
                showFlowchartGuide(guideBtn.dataset.guideId);
                return;
            }
            if (event.target.closest('.modal-close-btn-top')) {
                const modal = event.target.closest('.modal-overlay');
                if (modal) modal.classList.add('hidden');
                return;
            }
            if (!event.target.closest('#pressure-mode-container')) {
                elements.pressureModeControls.classList.add('hidden');
            }
            const leaveRoomBtn = event.target.closest('.back-to-main-menu-btn');
            if (leaveRoomBtn) {
                leaveRoom(true, isHost);
                return;
            }
            if (event.target.matches('#select-images-btn, #host-select-images-btn')) {
                const inputId = event.target.id.replace('select-images-btn', 'image-file-input');
                document.getElementById(inputId)?.click();
                return;
            }
            if (event.target.matches('#select-pdf-btn, #host-select-pdf-btn')) {
                const inputId = event.target.id.replace('select-pdf-btn', 'pdf-file-input');
                document.getElementById(inputId)?.click();
                return;
            }
            // *** FIXED: Event delegation for exam buttons ***
            const examBtn = event.target.closest('.exam-btn');
            if (examBtn) {
                handleExamSelection(event);
                return;
            }
        });

        // DELEGATED CHANGE LISTENER FOR FILE INPUTS
        document.body.addEventListener('change', (event) => {
            if (event.target.matches('#image-file-input, #host-image-file-input')) {
                handleImageSelection(event);
            }
            if (event.target.matches('#pdf-file-input, #host-pdf-file-input')) {
                handlePdfSelection(event);
            }
        });


        elements.flowchartModalCloseBtn.addEventListener('click', closeFlowchartGuide);
        elements.telegramBackupGuideBtn.addEventListener('click', () => elements.telegramBackupModalOverlay.classList.remove('hidden'));
        elements.telegramBackupCloseBtn.addEventListener('click', () => elements.telegramBackupModalOverlay.classList.add('hidden'));


        // Quiz and Results
        elements.startManualQuizBtn.addEventListener('click', startManualQuiz);
        elements.sharePdfBtn.addEventListener('click', generatePDF);
        elements.copyBookmarksBtn.addEventListener('click', () => copyQuizContent(true));
        elements.copyAllBtn.addEventListener('click', () => copyQuizContent(false));
        elements.shareWhatsappBtn.addEventListener('click', shareOnWhatsApp);
        elements.shareSiteBtn.addEventListener('click', shareWebsite);
        elements.restartBtn.addEventListener('click', restartQuiz);
        elements.bookmarkBtn.addEventListener('click', handleBookmark);
        elements.resultsPageOpenTelegramBtn.addEventListener('click', openTelegramWithBookmarks);

        // Misc, Automation & Session
        elements.themeToggleBtn.addEventListener('click', toggleTheme);
        elements.manualCopyCloseBtn.addEventListener('click', () => elements.manualCopyModalOverlay.classList.add('hidden'));
        document.addEventListener('visibilitychange', handleVisibilityChange);
        window.addEventListener('beforeunload', () => {
            saveQuizState();
            // The onDisconnect handler for Firebase will manage leaving the room
        });

        // Clipboard Permission & Automation
        elements.grantClipboardBtn.addEventListener('click', requestClipboardAndPaste);
        elements.denyClipboardBtn.addEventListener('click', () => {
            elements.clipboardPermissionModalOverlay.classList.add('hidden');
            showPasteNotification("Okay, you can paste the text yourself.");
        });
        elements.quizDataInput.addEventListener('focus', tryAutoPasteOnFocus);

        // Gemini Instructions Modal Listener
        elements.openGeminiBtn.addEventListener('click', () => {
            if (promptForGemini) {
                executePostPromptActions(promptForGemini);
                promptForGemini = null;
                elements.geminiInstructionsModalOverlay.classList.add('hidden');
            } else {
                console.error("No prompt was available to send to Gemini.");
                elements.geminiInstructionsModalOverlay.classList.add('hidden');
            }
        });

        // Pressure Mode Event Listeners
        elements.pressureModeToggleBtn.addEventListener('click', () => {
            elements.pressureModeControls.classList.toggle('hidden');
        });
        elements.shakeReminderToggle.addEventListener('change', (e) => {
            isShakeReminderEnabled = e.target.checked;
            localStorage.setItem('shakeReminderEnabled', isShakeReminderEnabled);
            const checkBtn = document.getElementById('check-answer-btn');
            if (!isShakeReminderEnabled && checkBtn) {
                checkBtn.classList.remove('vibrating');
            }
        });

        // Form persistence
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(saveScrollPosition, 150);
        });

        getPersistableInputs().forEach(input => {
            input.addEventListener('input', saveFormState);
            input.addEventListener('change', saveFormState);
        });

        // Host Decision Modal Actions
        elements.endRoomBtn.addEventListener('click', handleHostDecisionEnd);
        elements.restartMultiplayerQuizBtn.addEventListener('click', handleHostDecisionRestart);
    }

    // --- USER SESSION MANAGEMENT ---
    function getSessionUserId() {
        let uid = sessionStorage.getItem('examyatriUserId');
        if (!uid) {
            uid = 'user_' + Date.now() + Math.random().toString(36).substring(2, 8);
            sessionStorage.setItem('examyatriUserId', uid);
        }
        return uid;
    }


    // --- SESSION MANAGEMENT (Quiz-in-progress ONLY) ---
    async function saveQuizState() {
        if (quizData.length === 0 || elements.quizPlayerContainer.classList.contains('hidden') || currentRoomCode) {
            // Do not save local state if in a multiplayer room
             await dbHelper.set(QUIZ_STATE_KEY, null);
             return;
        }
        const state = {
            originalQuizData, userAnswers, currentQuestionIndex,
            bookmarkedQuestions: Array.from(bookmarkedQuestions),
            quizStartTime: quizStartTime.toISOString(),
            quizMetaData: quizMetaData
        };
        await dbHelper.set(QUIZ_STATE_KEY, state);
    }

    async function loadQuizState() {
        const state = await dbHelper.get(QUIZ_STATE_KEY);
        if (!state) return false;
        try {
            originalQuizData = state.originalQuizData;
            quizData = JSON.parse(JSON.stringify(originalQuizData));
            userAnswers = state.userAnswers;
            currentQuestionIndex = state.currentQuestionIndex;
            bookmarkedQuestions = new Set(state.bookmarkedQuestions);
            quizStartTime = new Date(state.quizStartTime);
            quizMetaData = state.quizMetaData || {};
            showScreen('player');
            loadQuestion(0);
            showPasteNotification('✅ Your active quiz has been restored.');
            return true;
        } catch (e) {
            console.error("Failed to load quiz state:", e);
            await dbHelper.set(QUIZ_STATE_KEY, null);
            return false;
        }
    }

    // --- CLIPBOARD PERMISSION & AUTOMATION ---
    async function handleClipboardPermission() {
        if (!navigator.clipboard || !navigator.permissions) return;
        try {
            const permissionStatus = await navigator.permissions.query({ name: "clipboard-read" });
            if (permissionStatus.state === "granted") {
                await tryAutoPasteOnReturn();
            } else if (permissionStatus.state === "prompt") {
                elements.clipboardPermissionModalOverlay.classList.remove('hidden');
            }
        } catch (e) {
            console.warn("Clipboard permission API not supported or failed.", e);
        }
    }

    async function requestClipboardAndPaste() {
        elements.clipboardPermissionModalOverlay.classList.add('hidden');
        await tryAutoPasteOnReturn(true); // `true` forces the browser prompt
    }

    async function tryAutoPasteOnReturn(forcePrompt = false) {
        if (!forcePrompt && document.hidden) return;
        try {
            const text = await navigator.clipboard.readText();
            if (text && text.trim() && (text.includes("Question:") || text.includes("Correct Answer:"))) {
                elements.quizDataInput.value = text;
                showPasteNotification('✨ Auto-pasted! Starting quiz...');
                startManualQuiz();
            } else if (forcePrompt) {
                 showPasteNotification("📋 Your clipboard is empty or doesn't look like a quiz.");
            }
        } catch (err) {
            if (err.name !== 'NotAllowedError') {
                console.error("Clipboard read failed: ", err);
            }
            if (forcePrompt) {
                showPasteNotification("Permission denied. You can paste manually.");
            }
        }
    }

    async function tryAutoPasteOnFocus() {
        if(elements.quizDataInput.value.trim() !== '') return;
        try {
            const permissionStatus = await navigator.permissions.query({ name: "clipboard-read" });
            if (permissionStatus.state === "granted") {
                await tryAutoPasteOnReturn(false);
            }
        } catch (e) { /* Fail silently */ }
    }


    async function handleVisibilityChange() {
        const isAwaitingPaste = sessionStorage.getItem('promptGeneratedForSolo') === 'true' || 
                              (JSON.parse(localStorage.getItem(HOST_DATA_KEY) || '{}')).awaitingQuizPaste;

        if (!document.hidden && isAwaitingPaste) {
            await handleClipboardPermission();
        }
    }

    // --- GUIDE MODAL FUNCTIONS ---
    function showFlowchartGuide(guideId) {
        const guideContent = GUIDE_DATA[guideId];
        if (guideContent) {
            elements.flowchartModalTitle.textContent = guideContent.title;
            elements.flowchartModalContent.innerHTML = guideContent.content;
            elements.flowchartModalOverlay.classList.remove('hidden');
        } else {
            console.error('No guide found for ID:', guideId);
        }
    }

    function closeFlowchartGuide() {
        elements.flowchartModalOverlay.classList.add('hidden');
    }

    // --- PROMPT BUILDER AND GENERATION LOGIC ---
    function handleGeneratePrompt(sourceType, isForMultiplayer = false) {
        let source, workflowContainer, sourceText = '';

        if (isForMultiplayer) {
            workflowContainer = document.getElementById('host-generator-workflow-container');
        } else {
            workflowContainer = document.getElementById(`${sourceType}-generator-workflow`);
        }

        const getInputValue = (id) => workflowContainer.querySelector(id)?.value.trim() || '';
        const getSelectValue = (id) => workflowContainer.querySelector(id)?.value || '';

        const sourceTextAreaId = `#${isForMultiplayer ? 'host-' : ''}source-text-${sourceType}`;
        const sourceTextArea = workflowContainer.querySelector(sourceTextAreaId);
        if (sourceTextArea) {
            sourceText = sourceTextArea.value || '';
        }

        const activeExamBtn = workflowContainer.querySelector('.exam-btn.active');
        let activeExam = activeExamBtn ? activeExamBtn.dataset.examName : '';
        if (activeExam === 'Other') {
            const otherExamInputId = `#${isForMultiplayer ? 'host-' : ''}prompt-exam-other-${sourceType}`;
            activeExam = getInputValue(otherExamInputId);
        }

        source = {
            numQuestions: getInputValue(`#${isForMultiplayer ? 'host-' : ''}prompt-num-questions-${sourceType}`),
            topic: getInputValue(`#${isForMultiplayer ? 'host-' : ''}prompt-topic-${sourceType}`),
            subject: getInputValue(`#${isForMultiplayer ? 'host-' : ''}prompt-subject-${sourceType}`),
            difficulty: getSelectValue(`#${isForMultiplayer ? 'host-' : ''}prompt-difficulty-${sourceType}`),
            language: getSelectValue(`#${isForMultiplayer ? 'host-' : ''}prompt-language-${sourceType}`),
            formatKey: getSelectValue(`#${isForMultiplayer ? 'host-' : ''}question-format-select-${sourceType}`),
            exam: activeExam,
            instructions: getInputValue(`#${isForMultiplayer ? 'host-' : ''}prompt-instructions-${sourceType}`),
        };

        // --- VALIDATION ---
        if (sourceType === 'topic' && !source.topic) {
            alert('Please enter a Quiz Topic.'); return;
        }
        if ((sourceType === 'topic' || sourceType === 'text') && !source.subject) {
            alert('Please enter a Subject Area.'); return;
        }
        if ((sourceType === 'text' || sourceType === 'image' || sourceType === 'pdf') && !sourceText) {
             alert('The source text is empty. Please provide content to generate questions from.'); return;
        }
        if (!source.numQuestions) {
            alert('Please specify the number of questions.'); return;
        }

        // --- PROMPT GENERATION ---
        const FORMAT_EXAMPLES = {
            'mcq': `1. Multiple Choice Questions\nQuestion: What is the capital of France?\nOptions:\na) Berlin\nb) Madrid\nc) Paris\nd) Rome\nCorrect Answer: c) Paris\nExplanation: Paris is the capital and most populous city of France.`,
            'statement': `1. Statement-Based Questions\nQuestion: Consider the following statements regarding the Earth:\n* The Earth is the third planet from the Sun.\n* The Earth is the largest of the terrestrial planets.\nWhich of the above statements are correct?\nOptions:\na) 1 only\nb) 2 only\nc) Both 1 and 2\nd) Neither 1 nor 2\nCorrect Answer: c) Both 1 and 2\nExplanation: Both statements are factually correct.`,
            'assertion-reason': `1. Assertion-Reason Based Questions\nAssertion (A): A rainbow is seen in the sky after a rainfall.\nReason (R): Water droplets in the atmosphere act as small prisms.\nOptions:\na) Both A and R are true and R is the correct explanation of A.\nb) Both A and R are true but R is not the correct explanation of A.\nc) A is true but R is false.\nd) A is false but R is true.\nCorrect Answer: a) Both A and R are true and R is the correct explanation of A.\nExplanation: The water droplets disperse sunlight into its constituent colors, forming a rainbow.`,
            'true-false': `1. True/False Questions\nQuestion: The planet Mars is also known as the Red Planet.\nOptions:\na) True\nb) False\nCorrect Answer: a) True\nExplanation: Mars has a reddish appearance due to iron oxide (rust) on its surface.`,
            'math-physics': `1. Maths, Physics, or Other Questions\nQuestion: What is the derivative of \\(x^3\\) with respect to x?\nOptions:\na) \\(3x\\)\nb) \\(x^2\\)\nc) \\(3x^2\\)\nd) \\(\\frac{x^4}{4}\\)\nCorrect Answer: c) \\(3x^2\\)\nExplanation: Using the power rule for differentiation, \\(\\frac{d}{dx}(x^n) = nx^{n-1}\\).`,
            'fill-blank': `1. Fill-in-the-Blank Questions\nQuestion: The powerhouse of the cell is the ___.\nOptions:\na) Nucleus\nb) Ribosome\nc) Mitochondrion\nd) Cytoplasm\nCorrect Answer: c) Mitochondrion\nExplanation: The mitochondrion generates most of the cell's supply of adenosine triphosphate (ATP), used as a source of chemical energy.`,
        };

        let selectedFormatExample;
        if (source.formatKey === 'mix') {
             selectedFormatExample = Object.values(FORMAT_EXAMPLES).join('\n---\n');
        } else {
             selectedFormatExample = FORMAT_EXAMPLES[source.formatKey] || FORMAT_EXAMPLES['mcq'];
        }

        let sourceMaterialInstruction;
        if (sourceType === 'pdf') {
            sourceMaterialInstruction = 'You must ONLY use information present in the source text provided below. **Do not use any external knowledge.** All questions, options, and explanations must be derived directly and exclusively from the provided text.';
        } else { // topic, text, image
            sourceMaterialInstruction = 'You MUST use your own extensive knowledge base to create original, high-quality questions. If source text is provided, use it for context and inspiration, but create new questions that match the specified exam level.';
        }

        let examInstruction = "The 'Target Exam' parameter is the most important instruction. You must generate questions that are **strictly relevant to the syllabus, question pattern, and difficulty level of the specified exam.** For example, if the exam is 'IIT-JEE', the questions must be of that specific engineering entrance exam level, involving complex problem-solving. If it is 'NEET', the questions must be based on the NEET syllabus (Physics, Chemistry, Biology). If it is 'UPSC', the questions must be analytical and based on the civil services syllabus. **This is a strict requirement.**";

        let prompt = `You are an expert quiz creator for competitive exams. Your task is to generate a high-quality quiz based on the user's strict specifications. Adherence to all instructions is critical.

**CRITICAL INSTRUCTIONS - FOLLOW THESE OR THE OUTPUT IS USELESS:**
1.  **SPEED IS ESSENTIAL:** Generate the entire list of questions in a single, fast pass. Do NOT re-check, review, or refine your output. Generate it correctly the first time.
2.  **PLAIN TEXT ONLY:** Your entire output must be in 100% plain text. NO MARKDOWN (like #, **, etc.). NO JSON. NO CODE BLOCKS. Just text.
3.  **ONE BY ONE OUTPUT:** Generate the questions sequentially. Complete question 1, then question 2, and so on. Do not generate all questions simultaneously.
4.  **CRITICAL MATHJAX FORMATTING:** This is the most important formatting rule. ALL mathematical or scientific notation—including single variables, numbers, fractions, and simple comparisons—MUST be enclosed in \\( ... \\) to ensure they render correctly. Failure to do this for even a simple fraction will break the user's display.
    -   **WRONG:** The formula is E=mc^2.
    -   **CORRECT:** The formula is \\(E=mc^2\\).
    -   **WRONG:** The fraction is 1/2.
    -   **CORRECT:** The fraction is \\(1/2\\).
    -   **WRONG:** ...where x > 5...
    -   **CORRECT:** ...where \\(x > 5\\)...
    This applies to everything that is not plain descriptive text.
5.  **ALWAYS INCLUDE A COPY BUTTON:** At the absolute end of your entire response, you MUST include a line of plain text that says: \`[Copy Quiz Text]\`. This is a critical fallback for users. Do not forget this button.
---

**QUIZ GENERATION PARAMETERS**
- **Number of Questions:** ${source.numQuestions}
- **Primary Topic:** ${source.topic || (sourceType !== 'topic' ? 'Inferred from source text' : 'N/A')}
- **Subject:** ${source.subject}
- **Difficulty Level:** ${source.difficulty}
- **Language:** ${source.language}
- **Question Format:** ${QUESTION_FORMATS[source.formatKey].name}
- **Target Exam:** ${source.exam || 'General Knowledge'}
${source.exam ? `- **Target Exam Instructions:** ${examInstruction}` : ''}
${source.instructions ? `- **User's Specific Instructions:** ${source.instructions} (Pay close attention to this instruction and prioritize it.)` : ''}
---

**SOURCE MATERIAL & KNOWLEDGE INSTRUCTIONS**
- **How to Use Knowledge:** ${sourceMaterialInstruction}
${(sourceType !== 'topic' && sourceText) ? `
**Source Text:**
---
${sourceText}
---` : ''}

**FORMAT EXAMPLE (Use this exact structure for every question)**
---
${selectedFormatExample}
---

Now, generate the quiz. Re-read all instructions. Failure to adhere to the formatting and content relevance guidelines will result in an incorrect output. Generate quickly and correctly in one pass.
`;

        promptForGemini = prompt;

        quizMetaData = {
            topic: source.topic || source.subject,
            subject: source.subject,
            difficulty: source.difficulty,
        };

        if (isForMultiplayer) {
            const hostData = JSON.parse(localStorage.getItem(HOST_DATA_KEY) || '{}');
            hostData.awaitingQuizPaste = true;
            localStorage.setItem(HOST_DATA_KEY, JSON.stringify(hostData));
        } else {
            sessionStorage.setItem('promptGeneratedForSolo', 'true');
        }

        elements.geminiInstructionsModalOverlay.classList.remove('hidden');
    }

    async function executePostPromptActions(prompt) {
        const isForMultiplayer = !!JSON.parse(localStorage.getItem(HOST_DATA_KEY));

        if (!isForMultiplayer) {
            clearFormState();
        }

        try {
            await copyTextToClipboard(prompt);
        } catch {}

        if (isForMultiplayer) {
             showHostPasteScreen();
        } else {
             showScreen('paste');
        }
        
        openAiWithFallback();
    }


    function openAiWithFallback() {
        const geminiUrl = 'https://gemini.google.com';
        const aiWindow = window.open(geminiUrl, '_blank');

        if (!aiWindow || aiWindow.closed || typeof aiWindow.closed === 'undefined') {
            showPasteNotification('⚠️ Popup blocked! Click the link to open manually.');
            elements.aiLinkFallback.classList.remove('hidden');
        } else {
            elements.aiLinkFallback.classList.add('hidden');
        }
    }

    // *** FIXED: Updated function to work with event delegation ***
    function handleExamSelection(event) {
        event.preventDefault();
        const clickedBtn = event.target.closest('.exam-btn');
        if (!clickedBtn) return;

        const examName = clickedBtn.dataset.examName;
        const parentContainer = clickedBtn.closest('.input-group');
        if (!parentContainer) return;

        const otherInput = parentContainer.querySelector('.prompt-exam-other');
        const allButtonsInGroup = parentContainer.querySelectorAll('.exam-btn');

        if (clickedBtn.classList.contains('active')) {
            clickedBtn.classList.remove('active');
            if (otherInput) otherInput.classList.add('hidden');
        } else {
            allButtonsInGroup.forEach(btn => btn.classList.remove('active'));
            clickedBtn.classList.add('active');
            if (otherInput) {
                otherInput.classList.toggle('hidden', examName !== 'Other');
                if (examName === 'Other') otherInput.focus();
                else otherInput.value = '';
            }
        }
        saveFormState();
    }

    // --- PDF WORKFLOW ---
    function handlePdfSelection(event) {
        pdfFile = event.target.files[0];
        if (pdfFile) {
            const isMultiplayer = !elements.hostQuizGenerationView.classList.contains('hidden');
            const fileNameEl = isMultiplayer ? elements.hostGeneratorWorkflowContainer.querySelector('[id*="pdf-file-name"]') : elements.pdfFileName;
            const optionsContainer = isMultiplayer ? elements.hostGeneratorWorkflowContainer.querySelector('[id*="pdf-options-container"]') : elements.pdfOptionsContainer;
            const definitionArea = isMultiplayer ? elements.hostGeneratorWorkflowContainer.querySelector('[id*="pdf-quiz-definition-area"]') : elements.pdfQuizDefinitionArea;
            const statusEl = isMultiplayer ? elements.hostGeneratorWorkflowContainer.querySelector('[id*="pdf-status"]') : elements.pdfStatus;

            fileNameEl.textContent = pdfFile.name;
            optionsContainer.classList.remove('hidden');
            definitionArea.classList.add('hidden');
            statusEl.textContent = '';
        }
    }

    async function runPdfExtraction() {
        if (!pdfFile) { alert('Please select a PDF file first.'); return; }

        const isMultiplayer = !elements.hostQuizGenerationView.classList.contains('hidden');
        const workflowContainer = isMultiplayer ? elements.hostGeneratorWorkflowContainer : document;

        showLoading('Initializing PDF processing...');

        const forceOcr = workflowContainer.querySelector('[id*="pdf-force-ocr"]').checked;
        const pageOption = workflowContainer.querySelector('input[name*="pdf-page-option"]:checked').value;
        let startPage = 1, endPage = Infinity;

        try {
            const loadingTask = pdfjsLib.getDocument(URL.createObjectURL(pdfFile));
            const pdf = await loadingTask.promise;
            endPage = pdf.numPages;

            if (pageOption === 'range') {
                const from = parseInt(workflowContainer.querySelector('[id*="pdf-page-from"]').value, 10);
                const to = parseInt(workflowContainer.querySelector('[id*="pdf-page-to"]').value, 10);
                if (!from || !to || from < 1 || to > endPage || from > to) {
                    alert('Invalid page range. Please enter valid start and end pages.');
                    hideLoading();
                    return;
                }
                startPage = from;
                endPage = to;
            }

            let fullText = '';
            if (forceOcr) {
                fullText = await extractPdfTextWithOcr(pdf, startPage, endPage);
            } else {
                fullText = await extractPdfTextNative(pdf, startPage, endPage);
            }

            const targetTextArea = workflowContainer.querySelector('[id*="source-text-pdf"]');
            targetTextArea.value = fullText.trim();
            const definitionArea = workflowContainer.querySelector('[id*="pdf-quiz-definition-area"]');

            if(fullText.trim()){
                definitionArea.classList.remove('hidden');
                definitionArea.scrollIntoView({ behavior: 'smooth' });
            } else {
                 showPasteNotification(`⚠️ No text was extracted. Try with "Force OCR" checked.`);
            }

        } catch (error) {
            console.error("PDF Processing Error:", error);
            showPasteNotification(`❌ An error occurred: ${error.message}`);
        } finally {
            hideLoading();
        }
    }

    async function extractPdfTextNative(pdf, start, end) {
        let textContent = '';
        for (let i = start; i <= end; i++) {
            showLoading(`Extracting text from page ${i}... (Native)`);
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            textContent += content.items.map(item => item.str).join(' ') + '\n\n';
        }
        return textContent;
    }

    async function extractPdfTextWithOcr(pdf, start, end) {
        let fullText = '';
        let worker = null;
        showLoading('Initializing Advanced OCR for PDF...');

        try {
            worker = await Tesseract.createWorker('eng', 1, {
                logger: m => {
                    if (m.status === 'recognizing text') {
                        const progress = (m.progress * 100).toFixed(0);
                        showLoading(`🤖 Performing OCR on page... ${progress}%`);
                    }
                }
            });

            for (let i = start; i <= end; i++) {
                showLoading(`⏳ Rendering page ${i} of ${end} for OCR...`);
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 2.0 });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({ canvasContext: context, viewport: viewport }).promise;

                showLoading(`🤖 Pre-processing page ${i} for handwriting...`);
                preProcessCanvasForOCR(canvas);

                showLoading(`🤖 Recognizing text on page ${i}...`);
                const { data: { text } } = await worker.recognize(canvas);
                fullText += text + '\n\n';
            }
        } catch (error) {
            console.error("PDF OCR Extraction Error:", error);
            showPasteNotification(`❌ OCR error on PDF: ${error.message}`);
            return fullText;
        } finally {
            if (worker) {
                await worker.terminate();
            }
        }
        return fullText;
    }


    // --- AUTOMATED IMAGE ORIENTATION & OCR WORKFLOW ---
    function preProcessCanvasForOCR(canvas) {
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        const threshold = 128;

        for (let i = 0; i < data.length; i += 4) {
            const luminance = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
            const value = luminance < threshold ? 0 : 255;
            data[i] = value;
            data[i + 1] = value;
            data[i + 2] = value;
        }
        ctx.putImageData(imageData, 0, 0);
        return canvas;
    }

    async function handleImageSelection(event) {
        const newFiles = Array.from(event.target.files);
        if (newFiles.length === 0) return;

        const isMultiplayer = event.target.id.startsWith('host-');
        imageFiles = [];

        const previewContainer = isMultiplayer ? elements.hostGeneratorWorkflowContainer.querySelector('[id*="image-preview-container"]') : elements.imagePreviewContainer;
        const sourceTextArea = isMultiplayer ? elements.hostGeneratorWorkflowContainer.querySelector('[id*="source-text-image"]') : elements.sourceTextImage;
        const definitionArea = isMultiplayer ? elements.hostGeneratorWorkflowContainer.querySelector('[id*="image-quiz-definition-area"]') : elements.imageQuizDefinitionArea;


        if(previewContainer) previewContainer.innerHTML = '';
        if(sourceTextArea) sourceTextArea.value = '';
        if(definitionArea) definitionArea.classList.add('hidden');

        await processAndExtractAllImages(newFiles, isMultiplayer);

        event.target.value = '';
    }

    async function processAndExtractAllImages(files, isMultiplayer) {
        let fullText = '';
        const previewContainer = isMultiplayer ? elements.hostGeneratorWorkflowContainer.querySelector('[id*="image-preview-container"]') : elements.imagePreviewContainer;
        const sourceTextArea = isMultiplayer ? elements.hostGeneratorWorkflowContainer.querySelector('[id*="source-text-image"]') : elements.sourceTextImage;
        const definitionArea = isMultiplayer ? elements.hostGeneratorWorkflowContainer.querySelector('[id*="image-quiz-definition-area"]') : elements.imageQuizDefinitionArea;


        if (!ocrWorker) {
            showLoading('Initializing OCR Engine (one-time setup)...');
            try {
                 ocrWorker = await Tesseract.createWorker('eng', 1, {});
            } catch (error) {
                 console.error("Failed to create Tesseract worker:", error);
                 showPasteNotification("❌ Could not initialize the OCR engine.");
                 hideLoading();
                 return;
            }
        }

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const progressPrefix = `Image ${i + 1}/${files.length}:`;

            try {
                showLoading(`${progressPrefix} Analyzing orientation...`);
                const bestRotation = await findBestOrientation(file, ocrWorker);

                const orientedImg = await createImageFromFile(file);
                let orientedCanvas = rotateCanvas(orientedImg, bestRotation);

                const orientedBlob = await new Promise(resolve => orientedCanvas.toBlob(resolve, 'image/jpeg', 0.95));
                const orientedFile = new File([orientedBlob], file.name, { type: 'image/jpeg' });
                addImageFile(orientedFile, previewContainer);

                showLoading(`${progressPrefix} Pre-processing for handwriting...`);
                orientedCanvas = preProcessCanvasForOCR(orientedCanvas); // Apply pre-processing

                showLoading(`${progressPrefix} Extracting text...`);
                const { data: { text } } = await ocrWorker.recognize(orientedCanvas);
                fullText += text + '\n\n';

            } catch (error) {
                console.error(`Failed to process image ${file.name}:`, error);
                showPasteNotification(`❌ Skipped ${file.name} due to an error.`);
            }
        }

        hideLoading();

        if (fullText.trim()) {
            sourceTextArea.value = fullText.trim();
            definitionArea.classList.remove('hidden');
            definitionArea.scrollIntoView({ behavior: 'smooth' });
            showPasteNotification('✅ All images processed and text extracted!');
        } else {
            showPasteNotification('⚠️ Could not extract any text from the selected images.');
        }
    }


    async function findBestOrientation(file, worker) {
        let maxConfidence = -1;
        let bestRotation = 0;
        const rotations = [0, 270, 180, 90];

        const img = await createImageFromFile(file);

        for (const rotation of rotations) {
            const canvas = rotateCanvas(img, rotation);
            const { data } = await worker.recognize(canvas);

            if (data.confidence > maxConfidence) {
                maxConfidence = data.confidence;
                bestRotation = rotation;
            }
            if (maxConfidence > 80) break;
        }
        return bestRotation;
    }

    function createImageFromFile(file) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => {
                URL.revokeObjectURL(img.src);
                resolve(img);
            };
            img.onerror = (err) => {
                URL.revokeObjectURL(img.src);
                reject(new Error("Failed to load image from file. It might be corrupt."));
            };
            img.src = URL.createObjectURL(file);
        });
    }

    function rotateCanvas(image, degrees) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const w = image.width;
        const h = image.height;

        if (degrees === 90 || degrees === 270) {
            canvas.width = h;
            canvas.height = w;
        } else {
            canvas.width = w;
            canvas.height = h;
        }

        ctx.translate(canvas.width / 2, canvas.height / 2);
        ctx.rotate(degrees * Math.PI / 180);
        ctx.drawImage(image, -w / 2, -h / 2);

        return canvas;
    }

    function addImageFile(file, container) {
        imageFiles.push({ originalFile: file, id: `img_${Date.now()}_${Math.random()}`, croppedFile: null, previewUrl: null, });
        updateImagePreviews(container);
    }

    function updateImagePreviews(container) {
        if (!container) return;
        container.innerHTML = '';
        imageFiles.forEach(imgFile => {
            const fileForPreview = imgFile.croppedFile || imgFile.originalFile;
            if(imgFile.previewUrl) URL.revokeObjectURL(imgFile.previewUrl);
            imgFile.previewUrl = URL.createObjectURL(fileForPreview);
            const wrapper = document.createElement('div');
            wrapper.className = 'img-preview-wrapper';
            wrapper.innerHTML = `<div class="img-container"><img src="${imgFile.previewUrl}" alt="Image preview"></div><div class="img-preview-actions"><button class="img-preview-btn crop-btn" data-id="${imgFile.id}" title="Crop">✂️</button><button class="img-preview-btn remove-btn" data-id="${imgFile.id}" title="Remove">🗑️</button></div>`;
            container.appendChild(wrapper);
        });
        container.querySelectorAll('.crop-btn').forEach(btn => btn.addEventListener('click', () => openCropModal(btn.dataset.id)));
        container.querySelectorAll('.remove-btn').forEach(btn => btn.addEventListener('click', () => removeImage(btn.dataset.id, container)));

        const isMultiplayer = !elements.hostQuizGenerationView.classList.contains('hidden');
        const definitionArea = isMultiplayer ? elements.hostGeneratorWorkflowContainer.querySelector('[id*="image-quiz-definition-area"]') : elements.imageQuizDefinitionArea;
        if (definitionArea) definitionArea.classList.add('hidden');
    }


    function removeImage(idToRemove, container) {
        const indexToRemove = imageFiles.findIndex(f => f.id === idToRemove);
        if (indexToRemove > -1) {
            if (imageFiles[indexToRemove].previewUrl) URL.revokeObjectURL(imageFiles[indexToRemove].previewUrl);
            imageFiles.splice(indexToRemove, 1);
            updateImagePreviews(container);
        }
    }
    function openCropModal(imageId) {
        const imgFile = imageFiles.find(f => f.id === imageId);
        if (!imgFile) return;
        currentEditingImageId = imageId;
        const fileToCrop = imgFile.croppedFile || imgFile.originalFile;
        elements.imageToCrop.src = URL.createObjectURL(fileToCrop);
        elements.cropModalOverlay.classList.remove('hidden');
        elements.imageToCrop.onload = () => { if (cropper) cropper.destroy(); cropper = new Cropper(elements.imageToCrop, { aspectRatio: NaN, viewMode: 1, background: false, autoCropArea: 0.9, }); };
    }
    function closeCropModal() { if(cropper) cropper.destroy(); cropper = null; currentEditingImageId = null; elements.cropModalOverlay.classList.add('hidden'); }
    function saveCrop() {
        if (!cropper || !currentEditingImageId) return;
        cropper.getCroppedCanvas({ minWidth: 256, maxWidth: 4096, imageSmoothingQuality: 'high' }).toBlob((blob) => {
            const imgFile = imageFiles.find(f => f.id === currentEditingImageId);
            if(imgFile) {
                imgFile.croppedFile = blob;
                const isMultiplayer = !elements.hostQuizGenerationView.classList.contains('hidden');
                const currentFiles = imageFiles.map(f => f.croppedFile || f.originalFile);
                processAndExtractAllImages(currentFiles, isMultiplayer);
            }
            closeCropModal();
        });
    }

    // --- MULTIPLAYER LOBBY LOGIC (FIREBASE) ---
    // UPDATED AND CORRECTED FUNCTION
    async function checkForHostRejoin() {
        const hostData = JSON.parse(localStorage.getItem(HOST_DATA_KEY));
        if (hostData && hostData.isHost) {
            showLoading("Rejoining your room as host...");
            const roomRef = ref(db, `rooms/${hostData.roomCode}`);
            const snapshot = await get(roomRef);

            if (snapshot.exists() && snapshot.val().hostId === hostData.userId) {
                isHost = true;
                currentRoomCode = hostData.roomCode;
                currentUserId = hostData.userId;
                sessionStorage.setItem('currentRoomCode', currentRoomCode);
                
                const participantRef = ref(db, `rooms/${currentRoomCode}/participants/${currentUserId}`);
                
                // --- NEW: Send an explicit "I'm back" signal ---
                // This update ensures all listeners get a fresh 'roomData' object with the host online
                // and the status confirmed as 'waiting'.
                await update(roomRef, {
                    [`participants/${currentUserId}/isOnline`]: true,
                    status: 'waiting' // Re-assert the status
                });
                // --- END OF NEW SIGNAL ---

                onDisconnect(participantRef).update({ isOnline: false });
                
                const roomData = (await get(roomRef)).val(); // Get the fresh data after our update
                
                if (hostData.awaitingQuizPaste && roomData.status === 'waiting') {
                    listenToRoomChanges(currentRoomCode); 
                    showHostPasteScreen();
                    hideLoading();
                    return true;
                }

                if (roomData.status === 'active') {
                    quizData = roomData.quiz.questions;
                    originalQuizData = JSON.parse(JSON.stringify(quizData));
                    userAnswers = (roomData.answers && roomData.answers[currentUserId]) ? roomData.answers[currentUserId] : originalQuizData.map(() => ({ selected: null, isCorrect: null, status: 'unseen' }));
                    quizMetaData = {
                        topic: roomData.topic,
                        subject: roomData.subject,
                        difficulty: roomData.quiz.difficulty,
                        duration: roomData.timeLimit,
                        startTime: roomData.quiz.startTime
                    };
                    showScreen('player');
                    const firstUnanswered = userAnswers.findIndex(a => a.status !== 'answered');
                    loadQuestion(firstUnanswered !== -1 ? firstUnanswered : 0);
                    if (isHost) {
                        listenForSubmissions();
                    }
                } else if (roomData.status === 'finished') {
                    showResults(); 
                } else {
                    // Default to listening to the room changes if no other state matches
                    listenToRoomChanges(currentRoomCode);
                }
                
                hideLoading();
                return true;
            } else {
                // The room doesn't exist or the host ID doesn't match, so clear the stale data.
                localStorage.removeItem(HOST_DATA_KEY);
                hideLoading();
            }
        }
        return false;
    }
    
    function showHostPasteScreen() {
        showScreen('paste');
        elements.pasteContainerTagline.textContent = "Host - Final Step";
        elements.pasteContainerMessage.textContent = "Paste the generated quiz text below to start the quiz for everyone in the room.";
        handleClipboardPermission();
    }

    function generateRoomCode() {
        return Math.floor(100000 + Math.random() * 900000).toString();
    }

    async function handleCreateRoom() {
        const hostName = elements.hostNameInput.value.trim();
        const timeLimit = elements.hostTimeLimitInput.value;

        if (!hostName) {
            alert("Please enter your name as the host.");
            shakeElement(elements.hostNameInput);
            return;
        }

        showLoading('Creating room...');
        isHost = true;
        currentRoomCode = generateRoomCode();
        const roomRef = ref(db, `rooms/${currentRoomCode}`);
        const participantRef = ref(db, `rooms/${currentRoomCode}/participants/${currentUserId}`);

        const roomData = {
            hostId: currentUserId,
            timeLimit: parseInt(timeLimit, 10),
            createdAt: serverTimestamp(),
            status: 'waiting',
            participants: {
                [currentUserId]: {
                    name: hostName,
                    joinedAt: serverTimestamp(),
                    isOnline: true 
                }
            }
        };

        try {
            await set(roomRef, roomData);
            onDisconnect(participantRef).update({ isOnline: false });

            const hostSessionData = {
                roomCode: currentRoomCode,
                userId: currentUserId,
                isHost: true,
                awaitingQuizPaste: false
            };
            localStorage.setItem(HOST_DATA_KEY, JSON.stringify(hostSessionData));
            
            sessionStorage.setItem('currentRoomCode', currentRoomCode);
            hideLoading();
            listenToRoomChanges(currentRoomCode);
        } catch (error) {
            console.error("Error creating room:", error);
            hideLoading();
            alert("Could not create room. Please try again.");
            isHost = false; 
        }
    }

    async function handleJoinRoomAttempt() {
        const playerName = elements.playerNameInput.value.trim();
        const roomCode = elements.joinGameCodeInput.value.trim();

        if (!playerName) { alert("Please enter your name."); shakeElement(elements.playerNameInput); return; }
        if (!roomCode) { alert("Please enter a room code."); shakeElement(elements.joinGameCodeInput); return; }

        showLoading('Joining room...');
        const roomRef = ref(db, `rooms/${roomCode}`);

        try {
            const snapshot = await get(roomRef);
            if (!snapshot.exists()) {
                elements.roomNotFoundNotification.classList.remove('hidden');
                setTimeout(() => elements.roomNotFoundNotification.classList.add('hidden'), 3000);
                hideLoading();
                return;
            }

            const roomData = snapshot.val();
            if (roomData.status !== 'waiting') {
                alert("This quiz has already started or is finished.");
                hideLoading();
                return;
            }

            const numParticipants = Object.keys(roomData.participants || {}).length;
            if (numParticipants >= MAX_PARTICIPANTS) {
                elements.roomFullNotification.classList.remove('hidden');
                setTimeout(() => elements.roomFullNotification.classList.add('hidden'), 3000);
                hideLoading();
                return;
            }

            isHost = false;
            currentRoomCode = roomCode;
            const participantRef = ref(db, `rooms/${currentRoomCode}/participants/${currentUserId}`);
            
            await set(participantRef, { name: playerName, joinedAt: serverTimestamp(), isOnline: true });
            onDisconnect(participantRef).update({ isOnline: false });
            
            sessionStorage.setItem('currentRoomCode', currentRoomCode);
            hideLoading();
            listenToRoomChanges(currentRoomCode);

        } catch (error) {
            console.error("Error joining room:", error);
            hideLoading();
            alert("Could not join room. Please check the code and try again.");
        }
    }

    function listenToRoomChanges(roomCode) {
        showScreen('multiplayer');
        elements.roomSelection.classList.add('hidden');
        elements.roomLobby.classList.remove('hidden');

        const roomRef = ref(db, `rooms/${roomCode}`);
        
        if (isHost) {
            elements.hostGenerateQuizBtn.disabled = true;
        }

        if (roomUnsubscribe) roomUnsubscribe();
        roomUnsubscribe = onValue(roomRef, (snapshot) => {
            if (!snapshot.exists()) {
                 if (elements.resultsScreen.classList.contains('hidden')) {
                    alert("The room has been closed by the host.");
                }
                leaveRoom(false, false); 
                return;
            }

            const roomData = snapshot.val();
            
            const participantRef = ref(db, `rooms/${currentRoomCode}/participants/${currentUserId}`);
            update(participantRef, { isOnline: true });
            
            if (roomData.status === 'active' && (!quizData || quizData.length === 0)) {
                quizData = roomData.quiz.questions;
                originalQuizData = JSON.parse(JSON.stringify(quizData));
                quizMetaData = {
                    topic: roomData.topic,
                    subject: roomData.subject,
                    difficulty: roomData.quiz.difficulty,
                    duration: roomData.timeLimit,
                    startTime: roomData.quiz.startTime
                };
                hideLoading();
                showScreen('player');
                startQuiz();
            } else if (roomData.status === 'waiting') {
                 updateLobbyUI(roomData);
            } else if (roomData.status === 'finished' && elements.resultsScreen.classList.contains('hidden')) {
                 showResults();
            }

            if (isHost) {
                elements.hostGenerateQuizBtn.disabled = false;
            }
        });
    }

    // UPDATED AND CORRECTED FUNCTION
    function updateLobbyUI(roomData) {
        if (!roomData || elements.roomLobby.classList.contains('hidden')) return;

        const hostId = roomData.hostId;
        const hostData = (roomData.participants && hostId) ? roomData.participants[hostId] : null;

        // --- NEW LOGIC TO HANDLE HOST ONLINE/OFFLINE STATUS ---
        if (hostData && !hostData.isOnline) {
            // Host is confirmed to be offline
            elements.waitingMessage.textContent = "The host seems to be offline. Waiting for them to return...";
            elements.waitingMessage.style.color = "orange"; // Use a warning color
            if (isHost) {
                // If the current user is the host, but their status is offline, hide their controls
                elements.hostControls.classList.add('hidden');
            }
        } else {
            // Host is online or data is not yet available (default state)
            elements.waitingMessage.textContent = isHost ? "" : "Waiting for the host to start the game...";
            elements.waitingMessage.style.color = ""; // Reset to default color
        }
        // --- END OF NEW LOGIC ---

        elements.roomCodeDisplay.textContent = currentRoomCode;
        elements.roomTopicDisplay.textContent = roomData.topic || 'Waiting for host to create quiz...';
        elements.roomTimeLimitDisplay.textContent = roomData.timeLimit ? `${roomData.timeLimit / 60} Minutes` : 'Not set';
        
        // Toggle host controls based on if the user is the host AND if the host is online
        elements.hostControls.classList.toggle('hidden', !isHost || (hostData && !hostData.isOnline));
        elements.waitingMessage.classList.toggle('hidden', isHost);

        const participants = roomData.participants || {};
        // Filter out participants who might be marked as offline but haven't been removed yet
        const onlineParticipants = Object.keys(participants).filter(uid => participants[uid].isOnline);
        const participantCount = onlineParticipants.length;
        elements.participantCount.textContent = `${participantCount}/${MAX_PARTICIPANTS}`;

        elements.participantList.innerHTML = '';
        Object.keys(participants).forEach(uid => {
            const p = participants[uid];
            const isCurrentUser = uid === currentUserId;
            const isTheHost = uid === roomData.hostId;
            
            // Use a clearer online/offline indicator
            const onlineIndicator = p.isOnline ? '🟢' : '⚪️';
            
            const li = document.createElement('li');
            li.innerHTML = `${onlineIndicator} ${isTheHost ? '👑' : '👤'} ${p.name} ${isCurrentUser ? '(You)' : ''}`;
            
            // Make offline users appear greyed out
            if (!p.isOnline) {
                li.style.opacity = '0.6';
            }
            
            elements.participantList.appendChild(li);
        });
    }

    async function leaveRoom(isIntentional = true, wasHost = false) {
        clearHostDecisionTimers();
    
        if (roomUnsubscribe) { roomUnsubscribe(); roomUnsubscribe = null; }
        if (roomStatusUnsubscribe) { roomStatusUnsubscribe(); roomStatusUnsubscribe = null; }
        if (submissionsListener) { submissionsListener(); submissionsListener = null; }
    
        if (isIntentional && currentRoomCode && currentUserId) {
            const participantRef = ref(db, `rooms/${currentRoomCode}/participants/${currentUserId}`);
            onDisconnect(participantRef).cancel(); 
            
            if (wasHost) {
                await remove(ref(db, `rooms/${currentRoomCode}`)).catch(err => console.error("Host: Error removing room on leave:", err));
            } else {
                 await remove(participantRef).catch(err => console.error("Player: Error removing self on leave:", err));
            }
        }
    
        currentRoomCode = null;
        isHost = false;
        quizData = []; 
        originalQuizData = [];
        userAnswers = [];
        sessionStorage.removeItem('currentRoomCode');
        sessionStorage.removeItem('promptGeneratedForHost');
        
        if (wasHost) {
           localStorage.removeItem(HOST_DATA_KEY);
        }
       
        showScreen('manualGenerator');
        elements.roomLobby.classList.add('hidden');
        elements.roomSelection.classList.remove('hidden');
    }

    function handleShareCode() {
        const time = elements.roomTimeLimitDisplay.textContent;
        const brandMessage = `*Quiz Se Kro Success Yatra!*
Create quizzes from topics, text, images, or PDFs, and challenge friends!`;

        const message = `You're invited to a study room on Examyatri! 🚀\n\n*Time Limit:* ${time}\n\n*Joining Code:* \`${currentRoomCode}\`\n\n*Join here:* ${window.location.href}\n\n---\n*About EXAMYATRI:*\n${brandMessage}`;

        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
    }

    function openHostQuizGenerationView() {
        showScreen('hostQuizGeneration');
        elements.hostGeneratorWorkflowContainer.innerHTML = '';
        elements.hostGeneratorWorkflowContainerWrapper.classList.add('hidden');
        elements.hostCreationMethodSelector.classList.remove('hidden');

        const workflowsToClone = ['topic', 'text', 'image', 'pdf'];
        workflowsToClone.forEach(type => {
            const originalWorkflow = document.getElementById(`${type}-generator-workflow`);
            if (!originalWorkflow) return;
            const clonedWorkflow = originalWorkflow.cloneNode(true);
            clonedWorkflow.id = `host-${type}-workflow`;

            clonedWorkflow.querySelectorAll('[id]').forEach(el => {
                const oldId = el.id;
                const newId = `host-${el.id}`;
                clonedWorkflow.querySelectorAll(`label[for="${oldId}"]`).forEach(label => label.htmlFor = newId);
                el.id = newId;
            });

            if (type === 'topic') {
                const topicInput = clonedWorkflow.querySelector('#host-prompt-topic-topic');
                if (topicInput) { topicInput.closest('.input-group').classList.remove('hidden'); topicInput.required = true; }
            }

            clonedWorkflow.querySelector('.back-to-selection-btn')?.remove();

            const backToTypeBtn = document.createElement('button');
            backToTypeBtn.textContent = '↩️ Back to Quiz Type Selection';
            backToTypeBtn.className = 'btn btn-secondary btn-full-width';
            backToTypeBtn.style.marginTop = '1rem';
            backToTypeBtn.addEventListener('click', (e) => {
                 e.preventDefault();
                 elements.hostGeneratorWorkflowContainerWrapper.classList.add('hidden');
                 elements.hostCreationMethodSelector.classList.remove('hidden');
            });
            clonedWorkflow.appendChild(backToTypeBtn);

            clonedWorkflow.querySelector('.glowing').addEventListener('click', (e) => {
                e.preventDefault();
                handleGeneratePrompt(type, true);
            });

            elements.hostGeneratorWorkflowContainer.appendChild(clonedWorkflow);
        });
    }

    function showHostWorkflow(workflowName) {
        const container = elements.hostGeneratorWorkflowContainer;
        container.querySelectorAll('div[id*="-workflow"]').forEach(el => el.classList.add('hidden'));
        const workflowToShow = container.querySelector(`#host-${workflowName}-workflow`);
        if (workflowToShow) workflowToShow.classList.remove('hidden');
        elements.hostCreationMethodSelector.classList.add('hidden');
        elements.hostGeneratorWorkflowContainerWrapper.classList.remove('hidden');
    }

    // --- === NEW GUARANTEED SOLUTION IMPLEMENTATION === ---
    function startManualQuiz() {
        const text = elements.quizDataInput.value.trim();
        if (!text) {
            alert('Please paste the quiz response into the box.');
            return;
        }

        const isForMultiplayer = !!currentRoomCode;
        sessionStorage.removeItem('promptGeneratedForSolo');
        sessionStorage.removeItem('promptGeneratedForHost');

        const parsedQuestions = transformParsedData(parseQuizText(text));

        if (!parsedQuestions || parsedQuestions.length === 0) {
            alert('Parsing Failed: Could not find any valid questions. Please check the AI response format.');
            return;
        }

        const validation = validateParsedData(parsedQuestions);
        if (!validation.isValid) {
            alert(`Quiz Validation Failed:\n\n${validation.error}`);
            return;
        }

        // --- SOLO QUIZ PATH ---
        if (!isForMultiplayer) {
            quizData = parsedQuestions;
            originalQuizData = JSON.parse(JSON.stringify(quizData));
            showScreen('player');
            startQuiz();
            return;
        }

        // --- MULTIPLAYER HOST PATH ---
        if (isHost && currentRoomCode) {
            showLoading("Broadcasting quiz to the room...");

            const hostData = JSON.parse(localStorage.getItem(HOST_DATA_KEY) || '{}');
            if (hostData.awaitingQuizPaste) {
                hostData.awaitingQuizPaste = false;
                localStorage.setItem(HOST_DATA_KEY, JSON.stringify(hostData));
            }

            const quizPayload = {
                questions: parsedQuestions,
                startTime: serverTimestamp(),
                difficulty: quizMetaData.difficulty,
            };

            const roomUpdates = {
                [`/rooms/${currentRoomCode}/quiz`]: quizPayload,
                [`/rooms/${currentRoomCode}/status`]: 'active',
                [`/rooms/${currentRoomCode}/topic`]: quizMetaData.topic,
                [`/rooms/${currentRoomCode}/subject`]: quizMetaData.subject,
            };
            
            // This now uses a direct success/failure check instead of relying on the listener.
            update(ref(db), roomUpdates).then(() => {
                console.log("Host: Broadcast to Firebase successful.");
                // The host's own listener will pick up this change and start the quiz.
                // No further action is needed here, as the listener is the single source of truth.
                // The loading screen will be hidden by the listener callback.
            }).catch(error => {
                console.error("HOST FAILED TO BROADCAST QUIZ:", error);
                hideLoading();
                alert("Critical Error: Could not broadcast the quiz to the room due to a database error. Please try creating a new room.");
            });
        }
    }

    function validateParsedData(questions) {
        for (let i = 0; i < questions.length; i++) {
            const q = questions[i];
            const qNum = i + 1;
            if (!q.question || q.question.trim() === '') return { isValid: false, error: `Question ${qNum} is missing its main text.` };
            if (!q.options || q.options.length < 2) return { isValid: false, error: `Question ${qNum} has fewer than two options.` };
            if (typeof q.correctAnswerIndex !== 'number' || q.correctAnswerIndex < 0 || q.correctAnswerIndex >= q.options.length) {
                return { isValid: false, error: `Could not find a valid correct answer for Question ${qNum}. Check the 'Correct Answer' line.` };
            }
            if (!q.explanation || q.explanation.trim() === '') return { isValid: false, error: `Question ${qNum} is missing its explanation.` };
        }
        return { isValid: true };
    }

    function transformParsedData(parsedItems) {
        return parsedItems.map(item => {
            if (!item) return null;

            const cleanedOptions = item.options.map(opt => opt.replace(/^[a-zA-Z]\)\s*/, '').trim());
            let correctAnswerText = item.answer.replace(/^[a-zA-Z]\)\s*/, '').trim();

            let correctAnswerIndex = cleanedOptions.findIndex(opt =>
                opt.toLowerCase() === correctAnswerText.toLowerCase()
            );

            if (correctAnswerIndex === -1) {
                const answerLetter = item.answer.trim().charAt(0).toLowerCase();
                 correctAnswerIndex = answerLetter.charCodeAt(0) - 'a'.charCodeAt(0);
            }

            if (correctAnswerIndex < 0 || correctAnswerIndex >= cleanedOptions.length) {
                console.error("Could not determine correct answer index for:", item);
                return null;
            }

            return {
                question: item.question,
                options: cleanedOptions,
                correctAnswerIndex: correctAnswerIndex,
                explanation: item.explanation,
                statements: item.statements || [],
                image: null,
                difficulty: quizMetaData.difficulty
            };
        }).filter(Boolean);
    }

    function parseQuizText(text) {
        if (!text || !text.trim()) return [];
        const questionBlocks = text.trim().split(/\n(?=\d+\.\s.*Questions\n)/);
        return questionBlocks.map(block => {
            const trimmedBlock = block.trim();
            let data = { type: 'Unknown', question: '', statements: [], options: [], answer: '', explanation: '' };
            const headerMatch = trimmedBlock.match(/^\d+\.\s(.*?)\s*Questions/);
            const headerText = headerMatch ? headerMatch[1] : '';
            if (headerText.includes('Assertion-Reason')) data.type = 'Assertion-Reason';
            else if (headerText.includes('Statement-Based')) data.type = 'Statement-Based';
            else if (headerText.includes('True/False')) data.type = 'True/False';
            else data.type = 'MCQ';
            const questionRegex = /Question:([\s\S]*?)Options:\n([\s\S]*?)Correct Answer:([\s\S]*?)Explanation:([\s\S]*)/;
            const match = trimmedBlock.match(questionRegex);
            if (!match) {
                 console.warn("Block did not match regex:", trimmedBlock);
                 return null;
            }
            let questionText = (match[1] || '').trim();
            data.options = (match[2] || '').trim().split('\n').map(o => o.trim()).filter(o => o);
            data.answer = (match[3] || '').trim();
            data.explanation = (match[4] || 'No explanation provided.').trim();
            if (data.type === 'Statement-Based') {
                 const statementParts = questionText.split(/Which of the above statements/i);
                 if (statementParts.length > 1) {
                    data.statements = statementParts[0].split('*').map(s => s.trim()).filter(s => s);
                    data.question = `Which of the above statements${statementParts[1]}`;
                 } else {
                    data.question = questionText;
                 }
            } else {
                data.question = questionText;
            }
            return data;
        }).filter(Boolean);
    }



    // --- UTILITY & RESULTS FUNCTIONS ---
    async function restartQuiz() {
        if(currentRoomCode) {
            await leaveRoom(true, isHost);
        }
        clearFormState();
        sessionStorage.removeItem('promptGeneratedForSolo');
        await dbHelper.clear();
        window.location.reload();
    }

    function getFullQuizContent(bookmarksOnly) {
        const indicesToCopy = bookmarksOnly ? Array.from(bookmarkedQuestions) : Array.from(originalQuizData.keys());

        if (indicesToCopy.length === 0) {
            return null;
        }

        const totalQuestions = originalQuizData.length;
        const correctCount = userAnswers.filter(ans => ans.isCorrect).length;
        const incorrectCount = userAnswers.filter(ans => ans.status === 'answered' && !ans.isCorrect).length;
        const skippedCount = totalQuestions - correctCount - incorrectCount;
        const percentage = totalQuestions > 0 ? (correctCount / totalQuestions) * 100 : 0;

        let preamble = `*QUIZ SUMMARY*\n`;
        if (quizMetaData.topic) preamble += `Topic: ${quizMetaData.topic}\n`;
        if (quizMetaData.subject) preamble += `Subject: ${quizMetaData.subject}\n`;
        preamble += `--------------------\n`;
        preamble += `Score: ${correctCount} / ${totalQuestions} (${percentage.toFixed(0)}%)\n`;
        preamble += `Correct: ${correctCount}\n`;
        preamble += `Incorrect: ${incorrectCount}\n`;
        preamble += `Skipped: ${skippedCount}\n`;
        preamble += `--------------------\n\n`;

        const questionsText = indicesToCopy.map(qIndex => {
            const q = originalQuizData[qIndex];
            let questionText = `Question ${qIndex + 1}: ${q.question.replace(/<b>|<\/b>/g, '')}`;
            if (q.statements && q.statements.length > 0) {
                const statementText = q.statements.map(stmt => `* ${stmt}`).join('\n');
                questionText = `Question ${qIndex + 1}:\n${statementText}\n${q.question.replace(/<b>|<\/b>/g, '')}`;
            }
            const optionsText = q.options.map((opt, i) => `${String.fromCharCode(65 + i)}) ${opt}`).join('\n');
            const correctAnswerText = q.options[q.correctAnswerIndex];
            return `${questionText}\n\nOptions:\n${optionsText}\n\nCorrect Answer: ${correctAnswerText}\nExplanation: ${q.explanation}`;
        }).join('\n\n---\n\n');

        return preamble + (bookmarksOnly ? '*BOOKMARKED QUESTIONS*\n\n' : '*ALL QUESTIONS*\n\n') + questionsText;
    }

    function copyQuizContent(bookmarksOnly) {
        const fullTextToCopy = getFullQuizContent(bookmarksOnly);

        if (!fullTextToCopy) {
            showPasteNotification(`🤔 No ${bookmarksOnly ? 'bookmarked ' : ''}questions to copy!`);
            return;
        }

        copyTextToClipboard(fullTextToCopy).then(() => showPasteNotification(`✅ Summary & ${bookmarksOnly ? 'bookmarked ' : 'all '}questions copied!`));
    }


    function copyTextToClipboard(text) { return new Promise((resolve, reject) => { if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(text).then(resolve).catch(err => { console.warn('Modern clipboard API failed, falling back.', err); legacyCopy(reject); }); } else { legacyCopy(reject); } function legacyCopy(onFail) { const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = "fixed"; textArea.style.top = "-9999px"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try { document.execCommand('copy') ? resolve() : onFail(new Error('Legacy copy command failed.')); } catch (err) { console.error('Legacy copy failed.', err); onFail(err); } finally { document.body.removeChild(textArea); } } }).catch(() => { showManualCopyModal(text); throw new Error("Manual intervention required for copy."); }); }
    function showManualCopyModal(text) { elements.manualCopyTextarea.value = text; elements.manualCopyModalOverlay.classList.remove('hidden'); elements.manualCopyTextarea.select(); elements.manualCopyTextarea.focus(); }
    function showPasteNotification(message) { elements.pasteNotification.textContent=message;elements.pasteNotification.classList.add('show');setTimeout(()=>elements.pasteNotification.classList.remove('show'),3000)}
    function toggleTheme(){document.body.classList.toggle('dark-mode');const isDarkMode=document.body.classList.contains('dark-mode');localStorage.setItem('quizTheme',isDarkMode?'dark':'light');elements.themeToggleBtn.textContent=isDarkMode?'☀️':'🌙'}
    function applyInitialTheme(){if(localStorage.getItem('quizTheme')==='dark'){document.body.classList.add('dark-mode');elements.themeToggleBtn.textContent='☀️'}}

    function shareOnWhatsApp() {
        const totalQuestions = originalQuizData.length;
        if (totalQuestions === 0) return;

        const correctCount = userAnswers.filter(ans => ans.isCorrect).length;
        const incorrectCount = userAnswers.filter(ans => ans.status === 'answered' && !ans.isCorrect).length;
        const skippedCount = totalQuestions - correctCount - incorrectCount;
        const percentage = (correctCount / totalQuestions) * 100;

        let remark = "Keep Practicing!";
        if (percentage >= 90) remark = "Excellent Work! 🤩";
        else if (percentage >= 75) remark = "Great Job! 👍";
        else if (percentage >= 50) remark = "Good Effort! 😊";

        const topic = quizMetaData.topic || 'a fun quiz';
        const urlToShare = window.location.href;

        const messageParts = [
            `*🏆 My Quiz Results on EXAMYATRI! 🏆*`,
            `\nI just took a quiz on *"${topic}"* and here's how I did:`,
            `\n*Overall Score: ${correctCount} / ${totalQuestions}*`,
            `-----------------------------------`,
            `*Detailed Breakdown:*`,
            `✅ Correct: ${correctCount}`,
            `❌ Incorrect: ${incorrectCount}`,
            `⏭️ Skipped: ${skippedCount}`,
            `📊 Percentage: *${percentage.toFixed(0)}%*`,
            `🗣️ Remark: _${remark}_`,
            `-----------------------------------`,
            `Think you can do better? Create your own quizzes on *EXAMYATRI* - _Quiz Se Kro Success Yatra!_ 🚀`,
            `\n👉 ${urlToShare}`
        ];

        const fullText = messageParts.join('\n');
        const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(fullText)}`;
        window.open(whatsappUrl, '_blank');
    }

    function shareWebsite() {
        const shareTitle = "EXAMYATRI - Quiz Se Kro Success Yatra";
        const shareText = `Check out EXAMYATRI, an amazing AI-powered quiz generator!

*Quiz Se Kro Success Yatra!*

Key Features:
• 📝 Generate quizzes from any Topic
• 📋 Create quizzes by pasting Text
• 🖼️ Make quizzes from Images of notes
• 📄 Upload a PDF to get questions
• 👥 Challenge friends in multiplayer mode
• 🎯 Tailor questions for exams like UPSC, NEET, etc.
• ✨ Fun, interactive quiz experience!

Create your own quiz now:`;
        const shareUrl = window.location.href;

        if (navigator.share) {
            navigator.share({
                title: shareTitle,
                text: `${shareText}\n${shareUrl}`,
                url: shareUrl,
            }).catch(console.error);
        } else {
            // Fallback for desktop browsers
            copyTextToClipboard(`${shareText}\n${shareUrl}`)
                .then(() => showPasteNotification('✅ Share message copied to clipboard!'))
                .catch(() => showPasteNotification('❌ Could not copy message.'));
        }
    }

    async function openTelegramWithBookmarks() {
        const username = elements.resultsPageTelegramInput.value.trim();
        if (!username) {
            alert("Please enter your Telegram channel username first.");
            shakeElement(elements.resultsPageTelegramInput);
            return;
        }

        const message = getFullQuizContent(true);
        if (!message) {
            showPasteNotification("🤔 You have no bookmarked questions. Bookmark some first!");
            return;
        }

        try {
            await copyTextToClipboard(message);
            showPasteNotification('✅ Bookmarks & summary copied!');

            const channel = username.replace(/^@/, '');
            const url = `https://t.me/${channel}`;
            window.open(url, '_blank');

            setTimeout(() => {
                showPasteNotification('Now paste the text into your Telegram channel.');
            }, 3200);

        } catch (error) {
            console.error("Could not complete the Telegram-open process:", error);
        }
    }

    async function generatePDF() { const { jsPDF } = window.jspdf; const doc = new jsPDF(); let y = 15; const pageHeight = doc.internal.pageSize.height; const margin = 15; const checkY = (inc) => { if (y + inc > pageHeight - margin) { doc.addPage(); y = margin; } }; doc.setFontSize(18).setFont(undefined, 'bold').text("Quiz Results", margin, y); y += 10; doc.setFontSize(12).setFont(undefined, 'normal'); const summaryDetails = Array.from(elements.quizSummaryDetails.querySelectorAll('.summary-item')).map(item => `${item.querySelector('.summary-label').textContent}: ${item.querySelector('.summary-value').textContent}`).join(' | '); doc.text(elements.scoreSummary.textContent, margin, y); y += 7; let summaryLines = doc.splitTextToSize(summaryDetails, 180); doc.text(summaryLines, margin, y); y += summaryLines.length * 5 + 10; doc.line(margin, y - 5, doc.internal.pageSize.width - margin, y - 5); originalQuizData.forEach((q, i) => { checkY(20); doc.setFontSize(14).setFont(undefined, 'bold'); const questionText = doc.splitTextToSize(`Q${i + 1}: ${q.question.replace(/<[^>]*>/g, '')}`, 180); doc.text(questionText, margin, y); y += questionText.length * 6; doc.setFontSize(11).setFont(undefined, 'normal'); q.options.forEach((opt, oi) => { checkY(7); let prefix = '  '; if(oi === q.correctAnswerIndex) { doc.setTextColor(34, 139, 34); prefix = '✔ '; } if(userAnswers[i] && userAnswers[i].selected === oi && !userAnswers[i].isCorrect) { doc.setTextColor(220, 20, 60); prefix = '✖ '; } doc.text(doc.splitTextToSize(`${prefix}${opt}`, 175), margin + 5, y); y += 6; doc.setTextColor(0, 0, 0); }); y += 5; checkY(15); doc.setFont(undefined, 'bold').text("Explanation:", margin, y); y += 5; doc.setFont(undefined, 'normal'); const explanationText = doc.splitTextToSize(q.explanation.replace(/<[^>]*>/g, ''), 180); checkY(explanationText.length * 5 + 10); doc.text(explanationText, margin, y); y += explanationText.length * 5 + 10; }); doc.save(`Quiz_Results_${new Date().toISOString().slice(0,10)}.pdf`); }

    // --- Feedback Effect Functions ---
    function triggerCongratsAnimation() {
        const container = elements.congratsAnimationContainer;
        container.innerHTML = '';

        clapSound.currentTime = 0;
        clapSound.play();

        const emojiList = ['🎉', '🥳', '🤩', '💯', '✨', '🎊', '🎇', '🎖️', '🏆', '🌟', '🎈'];
        const numEmojis = 60;
        for (let i = 0; i < numEmojis; i++) {
            const emoji = document.createElement('span');
            emoji.className = 'congrats-emoji';
            emoji.textContent = emojiList[i % emojiList.length];
            const angle = Math.random() * 2 * Math.PI;
            const radius = 50 + Math.random() * 50;
            const x = Math.cos(angle) * radius;
            const y = Math.sin(angle) * radius;
            emoji.style.setProperty('--transform-end', `translate(${x}vw, ${y}vh) rotate(${Math.random() * 720 - 360}deg)`);
            emoji.style.animationDelay = `${Math.random() * 0.4}s`;
            container.appendChild(emoji);
        }

        setTimeout(() => {
            container.innerHTML = '';
            if (!clapSound.paused) {
                clapSound.pause();
                clapSound.currentTime = 0;
            }
        }, 2500);
    }

    function showSadReaction() {
        const sadEmojis = ['😠', '😭', '😢'];
        elements.sadReactionEmoji.textContent = sadEmojis[Math.floor(Math.random() * sadEmojis.length)];
        elements.sadReactionOverlay.classList.remove('hidden');
        setTimeout(() => {
            elements.sadReactionOverlay.classList.add('hidden');
        }, 1500);
    }

    function loadPressureModeSettings() {
        const shakeEnabled = localStorage.getItem('shakeReminderEnabled');
        isShakeReminderEnabled = shakeEnabled === null ? true : shakeEnabled === 'true';
        elements.shakeReminderToggle.checked = isShakeReminderEnabled;
    }


    // --- QUIZ PLAYER LOGIC ---
    function resetAndStartQuestionTimer() {
        clearInterval(timerId);
        const isMultiplayer = !!currentRoomCode;

        if (isMultiplayer) {
            const quizStartedAt = quizMetaData.startTime;
            const duration = quizMetaData.duration;

            const updateTimerDisplay = () => {
                const now = Date.now();
                const elapsedSinceQuizStart = Math.floor((now - quizStartedAt) / 1000);
                const remaining = duration - elapsedSinceQuizStart;

                if (remaining <= 0) {
                    elements.timerText.textContent = "00:00";
                    clearInterval(timerId);
                    if (elements.quizPlayerContainer.offsetParent !== null) {
                        forceSubmitQuiz();
                    }
                    return;
                }

                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                elements.timerText.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            };

            updateTimerDisplay();
            timerId = setInterval(updateTimerDisplay, 1000);

        } else {
            questionStartTime = new Date();
            const emojiSequence = [elements.faces.happy, elements.faces.worried, elements.faces.sad, elements.faces.crying];

            const updateTimerDisplay = () => {
                const elapsedOnQuestion = Math.round((new Date() - questionStartTime) / 1000);

                const minutes = Math.floor(elapsedOnQuestion / 60);
                const seconds = elapsedOnQuestion % 60;
                elements.timerText.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                const emojiIntervalIndex = Math.floor(elapsedOnQuestion / 15);
                const currentEmoji = emojiSequence[emojiIntervalIndex % emojiSequence.length];
                if (currentEmoji && !currentEmoji.classList.contains('visible')) {
                    emojiSequence.forEach(face => face.classList.remove('visible'));
                    currentEmoji.classList.add('visible');
                }
                const pressureTextEl = document.getElementById('pressure-text-animation');
                if (elapsedOnQuestion >= 45 && userAnswers[currentQuestionIndex].status !== 'answered') {
                    if (isShakeReminderEnabled) {
                        const checkBtn = document.getElementById('check-answer-btn');
                        if (checkBtn) checkBtn.classList.add('vibrating');
                    }
                    if (pressureTextEl) {
                        elements.pressureModeToggleBtn.classList.add('hidden');
                        pressureTextEl.classList.remove('hidden');
                        pressureTextEl.textContent = `Tik Tik ${pressureTextCounter}`;
                        pressureTextCounter++;
                    }
                }
            };

            updateTimerDisplay();
            timerId = setInterval(updateTimerDisplay, 1000);
        }
    }

    function startQuiz(){
        const isMultiplayer = !!currentRoomCode;
        if (isMultiplayer && quizMetaData.startTime) {
            quizStartTime = new Date(quizMetaData.startTime);
        } else {
            quizStartTime = new Date();
        }

        currentQuestionIndex=0;
        userAnswers = originalQuizData.map(() => ({ selected: null, isCorrect: null, status: 'unseen' }));
        bookmarkedQuestions.clear();

        if (isHost && currentRoomCode) {
            listenForSubmissions();
        }

        loadQuestion(0);
    }
    
    function listenForSubmissions() {
        if (submissionsListener) submissionsListener(); 

        const roomRef = ref(db, `rooms/${currentRoomCode}`);
        const answersRef = ref(db, `rooms/${currentRoomCode}/answers`);
        
        submissionsListener = onValue(answersRef, async (snapshot) => {
            const roomSnapshot = await get(roomRef);
            if (!roomSnapshot.exists()) {
                if(submissionsListener) submissionsListener();
                return;
            }

            const roomData = roomSnapshot.val();
            const currentParticipantIds = Object.keys(roomData.participants || {});
            const answersData = snapshot.val() || {};
            const answeredParticipantIds = Object.keys(answersData);
            
            if (currentParticipantIds.length > 0 && currentParticipantIds.every(uid => answeredParticipantIds.includes(uid))) {
                await update(roomRef, { status: 'finished' });
                
                if (submissionsListener) {
                    submissionsListener();
                    submissionsListener = null;
                }
            }
        });
    }

    function loadQuestion(index){
        if(index<0||index>=originalQuizData.length)return;
        currentQuestionIndex=index;selectedOptionIndex=null;
        const question=originalQuizData[currentQuestionIndex];

        elements.congratsAnimationContainer.innerHTML = '';
        if (!clapSound.paused) {
            clapSound.pause();
            clapSound.currentTime = 0;
        }
        pressureTextCounter = 1;
        document.getElementById('pressure-text-animation')?.classList.add('hidden');
        elements.pressureModeToggleBtn.classList.remove('hidden');

        resetAndStartQuestionTimer();

        updateQuestionUI(question);
        updateOptionsAndExplanationState();
        updateQuizActions();

        if (window.MathJax) {
            MathJax.typesetPromise([elements.quizPlayerContainer]).catch((err) => console.log('MathJax typeset error on question load:', err.message));
        }
    }

    function updateQuestionUI(q){
        elements.questionTopic.textContent=quizMetaData.topic || "Quiz";
        elements.progress.textContent=`Question ${currentQuestionIndex+1} / ${originalQuizData.length}`;
        elements.questionText.innerHTML=q.question.replace(/\n/g, '<br>');
        elements.bookmarkBtn.classList.toggle('bookmarked',bookmarkedQuestions.has(currentQuestionIndex));
        elements.statementsList.innerHTML=q.statements?.map(stmt=>`<p>• ${stmt}</p>`).join('')||'';
        elements.optionsContainer.innerHTML='';
        q.options.forEach((optionText,i)=>{
            const optionDiv=document.createElement('div');
            optionDiv.className='option';
            optionDiv.dataset.index=i;
            optionDiv.innerHTML=`<span class="option-text">${optionText}</span><div class="option-feedback"><span class="user-choice-emoji"></span><span class="feedback-icon"></span></div>`;
            optionDiv.addEventListener('click',()=>selectOption(i));
            elements.optionsContainer.appendChild(optionDiv);
        });

        elements.explanationContainer.classList.add('hidden');
        if(userAnswers[currentQuestionIndex] && userAnswers[currentQuestionIndex].status==='answered'){
             elements.explanationText.innerHTML = `<p>${q.explanation}</p>`;
             elements.explanationContainer.classList.remove('hidden');
        }
    }

    function updateOptionsAndExplanationState(){
        const answer = userAnswers[currentQuestionIndex];
        const question = originalQuizData[currentQuestionIndex];
        const correctEmojis = ['🥳', '🎉', '🤩', '👍', '💯'];
        const incorrectEmojis = ['🤔', '😟', '🤨', '🤦‍♂️', '❌'];

        if (!answer) return;

        document.querySelectorAll('.option').forEach((optionDiv, i) => {
            optionDiv.className = 'option';
            if (answer.status === 'answered') {
                optionDiv.classList.add('disabled');

                if (i === question.correctAnswerIndex) {
                    optionDiv.classList.add('correct');
                    optionDiv.querySelector('.feedback-icon').textContent = '✔️';
                }

                if (i === answer.selected) {
                    const userChoiceEmoji = optionDiv.querySelector('.user-choice-emoji');
                    if (answer.isCorrect) {
                        userChoiceEmoji.textContent = correctEmojis[Math.floor(Math.random() * correctEmojis.length)];
                    } else {
                        optionDiv.classList.add('incorrect');
                        optionDiv.querySelector('.feedback-icon').textContent = '❌';
                        userChoiceEmoji.textContent = incorrectEmojis[Math.floor(Math.random() * incorrectEmojis.length)];
                    }
                    userChoiceEmoji.classList.add('visible');
                }
            } else if (i === selectedOptionIndex) {
                 optionDiv.classList.add('selected');
            }
        });

        elements.explanationContainer.classList.toggle('hidden', answer.status !== 'answered');
    }

    function updateQuizActions() {
        elements.quizActions.innerHTML = '';
        const primaryActions = document.createElement('div');
        primaryActions.className = 'quiz-actions-primary';
        const finalActions = document.createElement('div');
        finalActions.className = 'quiz-actions-final';

        const prevBtn = document.createElement('button');
        prevBtn.id = 'prev-question-btn';
        prevBtn.className = 'btn btn-secondary';
        prevBtn.textContent = '⬅️ Previous';
        prevBtn.disabled = currentQuestionIndex === 0;
        prevBtn.addEventListener('click', () => loadQuestion(currentQuestionIndex - 1));
        primaryActions.appendChild(prevBtn);

        if (userAnswers[currentQuestionIndex].status !== 'answered') {
            const checkBtn = document.createElement('button');
            checkBtn.id = 'check-answer-btn';
            checkBtn.className = 'btn';
            checkBtn.textContent = 'Check Answer ✅';
            checkBtn.disabled = selectedOptionIndex === null;
            checkBtn.addEventListener('click', checkAnswer);
            primaryActions.appendChild(checkBtn);
        }

        const nextBtn = document.createElement('button');
        nextBtn.id = 'next-question-btn';
        nextBtn.className = 'btn';
        nextBtn.textContent = 'Next ➡️';
        nextBtn.disabled = currentQuestionIndex >= originalQuizData.length - 1;
        nextBtn.addEventListener('click', () => loadQuestion(currentQuestionIndex + 1));
        primaryActions.appendChild(nextBtn);

        const submitBtn = document.createElement('button');
        submitBtn.id = 'submit-quiz-btn';
        submitBtn.className = 'btn btn-danger btn-full-width';
        submitBtn.textContent = 'Submit Quiz & See Results';
        submitBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to end the quiz now? All unanswered questions will be marked as skipped.')) {
                forceSubmitQuiz();
            }
        });
        finalActions.appendChild(submitBtn);

        elements.quizActions.appendChild(primaryActions);
        elements.quizActions.appendChild(finalActions);
    }

    function handleBookmark(){bookmarkedQuestions.has(currentQuestionIndex)?bookmarkedQuestions.delete(currentQuestionIndex):bookmarkedQuestions.add(currentQuestionIndex);elements.bookmarkBtn.classList.toggle('bookmarked')}
    
    async function forceSubmitQuiz() {
        if (timerId) clearInterval(timerId);

        userAnswers.forEach((answer, index) => {
            if (answer && answer.status === 'unseen') {
                userAnswers[index].status = 'skipped';
            }
        });

        if (currentRoomCode) {
            showLoading("Submitting your answers...");
            const answersRef = ref(db, `rooms/${currentRoomCode}/answers/${currentUserId}`);
            await set(answersRef, userAnswers);
            showResults();
            hideLoading();
        } else {
            showResults();
        }
    }


    function selectOption(index){
        if(userAnswers[currentQuestionIndex] && userAnswers[currentQuestionIndex].status==='answered')return;
        optionClickSound.play();
        selectedOptionIndex=index;
        document.querySelectorAll('.option').forEach((opt,i)=>opt.classList.toggle('selected',i===index));
        document.getElementById('check-answer-btn')?.removeAttribute('disabled');
    }

    function checkAnswer(){
        if (selectedOptionIndex === null) return;

        clearInterval(timerId);

        const question = originalQuizData[currentQuestionIndex];
        const isCorrect = selectedOptionIndex === question.correctAnswerIndex;
        userAnswers[currentQuestionIndex] = { selected: selectedOptionIndex, isCorrect: isCorrect, status: 'answered' };

        document.getElementById('pressure-text-animation')?.classList.add('hidden');
        elements.pressureModeToggleBtn.classList.remove('hidden');

        if(isCorrect) {
            triggerCongratsAnimation();
        } else {
            showSadReaction();
        }

        elements.explanationText.innerHTML = `<p>${question.explanation}</p>`;
        updateOptionsAndExplanationState();
        updateQuizActions();

        if (window.MathJax) {
            MathJax.typesetPromise([elements.explanationContainer]).catch((err) => console.log('MathJax typeset error on explanation:', err.message));
        }
    }


    async function showResults() {
        if (roomUnsubscribe) { roomUnsubscribe(); roomUnsubscribe = null; }
        showScreen('results');
        if (timerId) clearInterval(timerId);

        let allUsersAnswers = {};
        let roomParticipants = {};
        let timeTakenForQuiz = 'N/A';
        let isQuizFinishedForAll = false;

        if (currentRoomCode) {
            showLoading("Fetching results...");
            const roomRef = ref(db, `rooms/${currentRoomCode}`);
            const roomSnapshot = await get(roomRef);
            const roomData = roomSnapshot.val() || {};

            allUsersAnswers = roomData.answers || {};
            roomParticipants = roomData.participants || {};
            originalQuizData = roomData.quiz?.questions || originalQuizData;
            quizMetaData.topic = roomData.topic || quizMetaData.topic;
            quizMetaData.subject = roomData.subject || quizMetaData.subject;
            isQuizFinishedForAll = roomData.status === 'finished';

            if (!isQuizFinishedForAll) {
                if (roomStatusUnsubscribe) roomStatusUnsubscribe(); 
                const statusRef = ref(db, `rooms/${currentRoomCode}/status`);
                roomStatusUnsubscribe = onValue(statusRef, (snapshot) => {
                    if (snapshot.val() === 'finished') {
                        showResults(); 
                        if (roomStatusUnsubscribe) { roomStatusUnsubscribe = null; }
                    }
                });
            }
            hideLoading();
        } else {
            allUsersAnswers[currentUserId] = userAnswers;
            roomParticipants[currentUserId] = { name: "You" };
            const timeDiff = Math.round((new Date() - quizStartTime) / 1000);
            timeTakenForQuiz = `${String(Math.floor(timeDiff / 60)).padStart(2, '0')}:${String(timeDiff % 60).padStart(2, '0')}`;
            isQuizFinishedForAll = true; 
        }

        elements.scoreSummary.innerHTML = '🏆 Quiz Results 🏆';
        elements.scoreSummary.classList.add('visible');

        if (isQuizFinishedForAll) {
            const userScores = Object.keys(roomParticipants).map(uid => {
                const answers = allUsersAnswers[uid] || [];
                const correctCount = answers.filter(ans => ans && ans.isCorrect).length;
                const totalAnswered = answers.filter(ans => ans && ans.status === 'answered').length;
                const percentage = totalAnswered > 0 ? (correctCount / totalAnswered) * 100 : 0;
                return {
                    uid: uid,
                    name: roomParticipants[uid] ? roomParticipants[uid].name : 'Unknown Player',
                    score: correctCount,
                    total: originalQuizData.length,
                    percentage: percentage.toFixed(0)
                };
            });

            userScores.sort((a, b) => b.score - a.score);

            elements.scoreSummary.innerHTML = currentRoomCode ? '🏆 Final Leaderboard 🏆' : '🏆 Quiz Results 🏆';
            elements.scorePerformanceChartContainer.innerHTML = `
                <ul id="leaderboard" style="list-style-type: none; padding: 0; width: 100%; text-align: left;">
                    ${userScores.map((user, index) => `
                        <li style="background: var(--component-bg); padding: 10px; border-radius: 5px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid ${user.uid === currentUserId ? 'var(--accent-color)' : 'transparent'};">
                            <span><strong>#${index + 1}</strong> ${user.uid === currentUserId ? `<strong>${user.name} (You)</strong>` : user.name}</span>
                            <strong>${user.score}/${user.total}</strong>
                        </li>
                    `).join('')}
                </ul>`;
            
             if (isHost && !hostDecisionTimeout) {
                hostDecisionTimeout = setTimeout(() => {
                    showHostDecisionModal();
                }, 15000);
            }

        } else {
            elements.scoreSummary.innerHTML = '✨ Your Results ✨';
            elements.scorePerformanceChartContainer.innerHTML = `<div class="lobby-info" style="text-align:center; width: 100%;"><p><strong>Waiting for other players to finish...</strong></p><p>The final leaderboard will appear here once everyone has submitted their quiz.</p></div>`;
        }

        const totalQuestions = originalQuizData.length;
        const currentUserAnswers = allUsersAnswers[currentUserId] || userAnswers;
        const correctCount = currentUserAnswers.filter(ans => ans && ans.isCorrect).length;
        const percentage = totalQuestions > 0 ? (correctCount / totalQuestions) * 100 : 0;
        let remark = percentage >= 90 ? "Excellent!" : percentage >= 75 ? "Great Job!" : percentage >= 50 ? "Good Effort!" : "Needs Improvement";

        elements.quizSummaryDetails.innerHTML = `<div class="summary-item"><span class="summary-label">Your Performance</span><span class="summary-value remark">${remark}</span></div><div class="summary-item"><span class="summary-label">Your Score</span><span class="summary-value">${correctCount} / ${totalQuestions} (${percentage.toFixed(0)}%)</span></div><div class="summary-item"><span class="summary-label">Topic</span><span class="summary-value">${quizMetaData.topic || ''}</span></div><div class="summary-item"><span class="summary-label">Time Taken</span><span class="summary-value">${timeTakenForQuiz}</span></div>`;
        elements.resultsReview.innerHTML = originalQuizData.map((q, i) => { const answer = currentUserAnswers[i] || {}; const optionsHtml = q.options.map((opt, oi) => { let classes = 'result-option'; if (answer && answer.status === 'answered' && oi === answer.selected) classes += ' user-selected'; if (oi === q.correctAnswerIndex) classes += ' correct-answer'; return `<li class="${classes}">${opt}</li>` }).join(''); return `<div class="result-item"><p class="result-question"><strong>Q${i + 1}:</strong> ${q.question.replace(/<[^>]*>/g, '')}<span class="bookmark-indicator ${bookmarkedQuestions.has(i) ? 'visible' : ''}">⭐</span></p><ul class="result-options-list">${optionsHtml}</ul><div class="result-explanation"><h5>Explanation</h5><p>${q.explanation.replace(/<[^>]*>/g, '')}</p></div></div>` }).join('');
        
        elements.restartBtn.classList.add('hidden');
        document.getElementById('multiplayer-leave-btn')?.remove();
        
        if (currentRoomCode) {
            const leaveBtn = document.createElement('button');
            leaveBtn.id = 'multiplayer-leave-btn';
            leaveBtn.textContent = '🚪 Leave Room';
            leaveBtn.className = 'btn btn-secondary fire-animation';
            leaveBtn.addEventListener('click', () => leaveRoom(true, isHost));
            elements.shareWhatsappBtn.insertAdjacentElement('afterend', leaveBtn);
        } else {
            elements.restartBtn.classList.remove('hidden');
        }

        if (window.MathJax) {
            MathJax.typesetPromise([elements.resultsScreen]).catch((err) => console.log('MathJax typeset error on results:', err.message));
        }
    }

    
    // --- HOST POST-QUIZ DECISION LOGIC ---
    function showHostDecisionModal() {
        if(elements.hostDecisionModalOverlay.classList.contains('hidden')) {
            elements.hostDecisionModalOverlay.classList.remove('hidden');
            let countdown = 20;
            elements.hostDecisionTimer.textContent = countdown;
            
            hostDecisionInterval = setInterval(() => {
                countdown--;
                elements.hostDecisionTimer.textContent = countdown;
                 if (countdown <= 0) {
                    clearInterval(hostDecisionInterval);
                }
            }, 1000);

            hostDecisionTimeout = setTimeout(() => {
                clearInterval(hostDecisionInterval);
                endRoomForAll(true); // Auto-end after 20 seconds
            }, 20000);
        }
    }

    function clearHostDecisionTimers() {
        clearTimeout(hostDecisionTimeout);
        clearInterval(hostDecisionInterval);
        hostDecisionTimeout = null;
        hostDecisionInterval = null;
        elements.hostDecisionModalOverlay.classList.add('hidden');
    }

    function handleHostDecisionEnd() {
        clearHostDecisionTimers();
        endRoomForAll();
    }
    
    function handleHostDecisionRestart() {
        clearHostDecisionTimers();
        startNewMultiplayerQuiz();
    }
    
    async function endRoomForAll(isAutoEnd = false) {
        if (!isHost || !currentRoomCode) return;
        if (!isAutoEnd && !confirm("Are you sure you want to end this room for everyone?")) return;
        
        showLoading("Closing room...");
        
        try {
            await remove(ref(db, `rooms/${currentRoomCode}`));
        } catch(error) {
            console.error("Error removing room from Firebase:", error);
        }
        
        hideLoading();
        leaveRoom(true, true); 
    }

    async function startNewMultiplayerQuiz() {
        if (!isHost || !currentRoomCode) return;
        showLoading("Resetting room for a new quiz...");

        const roomUpdates = {
            quiz: null,
            answers: null,
            status: 'waiting',
            topic: 'Waiting for host to create a new quiz...'
        };

        try {
            await update(ref(db, `rooms/${currentRoomCode}`), roomUpdates);
            hideLoading();
            openHostQuizGenerationView();
        } catch (error) {
            console.error("Error resetting room:", error);
            hideLoading();
            alert("Could not reset the room. Please try ending it and creating a new one.");
        }
    }

});
</script>
  <!-- Help Me Button -->
<button onclick="openHelpModal()" style="
  position: fixed;
  bottom: 20px;
  left: 20px;
  background-color: #007BFF;
  color: white;
  border: none;
  border-radius: 30px;
  padding: 12px 20px;
  font-size: 16px;
  z-index: 9999;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
">
  How to use
</button>

<!-- Help Modal -->
<div id="helpModal" style="
  display: none;
  position: fixed;
  z-index: 10000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.8);
">
  <div style="
    background-color: #1c1c1e;
    color: white;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 90%;
    max-width: 600px;
    border-radius: 10px;
    max-height: 85%;
    overflow-y: auto;
  ">
    <span onclick="closeHelpModal()" style="
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    ">&times;</span>

    <h2 style="color: #00BFFF;">Guide: Create Quiz from Topic</h2>

    <h3>Step 1: Enter Your Topic</h3>
    <p>First, fill in the "Quiz Topic" field. For example: "World War II" or "Solar System".<br>
    <i>(चरण 1: अपना विषय दर्ज करें - सबसे पहले, "Quiz Topic" फील्ड भरें। उदाहरण के लिए: "द्वितीय विश्व युद्ध" या "सौर मंडल")</i></p>

    <h3>Step 2: Fill Quiz Details</h3>
    <p>Fill in the details like Number of Questions, Subject, Language, Difficulty, Exam, and Question Format.<br>
    <i>(चरण 2: क्विज़ का विवरण भरें - प्रश्नों की संख्या, विषय, भाषा, कठिनाई, परीक्षा और प्रश्न प्रारूप जैसे विवरण भरें)</i></p>

    <h3>Step 3: Generate Prompt & Open AI</h3>
    <p>Click the big "Start 🚀" button. This automatically copies the instructions for the AI and opens the Gemini website in a new tab.<br>
    <i>(चरण 3: 'Start 🚀' बटन पर क्लिक करें - यह AI के लिए निर्देश अपने आप कॉपी कर लेगा और एक नए टैब में Gemini वेबसाइट खोल देगा)</i></p>

    <h3>Step 4: Use the AI (Gemini)</h3>
    <p>In the Gemini website, just paste the prompt into the message box and send it. Wait for the AI to generate all the questions.<br>
    <i>(चरण 4: AI (Gemini) का उपयोग करें - Gemini वेबसाइट में, बस प्रॉम्प्ट को मैसेज बॉक्स में पेस्ट करें और भेजें। AI द्वारा सभी प्रश्न बनाने तक प्रतीक्षा करें)</i></p>

    <h3>Step 5: Copy AI's Response</h3>
    <p>After the questions are generated, copy the entire response. There are two ways to copy from Gemini:
    <br>1) Click the copy icon (like a clipboard 📋) below the answer.
    <br>2) Click the three dots (...) at the top-right of the response and select 'Copy'.<br>
    <i>(चरण 5: AI की प्रतिक्रिया कॉपी करें - प्रश्न बन जाने के बाद, पूरी प्रतिक्रिया कॉपी करें। Gemini से कॉपी करने के 2 तरीके हैं:
    <br>1) उत्तर के नीचे कॉपी आइकन (📋) पर क्लिक करें।
    <br>2) प्रतिक्रिया के ऊपर-दाईं ओर तीन डॉट्स (...) पर क्लिक करें और 'कॉपी करें' चुनें)</i></p>

    <h3>Step 6: Return to Examyatri</h3>
    <p>You have two choices:
    <br>1) Simply switch tabs from Gemini back to examyatri.
    <br>2) On mobile, you can press your phone's 'Back' navigation button twice. The quiz will be created automatically!<br>
    <i>(चरण 6: Examyatri पर लौटें - आपके पास दो विकल्प हैं:
    <br>1) बस Gemini से वापस examyatri टैब पर जाएं।
    <br>2) मोबाइल पर, अपने फोन का 'Back' बटन दो बार दबाएं। क्विज़ अपने आप बन जाएगा!)</i></p>

    <div style="text-align: center; margin-top: 20px;">
      <button onclick="closeHelpModal()" style="
        background-color: #007BFF;
        color: white;
        border: none;
        border-radius: 10px;
        padding: 10px 20px;
        font-size: 16px;
      ">Got it!</button>
    </div>
  </div>
</div>

<!-- Script to control modal -->
<script>
  function openHelpModal() {
    document.getElementById('helpModal').style.display = 'block';
  }

  function closeHelpModal() {
    document.getElementById('helpModal').style.display = 'none';
  }
</script>
  <!-- Add this in your HTML body -->
      <div id="disclaimer"
        class="disclaimer">
        ⚠️ If website not respond on clicking then delete browsing data of browser (Chrome) and reopen the website.
      </div>

      <style>
        .disclaimer {
          position: fixed;
          top: 10px;
          right: -100%;
          white-space: nowrap;
          background-color: yellow;
          color: red;
          font-weight: bold;
          padding: 5px 10px;
          border: 1px solid red;
          z-index: 9999;
          animation: moveLeft 15s linear infinite;
          font-size: 14px;
        }

        @keyframes moveLeft {
          from {
            right: -100%;
          }
          to {
            right: 100%;
          }
        }
      </style>
  <!-- ② new tiny script: hide after 15 000 ms -->
      <script>
        window.addEventListener('DOMContentLoaded', () => {
          setTimeout(() => {
            const banner = document.getElementById('disclaimer');
            if (banner) banner.style.display = 'none';
          }, 15000); // 15 seconds
        });
      </script>

</body>
</html>