<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EXAMYATRI - Quiz Se Kro Success Yatra</title>
  <!-- Cropper.js CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1HGZL93811"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-1HGZL93811');
</script>
  <!-- ADDED: MathJax for Math/Physics Formula Rendering (CORRECTED CONFIG) -->
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      ignoreHtmlClass: 'tex2jax_ignore',
      processHtmlClass: 'tex2jax_process'
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

  <style>
    /* --- Base & Theme Variables --- */
    :root {
      --primary-bg: #f0f4f8;
      --secondary-bg: #ffffff;
      --component-bg: #f8f9fa;
      --text-color: #333;
      --border-color: #dee2e6;
      --shadow-color: rgba(0, 0, 0, 0.08);
      --accent-color: #007bff;
      --accent-hover: #0056b3;
      --correct-color: #28a745;
      --incorrect-color: #dc3545;
      --skipped-color: #ffc107;
      --bookmark-color: #a5a5a5;
      --bookmarked-active-color: #ffb300;
      --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body.dark-mode {
      --primary-bg: #121212;
      --secondary-bg: #1e1e1e;
      --component-bg: #2a2a2e;
      --text-color: #e0e0e0;
      --border-color: #44474b;
      --shadow-color: rgba(255, 255, 255, 0.08);
      --accent-color: #4dabf7;
      --accent-hover: #1c7ed6;
    }

    /* --- General Styles --- */
    body {
      font-family: var(--font-family);
      background-color: var(--primary-bg);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      /* MODIFIED: Added padding-top to prevent content from hiding behind the new fixed nav bar */
      padding: 80px 20px 20px 20px;
      box-sizing: border-box;
      transition: background-color 0.3s, color 0.3s;
    }

    /* --- NEW: Global Top Navigation Bar --- */
    #global-nav-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 20px;
        background-color: var(--secondary-bg);
        box-shadow: 0 2px 10px var(--shadow-color);
        z-index: 10000;
        box-sizing: border-box;
    }
    #global-how-to-use-btn {
        font-size: 0.9em;
        padding: 8px 15px;
        text-decoration: none; /* Remove underline from anchor tag */
    }
    #global-home-btn {
        font-size: 0.9em;
        padding: 8px 15px;
        animation: aqua-glow 2s infinite ease-in-out;
    }


    .container {
      width: 100%;
      max-width: 800px;
      background-color: var(--secondary-bg);
      border-radius: 10px;
      box-shadow: 0 4px 15px var(--shadow-color);
      overflow: hidden;
      transition: background-color 0.3s, opacity 0.4s ease, transform 0.4s ease;
      margin-bottom: 20px;
      padding: 2rem 2.5rem;
    }

    .container.fade-out {
        opacity: 0;
        transform: scale(0.95);
    }

    .header {
      background-color: var(--accent-color);
      color: white;
      padding: 15px 20px;
      text-align: center;
      font-size: 1.5em;
      position: relative;
      margin: -2rem -2.5rem 2rem -2.5rem; /* Adjust to fit padding */
      border-radius: 10px 10px 0 0;
    }
    body.dark-mode .header { background-color: #1f1f1f; border-bottom: 1px solid var(--border-color); }

    .header-branding {
        font-size: 1em;
        display: inline-flex;
        align-items: center;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.2em 0.6em;
    }
    .header-branding strong {
        font-size: 1.1em;
        letter-spacing: 0.5px;
    }
    .header-branding .tagline {
        font-size: 0.7em;
        opacity: 0.9;
        font-weight: 400;
        margin-top: 0.2em;
    }


    .hidden { display: none !important; }

    /* --- Animations & Effects --- */
    .fade-in-slide-up {
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.5s ease-out, transform 0.5s ease-out;
    }
    .fade-in-slide-up:not(.hidden) {
        opacity: 1;
        transform: translateY(0);
    }

    @keyframes glow {
        0% { box-shadow: 0 0 4px var(--accent-color); }
        50% { box-shadow: 0 0 16px var(--accent-color), 0 0 24px var(--accent-hover); }
        100% { box-shadow: 0 0 4px var(--accent-color); }
    }
    .btn.glowing { animation: glow 1.8s infinite; }

    @keyframes shake-horizontal { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    .is-shaking { animation: shake-horizontal 0.8s cubic-bezier(.36,.07,.19,.97) both; }

    @keyframes fade-out-and-shrink {
      from {
        opacity: 1;
        transform: scale(1);
      }
      to {
        opacity: 0;
        transform: scale(0.9);
      }
    }

    .container.fade-out-and-shrink {
      animation: fade-out-and-shrink 1s ease-out forwards;
    }

    @keyframes aqua-glow {
      0% {
        box-shadow: 0 0 5px #007bff, 0 0 10px #007bff, 0 0 15px #00bfff, 0 0 20px #00bfff, inset 0 0 5px #00bfff;
      }
      50% {
        box-shadow: 0 0 10px #007bff, 0 0 20px #007bff, 0 0 30px #00bfff, 0 0 40px #00bfff, inset 0 0 10px #00bfff;
      }
      100% {
        box-shadow: 0 0 5px #007bff, 0 0 10px #007bff, 0 0 15px #00bfff, 0 0 20px #00bfff, inset 0 0 5px #00bfff;
      }
    }


    /* --- Loading Overlay --- */
    #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 11000;
        color: white;
        font-size: 1.2em;
        text-align: center;
    }
    .spinner {
        border: 6px solid rgba(255, 255, 255, 0.3);
        border-top: 6px solid var(--accent-color);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    #loading-text { font-weight: bold; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }


    /* --- CREATION METHOD SELECTOR --- */
    #creation-method-selector { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-top: 1rem; }
    .creation-option-card { background-color: var(--component-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s ease-in-out; }
    .creation-option-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px var(--shadow-color); border-color: var(--accent-color); }
    .creation-option-card .card-icon { font-size: 2.5rem; display: block; margin-bottom: 0.5rem; }
    .creation-option-card h4 { margin: 0.5rem 0; color: var(--accent-color); font-size: 1.1em; }
    .creation-option-card p { font-size: 0.9em; color: var(--text-color); opacity: 0.8; margin: 0; }
    @media (max-width: 600px) { #creation-method-selector { grid-template-columns: 1fr; gap: 1rem; } .creation-option-card { padding: 1rem; } }


    /* --- GENERATOR STYLES --- */
    .step-header-container { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; }
    .step-header { padding-bottom: 10px; margin: 1rem 0 0 0; border-bottom: none; }
    .input-group { margin-bottom: 1.5rem; }
    .input-label { display: block; margin-bottom: 8px; font-weight: bold; }
    .input-label-group { display: flex; justify-content: space-between; align-items: center; }
    textarea, .input-field, select.input-field { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 5px; box-sizing: border-box; background-color: var(--component-bg); color: var(--text-color); font-family: var(--font-family); font-size: 1em; resize: vertical; }
    select.input-field { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right .75rem center; background-size: 16px 12px; }
    body.dark-mode select.input-field { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23e0e0e0' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); }
    #quiz-data-input, #source-text-input { min-height: 250px; }

    #paste-notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: var(--correct-color); color: white; padding: 10px 20px; border-radius: 25px; font-size: 1em; font-weight: bold; opacity: 0; transition: opacity 0.5s ease, top 0.5s ease; pointer-events: none; z-index: 2100; }
    #paste-notification.show { top: 40px; opacity: 1; }
    .prompt-actions-row { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
    
    /* --- NEW: Language Pill Selection --- */
    .lang-selector-pills {
        display: flex;
        flex-wrap: wrap; 
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        justify-content: flex-start;
    }
    .lang-pill-btn {
        background-color: var(--component-bg);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        border-radius: 50px; /* Pill shape */
        padding: 8px 18px;
        font-size: 0.9em;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        flex-grow: 1;
        text-align: center;
    }
    @media (min-width: 600px) {
        .lang-pill-btn {
            flex-grow: 0; /* Prevent stretching on wider screens */
        }
    }
    .lang-pill-btn:hover {
        border-color: var(--accent-color);
        background-color: var(--primary-bg);
    }
    .lang-pill-btn.active {
        background-color: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
        font-weight: bold;
        box-shadow: 0 2px 8px var(--shadow-color);
        transform: translateY(-2px);
    }
    body.dark-mode .lang-pill-btn.active {
        color: var(--secondary-bg);
    }

    /* --- NEW: Dynamic Prompt Builder Styles --- */
    #dynamic-prompt-builder { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem; }
    .prompt-builder-row {
        background-color: var(--component-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.8rem 1rem;
        position: relative;
        transition: all 0.3s ease;
    }
    .prompt-builder-row.concise {
        padding: 0.8rem 1rem;
        cursor: pointer;
    }
    .prompt-builder-row.concise .prompt-builder-grid,
    .prompt-builder-row.concise .prompt-builder-remove-btn {
        display: none;
    }
    .prompt-builder-row .concise-summary {
        display: none;
        font-style: italic;
        opacity: 0.9;
    }
     .prompt-builder-row.concise .concise-summary {
        display: block;
    }
    .prompt-builder-grid {
        grid-column: 1 / -1;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.8rem 1rem;
    }
    .prompt-builder-row .input-group { margin-bottom: 0; }
    .prompt-builder-row .input-label { font-size: 0.9em; margin-bottom: 4px; }
    .prompt-builder-row .input-field { font-size: 0.95em; padding: 8px 10px; }
    .prompt-builder-remove-btn {
        position: absolute;
        top: -10px;
        right: -10px;
        background: var(--incorrect-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 1em;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px var(--shadow-color);
        transition: transform 0.2s;
    }
    .prompt-builder-remove-btn:hover { transform: scale(1.2); }
    .prompt-builder-add-btn-container { display: flex; justify-content: center; }
    #prompt-builder-add-btn {
        background-color: var(--correct-color);
        padding: 8px 15px;
        border-radius: 25px;
    }
    #prompt-builder-add-btn:hover { background-color: #218838; }


    /* --- PDF/IMAGE WORKFLOW STYLES --- */
    #image-input-area, #pdf-input-area { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 1.5rem; }
    #image-preview-container { display: flex; flex-wrap: wrap; gap: 15px; width: 100%; margin-top: 1rem; min-height: 100px; border: 2px dashed var(--border-color); padding: 10px; border-radius: 5px;}
    .img-preview-wrapper { position: relative; width: 120px; height: 120px; border: 1px solid var(--border-color); border-radius: 5px; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between; background-color: var(--component-bg); }
    .img-preview-wrapper .img-container { width: 100%; height: 100%; flex-grow: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .img-preview-wrapper img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .img-preview-actions { display: flex; justify-content: space-around; background-color: rgba(0,0,0,0.4); padding: 4px 0; }
    .img-preview-btn { background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem; }
    .img-preview-btn:hover { color: var(--accent-color); }

    #ocr-status, #pdf-status { margin-top: 1rem; font-style: italic; color: var(--accent-color); font-weight: bold;}
    .page-range-container { display: flex; align-items: center; gap: 10px; }
    .page-range-container input[type="number"] { width: 80px; }
    /* NEW: Handwriting Toggle Style */
    .handwriting-toggle-group { display: flex; align-items: center; gap: 10px; margin-top: 1rem; }


    /* --- Image Format Guide --- */
    #image-format-guide { display: flex; gap: 1.5rem; margin-top: 1rem; margin-bottom: 1.5rem; opacity: 0; transform: translateY(20px); transition: opacity 0.5s ease-out, transform 0.5s ease-out; }
    #image-format-guide:not(.hidden) { opacity: 1; transform: translateY(0); }
    .guide-card { flex: 1; background-color: var(--component-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; text-align: center; }
    .guide-card.good { border-left: 4px solid var(--correct-color); }
    .guide-card.bad { border-left: 4px solid var(--incorrect-color); }
    .guide-card h5 { margin: 0 0 0.5rem 0; font-size: 1em; }
    .guide-card p { font-size: 0.85em; margin: 0; line-height: 1.4; opacity: 0.9; }
    .guide-card svg { width: 100%; height: 80px; margin-bottom: 0.5rem; }
    @media (max-width: 600px) { #image-format-guide { flex-direction: column; gap: 1rem; } }


    /* --- QUIZ PLAYER & RESULTS --- */
    #quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px dashed var(--border-color); gap: 1rem; flex-wrap: wrap; }
    #question-topic { font-weight: bold; color: var(--accent-color); font-size: 1.1em; flex-shrink: 0; }
    #progress { background-color: var(--accent-color); color: white; padding: 5px 12px; border-radius: 15px; font-size: 0.9rem; font-weight: bold; white-space: nowrap; }
    #timer { font-weight: bold; background: var(--component-bg); padding: 8px 15px; border-radius: 25px; border: 2px solid var(--border-color); display: flex; align-items: center; gap: 10px; position: relative; width: auto; justify-content: center; }
    #timer-text { font-size: 1.4em; font-weight: bold; color: var(--accent-color); width: 60px; text-align: center; }
    body.dark-mode #timer-text { color: var(--accent-color); }
    .timer-face { font-size: 1.6rem; display: none; }
    .timer-face.visible { display: inline-block; animation: face-pop 0.4s ease-out; }
    @keyframes face-pop { 0% { transform: scale(0.5); opacity: 0; } 80% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
    #question-image-container { margin-bottom: 1rem; }
    #question-image-container img { max-width: 100%; max-height: 400px; border-radius: 8px; display: block; margin: auto; border: 1px solid var(--border-color); }
    #question-and-bookmark { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; margin-bottom: 1rem; }
    #question-text-container { flex-grow: 1; }
    #question-text { font-size: 1.4em; font-weight: 500; margin: 0; }
    #bookmark-btn { background: none; border: 1px solid var(--border-color); color: var(--bookmark-color); font-size: 1.5rem; cursor: pointer; border-radius: 50%; width: 44px; height: 44px; flex-shrink: 0; display: flex; justify-content: center; align-items: center; transition: all 0.2s ease; }
    #bookmark-btn:hover { background-color: var(--component-bg); transform: scale(1.1); }
    #bookmark-btn.bookmarked { color: white; background-color: var(--bookmarked-active-color); border-color: var(--bookmarked-active-color); }
    #statements-list p { margin: 0.5em 0; background: var(--component-bg); padding: 10px; border-radius: 5px; border-left: 3px solid var(--accent-color); }
    .option { position: relative; border: 2px solid var(--border-color); padding: 12px 15px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: space-between; }
    .option:hover:not(.disabled) { border-color: var(--accent-hover); background-color: var(--component-bg); }
    .option.selected { border-color: var(--accent-color); background-color: #eaf5ff; }
    body.dark-mode .option.selected { background-color: #36363c; }
    .option.correct { border-color: var(--correct-color); background-color: #e9f7ef; color: #145a32; font-weight: bold; }
    body.dark-mode .option.correct { background-color: #1c3c24; color: #a3d9b1; }
    .option.incorrect { border-color: var(--incorrect-color); background-color: #fbeee6; color: #943126; font-weight: bold; }
    body.dark-mode .option.incorrect { background-color: #4a1c20; color: #f1b0b7; }
    .option.disabled { pointer-events: none; opacity: 0.8; }
    .option-feedback { display: flex; align-items: center; gap: 10px; }
    .feedback-icon { font-size: 1.5rem; transform: scale(0); animation: pop-in 0.5s ease-out forwards; }
    .user-choice-emoji { font-size: 1.5rem; display: none; animation: pop-in 0.5s ease-out forwards; }
    .user-choice-emoji.visible { display: inline-block; }
    @keyframes pop-in { 0% { transform: scale(0); opacity: 0; } 70% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
    #explanation-container, #mp-explanation-container { margin-top: 1.5rem; padding: 1rem; background-color: var(--component-bg); border-left: 5px solid var(--accent-color); border-radius: 5px; }
    #explanation-container h4, #mp-explanation-container h4 { margin-top: 0; }

    /* --- Modified: Flexible Button Layout --- */
    #quiz-actions, #mp-quiz-actions {
        margin-top: 2rem;
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto auto;
        gap: 1rem;
        border-top: 1px solid var(--border-color);
        padding-top: 1.5rem;
    }
    .quiz-actions-top-left { grid-area: 1 / 1 / 2 / 2; }
    .quiz-actions-top-right { grid-area: 1 / 2 / 2 / 3; }
    .quiz-actions-bottom-left { grid-area: 2 / 1 / 3 / 2; }
    .quiz-actions-bottom-right { grid-area: 2 / 2 / 3 / 3; }


    .btn { background-color: var(--accent-color); color: white; padding: 10px 18px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: 600; text-align: center; transition: all 0.3s; margin: 0; display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
    .btn-full-width { width: 100%; }
    .btn:hover:not(:disabled) { background-color: var(--accent-hover); box-shadow: 0 4px 8px var(--shadow-color); transform: translateY(-2px); }
    .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; opacity: 0.7; }
    body.dark-mode .btn:disabled { background-color: #555; }
    .btn-secondary { background-color: #6c757d; }
    .btn-secondary:hover:not(:disabled) { background-color: #5a6268; }
    .btn-danger { background-color: var(--incorrect-color); }
    .btn-danger:hover:not(:disabled) { background-color: #c82333; }
    .btn-success { background-color: var(--correct-color); }
    .btn-success:hover:not(:disabled) { background-color: #218838; }
    #check-answer-btn, #mp-check-answer-btn { background-color: var(--correct-color); }
    #check-answer-btn:hover:not(:disabled), #mp-check-answer-btn:hover:not(:disabled) { background-color: #218838; }
    #skip-question-btn { background-color: var(--skipped-color); color: #212529;}
    #skip-question-btn:hover:not(:disabled) { background-color: #e0a800; }

    .exam-buttons-container, .ai-platform-selector { display: flex; flex-wrap: wrap; gap: 8px; }
    .ai-platform-selector { justify-content: center; margin-top: 10px; }
    .exam-btn, .ai-platform-btn { background-color: var(--component-bg); color: var(--text-color); border: 1px solid var(--border-color); padding: 6px 14px; font-size: 0.85em; min-width: auto; margin: 0; flex-grow: 1; }
    .exam-btn:hover:not(:disabled), .ai-platform-btn:hover:not(:disabled) { background-color: var(--primary-bg); border-color: var(--accent-color); transform: translateY(-1px); box-shadow: none; }
    .exam-btn.active, .ai-platform-btn.active { background-color: var(--accent-color); color: white; border-color: var(--accent-color); transform: none; box-shadow: none; }
    .ai-platform-option { display: flex; flex-direction: column; flex: 1; text-align: center; }
    .ai-tip { font-size: 0.8em; color: #6c757d; margin-top: 5px; }
    body.dark-mode .ai-tip { color: #aaa; }
    #results-screen h2 { color: var(--correct-color); border-bottom-color: var(--correct-color); }
    #score-summary { font-size: 1.5rem; font-weight: bold; text-align: center; margin-bottom: 1.5rem; transform: scale(0.8); opacity: 0; transition: transform 0.5s ease-out, opacity 0.5s ease-out; }
    #score-summary.visible { transform: scale(1); opacity: 1; }

    #results-summary-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
        background-color: var(--component-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    #score-performance-chart-container {
        flex: 1 1 200px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }
    .performance-pie-chart {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background-image: conic-gradient(var(--skipped-color) 0 100%);
        border: 4px solid var(--secondary-bg);
        box-shadow: 0 2px 8px var(--shadow-color);
    }
    .chart-legend {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        font-size: 0.9em;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .legend-color-box {
        width: 15px;
        height: 15px;
        border-radius: 3px;
    }
    #quiz-summary-details {
        flex: 1 1 300px;
        background-color: transparent;
        border: none;
        padding: 0;
        margin: 0;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    @media (min-width: 601px) {
        #score-performance-chart-container {
            flex-direction: row;
        }
    }

    .summary-item { display: flex; flex-direction: column; }
    .summary-label { font-size: 0.9em; color: #6c757d; font-weight: 500;}
    .summary-value { font-size: 1.2em; font-weight: bold; }
    .summary-value.remark { color: var(--accent-color); }
    .summary-value.count-up { transition: all 0.5s ease-out; }
    body.dark-mode .summary-label { color: #aaa; }
    .result-item { border: 1px solid var(--border-color); padding: 1rem; margin-bottom: 1rem; border-radius: 8px; background-color: var(--component-bg); }
    .result-item .result-question { font-weight: bold; position: relative; }
    .bookmark-indicator { color: var(--bookmarked-active-color); font-size: 1.2rem; position: absolute; top: 0; right: 0; opacity: 0; transition: opacity 0.3s; }
    .bookmark-indicator.visible { opacity: 1; }
    .result-options-list { margin-top: 1rem; padding-left: 0; list-style-type: none; }
    .result-option { padding: 8px; border-radius: 4px; margin-bottom: 5px; border: 1px solid transparent; }
    .result-option.user-selected { border-color: var(--accent-color); }
    .result-option.correct-answer { background-color: #d4edda; }
    body.dark-mode .result-option.correct-answer { background-color: #1c3c24; }
    .result-explanation { margin-top: 1rem; padding: 1rem; background-color: var(--primary-bg); border-left: 4px solid var(--accent-color); border-radius: 5px; font-size: 0.95em; }
    .result-explanation h5 { margin-top: 0; }
    .share-buttons { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; justify-content: center; align-items: center;}
    .share-buttons-row { display: flex; gap: 10px; justify-content: center; width: 100%; flex-wrap: wrap; }
    #results-page-telegram-opener { width: 100%; max-width: 400px; }
    .telegram-input-group { display: flex; gap: 10px; align-items: center; }
    .telegram-input-group .input-field { flex-grow: 1; margin: 0; padding: 12px; border-radius: 5px; border: 1px solid var(--border-color); background-color: var(--component-bg); color: var(--text-color);}
    .telegram-input-group .btn { flex-grow: 0; padding: 12px 15px; margin: 0; }
    #theme-toggle-btn { position: absolute; top: 50%; transform: translateY(-50%); right: 20px; background: none; border: 1px solid rgba(255, 255, 255, 0.7); color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; transition: all 0.3s ease; display: flex; justify-content: center; align-items: center; }
    #theme-toggle-btn:hover { background-color: rgba(255, 255, 255, 0.2); transform: translateY(-50%) rotate(15deg) scale(1.1); }

    /* --- GUIDE BUTTON & MODAL STYLES --- */
    .guide-container { display: flex; flex-direction: column; align-items: center; }
    .guide-help-text { font-size: 0.7em; font-weight: 500; opacity: 0.7; margin-top: -2px; user-select: none; }
    .guide-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 5px; line-height: 1; opacity: 0.7; transition: opacity 0.2s, transform 0.2s; animation: pulse 2.5s infinite ease-in-out; }
    .guide-btn:hover { opacity: 1; transform: scale(1.2); animation-play-state: paused; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

    #telegram-backup-guide-container { display: flex; flex-direction: column; align-items: center; gap: 5px; margin-top: 15px; }
    #telegram-backup-guide-btn { background: none; border: none; font-size: 2rem; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; }
    #telegram-backup-guide-btn:hover { opacity: 1; }
    #telegram-backup-guide-container p { font-size: 0.8em; color: var(--text-color); opacity: 0.8; margin: 0; text-align: center; }

    #flowchart-modal-content {
        width: 100%;
        max-height: 65vh; /* Limit height */
        overflow-y: auto; /* Add scroll for long content */
        padding-right: 15px; /* Space for scrollbar */
    }
    .guide-step {
        background-color: var(--component-bg);
        border-left: 4px solid var(--accent-color);
        padding: 1rem;
        margin-bottom: 1.5rem;
        border-radius: 5px;
    }
    .guide-step strong {
        font-size: 1.1em;
        display: block;
        margin-bottom: 0.5em;
        color: var(--accent-color);
    }
    .guide-step p {
        margin: 0.5em 0;
        line-height: 1.5;
        font-size: 0.95em;
    }
    .guide-step .hindi-text {
        font-style: italic;
        opacity: 0.9;
        font-size: 0.9em;
        color: var(--text-color);
    }
    .modal-close-btn-top {
        position: absolute;
        top: 10px;
        right: 15px;
        background: none;
        border: none;
        font-size: 2rem;
        line-height: 1;
        cursor: pointer;
        color: var(--text-color);
        opacity: 0.6;
        transition: opacity 0.2s, transform 0.2s;
    }
    .modal-close-btn-top:hover {
        opacity: 1;
        transform: scale(1.1);
    }


    /* --- Fallback & Redundancy Styles --- */
    #ai-link-fallback {
        background-color: var(--primary-bg);
        border: 2px dashed var(--accent-color);
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        margin-top: 1rem;
    }
    #ai-link-fallback p { margin: 0 0 0.5rem 0; }
    #ai-link-fallback a { font-weight: bold; }


    /* --- MODAL STYLES (MODIFIED Z-INDEX) --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 10001; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
    .modal-overlay:not(.hidden) { opacity: 1; pointer-events: auto; }
    .modal-content { position: relative; background-color: var(--secondary-bg); color: var(--text-color); padding: 1.5rem; border-radius: 10px; width: 90%; max-width: 800px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); transform: scale(0.95); transition: transform 0.3s ease; display: flex; flex-direction: column; max-height: 90vh; }
    .modal-overlay:not(.hidden) .modal-content { transform: scale(1); }
    .modal-content h3 { margin-top: 0; color: var(--accent-color); padding-right: 30px; } /* Add padding for close button */
    #manual-copy-modal-content h3 { color: var(--incorrect-color); }
    #crop-image-container { width: 100%; flex-grow: 1; overflow: hidden; }
    #crop-image-container img { max-width: 100%; max-height: 100%; }
    .modal-actions { margin-top: 1rem; display: flex; justify-content: flex-end; gap: 10px; flex-shrink: 0; border-top: 1px solid var(--border-color); padding-top: 1rem;}
    .modal-content textarea { width: 100%; min-height: 200px; max-height: 50vh; margin-top: 1rem; margin-bottom: 1.5rem; font-family: monospace; font-size: 0.9em; background-color: var(--primary-bg); border: 1px solid var(--border-color); color: var(--text-color); padding: 10px; box-sizing: border-box; border-radius: 5px; }

    /* --- NEW/MODIFIED: Feedback Effects --- */
    #congrats-animation-container {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        pointer-events: none;
        overflow: hidden;
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .congrats-emoji {
        position: absolute;
        top: 50%; left: 50%;
        font-size: 2.5rem;
        opacity: 0;
        animation: spread-out 2.5s ease-out forwards;
    }
    @keyframes spread-out {
        0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
        20% { opacity: 1; }
        100% { transform: var(--transform-end) scale(1); opacity: 0; }
    }

    #sad-reaction-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9998;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease-in-out;
    }
    #sad-reaction-overlay:not(.hidden) {
        opacity: 1;
    }
    #sad-reaction-emoji {
      font-size: 15vw; /* Responsive size */
      animation: sadBounce 1.5s ease-in-out forwards;
      text-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    @keyframes sadBounce {
      0% { transform: scale(0.5); opacity: 0; }
      30% { transform: scale(1.1) rotate(-5deg); opacity: 1; }
      50% { transform: scale(0.95) rotate(5deg); }
      70% { transform: scale(1.05) rotate(-2deg); }
      90% { transform: scale(1); opacity: 1; }
      100% { transform: scale(0.8); opacity: 0; }
    }

    /* --- NEW: Mental Pressure Mode --- */
    #pressure-mode-container {
        position: relative;
        margin-left: auto;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 50px; /* Ensure space for animation */
    }
    #pressure-mode-toggle-btn {
        background: none;
        border: none;
        font-size: 1.8rem;
        cursor: pointer;
        padding: 5px;
        transition: transform 0.2s;
    }
    #pressure-mode-toggle-btn:hover {
        transform: scale(1.2);
    }
    #pressure-text-animation {
        font-size: 1.1em;
        font-weight: bold;
        color: var(--incorrect-color);
        padding: 8px 15px;
        border-radius: 25px;
        background-color: var(--component-bg);
        border: 2px solid var(--incorrect-color);
        animation: pulse-red 1.5s infinite;
        white-space: nowrap;
    }
    @keyframes pulse-red {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
        70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
    }
    #pressure-mode-controls {
        position: absolute;
        top: 100%;
        right: 0;
        background-color: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 4px 15px var(--shadow-color);
        z-index: 100;
        width: 220px;
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
    }
    #pressure-mode-controls label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: var(--accent-color);
    }
    input:checked + .slider:before {
      transform: translateX(20px);
    }

    @keyframes vibrate {
      0% { transform: translate(0); }
      20% { transform: translate(-2px, 2px); }
      40% { transform: translate(-2px, -2px); }
      60% { transform: translate(2px, 2px); }
      80% { transform: translate(2px, -2px); }
      100% { transform: translate(0); }
    }
    #check-answer-btn.vibrating {
        animation: vibrate 0.3s linear infinite;
    }

    /* --- NEW: Gemini Instructions Modal & Fire Button --- */
    #gemini-instructions-modal-overlay .modal-content {
        padding: 1rem 1.5rem;
        height: auto;
        max-height: calc(100vh - 40px);
    }
    #gemini-instructions-modal-overlay .guide-step {
        margin-bottom: 0.8rem;
        padding: 0.8rem;
    }
     #gemini-instructions-modal-overlay h3 {
        text-align: center;
        margin-bottom: 1rem;
     }
    #gemini-instructions-content-wrapper {
        overflow-y: auto;
        flex-grow: 1;
        padding-right: 10px; /* space for scrollbar */
        margin-bottom: 1rem; /* space above button */
    }
    @keyframes fire {
        0% { box-shadow: 0 0 10px #ffc107, 0 0 20px #ffc107, 0 0 30px #ff8c00, 0 0 40px #ff4500, inset 0 0 5px #ffc107; }
        50% { box-shadow: 0 0 15px #ffc107, 0 0 25px #ffc107, 0 0 35px #ff8c00, 0 0 45px #ff4500, inset 0 0 10px #ff8c00; }
        100% { box-shadow: 0 0 10px #ffc107, 0 0 20px #ffc107, 0 0 30px #ff8c00, 0 0 40px #ff4500, inset 0 0 5px #ffc107; }
    }
    .fire-animation {
        animation: fire 1.5s infinite ease-in-out;
        background-color: #dc3545;
        border-color: #ffc107;
    }

    /* --- Multiplayer Specific Styles (FROM FILE 174) --- */
    #mode-selection-container, #multiplayer-selection-container { text-align: center; }
    #mode-selection-container h2, #multiplayer-selection-container h2 { margin-bottom: 2rem; }
    .mode-options, .multiplayer-options { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    .mode-option-card, .multiplayer-option-card { background-color: var(--component-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.2s ease-in-out; }
    .mode-option-card:hover, .multiplayer-option-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px var(--shadow-color); border-color: var(--accent-color); }
    .mode-option-card .card-icon, .multiplayer-option-card .card-icon { font-size: 3rem; display: block; margin-bottom: 1rem; }
    .mode-option-card h3, .multiplayer-option-card h3 { margin: 0.5rem 0; color: var(--accent-color); font-size: 1.2em; }
    @media (max-width: 600px) { .mode-options, .multiplayer-options { grid-template-columns: 1fr; } }

    #lobby-container { text-align: center; }
    #lobby-players-list { list-style-type: none; padding: 0; margin: 2rem 0; }
    #lobby-players-list li { background-color: var(--component-bg); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; font-size: 1.1em; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px; }
    #room-code-display { background-color: var(--primary-bg); padding: 1rem; border: 2px dashed var(--accent-color); border-radius: 8px; margin-bottom: 1.5rem; }
    #room-code-display p { margin: 0 0 10px 0; }
    #room-code-display strong { font-size: 1.8em; color: var(--accent-color); letter-spacing: 2px; word-wrap: break-word; }

    /* --- MODIFIED: Multiplayer Quiz Player --- */
    #mp-quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;}
    #mp-timer { font-size: 1.4em; font-weight: bold; color: var(--accent-color); }
    #mp-question-text { font-size: 1.4em; font-weight: 500; }
    #mp-options-container .option.selected { border-color: var(--accent-color); background-color: #eaf5ff; }
     body.dark-mode #mp-options-container .option.selected { background-color: #36363c; }
     #mp-face-reaction-container {
        font-size: 2rem;
        width: 40px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
     }

    #multiplayer-results-container h2, #multiplayer-results-container h3 { text-align: center; color: var(--accent-color); }
    #multiplayer-personal-summary {
        background-color: var(--component-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
     #multiplayer-personal-summary h3 {
        margin-top: 0;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.8rem;
        margin-bottom: 1rem;
    }
    #multiplayer-personal-summary .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
    }
    #leaderboard { list-style-type: none; padding: 0; margin-top: 1.5rem; }
    #leaderboard li { display: flex; justify-content: space-between; padding: 1rem; margin-bottom: 0.5rem; background-color: var(--component-bg); border-radius: 8px; font-size: 1.1em; }
    #leaderboard li strong { color: var(--accent-color); }
    #leaderboard li:first-child { background-color: #ffd700; color: #333; font-weight: bold; transform: scale(1.05); } /* Gold for 1st place */
    
    #waiting-for-submission-overlay {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(0,0,0,0.7);
        color: white;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        z-index: 1000;
    }

    .hard-reset-container {
        text-align: center;
        margin-top: 2.5rem;
        padding-top: 1.5rem;
        border-top: 2px dashed var(--incorrect-color);
    }
    .hard-reset-btn {
        padding: 12px 25px;
        font-size: 1.1em;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

  </style>
</head>
<body class="dark-mode">

<!-- NEW: Global Navigation Bar -->
<div id="global-nav-bar" class="global-nav">
    <button id="global-home-btn" class="btn btn-secondary">🏠 Home</button>
    <a href="https://m.youtube.com/@ExamYatrimocktest/videos" target="_blank" id="global-how-to-use-btn" class="btn fire-animation">🔥 How to Use 🔥</a>
</div>


<div id="loading-overlay" class="hidden">
    <div class="spinner"></div>
    <p id="loading-text"></p>
</div>

<div id="paste-notification"></div>
<div id="congrats-animation-container"></div>
<div id="sad-reaction-overlay" class="hidden"><span id="sad-reaction-emoji"></span></div>


<!-- ======================================= -->
<!-- ===== UNIFIED CONTAINER (MAIN) ==== -->
<!-- ======================================= -->
<div class="container" id="main-container">
    <div class="header">
        <span class="header-branding">✍️ <strong>EXAMYATRI</strong> - <span class="tagline">One Plateform. All Exam</span></span>
        <button id="theme-toggle-btn" title="Toggle Dark/Light Mode">🌙</button>
    </div>

    <!-- ===== NEW: MODE SELECTION (SINGLE/MULTI) ===== -->
    <div id="mode-selection-container">
        <h2>❤️Generate Topicwise, Chapterwise, Subjectwise Mock Test/ Quiz❤️</h2>
        <p>Completely FREE</p>
        <div class="mode-options">
            <div class="mode-option-card" id="select-single-player-btn">
                <span class="card-icon">👤</span>
                <h3>Single Player Practice</h3>
                <p>Create a set of questions on any topic and practice by yourself.</p>
            </div>
            <div class="mode-option-card" id="select-multiplayer-btn">
                <span class="card-icon">👥</span>
                <h3>Multiplayer/ Practice With Friends</h3>
                <p>Create a room or join a friend's to practice together.</p>
            </div>
        </div>
    </div>

    <!-- ===== MULTIPLAYER SELECTION SCREEN (JOIN OR CREATE) ===== -->
    <div id="multiplayer-selection-container" class="hidden">
        <h2>Multiplayer Mode</h2>
        <p>Join a friend's room or create a new one to host a game.</p>
        <div class="multiplayer-options">
            <div class="multiplayer-option-card" id="join-room-btn">
                <span class="card-icon">🤝</span>
                <h3>Join Room</h3>
                <p>Enter a code to join an assessment hosted by a friend.</p>
            </div>
            <div class="multiplayer-option-card" id="create-room-btn">
                <span class="card-icon">👑</span>
                <h3>Create Room</h3>
                <p>Generate questions and invite your friends to play.</p>
            </div>
        </div>
        <button class="btn btn-secondary back-to-mode-selection-btn" style="margin-top: 2rem;">← Back</button>
    </div>
  <!-- ===== BLOGGER POSTS SECTION ===== -->
<div id="blog-section">
  <p style="text-align:center;">Loading latest posts...</p>
</div>

<style>
  /* Blog Section Styling */
  #blog-section {
    max-width: 1000px;
    margin: 30px auto;
    padding: 0 15px;
  }
  .blog-feed-container {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
  }
  .blog-card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .blog-card img {
    width: 100%;
    aspect-ratio: 16/9;
    object-fit: cover;
  }
  .blog-content {
    padding: 15px;
  }
  .blog-content h3 {
    margin: 0 0 10px;
    font-size: 1.2em;
    color: #007bff;
  }
  .blog-content p {
    margin: 0;
    font-size: 0.9em;
    opacity: 0.85;
  }
  .blog-content a {
    text-decoration: none;
    color: inherit;
  }
</style>

<script>
  // Blogger JSON Feed Fetch
  const rssUrl = "https://examyatrilive.blogspot.com/feeds/posts/default?alt=json";

  fetch(rssUrl)
    .then(res => res.json())
    .then(data => {
      const posts = data.feed.entry.slice(0, 2); // Sirf 2 latest posts
      let html = '<div class="blog-feed-container">';
      
      posts.forEach(post => {
        const title = post.title.$t;
        const link = post.link.find(l => l.rel === "alternate").href;
        const content = post.content.$t.replace(/<[^>]+>/g, "");
        const shortDesc = content.substring(0, 120) + "...";
        let image = "";

        // Image nikalne ki koshish
        const imgMatch = post.content.$t.match(/<img[^>]+src="([^">]+)"/);
        if (imgMatch && imgMatch[1]) {
          image = imgMatch[1];
        } else {
          image = "https://via.placeholder.com/640x360.png?text=ExamYatri";
        }

        html += 
          <div class="blog-card">
            <img src="${image}" alt="${title}">
            <div class="blog-content">
              <h3><a href="${link}" target="_blank">${title}</a></h3>
              <p>${shortDesc}</p>
            </div>
          </div>
        ;
      });

      html += "</div>";
      document.getElementById("blog-section").innerHTML = html;
    })
    .catch(err => {
      document.getElementById("blog-section").innerHTML = "<p style='text-align:center;color:red;'>⚠️ Blog posts load nahi ho paye.</p>";
      console.error("Error loading blog feed:", err);
    });
</script>

    <!-- ===== JOIN ROOM SCREEN ===== -->
    <div id="join-room-container" class="hidden">
        <h3>Join a Room</h3>
        <div class="input-group">
            <label for="player-name-join" class="input-label">Your Name</label>
            <input type="text" id="player-name-join" class="input-field" placeholder="Enter your name">
        </div>
        <div class="input-group">
            <label for="room-code-input" class="input-label">Room Code</label>
            <input type="text" id="room-code-input" class="input-field" placeholder="Enter the 6-digit code" maxlength="6" inputmode="numeric" pattern="[0-9]*">
        </div>
        <button id="submit-join-room-btn" class="btn btn-full-width btn-success">Join Room</button>
         <button class="btn btn-secondary back-to-multiplayer-selection-btn" style="margin-top: 1rem;">← Back</button>
    </div>

    <!-- ===== QUIZ GENERATOR (SINGLE PLAYER OR MULTIPLAYER CREATE) ===== -->
    <div id="manual-generator-container" class="hidden">
        <div id="creation-method-selector">
             <p id="generator-title" style="font-size: 1.1em; text-align: center; grid-column: 1 / -1;">❤️ Create your questions below ❤️</p>
             <div class="creation-option-card" id="select-from-topic">
                <span class="card-icon">📝</span><h4>Generate from Topic</h4><p>Provide a topic or formula to generate question.</p>
            </div>
            <div class="creation-option-card" id="select-from-text">
                <span class="card-icon">📋</span><h4>Customise Your Mock Test</h4><p>Add different topics from different subject and create a mock test similar to your exam.</p>
            </div>
            <div class="creation-option-card" id="select-from-image">
                <span class="card-icon">🖼️</span><h4>Generate from Image</h4><p>Use images of notes / PYQs and generate similar question.</p>
            </div>
            <div class="creation-option-card" id="select-from-pdf">
                <span class="card-icon">📄</span><h4>Generate from PDF</h4><p>Upload a PDF to create questions from each line .</p>
            </div>
             <button class="btn btn-secondary back-to-mode-selection-btn" style="grid-column: 1 / -1; margin-top: 1rem;">← Back to Main Menu</button>
        </div>

        <!-- WORKFLOW 1: From Topic -->
        <div id="topic-generator-workflow" class="hidden">
            <div class="step-header-container">
              <h3 class="step-header">Step 1: Define Your Questions</h3>
              <div class="guide-container">
                  <button class="btn guide-btn" data-guide-id="topic-step1" title="Show Guide">💁</button>
                  <span class="guide-help-text">How to use</span>
              </div>
            </div>
            <div class="input-group"><label for="prompt-topic" class="input-label">Add Primary Topic Name or Formula of Physics or Mathematics or other subject</label><input type="text" id="prompt-topic" class="input-field" placeholder="e.g., The Solar System, World War II"></div>
            <div class="input-group"><label for="prompt-num-questions-topic" class="input-label">Number of Questions</label><input type="number" id="prompt-num-questions-topic" class="input-field" placeholder="e.g., 10" min="1" max="50"></div>
            <div class="input-group"><label for="prompt-subject-topic" class="input-label">Subject/ instruction e.g. generate question on this topic(Optional)</label><input type="text" id="prompt-subject-topic" class="input-field" placeholder="e.g., Science, maths"></div>
            <div class="input-group"><label for="prompt-language-topic" class="input-label">Language</label><select id="prompt-language-topic" class="input-field"><option value="English" selected>English</option><option value="Hindi">Hindi</option><option value="Spanish">Spanish</option><option value="French">French</option><option value="German">German</option></select></div>
            <div class="input-group"><label for="prompt-difficulty-topic" class="input-label">Difficulty Level</label><select id="prompt-difficulty-topic" class="input-field"><option value="Easy">Easy</option><option value="Medium" selected>Medium</option><option value="Hard">Hard</option><option value="Expert">Expert</option></select></div>
            <div class="input-group"><label class="input-label">Target Exam (Required)</label><div class="exam-buttons-container"></div><input type="text" class="prompt-exam-other input-field hidden" placeholder="Enter Other exam name" style="margin-top: 10px;"></div>
            <div class="input-group"><label for="question-format-select-topic" class="input-label">Question Format</label><select id="question-format-select-topic" class="input-field"></select></div>
            <button id="generate-prompt-btn-topic" class="btn btn-full-width glowing">Start 🚀</button>
            <button class="btn btn-secondary back-to-creation-selection-btn" style="margin-top: 1rem; width: 100%;">&larr; Back to Options</button>
        </div>
        
        <!-- WORKFLOW 2: From Text (MODIFIED) -->
        <div id="text-generator-workflow" class="hidden">
            <div class="step-header-container">
              <h3 class="step-header">Step 1: Build Your Mock Test Sections</h3>
              <div class="guide-container">
                  <button class="btn guide-btn" data-guide-id="text-step1" title="Show Guide">💁</button>
                  <span class="guide-help-text">How to use</span>
              </div>
            </div>
            
            <!-- NEW DYNAMIC BUILDER UI -->
            <div class="input-group">
                <label class="input-label">Add sections for your mock test. Click a filled box to edit.</label>
                <div id="dynamic-prompt-builder">
                    <!-- Rows will be injected here by JavaScript -->
                </div>
                <div class="prompt-builder-add-btn-container">
                    <button id="prompt-builder-add-btn" class="btn">➕ Add Section</button>
                </div>
            </div>

            <div class="step-header-container">
              <h3 class="step-header">Step 2: Define Global Settings</h3>
              <div class="guide-container">
                  <button class="btn guide-btn" data-guide-id="text-step2" title="Show Guide">💁</button>
                  <span class="guide-help-text">How to use</span>
              </div>
            </div>
            
            <div class="input-group"><label for="prompt-language-text" class="input-label">Language</label><select id="prompt-language-text" class="input-field"><option value="English" selected>English</option><option value="Hindi">Hindi</option><option value="Spanish">Spanish</option><option value="French">French</option><option value="German">German</option></select></div>
            <div class="input-group"><label for="prompt-difficulty-text" class="input-label">Difficulty Level</label><select id="prompt-difficulty-text" class="input-field"><option value="Easy">Easy</option><option value="Medium" selected>Medium</option><option value="Hard">Hard</option><option value="Expert">Expert</option></select></div>
            <div class="input-group"><label class="input-label">Target Exam (Required)</label><div class="exam-buttons-container"></div><input type="text" class="prompt-exam-other input-field hidden" placeholder="Enter other exam name" style="margin-top: 10px;"></div>
            <div class="input-group"><label for="question-format-select-text" class="input-label">Question Format</label><select id="question-format-select-text" class="input-field"></select></div>
            <button id="generate-prompt-btn-text" class="btn btn-full-width glowing">Start 🚀</button>
             <button class="btn btn-secondary back-to-creation-selection-btn" style="margin-top: 1rem; width: 100%;">&larr; Back to Options</button>
        </div>

        <!-- WORKFLOW 3: From Image -->
        <div id="image-generator-workflow" class="hidden">
            <div id="image-format-guide" class="hidden">
                 <div class="guide-card good">
                    <h5>✅ Good Example</h5>
                    <svg viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="5" width="90" height="110" rx="5" fill="var(--component-bg)" stroke="var(--correct-color)" stroke-width="3"/><path d="M20 25 h60 M20 40 h60 M20 55 h60 M20 70 h40 M20 85 h60" stroke="var(--text-color)" stroke-width="2" /></svg>
                    <p>Image is <strong>upright</strong> (portrait) and the text is <strong>clear</strong>.</p>
                </div>
                <div class="guide-card bad">
                    <h5>❌ Bad Example</h5>
                    <svg viewBox="0 0 120 100" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="5" width="110" height="90" rx="5" fill="var(--component-bg)" stroke="var(--incorrect-color)" stroke-width="3"/><path d="M25 20 v60 M40 20 v60 M55 20 v60 M70 20 v40 M85 20 v60" stroke="var(--text-color)" stroke-width="2" stroke-dasharray="3 3"/></svg>
                    <p>Image is <strong>sideways</strong> (landscape) or the text is <strong>blurry</strong>.</p>
                </div>
            </div>
            <div class="step-header-container">
              <h3 class="step-header">Step 1: Choose Document Language</h3>
              <div class="guide-container">
                  <button class="btn guide-btn" data-guide-id="image-step1" title="Show Guide">💁</button>
                  <span class="guide-help-text">How to use</span>
              </div>
            </div>
             <div class="input-group">
                <div class="lang-selector-pills" id="image-lang-selector-container">
                    <button class="lang-pill-btn" data-lang="eng">English</button>
                    <button class="lang-pill-btn" data-lang="hin">Hindi</button>
                    <button class="lang-pill-btn" data-lang="eng+hin">Mix (Eng+Hin)</button>
                </div>
            </div>

            <h3 class="step-header">Step 2: Add Your Images</h3>
            <p>Select your images. The system will automatically extract the text.</p>
            
            <div id="image-input-area"><button id="select-images-btn" class="btn btn-secondary glowing">📂 Select Images</button><input type="file" id="image-file-input" multiple accept="image/*" class="hidden"></div>

            <div class="handwriting-toggle-group">
                <label for="handwriting-toggle">
                    <input type="checkbox" id="handwriting-toggle" checked> This image contains handwriting
                </label>
            </div>
            <div id="image-preview-container"></div>
            <div id="ocr-status"></div>
            <div id="image-quiz-definition-area" class="hidden fade-in-slide-up">
                <div class="step-header-container">
                  <h3 class="step-header">Step 3: Define Your Questions</h3>
                  <div class="guide-container"><button class="btn guide-btn" data-guide-id="image-step3" title="Show Guide">💁</button><span class="guide-help-text">How to use</span></div>
                </div>
                <textarea id="source-text-image" style="display: none;"></textarea>
                <div class="input-group"><label for="prompt-num-questions-image" class="input-label">Number of Questions</label><input type="number" id="prompt-num-questions-image" class="input-field" placeholder="e.g., 5" min="1" max="50"></div>
                <div class="input-group"><label for="prompt-topic-image" class="input-label">Topic/Instruction e.g generate similar question</label><input type="text" id="prompt-topic-image" class="input-field" placeholder="e.g., Photosynthesis, Generate question on this topic"></div>
                <div class="input-group"><label for="prompt-subject-image" class="input-label">Subject Area (Optional)</label><input type="text" id="prompt-subject-image" class="input-field" placeholder="e.g., Biology from textbook page"></div>
                <div class="input-group"><label for="prompt-language-image" class="input-label">Language</label><select id="prompt-language-image" class="input-field"><option value="English" selected>English</option><option value="Hindi">Hindi</option><option value="Spanish">Spanish</option><option value="French">French</option><option value="German">German</option></select></div>
                <div class="input-group"><label for="prompt-difficulty-image" class="input-label">Difficulty Level</label><select id="prompt-difficulty-image" class="input-field"><option value="Easy">Easy</option><option value="Medium" selected>Medium</option><option value="Hard">Hard</option><option value="Expert">Expert</option></select></div>
                <div class="input-group"><label class="input-label">Target Exam (Required)</label><div class="exam-buttons-container"></div><input type="text" class="prompt-exam-other input-field hidden" placeholder="Enter other exam name" style="margin-top: 10px;"></div>
                <div class="input-group"><label for="question-format-select-image" class="input-label">Question Format</label><select id="question-format-select-image" class="input-field"></select></div>
                <button id="generate-prompt-btn-image" class="btn btn-full-width glowing">Start 🚀</button>
            </div>
            <button class="btn btn-secondary back-to-creation-selection-btn" style="margin-top: 1rem; width: 100%;">&larr; Back to Options</button>
        </div>
        <!-- WORKFLOW 4: From PDF -->
        <div id="pdf-generator-workflow" class="hidden">
            <div class="step-header-container">
              <h3 class="step-header">Step 1: Choose Document Language</h3>
              <div class="guide-container">
                  <button class="btn guide-btn" data-guide-id="pdf-step1" title="Show Guide">💁</button>
                  <span class="guide-help-text">How to use</span>
              </div>
            </div>
             <div class="input-group">
                <div class="lang-selector-pills" id="pdf-lang-selector-container">
                    <button class="lang-pill-btn" data-lang="eng">English</button>
                    <button class="lang-pill-btn" data-lang="hin">Hindi</button>
                    <button class="lang-pill-btn" data-lang="eng+hin">Mix (Eng+Hin)</button>
                </div>
            </div>

            <h3 class="step-header">Step 2: Upload & Extract</h3>
            
            <div id="pdf-input-area">
                <button id="select-pdf-btn" class="btn btn-secondary glowing">📂 Select PDF</button>
                <input type="file" id="pdf-file-input" accept=".pdf" class="hidden">
                <span id="pdf-file-name" style="align-self: center; margin-left: 15px; font-style: italic;"></span>
            </div>
            <div id="pdf-options-container" class="hidden fade-in-slide-up">
                <div class="input-group">
                    <label class="input-label">Extraction Options</label>
                    <label><input type="radio" name="pdf-page-option" id="pdf-page-option-all" value="all"> Extract All Pages</label><br>
                    <label><input type="radio" name="pdf-page-option" id="pdf-page-option-range" value="range" checked> Extract Page Range</label>
                    <div id="pdf-page-range-selector" class="hidden" style="margin-top: 10px;">
                        <div class="page-range-container">
                            <label for="pdf-page-from">From:</label>
                            <input type="number" id="pdf-page-from" class="input-field" min="1">
                            <label for="pdf-page-to">To:</label>
                            <input type="number" id="pdf-page-to" class="input-field" min="1">
                        </div>
                    </div>
                </div>
                <div class="input-group">
                    <label><input type="checkbox" id="pdf-force-ocr"> Force OCR (for scanned or image-based PDFs)</label>
                </div>

                <button id="extract-text-pdf-btn" class="btn btn-full-width glowing">🔍 Extract Text from PDF</button>
                <div id="pdf-status"></div>
            </div>
             <div id="pdf-quiz-definition-area" class="hidden fade-in-slide-up">
                <div class="step-header-container">
                  <h3 class="step-header">Step 3: Define Your Questions</h3>
                  <div class="guide-container">
                      <button class="btn guide-btn" data-guide-id="pdf-step2" title="Show Guide">💁</button>
                      <span class="guide-help-text">How to use</span>
                  </div>
                </div>
                <textarea id="source-text-pdf" style="display: none;"></textarea>
                <div class="input-group"><label for="prompt-num-questions-pdf" class="input-label">Number of Questions</label><input type="number" id="prompt-num-questions-pdf" class="input-field" placeholder="e.g., 10" min="1" max="50"></div>
                <div class="input-group"><label for="prompt-topic-pdf" class="input-label">Primary Topic (Optional)</label><input type="text" id="prompt-topic-pdf" class="input-field" placeholder="e.g., History of Ancient Rome"></div>
                <div class="input-group"><label for="prompt-subject-pdf" class="input-label">Subject Area (Optional)</label><input type="text" id="prompt-subject-pdf" class="input-field" placeholder="e.g., History, Science"></div>
                <div class="input-group"><label for="prompt-language-pdf" class="input-label">Language</label><select id="prompt-language-pdf" class="input-field"><option value="English" selected>English</option><option value="Hindi">Hindi</option><option value="Spanish">Spanish</option><option value="French">French</option><option value="German">German</option></select></div>
                <div class="input-group"><label for="prompt-difficulty-pdf" class="input-label">Difficulty Level</label><select id="prompt-difficulty-pdf" class="input-field"><option value="Easy">Easy</option><option value="Medium" selected>Medium</option><option value="Hard">Hard</option><option value="Expert">Expert</option></select></div>
                <div class="input-group"><label class="input-label">Target Exam (Required)</label><div class="exam-buttons-container"></div><input type="text" class="prompt-exam-other input-field hidden" placeholder="Enter other exam name" style="margin-top: 10px;"></div>
                <div class="input-group"><label for="question-format-select-pdf" class="input-label">Question Format</label><select id="question-format-select-pdf" class="input-field"></select></div>
                <button id="generate-prompt-btn-pdf" class="btn btn-full-width glowing">Start 🚀</button>
            </div>
             <button class="btn btn-secondary back-to-creation-selection-btn" style="margin-top: 1rem; width: 100%;">&larr; Back to Options</button>
        </div>
    </div>

    <!-- ===== PASTE CONTAINER (UNIFIED FOR SINGLE/MULTI) ====== -->
    <div id="paste-quiz-container" class="hidden">
        <p style="text-align: center; font-size: 1.1em;"><b>Welcome back!</b> I'm now waiting for the questions from the AI.</p>
        <div id="ai-link-fallback" class="hidden">
            <p>⚠️ It looks like the AI tab was blocked by your browser.</p>
            <a href="https://gemini.google.com" target="_blank" class="btn">Click Here to Open Gemini Manually</a>
        </div>
        <div class="input-group">
            <div class="input-label-group"><label for="quiz-data-input" class="input-label">Paste AI response here</label></div>
            <textarea id="quiz-data-input" placeholder="I'll try to paste and start automatically when you return to this tab. If that doesn't work, just click into this box."></textarea>
        </div>
        <button id="start-manual-quiz-btn" class="btn btn-full-width">Parse & Start! 🧠</button>
    </div>

    <!-- ===== MULTIPLAYER STEP 3: CONFIGURE ROOM ===== -->
    <div id="configure-room-container" class="hidden">
        <h3>Configure Your Room</h3>
        <div class="input-group">
            <label for="host-name" class="input-label">Your Name (as Host)</label>
            <input type="text" id="host-name" class="input-field" placeholder="Enter your name">
        </div>
        <div class="input-group">
            <label for="quiz-time-select" class="input-label">Total Time</label>
            <select id="quiz-time-select" class="input-field">
                <option value="300">5 Minutes</option>
                <option value="600" selected>10 Minutes</option>
                <option value="900">15 Minutes</option>
                <option value="1200">20 Minutes</option>
                <option value="1800">30 Minutes</option>
                <option value="2700">45 Minutes</option>
                <option value="3600">1 Hour</option>
            </select>
        </div>
        <button id="generate-code-btn" class="btn btn-full-width btn-success">Create Joining Code</button>
    </div>

    <!-- ===== LOBBY (for both host and players) ===== -->
    <div id="lobby-container" class="hidden">
        <h2 id="lobby-title">Waiting for Players...</h2>
        <div id="room-code-display" class="hidden">
            <p>Share this code with your friends:</p>
            <strong id="room-code-text"></strong>
            <button id="share-code-whatsapp-btn" class="btn" style="margin-top: 1rem; background-color: #25D366;">Share on WhatsApp</button>
        </div>
        <h3>Players in Room (<span id="player-count">1</span>/4)</h3>
        <ul id="lobby-players-list">
            <!-- Player names will be injected here by JS -->
        </ul>
        <button id="start-game-btn" class="btn btn-full-width btn-success hidden">Start for Everyone</button>
        <p id="waiting-for-host-text">Waiting for the host to start the game.</p>
    </div>

    <!-- ===== SINGLE PLAYER QUIZ PLAYER ===== -->
    <div id="quiz-player-container" class="hidden">
        <div id="quiz-header">
            <span id="question-topic"></span>
            <span id="timer">
                <span class="timer-face" id="face-happy">😊</span><span class="timer-face" id="face-worried">😟</span>
                <span class="timer-face" id="face-sad">😥</span><span class="timer-face" id="face-crying">😭</span>
                <span id="timer-text">00:00</span>
            </span>
            <span id="progress"></span>
            <div id="pressure-mode-container">
                <button id="pressure-mode-toggle-btn" title="Mental Pressure Settings">⏰</button>
                <span id="pressure-text-animation" class="hidden"></span>
                <div id="pressure-mode-controls" class="hidden">
                    <label><span class="switch"><input type="checkbox" id="shake-reminder-toggle"><span class="slider"></span></span> Shake Button Reminder</label>
                </div>
            </div>
        </div>
        <div id="question-image-container" class="hidden"></div>
        <div id="question-and-bookmark">
            <div id="question-text-container"><p id="question-text"></p><div id="statements-list"></div></div>
            <button id="bookmark-btn" title="Bookmark Question">⭐</button>
        </div>
        <div id="options-container"></div>
        <div id="explanation-container" class="hidden"><h4>Explanation</h4><p id="explanation-text"></p></div>
        <div id="quiz-actions"></div>
    </div>

    <!-- ===== MULTIPLAYER QUIZ PLAYER ===== -->
    <div id="multiplayer-quiz-player-container" class="hidden">
         <div id="mp-quiz-header">
            <span id="mp-progress" class="progress"></span>
             <span id="mp-face-reaction-container">
                 <span class="timer-face" id="mp-face-happy">😊</span>
                 <span class="timer-face" id="mp-face-angry">😠</span>
            </span>
            <span id="mp-timer" class="timer">Time Left: <strong>10:00</strong></span>
        </div>
        <hr>
        <p id="mp-question-text" class="question-text"></p>
        <div id="mp-options-container"></div>
        <div id="mp-explanation-container" class="explanation-container hidden"></div>
        <div id="mp-quiz-actions"></div>
        <div id="waiting-for-submission-overlay" class="hidden">
            <div class="spinner"></div>
            <p>Your answers have been submitted.<br>Waiting for other players to finish...</p>
        </div>
    </div>

    <!-- ===== SINGLE PLAYER RESULTS ===== -->
    <div id="results-screen" class="hidden">
        <div class="header"><h2>🏆 Assessment Results</h2></div>
        <div id="score-summary"></div>
        <div id="results-summary-wrapper">
            <div id="score-performance-chart-container"></div>
            <div id="quiz-summary-details"></div>
        </div>
        <div class="share-buttons">
            <div class="share-buttons-row">
                <button id="share-pdf-btn" class="btn">📄 Download PDF</button>
                <button id="copy-bookmarks-btn" class="btn" style="background-color: var(--bookmarked-active-color);">⭐ Copy Bookmarked</button>
                <button id="copy-all-btn" class="btn">📋 Copy All</button>
                <button id="share-whatsapp-btn" class="btn" style="background-color: #25D366;">💬 Share on WhatsApp</button>
                <button id="share-site-btn" class="btn" style="background-color: #5865f2;">📢 Share Website</button>
                <button id="restart-quiz-btn" class="btn">🔄 Take Another Assessment</button>
            </div>
            <div id="results-page-telegram-opener">
                <div class="telegram-input-group">
                    <input type="text" id="results-page-telegram-input" class="input-field" placeholder="Enter Telegram channel username...">
                    <button id="results-page-open-telegram-btn" class="btn btn-secondary">Open</button>
                </div>
            </div>
            <div id="telegram-backup-guide-container">
                <button id="telegram-backup-guide-btn" title="How to backup on Telegram">🤔</button>
                <p>how to backup this bookmark question on telegram for future revision</p>
            </div>
        </div>
        <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 2rem 0;">
        <h3 >Review Your Answers:</h3>
        <div id="results-review"></div>
        <div class="hard-reset-container">
            <button id="hard-reset-btn-single" class="btn hard-reset-btn fire-animation">🔥 Go to Home & Delete All Data 🔥</button>
        </div>
    </div>

     <!-- ===== MULTIPLAYER RESULTS (MODIFIED) ===== -->
    <div id="multiplayer-results-container" class="hidden">
        <h2 id="mp-results-title">🏆 Assessment Submitted! 🏆</h2>
        <div id="multiplayer-personal-summary">
            <h3>Your Performance</h3>
            <div class="summary-grid">
                 <!-- Personal stats will be injected here -->
            </div>
        </div>

        <div id="leaderboard-section" class="hidden">
            <h3>Final Leaderboard</h3>
            <ul id="leaderboard">
                <!-- Final scores will be injected here -->
            </ul>
        </div>

        <p id="waiting-for-leaderboard-text" class="hidden" style="margin-top: 1.5rem; text-align: center; font-style: italic;">Waiting for other players to finish to see the final leaderboard...</p>
        <p id="room-deletion-countdown" class="hidden" style="margin-top: 2rem; font-weight: bold; text-align: center; color: var(--incorrect-color);"></p>
        
        <div class="hard-reset-container">
            <button id="hard-reset-btn-multi" class="btn hard-reset-btn fire-animation">🔥 Go to Home & Delete All Data 🔥</button>
        </div>
    </div>
</div>

<!-- All modals from file 67 -->
<div id="manual-copy-modal-overlay" class="modal-overlay hidden"><div id="manual-copy-modal-content" class="modal-content"><h3>Automatic Copy Failed</h3><p>Please manually copy the text below (it's already selected for you):</p><textarea id="manual-copy-textarea" readonly></textarea><button id="manual-copy-close-btn" class="btn">Close</button></div></div>
<div id="crop-modal-overlay" class="modal-overlay hidden"><div id="crop-modal-content" class="modal-content"><h3>Crop Image</h3><div id="crop-image-container"><img id="image-to-crop" src="" alt="Image for cropping"></div><div class="modal-actions"><button id="cancel-crop-btn" class="btn btn-secondary">Cancel</button><button id="save-crop-btn" class="btn">Crop & Save</button></div></div></div>
<div id="flowchart-modal-overlay" class="modal-overlay hidden"><div class="modal-content"><button class="modal-close-btn-top" title="Close guide">&times;</button><h3 id="flowchart-modal-title">Step Guide</h3><div id="flowchart-modal-content"></div><div class="modal-actions"><button id="flowchart-modal-close-btn" class="btn">Got It!</button></div></div></div>
<div id="telegram-backup-modal-overlay" class="modal-overlay hidden"><div class="modal-content"><button class="modal-close-btn-top" title="Close guide">&times;</button><h3>How to Backup on Telegram</h3><div id="telegram-backup-modal-content" class="guide-step"><p><strong>Step 1: Create a Telegram Channel</strong><br>Open Telegram, create a "New Channel". Make sure you set it to "Public" and give it a unique, easy-to-remember username (e.g., "my_upsc_notes_123").</p><p><strong>Step 2: Copy Questions from EXAMYATRI</strong><br>On this results page, click the "⭐ Copy Bookmarked" or "📋 Copy All" button. This copies the text to your clipboard.</p><p><strong>Step 3: Enter Username & Open</strong><br>Type the channel username you created (e.g., "my_upsc_notes_123") into the box above the 🤔 button and click "Open".</p><p><strong>Step 4: Paste and Save</strong><br>This will open your channel in Telegram. Just paste the copied questions into the message box and send. Your notes are now saved!</p></div><div class="modal-actions"><button id="telegram-backup-close-btn" class="btn">Okay, I Understand</button></div></div></div>
<div id="clipboard-permission-modal-overlay" class="modal-overlay hidden"><div id="clipboard-permission-modal-content" class="modal-content"><h3>✨ Automation Helper</h3><p>To make things super fast, this website can automatically paste the generated questions for you when you return from the AI.</p><p>For this to work, I need your permission to read text from your clipboard. I will only do this when you're on this page and only to find the questions.</p><div class="modal-actions"><button id="deny-clipboard-btn" class="btn btn-secondary">No, I'll paste manually</button><button id="grant-clipboard-btn" class="btn">Yes, allow auto-pasting</button></div></div></div>
<div id="gemini-instructions-modal-overlay" class="modal-overlay hidden"><div class="modal-content"><h3>Ready for AI Magic? ✨</h3><div id="gemini-instructions-content-wrapper"><div class="guide-step"><strong>1️⃣ When Gemini opens:</strong><p>Just paste the instructions into the message box and hit send.</p></div><div class="guide-step"><strong>2️⃣ Copy the Generated Questions:</strong><p>Once the AI finishes, copy the entire response.</p><ul style="padding-left: 20px; margin-top: 0.5em; font-size: 0.9em;"><li><strong>Method 1:</strong> Tap on 3 Vertical Dots (⋮) at the start of the generated question.</li><li><strong>Method 2:</strong> Tap the Copy Icon (📋) at the end of the generated question.</li></ul></div><div class="guide-step"><strong>3️⃣ Return to Examyatri:</strong><p>Come back to this tab to start the assessment.</p><ul style="padding-left: 20px; margin-top: 0.5em; font-size: 0.9em;"><li><strong>Method 1:</strong> Press your device's 'Back' button twice.</li><li><strong>Method 2:</strong> Manually switch tabs from Gemini back to Examyatri.</li></ul></div></div><div class="modal-actions" style="justify-content: center;"><button id="open-gemini-btn" class="btn btn-full-width fire-animation">Got it and Open Gemini Now ➜</button></div></div></div>


<!-- SCRIPTS -->
<!-- Firebase Script (from file 174) -->
<script type="module">
  // Your web app's Firebase configuration
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getDatabase, ref, set, get, onValue, push, onChildAdded, onChildRemoved, serverTimestamp, runTransaction, remove } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB1CQwYIgrL5H9h5EyKLaBpBQS8X1MLzpU",
    authDomain: "examyatri-a6e8f.firebaseapp.com",
    databaseURL: "https://examyatri-a6e8f-default-rtdb.firebaseio.com",
    projectId: "examyatri-a6e8f",
    storageBucket: "examyatri-a6e8f.appspot.com",
    messagingSenderId: "779946225357",
    appId: "1:779946225357:web:4c663a567dc4eb66d402cf"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Expose to global scope for the main script
  window.firebase = { db, ref, set, get, onValue, push, onChildAdded, onChildRemoved, serverTimestamp, runTransaction, remove };
</script>

<!-- Original Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;</script>
<script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

<!-- MERGED & CORRECTED JAVASCRIPT LOGIC -->
<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- CONSTANTS ---
    const QUESTION_FORMATS = {
        'mcq': { name: 'Multiple Choice (MCQ)' },
        'statement': { name: 'Statement-Based' },
        'assertion-reason': { name: 'Assertion-Reason' },
        'math-physics': { name: 'Maths, Physics, or Other Questions'},
        'true-false': { name: 'True/False' },
        'fill-blank': { name: 'Fill-in-the-Blank' },
        'mix': { name: 'Mixed Format' }
    };

    // --- UPDATED LEGACY_FORMAT_TEXT & INDIVIDUAL EXAMPLES ---
    const MCQ_EXAMPLE = `1. Multiple Choice Questions
Question: What is the capital of France?
Options:
a) Berlin
b) Madrid
c) Paris
d) Rome
Correct Answer: c
Explanation: Paris is the capital and most populous city of France.`;

    const AR_EXAMPLE = `1. Assertion-Reason Based Questions
Assertion (A): The sun appears yellow from Earth.
Reason (R): The Earth's atmosphere scatters shorter wavelength blue light more than longer wavelength yellow and red light.
Options:
a) Both A and R are true and R is the correct explanation of A.
b) Both A and R are true but R is not the correct explanation of A.
c) A is true but R is false.
d) A is false but R is true.
Correct Answer: a
Explanation: This phenomenon is known as Rayleigh scattering.`;

    const STATEMENT_EXAMPLE = `1. Statement-Based Questions
Question: Consider the following statements regarding photosynthesis:
* Photosynthesis primarily occurs in the chloroplasts of plant cells.
* Oxygen is released as a byproduct during photosynthesis.
* Photosynthesis converts light energy into chemical energy.
Which of the above statements are correct?
Options:
a) 1 and 2 only
b) 2 and 3 only
c) 1 and 3 only
d) 1, 2, and 3
Correct Answer: d
Explanation: All three statements are correct.`;

    const MATH_EXAMPLE = `1. Maths, Physics, or Other Questions
Question: What is the value of the integral of 3x^2, i.e., \\( \\int 3x^2 \\,dx \\)?
Options:
a) \\( 3x^3 + C \\)
b) \\( x^3 + C \\)
c) \\( 6x + C \\)
d) \\( \\frac{1}{3}x^3 + C \\)
Correct Answer: b
Explanation: Using the power rule for integration, the integral of \\( 3x^2 \\) is \\( x^3 + C \\). C is the constant of integration. For math symbols, you MUST use LaTeX format enclosed in \\( ... \\) delimiters.`;

    const TF_EXAMPLE = `1. True/False Questions
Question: The Earth is the fourth planet from the Sun.
Options:
a) True
b) False
Correct Answer: b
Explanation: The Earth is the third planet from the Sun. Mars is the fourth.`;

    const FILL_BLANK_EXAMPLE = `1. Fill-in-the-Blank Questions
Question: The powerhouse of the cell is the __________.
Options:
a) Nucleus
b) Ribosome
c) Mitochondrion
d) Endoplasmic Reticulum
Correct Answer: c
Explanation: The mitochondrion is responsible for generating most of the cell's supply of adenosine triphosphate (ATP), used as a source of chemical energy.`;

    // This is used for the 'mix' format option.
    const LEGACY_FORMAT_TEXT = [MCQ_EXAMPLE, AR_EXAMPLE, STATEMENT_EXAMPLE, MATH_EXAMPLE, TF_EXAMPLE, FILL_BLANK_EXAMPLE].join('\n\n');


    const commonGuideAfterInput = `<div class="guide-step"><strong>Step 2: Fill Question Details</strong><p>Fill in the details like Number of Questions, Subject, Language, Difficulty, Exam, and Question Format.</p><p class="hindi-text">(चरण 2: क्विज़ का विवरण भरें - प्रश्नों की संख्या, विषय, भाषा, कठिनाई, परीक्षा और प्रश्न प्रारूप जैसे विवरण भरें।)</p></div><div class="guide-step"><strong>Step 3: Generate Prompt & Open AI</strong><p>Click the big "Start 🚀" button. This automatically copies the instructions for the AI and opens the Gemini website in a new tab.</p><p class="hindi-text">(चरण 3: 'Start 🚀' बटन पर क्लिक करें - यह AI के लिए निर्देश अपने आप कॉपी कर लेगा और एक नए टैब में Gemini वेबसाइट खोल देगा।)</p></div><div class="guide-step"><strong>Step 4: Use the AI (Gemini)</strong><p>In the Gemini website, just paste the prompt into the message box and send it. Wait for the AI to generate all the questions.</p><p class="hindi-text">(चरण 4: AI (Gemini) का उपयोग करें - Gemini वेबसाइट में, बस प्रॉम्प्ट को मैसेज बॉक्स में पेस्ट करें और भेजें। AI द्वारा सभी प्रश्न बनाने तक प्रतीक्षा करें।)</p></div><div class="guide-step"><strong>Step 5: Copy AI's Response</strong><p>After the questions are generated, copy the entire response. There are two ways to copy from Gemini: 1) Click the copy icon (like a clipboard 📋) below the answer. 2) Click the three dots (...) at the top-right of the response and select 'Copy'.</p><p class="hindi-text">(चरण 5: AI की प्रतिक्रिया कॉपी करें - प्रश्न बन जाने के बाद, पूरी प्रतिक्रिया कॉपी करें। Gemini से कॉपी करने के 2 तरीके हैं: 1) उत्तर के नीचे कॉपी आइकन (📋) पर क्लिक करें। 2) प्रतिक्रिया के ऊपर-दाईं ओर तीन डॉट्स (...) पर क्लिक करें और 'कॉपी करें' चुनें।)</p></div><div class="guide-step"><strong>Step 6: Return to Examyatri</strong><p>You have two choices: 1) Simply switch tabs from Gemini back to examyatri. 2) On mobile, you can press your phone's 'Back' navigation button twice. The questions will be created automatically!</p><p class="hindi-text">(चरण 6: Examyatri पर वापस आएं - आपके पास 2 विकल्प हैं: 1) बस Gemini से Gemini टैब पर वापस स्विच करें। 2) मोबाइल पर, आप अपने फोन का 'बैक' नेविगेशन बटन दो बार दबा सकते हैं। क्विज़ अपने आप बन जाएगा!)</p></div>`;

    const GUIDE_DATA = {
        'topic-step1':{title:'Guide: Create Questions from Topic',content:`<div class="guide-step"><strong>Step 1: Enter Your Topic</strong><p>First, fill in the "Primary Topic" field. For example: "World War II" or "Solar System".</p><p class="hindi-text">(चरण 1: अपना विषय दर्ज करें - सबसे पहले, "Primary Topic" फ़ील्ड भरें। उदाहरण के लिए: "द्वितीय विश्व युद्ध" या "सौर मंडल"।)</p></div>${commonGuideAfterInput}`},
        'text-step1':{title:'Guide: Create Questions from Text',content:`<div class="guide-step"><strong>Step 1: Paste Your Text</strong><p>Find any article, notes, or paragraph you want to make questions from. Copy that text and paste it into the big text box here.</p><p class="hindi-text">(चरण 1: अपना टेक्स्ट पेस्ट करें - कोई भी लेख, नोट्स या पैराग्राफ खोजें जिससे आप प्रश्न बनाना चाहते हैं। उस टेक्स्ट को कॉपी करें और यहां बड़े टेक्स्ट बॉक्स में पेस्ट करें।)</p></div>${commonGuideAfterInput}`},
        'text-step2':{title:'Guide: Create Questions from Text',content:`<div class="guide-step"><strong>Step 1: Paste Your Text</strong><p>Find any article, notes, or paragraph you want to make questions from. Copy that text and paste it into the big text box here.</p><p class="hindi-text">(चरण 1: अपना टेक्स्ट पेस्ट करें - कोई भी लेख, नोट्स या पैराग्राफ खोजें जिससे आप प्रश्न बनाना चाहते हैं। उस टेक्स्ट को कॉपी करें और यहां बड़े टेक्स्ट बॉक्स में पेस्ट करें।)</p></div>${commonGuideAfterInput}`},
        'image-step1':{title:'Guide: Create Questions from Image',content:`<div class="guide-step"><strong>Step 1: Upload Your Images</strong><p>Click "Select Images" and choose pictures of your book pages or notes. The app will automatically detect the correct text orientation and extract the text for you.</p><p class="hindi-text">(चरण 1: अपनी इमेज अपलोड करें - "Select Images" पर क्लिक करें और अपनी किताब के पन्नों या नोट्स की तस्वीरें चुनें। ऐप अपने आप टेक्स्ट की सही दिशा का पता लगा लेगा और आपके लिए टेक्स्ट निकाल देगा।)</p></div>${commonGuideAfterInput}`},
        'image-step3':{title:'Guide: Create Questions from Image',content:`<div class="guide-step"><strong>Step 1: Upload Your Images</strong><p>Click "Select Images" and choose pictures of your book pages or notes. The app will automatically detect the correct text orientation and extract the text for you.</p><p class="hindi-text">(चरण 1: अपनी इमेज अपलोड करें - "Select Images" पर क्लिक करें और अपनी किताब के पन्नों या नोट्स की तस्वीरें चुनें। ऐप अपने आप टेक्स्ट की सही दिशा का पता लगा लेगा और आपके लिए टेक्स्ट निकाल देगा।)</p></div>${commonGuideAfterInput}`},
        'pdf-step1':{title:'Guide: Create Questions from PDF',content:`<div class="guide-step"><strong>Step 1: Select Your PDF</strong><p>Click "Select PDF" and choose the PDF file from your phone or computer.</p><p class="hindi-text">(चरण 1: अपनी PDF चुनें - "Select PDF" पर क्लिक करें और अपने फोन या कंप्यूटर से PDF फाइल चुनें।)</p></div><div class="guide-step"><strong>Step 2: Choose Options & Extract Text</strong><p>You can extract all pages or a specific range. <strong>Important:</strong> If your PDF is a scanned copy or has images of text, check the "Force OCR" box for best results. Then click "Extract Text from PDF".</p><p class="hindi-text">(चरण 2: विकल्प चुनें और टेक्स्ट निकालें - आप सभी पृष्ठ या एक विशिष्ट रेंज निकाल सकते हैं। <strong>महत्वपूर्ण:</strong> यदि आपकी PDF एक स्कैन की हुई कॉपी है या उसमें टेक्स्ट की तस्वीरें हैं, तो सर्वोत्तम परिणामों के लिए "Force OCR" बॉक्स को चेक करें। फिर "Extract Text from PDF" पर क्लिक करें।)</p></div>${commonGuideAfterInput}`},
        'pdf-step2':{title:'Guide: Create Questions from a PDF',content:`<div class="guide-step"><strong>Step 1: Select Your PDF</strong><p>Click "Select PDF" and choose the PDF file from your phone or computer.</p><p class="hindi-text">(चरण 1: अपनी PDF चुनें - "Select PDF" पर क्लिक करें और अपने फोन या कंप्यूटर से PDF फाइल चुनें।)</p></div><div class="guide-step"><strong>Step 2: Choose Options & Extract Text</strong><p>You can extract all pages or a specific range. <strong>Important:</strong> If your PDF is a scanned copy or has images of text, check the "Force OCR" box for best results. Then click "Extract Text from PDF".</p><p class="hindi-text">(चरण 2: विकल्प चुनें और टेक्स्ट निकालें - आप सभी पृष्ठ या एक विशिष्ट रेंज निकाल सकते हैं। <strong>महत्वपूर्ण:</strong> यदि आपकी PDF एक स्कैन की हुई कॉपी है या उसमें टेक्स्ट की तस्वीरें हैं, तो सर्वोत्तम परिणामों के लिए "Force OCR" बॉक्स को चेक करें। फिर "Extract Text from PDF" पर क्लिक करें।)</p></div>${commonGuideAfterInput}`}
    };

    const FORM_STATE_KEY = 'examyatriFormState';
    const SCROLL_POS_KEY = 'examyatriScrollPos';

    const elements = {
        // NEW: Global Nav Bar
        globalNavBar: document.getElementById('global-nav-bar'),

        // Main Containers
        mainContainer: document.getElementById('main-container'),
        loadingOverlay: document.getElementById('loading-overlay'),
        loadingText: document.getElementById('loading-text'),
        modeSelectionContainer: document.getElementById('mode-selection-container'),
        multiplayerSelectionContainer: document.getElementById('multiplayer-selection-container'),
        manualGeneratorContainer: document.getElementById('manual-generator-container'),
        pasteQuizContainer: document.getElementById('paste-quiz-container'),
        quizPlayerContainer: document.getElementById('quiz-player-container'),
        resultsScreen: document.getElementById('results-screen'),
        joinRoomContainer: document.getElementById('join-room-container'),
        configureRoomContainer: document.getElementById('configure-room-container'),
        lobbyContainer: document.getElementById('lobby-container'),
        multiplayerQuizPlayerContainer: document.getElementById('multiplayer-quiz-player-container'),
        multiplayerResultsContainer: document.getElementById('multiplayer-results-container'),


        // Mode Selection Buttons
        selectSinglePlayerBtn: document.getElementById('select-single-player-btn'),
        selectMultiplayerBtn: document.getElementById('select-multiplayer-btn'),
        
        // Generator Screen
        creationMethodSelector: document.getElementById('creation-method-selector'),

        // Workflows
        topicGeneratorWorkflow: document.getElementById('topic-generator-workflow'),
        textGeneratorWorkflow: document.getElementById('text-generator-workflow'),
        imageGeneratorWorkflow: document.getElementById('image-generator-workflow'),
        pdfGeneratorWorkflow: document.getElementById('pdf-generator-workflow'),

        // Image Workflow
        imageFormatGuide: document.getElementById('image-format-guide'),
        imageLangSelectorContainer: document.getElementById('image-lang-selector-container'),
        imageFileInput: document.getElementById('image-file-input'),
        imagePreviewContainer: document.getElementById('image-preview-container'),
        ocrStatus: document.getElementById('ocr-status'),
        imageQuizDefinitionArea: document.getElementById('image-quiz-definition-area'),
        sourceTextImage: document.getElementById('source-text-image'),
        handwritingToggle: document.getElementById('handwriting-toggle'),
        
        // PDF Workflow
        pdfLangSelectorContainer: document.getElementById('pdf-lang-selector-container'),
        pdfFileInput: document.getElementById('pdf-file-input'),
        pdfFileName: document.getElementById('pdf-file-name'),
        pdfOptionsContainer: document.getElementById('pdf-options-container'),
        pdfPageRangeSelector: document.getElementById('pdf-page-range-selector'),
        pdfForceOcrCheckbox: document.getElementById('pdf-force-ocr'),
        pdfStatus: document.getElementById('pdf-status'),
        pdfQuizDefinitionArea: document.getElementById('pdf-quiz-definition-area'),
        sourceTextPdf: document.getElementById('source-text-pdf'),

        // Paste & Parse Screen
        aiLinkFallback: document.getElementById('ai-link-fallback'),
        quizDataInput: document.getElementById('quiz-data-input'),

        // Quiz Player
        questionTopic: document.getElementById('question-topic'),
        progress: document.getElementById('progress'),
        timerText: document.getElementById('timer-text'),
        faces: { happy: document.getElementById('face-happy'), worried: document.getElementById('face-worried'), sad: document.getElementById('face-sad'), crying: document.getElementById('face-crying')},
        bookmarkBtn: document.getElementById('bookmark-btn'),
        questionText: document.getElementById('question-text'),
        statementsList: document.getElementById('statements-list'),
        optionsContainer: document.getElementById('options-container'),
        explanationContainer: document.getElementById('explanation-container'),
        explanationText: document.getElementById('explanation-text'),
        quizActions: document.getElementById('quiz-actions'),

        // Feedback & Pressure Mode Elements
        congratsAnimationContainer: document.getElementById('congrats-animation-container'),
        sadReactionOverlay: document.getElementById('sad-reaction-overlay'),
        sadReactionEmoji: document.getElementById('sad-reaction-emoji'),
        pressureModeControls: document.getElementById('pressure-mode-controls'),
        shakeReminderToggle: document.getElementById('shake-reminder-toggle'),

        // Results Screen
        scoreSummary: document.getElementById('score-summary'),
        scorePerformanceChartContainer: document.getElementById('score-performance-chart-container'),
        quizSummaryDetails: document.getElementById('quiz-summary-details'),
        resultsReview: document.getElementById('results-review'),
        resultsPageTelegramInput: document.getElementById('results-page-telegram-input'),

        // Modals
        pasteNotification: document.getElementById('paste-notification'),
        manualCopyModalOverlay: document.getElementById('manual-copy-modal-overlay'),
        manualCopyTextarea: document.getElementById('manual-copy-textarea'),
        cropModalOverlay: document.getElementById('crop-modal-overlay'),
        imageToCrop: document.getElementById('image-to-crop'),
        flowchartModalOverlay: document.getElementById('flowchart-modal-overlay'),
        flowchartModalTitle: document.getElementById('flowchart-modal-title'),
        flowchartModalContent: document.getElementById('flowchart-modal-content'),
        telegramBackupModalOverlay: document.getElementById('telegram-backup-modal-overlay'),
        clipboardPermissionModalOverlay: document.getElementById('clipboard-permission-modal-overlay'),
        geminiInstructionsModalOverlay: document.getElementById('gemini-instructions-modal-overlay'),
        
        // Multiplayer Elements
        playerNameJoinInput: document.getElementById('player-name-join'),
        roomCodeInput: document.getElementById('room-code-input'),
        hostNameInput: document.getElementById('host-name'),
        quizTimeSelect: document.getElementById('quiz-time-select'),
        roomCodeText: document.getElementById('room-code-text'),
        roomCodeDisplay: document.getElementById('room-code-display'),
        lobbyPlayersList: document.getElementById('lobby-players-list'),
        playerCountSpan: document.getElementById('player-count'),
        waitingForHostText: document.getElementById('waiting-for-host-text'),
        multiplayerPersonalSummary: document.getElementById('multiplayer-personal-summary'),
        mpQuizActions: document.getElementById('mp-quiz-actions'),
        mpProgress: document.getElementById('mp-progress'),
        mpTimer: document.getElementById('mp-timer').querySelector('strong'),
        mpQuestionText: document.getElementById('mp-question-text'),
        mpOptionsContainer: document.getElementById('mp-options-container'),
        mpExplanationContainer: document.getElementById('mp-explanation-container'),
        waitingForSubmissionOverlay: document.getElementById('waiting-for-submission-overlay'),
        mpFaceHappy: document.getElementById('mp-face-happy'),
        mpFaceAngry: document.getElementById('mp-face-angry'),
    };

    const dbHelper = {
        db: null, dbName: 'examyatriDB', storeName: 'sessionState',
        async init() { return new Promise((resolve, reject) => { const request = indexedDB.open(this.dbName, 1); request.onupgradeneeded = (event) => { const db = event.target.result; if (!db.objectStoreNames.contains(this.storeName)) { db.createObjectStore(this.storeName); } }; request.onsuccess = (event) => { this.db = event.target.result; resolve(this.db); }; request.onerror = (event) => { console.error('IndexedDB error:', event.target.error); reject(event.target.error); }; }); },
        async set(key, value) { if (!this.db) await this.init(); return new Promise((resolve, reject) => { const transaction = this.db.transaction([this.storeName], 'readwrite'); const store = transaction.objectStore(this.storeName); const request = store.put(value, key); request.onsuccess = () => resolve(); request.onerror = (event) => reject(event.target.error); }); },
        async get(key) { if (!this.db) await this.init(); return new Promise((resolve, reject) => { const transaction = this.db.transaction([this.storeName], 'readonly'); const store = transaction.objectStore(this.storeName); const request = store.get(key); request.onsuccess = () => resolve(request.result); request.onerror = (event) => reject(event.target.error); }); },
        async clear() { if (!this.db) await this.init(); return new Promise((resolve, reject) => { const transaction = this.db.transaction([this.storeName], 'readwrite'); const store = transaction.objectStore(this.storeName); const request = store.clear(); request.onsuccess = () => resolve(); request.onerror = (event) => reject(event.target.error); }); }
    };

    // --- STATE MANAGEMENT ---
    let gameMode = null; // 'singlePlayer' or 'multiplayer'
    const QUIZ_STATE_KEY = 'examyatriQuizState';
    let quizData = [], originalQuizData = [], userAnswers = [];
    let quizMetaData = {};
    let currentQuestionIndex = 0, selectedOptionIndex = null;
    let bookmarkedQuestions = new Set();
    let timerId = null, quizStartTime = null, questionStartTime = null;
    let imageFiles = [];
    let pdfFile = null;
    let cropper = null;
    let currentEditingImageId = null;
    let selectedExam = '';
    
    // --- OCR State (FIX) ---
    let ocrWorker = null;
    let currentOcrLang = null; // Tracks the language of the current ocrWorker instance
    let selectedImageOcrLang = null; // NEW: State for image language
    let selectedPdfOcrLang = null;   // NEW: State for PDF language
    let promptForGemini = null;

    // Multiplayer State
    let currentRoomCode = null, currentPlayerId = null, isHost = false;
    let roomListener = null, clientTimer = null;
    let lastRoomData = null; // To store the final room data for results
    let mpCurrentQuestionIndex = 0; // Local index for multiplayer navigation
    let mpSelectedOptionIndex = null; // Local selection for multiplayer
    let countdownTimerId = null; // FIX: Added for leaderboard countdown control

    let isShakeReminderEnabled = true;
    let pressureTextCounter = 1;
    const optionClickSound = new Audio('data:audio/mpeg;base64,UklGRkYAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhMgAAAP//AwD//wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v8CAP7/AwD+/wEAAQAAAAEAAAAA/v-');
    const clapSound = new Audio('data:audio/mpeg;base64,UklGRigBAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABgAAABkYXRhJAEAAAD///////8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A-BAAGvbnAAAAAIAAAARYAAAAYwBvAG4AZgBuAG8AcgBtAGEAbAAgACgASQBDAEUAIAAgAGMAaQBjAGUAbABhAG4AZABhACAAQwByAGUAZQBtAGkQByACkALgAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJABMAcwBvAHUAbgBkACAARgBvAHIAZwBlACAAWABQAAANAAAAAGQAYQB0AGE');
    
    // --- INITIALIZATION ---
    async function init() {
        applyInitialTheme();
        populateSharedElements();
        setupAudio();
        setupEventListeners();
        setupAllExamSelectors();
        loadFormState();
        loadScrollPosition();
        loadPressureModeSettings();
        
        document.getElementById('pdf-force-ocr').checked = true;
        
        await dbHelper.init();
        
        // *** MODIFICATION START: Simplified and Robust Routing Logic ***

        // Add event listener for back/forward button presses
        window.addEventListener('hashchange', handleHashChange);

        // Add safety net to prevent accidental reloads during a quiz
        window.addEventListener('beforeunload', (event) => {
            const isQuizActive = !elements.quizPlayerContainer.classList.contains('hidden') && quizData.length > 0;
            const isMultiplayerQuizActive = !elements.multiplayerQuizPlayerContainer.classList.contains('hidden');

            if (isQuizActive || isMultiplayerQuizActive) {
                event.preventDefault(); // Required for modern browsers
                event.returnValue = ''; // Required for older browsers
            }
        });

        const quizRestored = await loadQuizState();
        if (quizRestored) {
            // Priority 1: If there's a saved quiz, ALWAYS go to the player.
            // The loadQuizState function already handles showing the screen. We just set the hash.
            showScreen('player');
        } else {
            // Priority 2: If no saved quiz, let the hash router decide what to show.
            // This will correctly handle #paste if the user is returning from the AI tab,
            // or default to the home screen if the hash is empty.
            handleHashChange();
        }
        
        // *** MODIFICATION END ***

        setupDynamicPromptBuilder();
    }
    
    function setupAudio() { optionClickSound.volume = 0.7; clapSound.volume = 0.5; }

    init();

    // --- UI & SCREEN MANAGEMENT ---
    function showLoading(text) { elements.loadingText.textContent = text; elements.loadingOverlay.classList.remove('hidden'); }
    function hideLoading() { elements.loadingOverlay.classList.add('hidden'); }

    /**
     * Navigates to a new screen by updating the URL hash.
     * This creates a browser history entry, allowing the back button to work.
     * @param {string} screenName - The key of the screen to navigate to.
     */
    function showScreen(screenName) {
        const newHash = `#${screenName}`;
        if (window.location.hash !== newHash) {
            window.location.hash = newHash;
        } else {
            _displayScreen(screenName);
        }
    }

    /**
     * The internal function that physically shows/hides the screen divs.
     * It does NOT modify the URL hash. This is called by the router (handleHashChange).
     * @param {string} screenName - The key of the screen to display.
     */
    function _displayScreen(screenName) {
        const screens = {
            modeSelection: elements.modeSelectionContainer,
            multiplayerSelection: elements.multiplayerSelectionContainer,
            manualGenerator: elements.manualGeneratorContainer,
            paste: elements.pasteQuizContainer,
            player: elements.quizPlayerContainer,
            results: elements.resultsScreen,
            joinRoom: elements.joinRoomContainer,
            configureRoom: elements.configureRoomContainer,
            lobby: elements.lobbyContainer,
            mpPlayer: elements.multiplayerQuizPlayerContainer,
            mpResults: elements.multiplayerResultsContainer,
        };

        const isQuizScreen = screenName === 'player' || screenName === 'mpPlayer';
        if (elements.globalNavBar) {
            elements.globalNavBar.classList.toggle('hidden', isQuizScreen);
        }

        Object.values(screens).forEach(screen => {
            if (screen) screen.classList.add('hidden');
        });

        if(screens[screenName]) {
            screens[screenName].classList.remove('hidden');
            if(screenName === 'manualGenerator') {
                showCreationSelector();
            }
        }
    }

    /**
     * The "Router". This function is triggered by the 'hashchange' event or on initial load.
     * It reads the current URL hash and shows the correct content.
     */
    function handleHashChange() {
        const screenName = window.location.hash.substring(1);

        // All possible screens must have a corresponding container element with the id `${screenName}Container`
        const allScreens = ['modeSelection', 'multiplayerSelection', 'manualGenerator', 'paste', 'player', 'results', 'joinRoom', 'configureRoom', 'lobby', 'mpPlayer', 'mpResults'];

        if (!screenName || !allScreens.includes(screenName)) {
            _displayScreen('modeSelection');
            return;
        }

        _displayScreen(screenName);
        
        // *** MODIFICATION ***: Trigger clipboard logic when we route to the paste screen.
        if (screenName === 'paste') {
            handleClipboardPermission();
        }
    }

    // --- EVENT LISTENERS (REFACTORED WITH EVENT DELEGATION) ---
    function setupEventListeners() {
        // --- MASTER CLICK HANDLER (EVENT DELEGATION) ---
        document.body.addEventListener('click', (event) => {
            const target = event.target;
            const targetId = target.id;
            const closestButton = target.closest('[id]'); // Find nearest parent with an ID
            const closestPill = target.closest('.lang-pill-btn'); // Use new class

            // Use the closest button's ID if the target itself doesn't have one (e.g., clicking an icon inside a button)
            const effectiveId = closestButton ? closestButton.id : targetId;
            
            // --- NEW: Global Nav Button ---
            if (effectiveId === 'global-home-btn') { handleHardReset(); return; }

            // --- Navigation and Mode Selection ---
            if (effectiveId === 'select-single-player-btn') { gameMode = 'singlePlayer'; showScreen('manualGenerator'); return; }
            if (effectiveId === 'select-multiplayer-btn') { gameMode = 'multiplayer'; showScreen('multiplayerSelection'); return; }
            if (target.classList.contains('back-to-mode-selection-btn')) { showScreen('modeSelection'); return; }
            if (target.classList.contains('back-to-multiplayer-selection-btn')) { showScreen('multiplayerSelection'); return; }
            if (target.classList.contains('back-to-creation-selection-btn')) { showCreationSelector(); return; }

            // --- Multiplayer Flow ---
            if (effectiveId === 'join-room-btn') { showScreen('joinRoom'); return; }
            if (effectiveId === 'create-room-btn') { showScreen('manualGenerator'); return; }
            if (effectiveId === 'submit-join-room-btn') { handleJoinRoom(); return; }
            if (effectiveId === 'generate-code-btn') { handleGenerateCode(); return; }
            if (effectiveId === 'start-game-btn') { handleStartGame(); return; }
            if (effectiveId === 'share-code-whatsapp-btn') { const text = `Join my Examyatri room! 🚀\n\nRoom Code: \`${currentRoomCode}\`\n\nClick the link to join: ${window.location.href}`; window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`, '_blank'); return; }

            // --- Generator Creation Method Selection ---
            if (effectiveId === 'select-from-topic') { showWorkflow('topic'); return; }
            if (effectiveId === 'select-from-text') { showWorkflow('text'); return; }
            if (effectiveId === 'select-from-image') { showWorkflow('image'); return; }
            if (effectiveId === 'select-from-pdf') { showWorkflow('pdf'); return; }
            
            // --- UPDATED: Language Pill Selection ---
            if (closestPill) {
                const lang = closestPill.dataset.lang;
                const container = closestPill.parentElement;
                
                // Remove active class from siblings
                container.querySelectorAll('.lang-pill-btn').forEach(btn => btn.classList.remove('active'));
                // Add active class to the clicked one
                closestPill.classList.add('active');

                // Update state based on which container it's in
                if (container.id === 'image-lang-selector-container') {
                    selectedImageOcrLang = lang;
                } else if (container.id === 'pdf-lang-selector-container') {
                    selectedPdfOcrLang = lang;
                }
                saveFormState(); // Persist the selection
                return;
            }

            // --- Generator "Start" Buttons ---
            if (effectiveId === 'generate-prompt-btn-topic') { generateTopicPrompt(); return; }
            if (effectiveId === 'generate-prompt-btn-text') { generateTextPrompt(); return; }
            if (effectiveId === 'generate-prompt-btn-image') { generateImagePrompt(); return; }
            if (effectiveId === 'generate-prompt-btn-pdf') { generatePdfPrompt(); return; }
            
            // --- MODIFIED: Image/PDF Workflow Buttons with mandatory language check ---
            if (effectiveId === 'select-images-btn') {
                if (!selectedImageOcrLang) {
                    alert('Please first select a Document Language.');
                    return;
                }
                elements.imageFileInput.click();
                return;
            }
            if (effectiveId === 'select-pdf-btn') {
                 if (!selectedPdfOcrLang) {
                    alert('Please first select a Document Language.');
                    return;
                }
                elements.pdfFileInput.click();
                return;
            }
            if (effectiveId === 'extract-text-pdf-btn') { runPdfExtraction(); return; }
            if (target.closest('.crop-btn')) { openCropModal(target.closest('.crop-btn').dataset.id); return; }
            if (target.closest('.remove-btn')) { removeImage(target.closest('.remove-btn').dataset.id); return; }

            // --- Quiz Parsing ---
            if (effectiveId === 'start-manual-quiz-btn') { handlePasteAndParse(); return; }

            // --- Quiz Player Actions ---
            if (target.closest('.option')) { 
                const optionIndex = parseInt(target.closest('.option').dataset.index, 10);
                if (elements.quizPlayerContainer.offsetParent !== null) selectOption(optionIndex); 
                else if (elements.multiplayerQuizPlayerContainer.offsetParent !== null) selectMultiplayerOption(optionIndex);
                return; 
            }
            if (effectiveId === 'check-answer-btn') { checkAnswer(); return; }
            if (effectiveId === 'mp-check-answer-btn') { checkMultiplayerAnswer(); return; }
            if (effectiveId === 'skip-question-btn') { handleSkip(); return; }
            if (effectiveId === 'next-question-btn') { loadQuestion(currentQuestionIndex + 1); return; }
            if (effectiveId === 'mp-next-btn') { loadMultiplayerQuestion(mpCurrentQuestionIndex + 1); return; }
            if (effectiveId === 'prev-question-btn') { loadQuestion(currentQuestionIndex - 1); return; }
            if (effectiveId === 'mp-prev-btn') { loadMultiplayerQuestion(mpCurrentQuestionIndex - 1); return; }
            if (effectiveId === 'submit-quiz-btn') { forceSubmitQuiz(); return; }
            if (effectiveId === 'bookmark-btn') { handleBookmark(); return; }

            // --- Results Screen Actions ---
            if (effectiveId === 'share-pdf-btn') { generatePDF(); return; }
            if (effectiveId === 'copy-bookmarks-btn') { copyQuizContent(true); return; }
            if (effectiveId === 'copy-all-btn') { copyQuizContent(false); return; }
            if (effectiveId === 'share-whatsapp-btn') { shareOnWhatsApp(); return; }
            if (effectiveId === 'share-site-btn') { shareWebsite(); return; }
            if (effectiveId === 'restart-quiz-btn') { restartQuiz(); return; }
            if (effectiveId === 'results-page-open-telegram-btn') { openTelegramWithBookmarks(); return; }
            if (effectiveId === 'hard-reset-btn-single' || effectiveId === 'hard-reset-btn-multi') { handleHardReset(); return; }

            // --- Modals and Misc UI ---
            if (effectiveId === 'theme-toggle-btn') { toggleTheme(); return; }
            if (target.closest('.guide-btn')) { showFlowchartGuide(target.closest('.guide-btn').dataset.guideId); return; }
            if (target.closest('.modal-close-btn-top') || effectiveId === 'flowchart-modal-close-btn') { target.closest('.modal-overlay').classList.add('hidden'); return; }
            if (effectiveId === 'telegram-backup-guide-btn') { elements.telegramBackupModalOverlay.classList.remove('hidden'); return; }
            if (effectiveId === 'telegram-backup-close-btn') { elements.telegramBackupModalOverlay.classList.add('hidden'); return; }
            if (effectiveId === 'manual-copy-close-btn') { elements.manualCopyModalOverlay.classList.add('hidden'); return; }
            if (effectiveId === 'cancel-crop-btn') { closeCropModal(); return; }
            if (effectiveId === 'save-crop-btn') { saveCrop(); return; }
            if (effectiveId === 'grant-clipboard-btn') { requestClipboardAndPaste(); return; }
            if (effectiveId === 'deny-clipboard-btn') { elements.clipboardPermissionModalOverlay.classList.add('hidden'); showPasteNotification("Okay, you can paste the text yourself."); return; }
            if (effectiveId === 'open-gemini-btn') { if (promptForGemini) { executePostPromptActions(promptForGemini); promptForGemini = null; elements.geminiInstructionsModalOverlay.classList.add('hidden'); } return; }
            if (effectiveId === 'pressure-mode-toggle-btn') { elements.pressureModeControls.classList.toggle('hidden'); return; }

        });

        // --- Other non-click event listeners ---
        elements.imageFileInput.addEventListener('change', handleImageSelection);
        elements.pdfFileInput.addEventListener('change', handlePdfSelection);
        elements.pdfForceOcrCheckbox.addEventListener('change', (e) => {
             // This logic remains, though language selection is separate.
             // It controls whether to USE the selected OCR language or not.
        });

        document.querySelectorAll('input[name="pdf-page-option"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const isRange = e.target.value === 'range';
                elements.pdfPageRangeSelector.classList.toggle('hidden', !isRange);
            });
        });

        document.addEventListener('visibilitychange', handleVisibilityChange);
        window.addEventListener('beforeunload', saveQuizState);
        elements.quizDataInput.addEventListener('focus', tryAutoPasteOnFocus);
        elements.shakeReminderToggle.addEventListener('change', (e) => { isShakeReminderEnabled = e.target.checked; localStorage.setItem('shakeReminderEnabled', isShakeReminderEnabled); const checkBtn = document.getElementById('check-answer-btn'); if (!isShakeReminderEnabled && checkBtn) checkBtn.classList.remove('vibrating'); });
        
        let scrollTimeout;
        window.addEventListener('scroll', () => { clearTimeout(scrollTimeout); scrollTimeout = setTimeout(saveScrollPosition, 150); });
        getPersistableInputs().forEach(input => { input.addEventListener('input', saveFormState); input.addEventListener('change', saveFormState); });
    }

    // --- FORM & SCROLL PERSISTENCE ---
    function getPersistableInputs() { return document.querySelectorAll('#manual-generator-container input, #manual-generator-container textarea, #manual-generator-container select'); }
    function saveFormState() { const state = {}; const inputs = getPersistableInputs(); inputs.forEach(input => { if (!input.id && !input.name) return; const key = input.id || input.name; switch (input.type) { case 'checkbox': state[key] = input.checked; break; case 'radio': if (input.checked) { state[input.name] = input.id; } break; default: state[key] = input.value; } }); state['activeExamButton'] = selectedExam; state['selectedImageOcrLang'] = selectedImageOcrLang; state['selectedPdfOcrLang'] = selectedPdfOcrLang; localStorage.setItem(FORM_STATE_KEY, JSON.stringify(state)); }
    function loadFormState() {
        const savedState = localStorage.getItem(FORM_STATE_KEY);
        if (!savedState) return;
        const state = JSON.parse(savedState);
        const inputs = getPersistableInputs();
        inputs.forEach(input => {
            if (!input.id && !input.name) return;
            const key = input.id || input.name;
            if (input.type === 'radio' && state[input.name]) {
                input.checked = (input.id === state[input.name]);
            } else if (state.hasOwnProperty(key)) {
                switch (input.type) {
                    case 'checkbox': input.checked = state[key]; break;
                    default: input.value = state[key];
                }
            }
        });
        document.querySelectorAll('.exam-btn').forEach(btn => btn.classList.remove('active'));
        if (state.activeExamButton) {
            selectedExam = state.activeExamButton;
            document.querySelectorAll('.exam-buttons-container').forEach(container => {
                const btnToActivate = container.querySelector(`.exam-btn[data-exam-name="${state.activeExamButton}"]`);
                if (btnToActivate) {
                    btnToActivate.classList.add('active');
                    const otherInput = container.closest('.input-group').querySelector('.prompt-exam-other');
                    if (otherInput) {
                        otherInput.classList.toggle('hidden', state.activeExamButton !== 'Other');
                    }
                }
            });
        }
        document.querySelectorAll('input[name="pdf-page-option"]').forEach(radio => {
            if (radio.checked) {
                elements.pdfPageRangeSelector.classList.toggle('hidden', radio.value !== 'range');
            }
        });

        // UPDATED: Restore language pill selection
        if (state.selectedImageOcrLang) {
            selectedImageOcrLang = state.selectedImageOcrLang;
            const btn = elements.imageLangSelectorContainer.querySelector(`.lang-pill-btn[data-lang="${selectedImageOcrLang}"]`);
            if (btn) btn.classList.add('active');
        }
        if (state.selectedPdfOcrLang) {
            selectedPdfOcrLang = state.selectedPdfOcrLang;
            const btn = elements.pdfLangSelectorContainer.querySelector(`.lang-pill-btn[data-lang="${selectedPdfOcrLang}"]`);
            if (btn) btn.classList.add('active');
        }
    }
    function clearFormState() {
        localStorage.removeItem(FORM_STATE_KEY);
        localStorage.removeItem(SCROLL_POS_KEY);
        selectedImageOcrLang = null;
        selectedPdfOcrLang = null;
        document.querySelectorAll('.lang-pill-btn.active').forEach(c => c.classList.remove('active'));
    }
    function saveScrollPosition() { if (elements.manualGeneratorContainer.offsetParent !== null) { localStorage.setItem(SCROLL_POS_KEY, window.scrollY); } }
    function loadScrollPosition() { const scrollY = localStorage.getItem(SCROLL_POS_KEY); if (scrollY && elements.manualGeneratorContainer.offsetParent !== null) { setTimeout(() => window.scrollTo(0, parseInt(scrollY, 10)), 100); } }
    
    // --- PARSER, VALIDATOR, AND QUIZ START LOGIC ---
    function handlePasteAndParse() {
        // FIX: Retrieve the game mode from sessionStorage to persist it across the redirect to the AI.
        const gameMode = sessionStorage.getItem('gameMode');
        const text = elements.quizDataInput.value.trim();
        if (!text) { alert('Please paste the response into the box.'); return; }

        sessionStorage.removeItem('gameMode'); // Clear this after use

        if (gameMode === 'multiplayer') {
            localStorage.setItem('multiplayerQuizText', text);
            showScreen('configureRoom');
        } else {
            // Single Player Logic
            if (!quizMetaData || Object.keys(quizMetaData).length === 0) { quizMetaData = { topic: '', subject: '' }; }
            const parsedQuestions = transformParsedData_Legacy(parseQuizText_Legacy(text));
            if (!parsedQuestions || parsedQuestions.length === 0) { alert('Parsing Failed: Could not find valid questions.'); return; }
            const validation = validateParsedData(parsedQuestions);
            if (!validation.isValid) { alert(`Validation Failed:\n\n${validation.error}`); return; }
            quizData = parsedQuestions;
            startQuiz();
        }
    }
    
    // --- MULTIPLAYER LOGIC ---
    async function handleJoinRoom() {
        const playerName = elements.playerNameJoinInput.value.trim();
        const roomCode = elements.roomCodeInput.value.trim();
        if (!playerName || !roomCode) { alert('Please fill in all fields.'); return; }
        
        const { db, ref, get, set, push } = window.firebase;
        const roomRef = ref(db, `rooms/${roomCode}`);
        
        try {
            const snapshot = await get(roomRef);
            if (!snapshot.exists()) { alert('Room not found. Please check the code.'); return; }
            const roomData = snapshot.val();
            if (Object.keys(roomData.players || {}).length >= 4) { alert('This room is full.'); return; }
            if (roomData.status !== 'waiting') { alert('This game has already started or finished.'); return; }

            currentRoomCode = roomCode;
            const newPlayerRef = push(ref(db, `rooms/${currentRoomCode}/players`));
            currentPlayerId = newPlayerRef.key;
            await set(newPlayerRef, { name: playerName, isHost: false, score: 0, answers: [] });
            enterLobby();
        } catch (error) { console.error("Failed to join room: ", error); alert("Could not join the room."); }
    }

    async function handleGenerateCode() {
        const hostName = elements.hostNameInput.value.trim();
        const quizText = localStorage.getItem('multiplayerQuizText');
        if (!hostName) { alert('Please enter your name.'); return; }
        if (!quizText) { alert('Error: Question text not found. Please go back and create the questions.'); return; }

        isHost = true;
        currentRoomCode = Math.floor(100000 + Math.random() * 900000).toString();
        
        const { db, ref, set, push, serverTimestamp } = window.firebase;
        const playersRef = ref(db, `rooms/${currentRoomCode}/players`);
        const newPlayerRef = push(playersRef);
        currentPlayerId = newPlayerRef.key;

        const roomData = {
            quizText: quizText,
            totalQuizTime: parseInt(elements.quizTimeSelect.value, 10),
            hostId: currentPlayerId,
            status: 'waiting',
            createdAt: serverTimestamp(),
            players: { [currentPlayerId]: { name: hostName, isHost: true, score: 0, answers: [] } },
        };
        
        try {
            await set(ref(db, `rooms/${currentRoomCode}`), roomData);
            localStorage.removeItem('multiplayerQuizText');
            enterLobby();
        } catch (error) { console.error("Firebase write failed: ", error); alert("Could not create the room."); }
    }

    function enterLobby() {
        showScreen('lobby');
        // The display logic is now handled by the router, but we can set up the content here.
        if (isHost) {
            elements.roomCodeText.textContent = currentRoomCode;
            elements.roomCodeDisplay.classList.remove('hidden');
            document.getElementById('start-game-btn').classList.remove('hidden');
            elements.waitingForHostText.classList.add('hidden');
        } else {
            document.getElementById('lobby-title').textContent = "You've Joined the Room!";
            elements.roomCodeDisplay.classList.add('hidden');
            document.getElementById('start-game-btn').classList.add('hidden');
            elements.waitingForHostText.classList.remove('hidden');
        }
        listenForRoomChanges();
    }
    
    function listenForRoomChanges() {
        const { db, ref, onValue, runTransaction } = window.firebase;
        const roomRef = ref(db, `rooms/${currentRoomCode}`);
        
        if(roomListener) roomListener(); // Unsubscribe old listener
        roomListener = onValue(roomRef, (snapshot) => {
            if (!snapshot.exists()) {
                if(clientTimer) clearInterval(clientTimer);
                const resultsScreenVisible = !elements.multiplayerResultsContainer.classList.contains('hidden');
                if (!resultsScreenVisible) {
                    alert("The host has left or the room was deleted.");
                    window.location.hash = ''; // Go home
                }
                return;
            }
            const roomData = snapshot.val();
            lastRoomData = roomData;
    
            // Update Lobby UI
            if (roomData.status === 'waiting') {
                const players = roomData.players || {};
                elements.lobbyPlayersList.innerHTML = '';
                Object.values(players).forEach(player => {
                    const li = document.createElement('li');
                    li.textContent = player.name;
                    if (player.isHost) li.innerHTML += ' 👑';
                    elements.lobbyPlayersList.appendChild(li);
                });
                elements.playerCountSpan.textContent = Object.keys(players).length;
                if (isHost) { document.getElementById('start-game-btn').disabled = Object.keys(players).length < 1; }
            }
    
            // Start the quiz for all players if status changes to 'playing'
            if (roomData.status === 'playing' && elements.multiplayerQuizPlayerContainer.classList.contains('hidden')) {
                 startMultiplayerQuiz(roomData);
            }
    
            const allPlayersFinished = Object.values(roomData.players || {}).every(p => p.isFinished);
    
            if (allPlayersFinished && roomData.status === 'playing') {
                if (isHost) {
                    runTransaction(ref(db, `rooms/${currentRoomCode}/status`), (currentStatus) => {
                        return currentStatus === 'playing' ? 'finished' : currentStatus;
                    });
                }
            }
            
            // FIX: Simplified this block to be more robust
            if (roomData.status === 'finished') {
                if (clientTimer) clearInterval(clientTimer);
                showFinalLeaderboardAndStartCountdown(roomData);
            }
        });
    }

    async function handleStartGame() {
        const { db, ref, runTransaction, serverTimestamp } = window.firebase;
        const roomRef = ref(db, `rooms/${currentRoomCode}`);
        try {
            await runTransaction(roomRef, (room) => {
                if (room && room.status === 'waiting') {
                    room.status = 'playing';
                    room.startTime = serverTimestamp();
                }
                return room;
            });
        } catch (error) {
            console.error("Failed to start game:", error);
            alert("Could not start the game. Please try again.");
        }
    }
    
    function startMultiplayerQuiz(roomData) {
        const quizText = roomData.quizText;
        quizData = parseMultiplayerQuizText(quizText);
        mpCurrentQuestionIndex = 0;
        mpSelectedOptionIndex = null;
        showScreen('mpPlayer');
        loadMultiplayerQuestion(mpCurrentQuestionIndex);
        startMultiplayerTimer(roomData.totalQuizTime, roomData.startTime);
    }

    function loadMultiplayerQuestion(index) {
        if (index < 0 || index >= quizData.length) return;
        mpCurrentQuestionIndex = index;
        mpSelectedOptionIndex = null;

        const question = quizData[index];
        const myAnswers = lastRoomData?.players[currentPlayerId]?.answers || [];
        const currentAnswer = myAnswers[index];

        elements.mpProgress.textContent = `Question ${index + 1} / ${quizData.length}`;
        elements.mpQuestionText.innerHTML = question.question.replace(/\n/g, '<br>');
        
        elements.mpOptionsContainer.innerHTML = '';
        question.options.forEach((opt, i) => {
            const optDiv = document.createElement('div');
            optDiv.className = 'option';
            optDiv.dataset.index = i;
            optDiv.innerHTML = `<span class="option-text">${opt}</span><div class="option-feedback"><span class="user-choice-emoji"></span><span class="feedback-icon"></span></div>`;
            elements.mpOptionsContainer.appendChild(optDiv);
        });
        
        elements.mpExplanationContainer.innerHTML = '';
        elements.mpExplanationContainer.classList.add('hidden');
        
        if(currentAnswer) {
            renderMultiplayerAnsweredState(currentAnswer.selected, currentAnswer.correct);
        } else {
             document.querySelectorAll('#mp-options-container .option').forEach(opt => opt.classList.remove('disabled', 'correct', 'incorrect'));
        }

        updateMultiplayerQuizActions();
        if (window.MathJax) MathJax.typesetPromise([elements.multiplayerQuizPlayerContainer]);
    }

    function renderMultiplayerAnsweredState(selectedIndex, isCorrect) {
        const question = quizData[mpCurrentQuestionIndex];
        const correctEmojis = ['😊', '👍', '✅', '🥳', '✨'];
        const incorrectEmojis = ['🤔', '😟', '❌', '🤦', '🤨'];

        document.querySelectorAll('#mp-options-container .option').forEach((opt, i) => {
            opt.classList.add('disabled');
            if (i === question.correctAnswerIndex) {
                opt.classList.add('correct');
                opt.querySelector('.feedback-icon').textContent = '✔️';
            }
            if (i === selectedIndex) {
                 const userChoiceEmoji = opt.querySelector('.user-choice-emoji');
                if (isCorrect) {
                    userChoiceEmoji.textContent = correctEmojis[mpCurrentQuestionIndex % correctEmojis.length];
                } else {
                    opt.classList.add('incorrect');
                    opt.querySelector('.feedback-icon').textContent = '❌';
                    userChoiceEmoji.textContent = incorrectEmojis[mpCurrentQuestionIndex % incorrectEmojis.length];
                }
                userChoiceEmoji.classList.add('visible');
            }
        });
        
        if (question.explanation) {
            elements.mpExplanationContainer.innerHTML = `<h4>Explanation</h4><p>${question.explanation}</p>`;
            elements.mpExplanationContainer.classList.remove('hidden');
            if (window.MathJax) {
                MathJax.typesetPromise([elements.mpExplanationContainer]);
            }
        }
    }

    function selectMultiplayerOption(index) {
        const option = document.querySelector(`#mp-options-container .option[data-index='${index}']`);
        if (option.classList.contains('disabled')) return;
        
        optionClickSound.play();
        mpSelectedOptionIndex = index;
        document.querySelectorAll('#mp-options-container .option').forEach((opt, i) => {
            opt.classList.toggle('selected', i === index);
        });
        updateMultiplayerQuizActions();
    }

    function checkMultiplayerAnswer() {
        if (mpSelectedOptionIndex === null) return;
        
        const question = quizData[mpCurrentQuestionIndex];
        const isCorrect = mpSelectedOptionIndex === question.correctAnswerIndex;

        if(isCorrect) {
            triggerCongratsAnimation();
            showMultiplayerFaceReaction(true);
        } else {
            showSadReaction();
            showMultiplayerFaceReaction(false);
        }
        
        renderMultiplayerAnsweredState(mpSelectedOptionIndex, isCorrect);
        saveMultiplayerAnswer(mpSelectedOptionIndex, isCorrect);
        updateMultiplayerQuizActions();
    }
    
    async function saveMultiplayerAnswer(selectedIndex, isCorrect) {
        const { db, ref, runTransaction } = window.firebase;
        const playerRef = ref(db, `rooms/${currentRoomCode}/players/${currentPlayerId}`);

        try {
            await runTransaction(playerRef, (player) => {
                if (player) {
                    if (!player.answers) player.answers = [];
                    if (!player.answers[mpCurrentQuestionIndex]) {
                       player.answers[mpCurrentQuestionIndex] = { selected: selectedIndex, correct: isCorrect };
                    }
                }
                return player;
            });
        } catch (error) {
            console.error("Failed to save answer:", error);
            alert("Could not save your answer. Please check your connection.");
        }
    }
    
    function updateMultiplayerQuizActions() {
        elements.mpQuizActions.innerHTML = '';
        const myAnswers = lastRoomData?.players[currentPlayerId]?.answers || [];
        const isAnswered = !!myAnswers[mpCurrentQuestionIndex];

        // Previous Button
        const prevBtn = document.createElement('button');
        prevBtn.id = 'mp-prev-btn';
        prevBtn.className = 'btn btn-secondary quiz-actions-top-left';
        prevBtn.textContent = '⬅️ Previous';
        prevBtn.disabled = mpCurrentQuestionIndex === 0;
        elements.mpQuizActions.appendChild(prevBtn);

        if (isAnswered) {
            const nextBtn = document.createElement('button');
            nextBtn.id = 'mp-next-btn';
            nextBtn.className = 'btn quiz-actions-bottom-left';
            nextBtn.textContent = 'Next ➡️';
            nextBtn.disabled = mpCurrentQuestionIndex >= quizData.length - 1;
            elements.mpQuizActions.appendChild(nextBtn);

        } else {
            const checkBtn = document.createElement('button');
            checkBtn.id = 'mp-check-answer-btn';
            checkBtn.className = 'btn btn-success quiz-actions-top-right';
            checkBtn.textContent = 'Check Answer ✅';
            checkBtn.disabled = mpSelectedOptionIndex === null;
            elements.mpQuizActions.appendChild(checkBtn);
            
            const skipBtn = document.createElement('button');
            skipBtn.id = 'mp-skip-btn';
            skipBtn.className = 'btn quiz-actions-bottom-left';
            skipBtn.style.backgroundColor = '#ffc107';
            skipBtn.style.color = '#333';
            skipBtn.textContent = 'Skip ➡️';
            skipBtn.addEventListener('click', () => {
                 if (mpCurrentQuestionIndex < quizData.length - 1) {
                    loadMultiplayerQuestion(mpCurrentQuestionIndex + 1);
                 }
            });
            elements.mpQuizActions.appendChild(skipBtn);
        }

        const submitBtn = document.createElement('button');
        submitBtn.className = 'btn btn-danger quiz-actions-bottom-right';
        submitBtn.textContent = 'Submit';
        submitBtn.addEventListener('click', () => submitMultiplayerQuiz(false));
        elements.mpQuizActions.appendChild(submitBtn);
    }
    
    function showMultiplayerFaceReaction(isCorrect) {
        const faceToShow = isCorrect ? elements.mpFaceHappy : elements.mpFaceAngry;
        const faceToHide = isCorrect ? elements.mpFaceAngry : elements.mpFaceHappy;
        
        faceToHide.classList.remove('visible');
        faceToShow.classList.add('visible');
        
        setTimeout(() => {
            faceToShow.classList.remove('visible');
        }, 2000);
    }

    function startMultiplayerTimer(totalSeconds, startTime) {
        if (clientTimer) clearInterval(clientTimer);
        
        const updateTimer = () => {
            const serverTimeOffset = 0; 
            const now = Date.now() + serverTimeOffset;
            const elapsedSeconds = Math.floor((now - startTime) / 1000);
            const remainingSeconds = totalSeconds - elapsedSeconds;

            if (remainingSeconds <= 0) {
                elements.mpTimer.textContent = "00:00";
                clearInterval(clientTimer);
                const myData = lastRoomData?.players?.[currentPlayerId];
                if (myData && !myData.isFinished) {
                    submitMultiplayerQuiz(true);
                }
                return;
            }
            const minutes = Math.floor(remainingSeconds / 60);
            const seconds = remainingSeconds % 60;
            elements.mpTimer.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        };

        updateTimer();
        clientTimer = setInterval(updateTimer, 1000);
    }
    
    async function submitMultiplayerQuiz(isAutoSubmit = false) {
        if (!isAutoSubmit) {
            if (!confirm("Are you sure you want to submit? You cannot change your answers after submitting.")) return;
        }
    
        if (clientTimer) clearInterval(clientTimer);
        elements.waitingForSubmissionOverlay.classList.remove('hidden');
    
        const { db, ref, set } = window.firebase;
        const finishedRef = ref(db, `rooms/${currentRoomCode}/players/${currentPlayerId}/isFinished`);
    
        try {
            await set(finishedRef, true);
            showPersonalMultiplayerResults();
        } catch (error) {
            console.error("Failed to submit:", error);
            alert("There was an error submitting. Please check your connection.");
        } finally {
            elements.waitingForSubmissionOverlay.classList.add('hidden');
        }
    }
    
    function showPersonalMultiplayerResults() {
        showScreen('mpResults');
        elements.multiplayerResultsContainer.querySelector('#leaderboard-section').classList.add('hidden');
        elements.multiplayerResultsContainer.querySelector('#waiting-for-leaderboard-text').classList.remove('hidden');
        elements.multiplayerResultsContainer.querySelector('#room-deletion-countdown').classList.add('hidden');
        elements.multiplayerResultsContainer.querySelector('#mp-results-title').textContent = '🏆 Assessment Submitted! 🏆';
    
        const personalStatsContainer = elements.multiplayerPersonalSummary.querySelector('.summary-grid');
        const myData = lastRoomData.players[currentPlayerId];
        if (myData) {
            const myAnswers = myData.answers || [];
            let correctCount = 0;
            myAnswers.forEach((ans, index) => {
                if (ans && quizData[index] && ans.correct) {
                    correctCount++;
                }
            });
            const finalScore = correctCount * 10;
            const totalAnswered = myAnswers.filter(a => a !== null && a !== undefined).length;
            const incorrectCount = totalAnswered - correctCount;
            const skippedCount = quizData.length - totalAnswered;
            const percentage = totalAnswered > 0 ? (correctCount / totalAnswered) * 100 : 0;
            
            personalStatsContainer.innerHTML = `
                <div class="summary-item">
                    <span class="summary-label">Correct</span>
                    <span class="summary-value" style="color: var(--correct-color);">${correctCount}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Incorrect</span>
                    <span class="summary-value" style="color: var(--incorrect-color);">${incorrectCount}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Skipped</span>
                    <span class="summary-value" style="color: var(--skipped-color);">${skippedCount}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Score</span>
                    <span class="summary-value remark">${finalScore} (${percentage.toFixed(0)}%)</span>
                </div>
            `;
        }
    }
    
    function showFinalLeaderboardAndStartCountdown(roomData) {
        // FIX: Add a guard to prevent this function from running multiple times and creating multiple timers.
        if (countdownTimerId) return;

        if (elements.multiplayerResultsContainer.classList.contains('hidden')) {
            showPersonalMultiplayerResults();
        }
    
        const leaderboardSection = elements.multiplayerResultsContainer.querySelector('#leaderboard-section');
        const waitingText = elements.multiplayerResultsContainer.querySelector('#waiting-for-leaderboard-text');
        const countdownText = elements.multiplayerResultsContainer.querySelector('#room-deletion-countdown');
        const title = elements.multiplayerResultsContainer.querySelector('#mp-results-title');
    
        title.textContent = '🏆 Final Results 🏆';
        waitingText.classList.add('hidden');
        leaderboardSection.classList.remove('hidden');
        countdownText.classList.remove('hidden');
    
        const leaderboard = document.getElementById('leaderboard');
        leaderboard.innerHTML = '';
        
        const players = Object.values(roomData.players || {});
        players.forEach(player => {
            const answers = player.answers || [];
            let correctCount = 0;
            answers.forEach((ans, index) => {
                if (ans && ans.correct) {
                    correctCount++;
                }
            });
            player.finalScore = correctCount * 10;
        });
    
        players.sort((a, b) => (b.finalScore || 0) - (a.finalScore || 0));
        
        players.forEach(player => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${player.name} ${player.isHost ? '👑' : ''}</span> <strong>${player.finalScore || 0} Points</strong>`;
            leaderboard.appendChild(li);
        });
    
        let countdown = 8;
        countdownText.textContent = `Room will be deleted and you will return to the home screen in ${countdown} seconds...`;
        
        // FIX: Assign the interval to the guard variable.
        countdownTimerId = setInterval(() => {
            countdown--;
            countdownText.textContent = `Room will be deleted and you will return to the home screen in ${countdown} seconds...`;
            if (countdown <= 0) {
                clearInterval(countdownTimerId);
                countdownTimerId = null; // FIX: Reset the guard variable.
                handleHardReset();
            }
        }, 1000);
    }

    function parseMultiplayerQuizText(text) {
        return transformParsedData_Legacy(parseQuizText_Legacy(text));
    }


    // --- OCR & Image/PDF Processing (UPGRADED) ---
    async function getOcrWorker(lang, statusEl) {
        if (ocrWorker && currentOcrLang === lang) {
            return ocrWorker;
        }

        if (ocrWorker) {
            statusEl.textContent = 'Switching OCR language model...';
            await ocrWorker.terminate();
            ocrWorker = null;
            currentOcrLang = null;
        }

        const langName = { 'eng': 'English', 'hin': 'Hindi', 'eng+hin': 'English+Hindi' }[lang];
        statusEl.textContent = `Initializing ${langName} OCR Engine (this happens once per language)...`;
        try {
            ocrWorker = await Tesseract.createWorker(lang, 1, {
                logger: m => {
                    if (m.status === 'recognizing text') {
                        const progress = (m.progress * 100).toFixed(0);
                        statusEl.textContent = `Recognizing Text... ${progress}%`;
                    } else if (m.status === 'loading language model') {
                         statusEl.textContent = `Loading ${langName} Model... (may take a moment on first load)`;
                    }
                }
            });
            currentOcrLang = lang;
            statusEl.textContent = `${langName} OCR Engine is ready.`;
            return ocrWorker;
        } catch (error) {
            console.error("Failed to initialize OCR worker:", error);
            statusEl.textContent = `Error: Could not initialize ${langName} OCR engine.`;
            ocrWorker = null;
            currentOcrLang = null;
            return null;
        }
    }
    
    async function processAndExtractAllImages(files) {
        if (files.length === 0) {
            hideLoading();
            return;
        }

        showLoading("Preparing OCR Engine...");
        const worker = await getOcrWorker(selectedImageOcrLang, elements.ocrStatus);

        if (!worker) {
            hideLoading();
            alert("OCR Engine could not be started. Please check your internet connection and try again.");
            return;
        }

        imageFiles = files.map(file => ({
            originalFile: file,
            id: `img_${Date.now()}_${Math.random()}`,
            croppedFile: null,
            previewUrl: URL.createObjectURL(file)
        }));
        updateImagePreviews();

        showLoading("Processing images...");
        let allExtractedText = '';

        try {
            for (let i = 0; i < imageFiles.length; i++) {
                const imgState = imageFiles[i];
                const fileToProcess = imgState.croppedFile || imgState.originalFile;

                let bestText = '';
                let bestConfidence = -1;

                const imageElement = new Image();
                const imageLoadPromise = new Promise(resolve => imageElement.onload = resolve);
                imageElement.src = URL.createObjectURL(fileToProcess);
                await imageLoadPromise;

                for (const angle of [0, 90, 180, 270]) {
                    elements.ocrStatus.textContent = `Analyzing image ${i + 1}/${imageFiles.length} (orientation: ${angle}°)...`;

                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    if (angle === 90 || angle === 270) {
                        canvas.width = imageElement.height;
                        canvas.height = imageElement.width;
                    } else {
                        canvas.width = imageElement.width;
                        canvas.height = imageElement.height;
                    }

                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    ctx.rotate(angle * Math.PI / 180);
                    ctx.drawImage(imageElement, -imageElement.width / 2, -imageElement.height / 2);

                    const isHandwriting = elements.handwritingToggle.checked;
                    const psm = isHandwriting ? Tesseract.PSM.SINGLE_BLOCK : Tesseract.PSM.AUTO;
                    await worker.setParameters({ tessedit_pageseg_mode: psm });

                    const { data } = await worker.recognize(canvas);

                    if (data.confidence > bestConfidence) {
                        bestConfidence = data.confidence;
                        bestText = data.text;
                    }

                    if (bestConfidence > 95) break; 
                }

                URL.revokeObjectURL(imageElement.src);
                allExtractedText += bestText + '\n\n';
            }

            elements.sourceTextImage.value = allExtractedText;
            if (allExtractedText.trim()) {
                elements.imageQuizDefinitionArea.classList.remove('hidden');
                elements.ocrStatus.textContent = `✅ Text extracted successfully from ${imageFiles.length} image(s).`;
            } else {
                elements.ocrStatus.textContent = `🤔 Could not extract any text from the image(s). Try a different image.`;
            }
        } catch (err) {
            console.error("Error during image processing:", err);
            elements.ocrStatus.textContent = '❌ Error during image processing. Please try again.';
        } finally {
            hideLoading();
        }
    }

    async function runPdfExtraction() {
        if (!pdfFile) { alert("Please select a PDF file first."); return; }
        
        const useOcr = elements.pdfForceOcrCheckbox.checked;
        let worker;
        if (useOcr) {
            showLoading("Preparing OCR Engine...");
            worker = await getOcrWorker(selectedPdfOcrLang, elements.pdfStatus);
            if (!worker) {
                hideLoading();
                alert("OCR Engine could not be started. Please check your internet connection and try again.");
                return;
            }
        }

        showLoading("Extracting text from PDF...");
        elements.pdfStatus.textContent = 'Starting extraction... Please wait.';
        try {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const typedarray = new Uint8Array(e.target.result);
                    const pdfDoc = await pdfjsLib.getDocument(typedarray).promise;
                    const pageOption = document.querySelector('input[name="pdf-page-option"]:checked').value;
                    let startPage = 1, endPage = pdfDoc.numPages;
                    if (pageOption === 'range') {
                        startPage = parseInt(document.getElementById('pdf-page-from').value, 10) || 1;
                        endPage = parseInt(document.getElementById('pdf-page-to').value, 10) || pdfDoc.numPages;
                    }
                    elements.pdfStatus.textContent = `Processing pages ${startPage} to ${endPage}...`;
                    const text = useOcr 
                        ? await extractPdfTextWithOcr(pdfDoc, startPage, endPage, worker) 
                        : await extractPdfTextNative(pdfDoc, startPage, endPage);
                    elements.sourceTextPdf.value = text;
                    elements.pdfQuizDefinitionArea.classList.remove('hidden');
                    elements.pdfStatus.textContent = '✅ Text extracted successfully!';
                } catch (err) {
                    console.error("Error during PDF processing:", err);
                    elements.pdfStatus.textContent = '❌ Error: Could not process PDF. It may be corrupt or protected.';
                } finally {
                    hideLoading();
                }
            };
            reader.readAsArrayBuffer(pdfFile);
        } catch (error) {
            console.error("FileReader error:", error);
            elements.pdfStatus.textContent = '❌ Error: Could not read the selected file.';
            hideLoading();
        }
    }

    // --- All other functions ---
    function showCreationSelector() { elements.manualGeneratorContainer.querySelectorAll('.hidden').forEach(el => el.classList.remove('hidden')); ['topic', 'text', 'image', 'pdf'].forEach(w => elements[w+'GeneratorWorkflow'].classList.add('hidden')); elements.creationMethodSelector.classList.remove('hidden'); elements.imageFormatGuide.classList.add('hidden'); }
    
    function showWorkflow(workflowName) {
        elements.creationMethodSelector.classList.add('hidden');
        document.querySelector('.back-to-mode-selection-btn').classList.add('hidden');
        ['topic', 'text', 'image', 'pdf'].forEach(w => {
            if (elements[w + 'GeneratorWorkflow']) {
                elements[w + 'GeneratorWorkflow'].classList.add('hidden');
            }
        });

        const workflowElement = elements[workflowName + 'GeneratorWorkflow'];
        if (workflowElement) {
            workflowElement.classList.remove('hidden');

            const examButtonsContainer = workflowElement.querySelector('.exam-buttons-container');
            const otherExamInput = workflowElement.querySelector('.prompt-exam-other');

            if (examButtonsContainer) {
                examButtonsContainer.querySelectorAll('.exam-btn').forEach(btn => btn.classList.remove('active'));
                const btnToActivate = examButtonsContainer.querySelector(`.exam-btn[data-exam-name="${selectedExam}"]`);
                if (btnToActivate) {
                    btnToActivate.classList.add('active');
                }
            }

            if (otherExamInput) {
                otherExamInput.classList.toggle('hidden', selectedExam === 'Other');
            }

            if (workflowName === 'pdf') {
                const rangeRadio = document.getElementById('pdf-page-option-range');
                elements.pdfPageRangeSelector.classList.toggle('hidden', !rangeRadio.checked);
            }
        }
    }

    function populateSharedElements() {
        const formatSelects = document.querySelectorAll('select[id^="question-format-select"]');
        formatSelects.forEach(select => {
            if (!select) return;
            select.innerHTML = '';
            Object.keys(QUESTION_FORMATS).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = QUESTION_FORMATS[key].name;
                select.appendChild(option);
            });
            select.value = 'mcq';
        });
    }

    async function saveQuizState() { if (quizData.length === 0 || elements.quizPlayerContainer.classList.contains('hidden')) { await dbHelper.set(QUIZ_STATE_KEY, null); return; } const state = { originalQuizData, userAnswers, currentQuestionIndex, bookmarkedQuestions: Array.from(bookmarkedQuestions), quizStartTime: quizStartTime.toISOString(), quizMetaData: quizMetaData }; await dbHelper.set(QUIZ_STATE_KEY, state); }
    async function loadQuizState() { const state = await dbHelper.get(QUIZ_STATE_KEY); if (!state) return false; try { originalQuizData = state.originalQuizData; quizData = JSON.parse(JSON.stringify(originalQuizData)); userAnswers = state.userAnswers; currentQuestionIndex = state.currentQuestionIndex; bookmarkedQuestions = new Set(state.bookmarkedQuestions); quizStartTime = new Date(state.quizStartTime); quizMetaData = state.quizMetaData || {}; _displayScreen('player'); loadQuestion(currentQuestionIndex); showPasteNotification('✅ Your active assessment has been restored.'); return true; } catch (e) { console.error("Failed to load state:", e); await dbHelper.set(QUIZ_STATE_KEY, null); return false; } }
    async function handleClipboardPermission() { if (!navigator.clipboard || !navigator.permissions) return; try { const permissionStatus = await navigator.permissions.query({ name: "clipboard-read" }); if (permissionStatus.state === "granted") { await tryAutoPasteOnReturn(); } else if (permissionStatus.state === "prompt") { elements.clipboardPermissionModalOverlay.classList.remove('hidden'); } } catch (e) { console.warn("Clipboard permission API not supported or failed.", e); } }
    async function requestClipboardAndPaste() { elements.clipboardPermissionModalOverlay.classList.add('hidden'); await tryAutoPasteOnReturn(true); }
    async function tryAutoPasteOnReturn(forcePrompt = false) { if (!forcePrompt && document.hidden) return; try { const text = await navigator.clipboard.readText(); if (text && text.trim() && (text.includes("Question:") || text.includes("Correct Answer:"))) { elements.quizDataInput.value = text; showPasteNotification('✨ Auto-pasted! Processing...'); handlePasteAndParse(); } else if (forcePrompt) { showPasteNotification("📋 Your clipboard is empty or doesn't look like a set of questions."); } } catch (err) { if (err.name !== 'NotAllowedError') console.error("Clipboard read failed: ", err); if (forcePrompt) showPasteNotification("Permission denied. You can paste manually."); } }
    async function tryAutoPasteOnFocus() { if(elements.quizDataInput.value.trim() !== '') return; try { const permissionStatus = await navigator.permissions.query({ name: "clipboard-read" }); if (permissionStatus.state === "granted") await tryAutoPasteOnReturn(false); } catch (e) { /* Fail silently */ } }
    async function handleVisibilityChange() { if (!document.hidden && window.location.hash === '#paste') await handleClipboardPermission(); }
    function showFlowchartGuide(guideId) { const guideContent = GUIDE_DATA[guideId]; if (guideContent) { elements.flowchartModalTitle.textContent = guideContent.title; elements.flowchartModalContent.innerHTML = guideContent.content; elements.flowchartModalOverlay.classList.remove('hidden'); } else { console.error('No guide found for ID:', guideId); } }
    
    function generatePrompt(source, sourceType) {
        const { numQuestions, topic, subject, difficulty, language, formatKey, exam, sourceText } = source;

        if (sourceType === 'topic' && !topic) { alert('Please enter a Primary Topic.'); return null; }
        if ((sourceType !== 'topic' && !sourceText) || !numQuestions) { alert('Please ensure you have provided source material and the number of questions.'); return null; }
        if (!exam) { alert("Please select a target exam before generating questions."); return null; }
        
        let sampleFormat = "";
        switch (formatKey) {
            case 'mcq': sampleFormat = MCQ_EXAMPLE; break;
            case 'statement': sampleFormat = STATEMENT_EXAMPLE; break;
            case 'assertion-reason': sampleFormat = AR_EXAMPLE; break;
            case 'math-physics': sampleFormat = MATH_EXAMPLE; break;
            case 'true-false': sampleFormat = TF_EXAMPLE; break;
            case 'fill-blank': sampleFormat = FILL_BLANK_EXAMPLE; break;
            default: sampleFormat = LEGACY_FORMAT_TEXT; break;
        }

        let prompt = `You are an expert at generating high-quality assessment questions in plain text format. Your responses must be very fast and precise.

CRITICAL INSTRUCTIONS (MUST be followed):
1.  **Output Format:** Provide the entire response as a single block of plain text. DO NOT use Markdown, JSON, code blocks, or any other formatting.
2.  **Strict Format Adherence:** You MUST generate questions that EXACTLY match the requested "Question Format" parameter below. For example, if asked for "Multiple Choice (MCQ)", you MUST generate ONLY MCQs.
3.  **Question Structure:** STRICTLY follow the sample format provided below for every single question.
4.  **Statement Formatting:** For Statement-Based questions, individual statements MUST be preceded by an asterisk (*) and a space. DO NOT number the statements (e.g., use "* Statement text" NOT "1. Statement text"). The provided sample for Statement-Based questions demonstrates this correct format.
5.  **Correct Answer Line:** The 'Correct Answer:' line MUST contain ONLY the letter of the correct option (e.g., "Correct Answer: c"). DO NOT include the text of the answer.
6.  **Completeness:** Each question MUST have a question, all options, a single correct answer letter, and a detailed explanation.
7.  **Math/Physics Symbols:** Use valid LaTeX for all formulas. Enclose all inline math with \\( ... \\) delimiters (e.g., \\(x^2\\)) and all display math with \\[ ... \\]. DO NOT use $ or $$.
8.  **Terminology:** Use the term "questions" or "assessment". DO NOT use the word "quiz".

--- ASSESSMENT PARAMETERS ---
*   **Number of Questions:** ${numQuestions}
*   **Primary Topic:** ${topic || (sourceType === 'text' ? 'Multiple Topics' : 'Not specified')}
*   **Subject:** ${subject || (sourceType === 'text' ? 'Multiple Subjects' : 'Not specified')}
*   **Difficulty Level:** ${difficulty}
*   **Language:** ${language}
*   **Question Format:** ${QUESTION_FORMATS[formatKey].name}
*   **Target Exam:** ${exam}
*   **Target Exam Instructions:** Generate questions based on analysis of previous year questions that are relevant, and match the syllabus, question pattern, and difficulty level of the '${exam}' exam.

--- SOURCE MATERIAL INSTRUCTIONS ---
`;

        if (sourceType === 'pdf') {
            prompt += `*   **Knowledge Base:** You MUST generate questions based primarily on the "Source Material" provided below. Use the provided text as the core context and factual basis for the questions.
    *   For 'Easy' difficulty, generate questions directly from the lines and facts present.
    *   For 'Medium', 'Hard', and 'Expert' difficulties, increase the conceptual depth of the questions, but they MUST remain grounded in the information provided in the source material.
    *   You may use your external knowledge ONLY to properly frame the questions, ensure they are conceptually sound, and match the difficulty and style of the specified target exam. DO NOT introduce facts or topics completely unrelated to the source material.`;
        } else { // For topic, text, image
            prompt += `*   **Knowledge Base:** Use your own internal knowledge to create the questions. The "Primary Topic", "Subject", and "Source Material" (if provided) should be used as a guide and context. Your primary goal is to create new, high-quality questions that accurately match the standard, syllabus, and difficulty level of the specified target exam.`;
        }

        prompt += `

--- REQUIRED QUESTION SAMPLE FORMAT (Follow Strictly) ---
${sampleFormat}
-------------------------------------------------------
`;

        if (sourceText) {
            prompt += `
Now, generate the questions based on all the instructions above and the following source material/details:
--- START OF SOURCE MATERIAL ---
${sourceText}
--- END OF SOURCE MATERIAL ---`;
        } else {
             prompt += `
Now, generate the questions based on all the instructions above.`;
        }

        promptForGemini = prompt;
        elements.geminiInstructionsModalOverlay.classList.remove('hidden');
    }
    
    // *** MODIFICATION ***: Removed the unreliable 'promptGenerated' flag.
    async function executePostPromptActions(prompt) { clearFormState(); try { await copyTextToClipboard(prompt); } catch {} sessionStorage.setItem('gameMode', gameMode); showScreen('paste'); openAiWithFallback(); }
    function openAiWithFallback() { const aiWindow = window.open('https://gemini.google.com', '_blank'); if (!aiWindow || aiWindow.closed || typeof aiWindow.closed === 'undefined') { showPasteNotification('⚠️ Popup blocked! Click the link to open manually.'); elements.aiLinkFallback.classList.remove('hidden'); } else { elements.aiLinkFallback.classList.add('hidden'); } }
    
    function generateTopicPrompt() {
        quizMetaData = { topic: document.getElementById('prompt-topic').value.trim(), subject: document.getElementById('prompt-subject-topic').value.trim() };
        const otherExamInput = elements.topicGeneratorWorkflow.querySelector('.prompt-exam-other');
        const finalExam = (selectedExam === 'Other') ? otherExamInput.value.trim() : selectedExam;
        const source = { numQuestions: document.getElementById('prompt-num-questions-topic').value || 5, topic: quizMetaData.topic, subject: quizMetaData.subject, difficulty: document.getElementById('prompt-difficulty-topic').value, language: document.getElementById('prompt-language-topic').value, formatKey: document.getElementById('question-format-select-topic').value, exam: finalExam };
        generatePrompt(source, 'topic');
    }

    function generateTextPrompt() {
        const rows = document.querySelectorAll('.prompt-builder-row');
        let totalQuestions = 0;
        let sourceText = "Generate a mixed mock test based on the following sections:\n\n";

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const numVal = row.querySelector('[data-type="numQuestions"]').value;
            const subject = row.querySelector('[data-type="subject"]').value.trim();
            const topic = row.querySelector('[data-type="topic"]').value.trim();
            const standard = row.querySelector('[data-type="standard"]').value.trim();
            const book = row.querySelector('[data-type="book"]').value.trim();

            if (!numVal || !subject || !topic) {
                alert(`Please fill out at least the number of questions, subject, and topic for Section ${i + 1}.`);
                return;
            }
            
            const num = parseInt(numVal, 10);
            totalQuestions += num;

            sourceText += `Section ${i + 1}:\n`;
            sourceText += `- Subject: ${subject}\n`;
            sourceText += `- Topic: ${topic}\n`;
            sourceText += `- Number of Questions: ${num}\n`;
            if (standard) sourceText += `- Class/Standard: ${standard}\n`;
            if (book) sourceText += `- Reference Book: ${book}\n\n`;
        }

        if (totalQuestions === 0) {
            alert("Please add at least one section with a valid number of questions.");
            return;
        }

        quizMetaData = { topic: 'Custom Mock Test', subject: 'Mixed' };
        const otherExamInput = elements.textGeneratorWorkflow.querySelector('.prompt-exam-other');
        const finalExam = (selectedExam === 'Other') ? otherExamInput.value.trim() : selectedExam;

        const source = { 
            numQuestions: totalQuestions, 
            topic: '', 
            subject: '', 
            difficulty: document.getElementById('prompt-difficulty-text').value, 
            language: document.getElementById('prompt-language-text').value, 
            formatKey: document.getElementById('question-format-select-text').value, 
            exam: finalExam,
            sourceText: sourceText.trim()
        };
        generatePrompt(source, 'text');
    }

    function generateImagePrompt() {
        quizMetaData = { topic: document.getElementById('prompt-topic-image').value.trim(), subject: document.getElementById('prompt-subject-image').value.trim() };
        const otherExamInput = elements.imageGeneratorWorkflow.querySelector('.prompt-exam-other');
        const finalExam = (selectedExam === 'Other') ? otherExamInput.value.trim() : selectedExam;
        const source = { numQuestions: document.getElementById('prompt-num-questions-image').value, topic: quizMetaData.topic, subject: quizMetaData.subject, difficulty: document.getElementById('prompt-difficulty-image').value, language: document.getElementById('prompt-language-image').value, formatKey: document.getElementById('question-format-select-image').value, exam: finalExam, sourceText: elements.sourceTextImage.value.trim() };
        generatePrompt(source, 'image');
    }

    function generatePdfPrompt() {
        quizMetaData = { topic: document.getElementById('prompt-topic-pdf').value.trim(), subject: document.getElementById('prompt-subject-pdf').value.trim() };
        const otherExamInput = elements.pdfGeneratorWorkflow.querySelector('.prompt-exam-other');
        const finalExam = (selectedExam === 'Other') ? otherExamInput.value.trim() : selectedExam;
        const source = { numQuestions: document.getElementById('prompt-num-questions-pdf').value, topic: quizMetaData.topic, subject: quizMetaData.subject, difficulty: document.getElementById('prompt-difficulty-pdf').value, language: document.getElementById('prompt-language-pdf').value, formatKey: document.getElementById('question-format-select-pdf').value, exam: finalExam, sourceText: elements.sourceTextPdf.value.trim() };
        generatePrompt(source, 'pdf');
    }
    
    function setupAllExamSelectors() { document.querySelectorAll('.exam-buttons-container').forEach(container => { const inputField = container.nextElementSibling; populateExamButtons(container, inputField); }); }
    
    function populateExamButtons(container, inputField) {
        const exams = ["JEE", "NEET", "BANK", "RRB", "NEET PG", "CTET", "State PSC", "Police", "UPSSSC", "CUET", "UPSC", "SSC", "CBSE", "Other"];
        container.innerHTML = exams.map(exam => `<button class="btn exam-btn" data-exam-name="${exam}">${exam}</button>`).join('');

        container.addEventListener('click', e => {
            if (e.target.classList.contains('exam-btn')) {
                const clickedBtn = e.target;
                const examName = clickedBtn.dataset.examName;
                container.querySelectorAll('.exam-btn').forEach(btn => btn.classList.remove('active'));
                clickedBtn.classList.add('active');
                selectedExam = examName;
                if (inputField) {
                    inputField.classList.toggle('hidden', examName !== 'Other');
                    if (examName === 'Other') inputField.focus();
                }
                saveFormState(); 
            }
        });

        if (inputField) {
            inputField.addEventListener('input', () => {
                if (selectedExam === 'Other') saveFormState();
            });
        }
    }
    
    function handlePdfSelection(event) { 
        pdfFile = event.target.files[0]; 
        if (pdfFile) { 
            elements.pdfFileName.textContent = pdfFile.name; 
            elements.pdfOptionsContainer.classList.remove('hidden'); 
            elements.pdfQuizDefinitionArea.classList.add('hidden'); 
            elements.pdfStatus.textContent = '';
            document.getElementById('pdf-page-range-selector').classList.remove('hidden');
        } 
    }
    
    async function extractPdfTextWithOcr(pdfDoc, start, end, worker) {
        let fullText = '';
        const scale = 2.5;

        for (let i = start; i <= Math.min(end, pdfDoc.numPages); i++) {
            elements.pdfStatus.textContent = `Performing OCR on page ${i} of ${end}... (this may take a moment)`;
            const page = await pdfDoc.getPage(i);
            const viewport = page.getViewport({ scale: scale });
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };

            await page.render(renderContext).promise;
            
            const { data: { text } } = await worker.recognize(canvas);
            fullText += text + '\n\n';

            canvas.width = 0;
            canvas.height = 0;
        }
        return fullText;
    }

    async function extractPdfTextNative(pdf, start, end) { let fullText = ''; for (let i = start; i <= end; i++) { elements.pdfStatus.textContent = `Reading text from page ${i}...`; const page = await pdf.getPage(i); const textContent = await page.getTextContent(); fullText += textContent.items.map(item => item.str).join(' ') + '\n\n'; } return fullText; }
    async function handleImageSelection(event) { const newFiles = Array.from(event.target.files); if (newFiles.length === 0) return; imageFiles = []; elements.sourceTextImage.value = ''; elements.imageQuizDefinitionArea.classList.add('hidden'); elements.ocrStatus.textContent = ''; updateImagePreviews(); processAndExtractAllImages(newFiles); event.target.value = ''; }
    function updateImagePreviews() { elements.imagePreviewContainer.innerHTML = ''; imageFiles.forEach(imgFile => { const fileForPreview = imgFile.croppedFile || imgFile.originalFile; if(imgFile.previewUrl) URL.revokeObjectURL(imgFile.previewUrl); imgFile.previewUrl = URL.createObjectURL(fileForPreview); const wrapper = document.createElement('div'); wrapper.className = 'img-preview-wrapper'; wrapper.innerHTML = `<div class="img-container"><img src="${imgFile.previewUrl}" alt="Image preview"></div><div class="img-preview-actions"><button class="img-preview-btn crop-btn" data-id="${imgFile.id}" title="Crop">✂️</button><button class="img-preview-btn remove-btn" data-id="${imgFile.id}" title="Remove">🗑️</button></div>`; elements.imagePreviewContainer.appendChild(wrapper); }); }
    function removeImage(idToRemove) { const indexToRemove = imageFiles.findIndex(f => f.id === idToRemove); if (indexToRemove > -1) { if (imageFiles[indexToRemove].previewUrl) URL.revokeObjectURL(imageFiles[indexToRemove].previewUrl); imageFiles.splice(indexToRemove, 1); updateImagePreviews(); const remainingFiles = imageFiles.map(f => f.croppedFile || f.originalFile); showLoading("Re-extracting text from cropped image..."); processAndExtractAllImages(remainingFiles); } }
    function openCropModal(imageId) { const imgFile = imageFiles.find(f => f.id === imageId); if (!imgFile) return; currentEditingImageId = imageId; const fileToCrop = imgFile.croppedFile || imgFile.originalFile; elements.imageToCrop.src = URL.createObjectURL(fileToCrop); elements.cropModalOverlay.classList.remove('hidden'); elements.imageToCrop.onload = () => { if (cropper) cropper.destroy(); cropper = new Cropper(elements.imageToCrop, { aspectRatio: NaN, viewMode: 1, background: false, autoCropArea: 0.9, }); }; }
    function closeCropModal() { if(cropper) cropper.destroy(); cropper = null; currentEditingImageId = null; elements.cropModalOverlay.classList.add('hidden'); }
    function saveCrop() { if (!cropper || !currentEditingImageId) return; cropper.getCroppedCanvas({ minWidth: 256, maxWidth: 4096, imageSmoothingQuality: 'high' }).toBlob((blob) => { const imgFile = imageFiles.find(f => f.id === currentEditingImageId); if(imgFile) { imgFile.croppedFile = blob; updateImagePreviews(); const currentFiles = imageFiles.map(f => f.croppedFile || f.originalFile); showLoading("Re-extracting text from cropped image..."); processAndExtractAllImages(currentFiles); } closeCropModal(); }); }
    function validateParsedData(questions) { for (let i = 0; i < questions.length; i++) { const q = questions[i]; const qNum = i + 1; if (!q.question || q.question.trim() === '') return { isValid: false, error: `Question ${qNum} is missing its main text.` }; if (!q.options || q.options.length < 2) return { isValid: false, error: `Question ${qNum} has fewer than two options.` }; if (typeof q.correctAnswerIndex !== 'number' || q.correctAnswerIndex < 0 || q.correctAnswerIndex >= q.options.length) return { isValid: false, error: `Could not find a valid correct answer for Question ${qNum}. Check the 'Correct Answer' line.` }; if (!q.explanation || q.explanation.trim() === '') return { isValid: false, error: `Question ${qNum} is missing its explanation.` }; } return { isValid: true }; }
    function transformParsedData_Legacy(parsedQuestions) { return parsedQuestions.map(q => { if (!q) return null; const cleanedOptions = q.options.map(opt => opt.replace(/^[a-zA-Z]\)\s*/, '').trim()); const correctAnswerIndex = q.options.findIndex(opt => opt.trim().toLowerCase().startsWith(q.answer.toLowerCase() + ')')); if (correctAnswerIndex === -1) { console.error("Could not find correct answer for question:", q); return null; } let finalQuestionText = q.question; let statements = []; if (q.type === 'Statement' || q.question.includes('*')) { const parts = q.question.split(/Which of the above statements are correct\?/i); if (parts.length > 1) { finalQuestionText = `Which of the above statements are correct?`; statements = parts[0].split('*').map(s => s.trim()).filter(s => s); } } else if (q.type === 'Assertion-Reason') { finalQuestionText = q.question.replace(/<br>/g, '\n'); } return { question: finalQuestionText, options: cleanedOptions, correctAnswerIndex: correctAnswerIndex, explanation: q.explanation, statements: statements, image: null, }; }).filter(Boolean); }
    function parseQuizText_Legacy(text) { if (!text || !text.trim()) return []; const questionBlocks = text.trim().split(/\n(?=\d+\.\s)/); return questionBlocks.map(block => { const fullBlock = block.trim(); const headerMatch = fullBlock.match(/^\d+\.\s(.*?Questions)/); if (!headerMatch) return null; let data = { type: 'Unknown', question: '', options: [], answer: '', explanation: '' }; const headerText = headerMatch[1]; if (headerText.includes('Assertion-Reason')) data.type = 'Assertion-Reason'; else if (headerText.includes('Statement-Based')) data.type = 'Statement'; else if (headerText.includes('Maths, Physics, or Other')) data.type = 'Maths'; else if (headerText.includes('True/False')) data.type = 'True/False'; else if (headerText.includes('Fill-in-the-Blank')) data.type = 'Fill-in-the-Blank'; else data.type = 'MCQ'; const questionRegex = /Question:([\s\S]*?)Options:\n([\s\S]*?)Correct Answer:([\s\S]*?)(?:Explanation:([\s\S]*))?$/; const arRegex = /Assertion \(A\):([\s\S]*?)Reason \(R\):([\s\S]*?)Options:\n([\s\S]*?)Correct Answer:([\s\S]*?)(?:Explanation:([\s\S]*))?$/; const match = (data.type === 'Assertion-Reason') ? fullBlock.match(arRegex) : fullBlock.match(questionRegex); if (match) { if (data.type === 'Assertion-Reason') { data.question = `Assertion (A): ${match[1].trim()}\nReason (R): ${match[2].trim()}`; data.options = match[3].trim().split('\n').map(opt => opt.trim()); data.answer = match[4].trim().split(')')[0].trim(); data.explanation = (match[5] || 'No explanation provided.').trim(); } else { data.question = match[1].trim(); data.options = match[2].trim().split('\n').map(opt => opt.trim()); data.answer = match[3].trim().split(')')[0].trim(); data.explanation = (match[4] || 'No explanation provided.').trim(); } return data; } return null; }).filter(Boolean); }
    async function restartQuiz() { clearFormState(); await dbHelper.clear(); window.location.hash = ''; }
    async function handleHardReset() { elements.mainContainer.classList.add('fade-out-and-shrink'); showLoading("Deleting all data and returning home..."); localStorage.clear(); sessionStorage.clear(); await dbHelper.clear(); if (gameMode === 'multiplayer' && currentRoomCode && window.firebase) { const { db, ref, remove } = window.firebase; const roomRef = ref(db, `rooms/${currentRoomCode}`); try { if (isHost) { await remove(roomRef); } else if(currentPlayerId) { await remove(ref(db, `rooms/${currentRoomCode}/players/${currentPlayerId}`)); } } catch (error) { console.error("Firebase deletion failed:", error); } } setTimeout(() => { window.location.href = window.location.pathname; }, 1000); }
    function getFullQuizContent(bookmarksOnly) { let text = `🏆 EXAMYATRI Assessment Results 🏆\n\n`; const totalQuestions = originalQuizData.length; const correctCount = userAnswers.filter(ans => ans.isCorrect).length; const percentage = totalQuestions > 0 ? (correctCount / totalQuestions) * 100 : 0; const timeDiff = Math.round(((new Date()) - quizStartTime) / 1000); const timeTaken = `${String(Math.floor(timeDiff / 60)).padStart(2, '0')}:${String(timeDiff % 60).padStart(2, '0')}`; text += `Final Score: ${correctCount} / ${totalQuestions} (${percentage.toFixed(1)}%)\n`; text += `Time Taken: ${timeTaken}\n\n`; text += '------------------------------------\n\n'; const questionsToProcess = originalQuizData.map((q, i) => ({ ...q, originalIndex: i })).filter(q => !bookmarksOnly || bookmarkedQuestions.has(q.originalIndex)); if (questionsToProcess.length === 0) return null; questionsToProcess.forEach(q => { const userAnswer = userAnswers[q.originalIndex]; text += `Q${q.originalIndex + 1}: ${q.question.replace(/<br>/g, '\n')}\n\n`; if (q.statements && q.statements.length > 0) { q.statements.forEach(stmt => { text += `• ${stmt}\n`; }); text += '\n'; } q.options.forEach((opt, oi) => { text += `${String.fromCharCode(97 + oi)}) ${opt.replace(/<[^>]*>/g, '')}\n`; }); text += `\nCorrect Answer: ${String.fromCharCode(97 + q.correctAnswerIndex)})\n`; if (userAnswer.status === 'answered') { text += `Your Answer: ${String.fromCharCode(97 + userAnswer.selected)}) - ${userAnswer.isCorrect ? 'Correct' : 'Incorrect'}\n`; } else { text += `Your Answer: Skipped\n`; } text += `\nExplanation:\n${q.explanation}\n\n`; text += '------------------------------------\n\n'; }); return text; }
    function copyQuizContent(bookmarksOnly) { const fullTextToCopy = getFullQuizContent(bookmarksOnly); if (!fullTextToCopy) { showPasteNotification(`🤔 No ${bookmarksOnly ? 'bookmarked ' : ''}questions to copy!`); return; } copyTextToClipboard(fullTextToCopy).then(() => showPasteNotification(`✅ Summary & ${bookmarksOnly ? 'bookmarked ' : 'all '}questions copied!`)); }
    function copyTextToClipboard(text) { return new Promise((resolve, reject) => { if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(text).then(resolve).catch(err => { console.warn('Modern clipboard API failed, falling back.', err); legacyCopy(reject); }); } else { legacyCopy(reject); } function legacyCopy(onFail) { const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = "fixed"; textArea.style.top = "-9999px"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try { document.execCommand('copy') ? resolve() : onFail(new Error('Legacy copy command failed.')); } catch (err) { console.error('Legacy copy failed.', err); onFail(err); } finally { document.body.removeChild(textArea); } } }).catch(() => { showManualCopyModal(text); throw new Error("Manual intervention required for copy."); }); }
    function showManualCopyModal(text) { elements.manualCopyTextarea.value = text; elements.manualCopyModalOverlay.classList.remove('hidden'); elements.manualCopyTextarea.select(); elements.manualCopyTextarea.focus(); }
    function showPasteNotification(message) { elements.pasteNotification.textContent=message;elements.pasteNotification.classList.add('show');setTimeout(()=>elements.pasteNotification.classList.remove('show'),3000)}
    function toggleTheme(){document.body.classList.toggle('dark-mode');const isDarkMode=document.body.classList.contains('dark-mode');localStorage.setItem('quizTheme',isDarkMode?'dark':'light');document.getElementById('theme-toggle-btn').textContent=isDarkMode?'☀️':'🌙'}
    function applyInitialTheme(){ if(localStorage.getItem('quizTheme') === 'light'){ document.body.classList.remove('dark-mode'); } const isDarkMode = document.body.classList.contains('dark-mode'); document.getElementById('theme-toggle-btn').textContent = isDarkMode ? '☀️' : '🌙'; }
    function shareOnWhatsApp() { const totalQuestions = originalQuizData.length; const correctCount = userAnswers.filter(ans => ans.isCorrect).length; const percentage = totalQuestions > 0 ? (correctCount / totalQuestions) * 100 : 0; const text = `I just took a quiz on EXAMYATRI! 🚀\n\n*My Score:* ${correctCount} out of ${totalQuestions} (${percentage.toFixed(1)}%).\n\nThink you can beat me? Create your own free mock tests here:\n${window.location.href}`; const encodedText = encodeURIComponent(text); window.open(`https://api.whatsapp.com/send?text=${encodedText}`, '_blank'); }
    async function shareWebsite() { const shareData = { title: 'EXAMYATRI - Free Mock Test Generator', text: 'Create unlimited topic-wise mock tests for any exam, completely free! Generate questions from topics, text, images, or PDFs with AI. 🚀', url: window.location.href }; try { if (navigator.share) { await navigator.share(shareData); } else { await copyTextToClipboard(shareData.url); showPasteNotification('✅ Website link copied to clipboard!'); } } catch (err) { console.error('Error sharing website:', err); await copyTextToClipboard(shareData.url); showPasteNotification('Sharing failed. Link copied to clipboard instead!'); } }
    async function openTelegramWithBookmarks() { /* ... implementation ... */ }
    async function generatePDF() { showLoading("Generating PDF..."); const { jsPDF } = window.jspdf; const doc = new jsPDF(); const totalQuestions = originalQuizData.length; const correctCount = userAnswers.filter(ans => ans.isCorrect).length; const incorrectCount = userAnswers.filter(ans => ans.status === 'answered' && !ans.isCorrect).length; const skippedCount = totalQuestions - correctCount - incorrectCount; const percentage = totalQuestions > 0 ? (correctCount / totalQuestions) * 100 : 0; const timeDiff = Math.round(((new Date()) - quizStartTime) / 1000); const timeTaken = `${String(Math.floor(timeDiff / 60)).padStart(2, '0')}:${String(timeDiff % 60).padStart(2, '0')}`; let y = 15; const x = 15; const margin = 15; const pageHeight = doc.internal.pageSize.height; const pageWidth = doc.internal.pageSize.width; const addText = (text, X, Y, options = {}) => { doc.setFontSize(options.fontSize || 10); const maxWidth = pageWidth - (margin * 2); const lines = doc.splitTextToSize(text, maxWidth); doc.text(lines, X, Y, options); return y + (lines.length * (options.fontSize || 10) * 0.35); }; const checkPageBreak = (currentY, neededHeight = 20) => { if (currentY + neededHeight > pageHeight - margin) { doc.addPage(); return margin; } return currentY; }; doc.setFontSize(20); doc.setFont("helvetica", "bold"); y = addText("EXAMYATRI - Assessment Results", x, y, { fontSize: 20 }); doc.setLineWidth(0.5); doc.line(x, y, pageWidth - x, y); y += 10; doc.setFontSize(14); doc.setFont("helvetica", "bold"); y = addText("Summary:", x, y, { fontSize: 14 }); y += 5; doc.setFontSize(11); doc.setFont("helvetica", "normal"); y = addText(`Final Score: ${correctCount} / ${totalQuestions} (${percentage.toFixed(1)}%)`, x, y, { fontSize: 11 }); y = addText(`Correct Answers: ${correctCount}`, x, y, { fontSize: 11 }); y = addText(`Incorrect Answers: ${incorrectCount}`, x, y, { fontSize: 11 }); y = addText(`Skipped Questions: ${skippedCount}`, x, y, { fontSize: 11 }); y = addText(`Time Taken: ${timeTaken}`, x, y, { fontSize: 11 }); y += 10; doc.line(x, y, pageWidth - x, y); y += 10; y = checkPageBreak(y); doc.setFontSize(14); doc.setFont("helvetica", "bold"); y = addText("Answer Review:", x, y, { fontSize: 14 }); y += 5; for (let i = 0; i < originalQuizData.length; i++) { y = checkPageBreak(y, 40); const q = originalQuizData[i]; const answer = userAnswers[i]; doc.setFontSize(12); doc.setFont("helvetica", "bold"); const questionText = `Q${i + 1}: ${q.question.replace(/<[^>]*>/g, '').replace(/\n/g, ' ')}`; y = addText(questionText, x, y, { fontSize: 12 }); y += 2; if (q.statements && q.statements.length > 0) { y = checkPageBreak(y, q.statements.length * 5); doc.setFontSize(10); doc.setFont("helvetica", "italic"); q.statements.forEach(stmt => { y = addText(`• ${stmt}`, x + 5, y, { fontSize: 10 }); }); y += 2; } y = checkPageBreak(y, q.options.length * 5); doc.setFontSize(10); doc.setFont("helvetica", "normal"); q.options.forEach((opt, oi) => { let prefix = ''; const optionLetter = String.fromCharCode(97 + oi); const isUserAnswer = answer.status === 'answered' && oi === answer.selected; const isCorrectAnswer = oi === q.correctAnswerIndex; if (isUserAnswer && isCorrectAnswer) { doc.setFont("helvetica", "bold"); prefix = `(Your Correct Answer) `; } else if (isUserAnswer) { doc.setFont("helvetica", "bold"); prefix = `(Your Answer) `; } else if (isCorrectAnswer) { prefix = `(Correct Answer) `; } y = addText(`${optionLetter}) ${prefix}${opt.replace(/<[^>]*>/g, '')}`, x + 5, y, { fontSize: 10 }); doc.setFont("helvetica", "normal"); }); y += 4; y = checkPageBreak(y, 20); doc.setFontSize(10); doc.setFont("helvetica", "bold"); y = addText("Explanation:", x + 5, y, { fontSize: 10 }); doc.setFont("helvetica", "normal"); y = addText(q.explanation.replace(/<[^>]*>/g, ''), x + 5, y, { fontSize: 10 }); y += 8; if (i < originalQuizData.length - 1) { y = checkPageBreak(y, 10); doc.setDrawColor(200); doc.line(x, y, pageWidth - x, y); y += 8; } } const fileName = `Examyatri_Results_${new Date().toISOString().split('T')[0]}.pdf`; doc.save(fileName); hideLoading(); }
    function triggerCongratsAnimation() { elements.congratsAnimationContainer.innerHTML = ''; const emojis = ['🎉', '🤩', '🥳', '✨', '👍', '💯']; for (let i = 0; i < 30; i++) { const emojiSpan = document.createElement('span'); emojiSpan.className = 'congrats-emoji'; emojiSpan.textContent = emojis[Math.floor(Math.random() * emojis.length)]; const angle = Math.random() * Math.PI * 2; const radius = Math.random() * (window.innerWidth / 2); const endX = Math.cos(angle) * radius; const endY = Math.sin(angle) * radius; emojiSpan.style.setProperty('--transform-end', `translate(${endX}px, ${endY}px)`); elements.congratsAnimationContainer.appendChild(emojiSpan); } clapSound.currentTime = 0; clapSound.play(); }
    function showSadReaction() { const sadEmojis = ['😥', '😭', '🤦', '😫']; elements.sadReactionEmoji.textContent = sadEmojis[Math.floor(Math.random() * sadEmojis.length)]; elements.sadReactionOverlay.classList.remove('hidden'); setTimeout(() => { elements.sadReactionOverlay.classList.add('hidden'); }, 1500); }
    function loadPressureModeSettings() { const shakeEnabled = localStorage.getItem('shakeReminderEnabled'); isShakeReminderEnabled = shakeEnabled === null ? true : shakeEnabled === 'true'; elements.shakeReminderToggle.checked = isShakeReminderEnabled; }
    function resetAndStartQuestionTimer() { clearInterval(timerId); questionStartTime = new Date(); const emojiSequence = [elements.faces.happy, elements.faces.worried, elements.faces.sad, elements.faces.crying]; const updateTimerDisplay = () => { if (!questionStartTime) return; const elapsedTime = Math.round((new Date() - questionStartTime) / 1000); elements.timerText.textContent = `${String(Math.floor(elapsedTime / 60)).padStart(2, '0')}:${String(elapsedTime % 60).padStart(2, '0')}`; const emojiIntervalIndex = Math.floor(elapsedTime / 15); const currentEmoji = emojiSequence[emojiIntervalIndex % emojiSequence.length]; if (currentEmoji && !currentEmoji.classList.contains('visible')) { emojiSequence.forEach(face => face.classList.remove('visible')); currentEmoji.classList.add('visible'); } const pressureTextEl = document.getElementById('pressure-text-animation'); if (elapsedTime >= 45 && userAnswers[currentQuestionIndex].status !== 'answered') { if (isShakeReminderEnabled) { const checkBtn = document.getElementById('check-answer-btn'); if (checkBtn) checkBtn.classList.add('vibrating'); } if (pressureTextEl) { document.getElementById('pressure-mode-toggle-btn').classList.add('hidden'); pressureTextEl.classList.remove('hidden'); pressureTextEl.textContent = `Tik Tik ${pressureTextCounter}`; pressureTextCounter++; } } }; updateTimerDisplay(); timerId = setInterval(updateTimerDisplay, 1000); }
    function startQuiz(){ showScreen('player'); quizStartTime=new Date(); currentQuestionIndex=0; userAnswers=quizData.map((q, i)=>({selected:null,isCorrect:null,status:'unseen', startTime: null, endTime: null})); bookmarkedQuestions.clear(); originalQuizData=JSON.parse(JSON.stringify(quizData)); loadQuestion(0); }
    function loadQuestion(index){ if(index<0||index>=originalQuizData.length)return; currentQuestionIndex=index;selectedOptionIndex=null; const question=originalQuizData[currentQuestionIndex]; const answer=userAnswers[currentQuestionIndex]; elements.congratsAnimationContainer.innerHTML = ''; if (!clapSound.paused) { clapSound.pause(); clapSound.currentTime = 0; } pressureTextCounter = 1; const pressureTextEl = document.getElementById('pressure-text-animation'); if(pressureTextEl) pressureTextEl.classList.add('hidden'); document.getElementById('pressure-mode-toggle-btn').classList.remove('hidden'); if(answer.status==='answered'){ clearInterval(timerId); elements.timerText.textContent="--:--"; Object.values(elements.faces).forEach(face=>face.classList.remove('visible')) } else { resetAndStartQuestionTimer() } updateQuestionUI(question); updateOptionsAndExplanationState(); updateQuizActions(); if (window.MathJax) MathJax.typesetPromise([elements.quizPlayerContainer]); }
    function updateQuestionUI(q) {
        elements.questionTopic.textContent = quizMetaData.topic || "";
        elements.progress.textContent = `Question ${currentQuestionIndex + 1} / ${originalQuizData.length}`;
        elements.questionText.innerHTML = q.question.replace(/\n/g, '<br>');
        elements.bookmarkBtn.classList.toggle('bookmarked', bookmarkedQuestions.has(currentQuestionIndex));
        elements.statementsList.innerHTML = q.statements?.map(stmt => `<p>• ${stmt}</p>`).join('') || '';
        elements.optionsContainer.innerHTML = '';
        q.options.forEach((optionText, i) => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option';
            optionDiv.dataset.index = i;
            optionDiv.innerHTML = `<span class="option-text">${optionText}</span><div class="option-feedback"><span class="user-choice-emoji"></span><span class="feedback-icon"></span></div>`;
            elements.optionsContainer.appendChild(optionDiv);
        });
    }
    function updateOptionsAndExplanationState() { const answer = userAnswers[currentQuestionIndex]; const question = originalQuizData[currentQuestionIndex]; const correctEmojis = ['🥳', '🎉', '🤩', '👍', '💯']; const incorrectEmojis = ['🤔', '😟', '🤨', '🤦‍♂️', '❌']; document.querySelectorAll('.option').forEach((optionDiv, i) => { if (answer.status === 'answered') { optionDiv.classList.add('disabled'); if (i === question.correctAnswerIndex) { optionDiv.classList.add('correct'); optionDiv.querySelector('.feedback-icon').textContent = '✔️'; } if (i === answer.selected) { const userChoiceEmoji = optionDiv.querySelector('.user-choice-emoji'); if (answer.isCorrect) userChoiceEmoji.textContent = correctEmojis[Math.floor(Math.random() * correctEmojis.length)]; else { optionDiv.classList.add('incorrect'); optionDiv.querySelector('.feedback-icon').textContent = '❌'; userChoiceEmoji.textContent = incorrectEmojis[Math.floor(Math.random() * incorrectEmojis.length)]; } userChoiceEmoji.classList.add('visible'); } } }); const isAnswered = answer.status === 'answered'; elements.explanationContainer.classList.toggle('hidden', !isAnswered); if (isAnswered) { elements.explanationText.innerHTML = question.explanation; } }
    function updateQuizActions() { elements.quizActions.innerHTML = ''; const prevBtn = document.createElement('button'); prevBtn.id = 'prev-question-btn'; prevBtn.className = 'btn btn-secondary quiz-actions-top-left'; prevBtn.textContent = '⬅️ Previous'; prevBtn.disabled = currentQuestionIndex === 0; elements.quizActions.appendChild(prevBtn); if (userAnswers[currentQuestionIndex].status !== 'answered') { const checkBtn = document.createElement('button'); checkBtn.id = 'check-answer-btn'; checkBtn.className = 'btn quiz-actions-top-right'; checkBtn.textContent = 'Check Answer ✅'; checkBtn.disabled = selectedOptionIndex === null; elements.quizActions.appendChild(checkBtn); const skipBtn = document.createElement('button'); skipBtn.id = 'skip-question-btn'; skipBtn.className = 'btn quiz-actions-bottom-left'; skipBtn.textContent = 'Skip ➡️'; elements.quizActions.appendChild(skipBtn); } else { const nextBtn = document.createElement('button'); nextBtn.id = 'next-question-btn'; nextBtn.className = 'btn quiz-actions-bottom-left'; nextBtn.textContent = 'Next ➡️'; nextBtn.disabled = currentQuestionIndex === originalQuizData.length - 1; elements.quizActions.appendChild(nextBtn); } const submitBtn = document.createElement('button'); submitBtn.id = 'submit-quiz-btn'; submitBtn.className = 'btn btn-danger quiz-actions-bottom-right'; submitBtn.textContent = 'Submit'; elements.quizActions.appendChild(submitBtn); }
    function handleBookmark(){bookmarkedQuestions.has(currentQuestionIndex)?bookmarkedQuestions.delete(currentQuestionIndex):bookmarkedQuestions.add(currentQuestionIndex);elements.bookmarkBtn.classList.toggle('bookmarked')}
    function handleSkip(){if(userAnswers[currentQuestionIndex].status==='unseen')userAnswers[currentQuestionIndex].status='skipped';if(currentQuestionIndex<originalQuizData.length-1)loadQuestion(currentQuestionIndex+1);else{const firstUnanswered=userAnswers.findIndex(ans=>ans.status!=='answered');if(firstUnanswered!==-1)loadQuestion(firstUnanswered);else forceSubmitQuiz()}}
    function forceSubmitQuiz(){if(confirm('Are you sure you want to end the assessment now?')){if(timerId) clearInterval(timerId); const pressureTextEl = document.getElementById('pressure-text-animation');if(pressureTextEl) pressureTextEl.classList.add('hidden');document.getElementById('pressure-mode-toggle-btn').classList.remove('hidden');userAnswers.forEach((answer,index)=>{if(answer.status==='unseen')userAnswers[index].status='skipped'});showResults()}}
    function selectOption(index){ if(userAnswers[currentQuestionIndex].status==='answered')return; optionClickSound.play(); selectedOptionIndex=index; document.querySelectorAll('.option').forEach((opt,i)=>opt.classList.toggle('selected',i===index)); const checkBtn = document.getElementById('check-answer-btn'); if(checkBtn) checkBtn.disabled=false; }
    function checkAnswer(){ if (selectedOptionIndex === null) return; const question=originalQuizData[currentQuestionIndex];const isCorrect=selectedOptionIndex===question.correctAnswerIndex;userAnswers[currentQuestionIndex]={selected:selectedOptionIndex,isCorrect:isCorrect,status:'answered'}; const pressureTextEl = document.getElementById('pressure-text-animation');if(pressureTextEl) pressureTextEl.classList.add('hidden');document.getElementById('pressure-mode-toggle-btn').classList.remove('hidden'); if(isCorrect) triggerCongratsAnimation(); else showSadReaction(); updateQuestionUI(originalQuizData[currentQuestionIndex]); updateOptionsAndExplanationState(); updateQuizActions(); if (window.MathJax) MathJax.typesetPromise([elements.quizPlayerContainer]); }
    function animateCountUp(el, end, duration = 1000) { let start = 0; const final = parseInt(end, 10); if (isNaN(final)) { el.textContent = end; return; } let startTimestamp = null; const step = (timestamp) => { if (!startTimestamp) startTimestamp = timestamp; const progress = Math.min((timestamp - startTimestamp) / duration, 1); el.textContent = Math.floor(progress * (final - start) + start); if (progress < 1) window.requestAnimationFrame(step); }; window.requestAnimationFrame(step); }
    function showResults(){ showScreen('results'); if(timerId) clearInterval(timerId); const totalQuestions = originalQuizData.length; const correctCount = userAnswers.filter(ans => ans.isCorrect).length; const incorrectCount = userAnswers.filter(ans => ans.status === 'answered' && !ans.isCorrect).length; const skippedCount = totalQuestions - correctCount - incorrectCount; const percentage = totalQuestions > 0 ? (correctCount / totalQuestions) * 100 : 0; let remark=percentage>=90?"Excellent!":percentage>=75?"Great Job!":percentage>=50?"Good Effort!":"Needs Improvement"; const timeDiff=Math.round(((new Date())-quizStartTime)/1000); const timeTaken=`${String(Math.floor(timeDiff/60)).padStart(2,'0')}:${String(timeDiff%60).padStart(2,'0')}`; elements.scoreSummary.textContent=`You scored ${correctCount} out of ${totalQuestions}!`; setTimeout(() => { elements.scoreSummary.classList.add('visible'); }, 100); elements.scorePerformanceChartContainer.innerHTML = ''; elements.quizSummaryDetails.innerHTML=` <div class="summary-item"> <span class="summary-label">Status</span> <span class="summary-value remark">${remark}</span> </div> <div class="summary-item"> <span class="summary-label">Final Score</span> <span class="summary-value">${percentage.toFixed(1)}%</span> </div> <div class="summary-item"> <span class="summary-label">Correct Answers</span> <span class="summary-value" style="color: var(--correct-color);">${correctCount} / ${totalQuestions}</span> </div> <div class="summary-item"> <span class="summary-label">Incorrect Answers</span> <span class="summary-value" style="color: var(--incorrect-color);">${incorrectCount}</span> </div> <div class="summary-item"> <span class="summary-label">Skipped Questions</span> <span class="summary-value" style="color: var(--skipped-color);">${skippedCount}</span> </div> <div class="summary-item"> <span class="summary-label">Time Taken</span> <span class="summary-value">${timeTaken}</span> </div>`; document.querySelectorAll('.count-up').forEach(el => animateCountUp(el, el.dataset.value)); elements.resultsReview.innerHTML=originalQuizData.map((q,i)=>{const answer=userAnswers[i];const optionsHtml=q.options.map((opt,oi)=>{let classes='result-option';if(answer.status==='answered'&&oi===answer.selected)classes+=' user-selected';if(oi===q.correctAnswerIndex)classes+=' correct-answer';return`<li class="${classes}">${opt}</li>`}).join('');return`<div class="result-item"><p class="result-question"><strong>Q${i + 1}:</strong> ${q.question.replace(/<[^>]*>/g, '')}<span class="bookmark-indicator ${bookmarkedQuestions.has(i)?'visible':''}">⭐</span></p><ul class="result-options-list">${optionsHtml}</ul><div class="result-explanation"><h5>Explanation</h5><p>${q.explanation}</p></div></div>`}).join(''); if (window.MathJax) MathJax.typesetPromise([elements.resultsScreen]); }

    // --- NEW: DYNAMIC PROMPT BUILDER LOGIC ---
    function setupDynamicPromptBuilder() {
        const builderContainer = document.getElementById('dynamic-prompt-builder');
        const addBtn = document.getElementById('prompt-builder-add-btn');

        const createRowHTML = () => `
            <div class="concise-summary">Click to edit section...</div>
            <div class="prompt-builder-grid">
                <div class="input-group">
                    <label class="input-label">Subject Name</label>
                    <input type="text" class="input-field" data-type="subject" placeholder="e.g., Physics">
                </div>
                <div class="input-group">
                    <label class="input-label">Topic Name</label>
                    <input type="text" class="input-field" data-type="topic" placeholder="e.g., Thermodynamics">
                </div>
                <div class="input-group">
                    <label class="input-label">No. of Questions</label>
                    <input type="number" class="input-field" data-type="numQuestions" min="1" max="50" placeholder="e.g., 10">
                </div>
                <div class="input-group">
                    <label class="input-label">Class/Standard</label>
                    <input type="text" class="input-field" data-type="standard" placeholder="e.g., 12th">
                </div>
                <div class="input-group">
                    <label class="input-label">Reference Book (Optional)</label>
                    <input type="text" class="input-field" data-type="book" placeholder="e.g., NCERT">
                </div>
            </div>
            <button class="prompt-builder-remove-btn" title="Remove Section">×</button>
        `;

        const addRow = () => {
            const row = document.createElement('div');
            row.className = 'prompt-builder-row';
            row.innerHTML = createRowHTML();
            builderContainer.appendChild(row);
            updateRemoveButtons();
        };

        const updateRemoveButtons = () => {
            const rows = builderContainer.querySelectorAll('.prompt-builder-row');
            rows.forEach((row, index) => {
                const removeBtn = row.querySelector('.prompt-builder-remove-btn');
                removeBtn.style.display = rows.length > 1 ? 'flex' : 'none';
            });
        };

        const updateRowState = (row) => {
            const numVal = row.querySelector('[data-type="numQuestions"]').value;
            const subject = row.querySelector('[data-type="subject"]').value;
            const topic = row.querySelector('[data-type="topic"]').value;
            
            if (numVal && subject && topic) {
                row.classList.add('concise');
                const summary = row.querySelector('.concise-summary');
                summary.textContent = `${numVal} Qs from ${subject} (${topic})`;
            } else {
                row.classList.remove('concise');
            }
        };

        addBtn.addEventListener('click', addRow);

        builderContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('prompt-builder-remove-btn')) {
                e.target.parentElement.remove();
                updateRemoveButtons();
            } else if (e.target.closest('.prompt-builder-row.concise')) {
                e.target.closest('.prompt-builder-row.concise').classList.remove('concise');
            }
        });

        builderContainer.addEventListener('change', (e) => {
             const row = e.target.closest('.prompt-builder-row');
             if(row) updateRowState(row);
        });

        // Add the first row initially
        addRow();
    }
});
</script>
</body>
</html>
